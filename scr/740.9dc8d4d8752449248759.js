"use strict";(self.webpackChunk_tolokoban_tgd=self.webpackChunk_tolokoban_tgd||[]).push([[740],{8740:(t,e,i)=>{function r(t,e=6){const i=Math.pow(10,e),r=[];let n=0;for(const s of t){const t=(Math.round(s*i)/i).toFixed(e);n=Math.max(n,t.length),r.push(t)}return r.map((t=>t.padStart(n," ")))}i.d(e,{v$:()=>x,xN:()=>v,Gb:()=>At,tf:()=>k,pw:()=>W,I9:()=>Y,vA:()=>Pt,Ch:()=>St,ZW:()=>ct,$H:()=>dt,tb:()=>X,m1:()=>q,b6:()=>J,o5:()=>Q,AN:()=>tt,D$:()=>ot,ZJ:()=>at,g6:()=>ft,dR:()=>gt,bu:()=>xt,b5:()=>vt,$R:()=>yt,$f:()=>wt,FX:()=>Vt,qj:()=>Ft,HI:()=>c,op:()=>f,hN:()=>o,o:()=>h,vR:()=>U,oj:()=>F,LU:()=>N});class n extends Float32Array{constructor(t=1,e=0,i=0,r=0,n=1,s=0,o=0,a=0,h=1){super("number"==typeof t?[t,e,i,r,n,s,o,a,h]:t)}transpose(){let t=this.m10;return this.m10=this.m01,this.m01=t,t=this.m20,this.m20=this.m02,this.m02=t,t=this.m21,this.m21=this.m12,this.m12=t,this}fromQuat({x:t,y:e,z:i,w:r}){const n=t+t,s=e+e,o=i+i,a=t*n,h=e*n,c=e*s,u=i*n,l=i*s,m=i*o,d=r*n,f=r*s,g=r*o;return this.m00=1-c-m,this.m10=h-g,this.m20=u+f,this.m01=h+g,this.m11=1-a-m,this.m21=l-d,this.m02=u-f,this.m12=l+d,this.m22=1-a-c,this}toAxis(t,e,i){return this.toAxisX(t),this.toAxisY(e),this.toAxisZ(i)}toAxisX(t){return t.x=this.m00,t.y=this.m01,t.z=this.m02,this}toAxisY(t){return t.x=this.m10,t.y=this.m11,t.z=this.m12,this}toAxisZ(t){return t.x=this.m20,t.y=this.m21,t.z=this.m22,this}scale(t){return this[0]*=t,this[1]*=t,this[2]*=t,this[3]*=t,this[4]*=t,this[5]*=t,this[6]*=t,this[7]*=t,this[8]*=t,this}get m00(){return this[0]}set m00(t){this[0]=t}get m01(){return this[1]}set m01(t){this[1]=t}get m02(){return this[2]}set m02(t){this[2]=t}get m10(){return this[3]}set m10(t){this[3]=t}get m11(){return this[4]}set m11(t){this[4]=t}get m12(){return this[5]}set m12(t){this[5]=t}get m20(){return this[6]}set m20(t){this[6]=t}get m21(){return this[7]}set m21(t){this[7]=t}get m22(){return this[8]}set m22(t){this[8]=t}debug(t="Mat3"){const e=r([this.m00,this.m01,this.m02]),i=r([this.m10,this.m11,this.m12]),n=r([this.m20,this.m21,this.m22]);console.log(t),console.log("   ",[e[0],i[0],n[0]].join(" | ")),console.log("   ",[e[1],i[1],n[1]].join(" | ")),console.log("   ",[e[2],i[2],n[2]].join(" | "))}}function s(t,e,i){return(1-i)*t+i*e}class o extends Float32Array{static fromMix(t,e,i=.5){const r=1-i,n=r*t.x+i*e.x,s=r*t.y+i*e.y,a=r*t.z+i*e.z;return new o(n,s,a)}static distance(t,e){const i=e.x-t.x,r=e.y-t.y,n=e.z-t.z;return Math.sqrt(i*i+r*r+n*n)}constructor(t=0,e=0,i=0){if(super(3),"number"!=typeof t)return this.x=t[0],this.y=t[1],void(this.z=t[2]);this.x=t,this.y=e,this.z=i}clone(){return new o(this)}isEqual(t){const[e,i,r]=t;return e===this.x&&i===this.y&&r===this.z}isClose(t,e=1e-6){const[i,r,n]=t;return!(Math.abs(i-this.x)>e||Math.abs(r-this.y)>e||Math.abs(n-this.z)>e)}rotateAround(t,e){const i=Math.cos(e),r=Math.sin(e),[n,s,o]=this,[a,h,c]=t,u=h*o-c*s,l=c*n-a*o,m=a*s-h*n,d=(n*a+s*h+o*c)*(1-i);return this.x=n*i+u*r+a*d,this.y=s*i+l*r+h*d,this.z=o*i+m*r+c*d,this}applyMatrix(t){const{x:e,y:i,z:r}=this;return this.x=e*t.m00+i*t.m10+r*t.m20,this.y=e*t.m01+i*t.m11+r*t.m21,this.z=e*t.m02+i*t.m12+r*t.m22,this}from(t){const[e,i,r]=t;return this.x=e,this.y=i,this.z=r,this}fromMix(t,e,i){const[r,n,o]=t,[a,h,c]=e;return this.reset(s(r,a,i),s(n,h,i),s(o,c,i))}reset(t,e,i){return this[0]=t,this[1]=e,this[2]=i,this}distanceToLineSquared(t,e){const[i,r,n]=this,[s,o,a]=t,[h,c,u]=e,l=h*(i-s)+c*(r-o)+u*(n-a),m=i-(s+l*h),d=r-(o+l*c),f=n-(a+l*u);return m*m+d*d+f*f}get x(){return this[0]}set x(t){this[0]=t}get y(){return this[1]}set y(t){this[1]=t}get z(){return this[2]}set z(t){this[2]=t}add(...t){for(const e of t)this[0]+=e.x,this[1]+=e.y,this[2]+=e.z;return this}addWithScale(t,e){return this[0]+=t.x*e,this[1]+=t.y*e,this[2]+=t.z*e,this}subtract(t){return this[0]-=t[0],this[1]-=t[1],this[2]-=t[2],this}scale(t){return this[0]*=t,this[1]*=t,this[2]*=t,this}dot(t){return this[0]*t[0]+this[1]*t[1]+this[2]*t[2]}get size(){return Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2])}normalize(){const t=this[0]*this[0]+this[1]*this[1]+this[2]*this[2];return 0===t?this:this.scale(1/Math.sqrt(t))}cross(t){const[e,i,r]=this,[n,s,o]=t;return this[0]=i*o-s*r,this[1]=r*n-o*e,this[2]=e*s-n*i,this}random(){return this[0]=Math.random()-.5,this[1]=Math.random()-.5,this[2]=Math.random()-.5,this}debug(t="vec3"){const{x:e,y:i,z:r}=this,n=[e,i,r].map((t=>t.toFixed(6)));console.log(`${t}:   `,n.join(" | "),"   length:",Math.sqrt(e*e+i*i+r*r))}}class a extends Float32Array{constructor(t=1,e=0,i=0,r=0,n=0,s=1,o=0,a=0,h=0,c=0,u=1,l=0,m=0,d=0,f=0,g=1){super("number"==typeof t?[t,e,i,r,n,s,o,a,h,c,u,l,m,d,f,g]:t)}multiply(t){const[e,i,r,n,s,o,a,h,c,u,l,m,d,f,g,p]=this,[x,v,y,w,b,_,A,E,T,M,P,S,R,C,I,U]=t;return this.m00=e*x+s*v+c*y+d*w,this.m10=e*b+s*_+c*A+d*E,this.m20=e*T+s*M+c*P+d*S,this.m30=e*R+s*C+c*I+d*U,this.m01=i*x+o*v+u*y+f*w,this.m11=i*b+o*_+u*A+f*E,this.m21=i*T+o*M+u*P+f*S,this.m31=i*R+o*C+u*I+f*U,this.m02=r*x+a*v+l*y+g*w,this.m12=r*b+a*_+l*A+g*E,this.m22=r*T+a*M+l*P+g*S,this.m32=r*R+a*C+l*I+g*U,this.m03=n*x+h*v+m*y+p*w,this.m13=n*b+h*_+m*A+p*E,this.m23=n*T+h*M+m*P+p*S,this.m33=n*R+h*C+m*I+p*U,this}invert(t){const[e,i,r,n,s,o,a,h,c,u,l,m,d,f,g,p]=t??this,x=e*o-i*s,v=e*a-r*s,y=e*h-n*s,w=i*a-r*o,b=i*h-n*o,_=r*h-n*a,A=c*f-u*d,E=c*g-l*d,T=c*p-m*d,M=u*g-l*f,P=u*p-m*f,S=l*p-m*g,R=x*S-v*P+y*M+w*T-b*E+_*A;if(!R)return this;const C=1/R;return this[0]=(o*S-a*P+h*M)*C,this[1]=(r*P-i*S-n*M)*C,this[2]=(f*_-g*b+p*w)*C,this[3]=(l*b-u*_-m*w)*C,this[4]=(a*T-s*S-h*E)*C,this[5]=(e*S-r*T+n*E)*C,this[6]=(g*y-d*_-p*v)*C,this[7]=(c*_-l*y+m*v)*C,this[8]=(s*P-o*T+h*A)*C,this[9]=(i*T-e*P-n*A)*C,this[10]=(d*b-f*y+p*x)*C,this[11]=(u*y-c*b-m*x)*C,this[12]=(o*E-s*M-a*A)*C,this[13]=(e*M-i*E+r*A)*C,this[14]=(f*v-d*w-g*x)*C,this[15]=(c*w-u*v+l*x)*C,this}get translation(){const{m30:t,m31:e,m32:i}=this;return new o(t,e,i)}set translation(t){this.m30=t.x,this.m31=t.y,this.m32=t.z}from(t){const[e,i,r,n,s,o,a,h,c,u,l,m,d,f,g,p]=t;return this.m00=e,this.m01=i,this.m02=r,this.m03=n,this.m10=s,this.m11=o,this.m12=a,this.m13=h,this.m20=c,this.m21=u,this.m22=l,this.m23=m,this.m30=d,this.m31=f,this.m32=g,this.m33=p,this}fromMat3(t){return this.m00=t.m00,this.m01=t.m01,this.m02=t.m02,this.m10=t.m10,this.m11=t.m11,this.m12=t.m12,this.m20=t.m20,this.m21=t.m21,this.m22=t.m22,this}toAxis(t,e,i){return this.toAxisX(t),this.toAxisY(e),this.toAxisZ(i)}toAxisX(t){return t.x=this.m00,t.y=this.m01,t.z=this.m02,this}toAxisY(t){return t.x=this.m10,t.y=this.m11,t.z=this.m12,this}toAxisZ(t){return t.x=this.m20,t.y=this.m21,t.z=this.m22,this}fromQuat({x:t,y:e,z:i,w:r}){const n=t+t,s=e+e,o=i+i,a=t*n,h=e*n,c=e*s,u=i*n,l=i*s,m=i*o,d=r*n,f=r*s,g=r*o;return this.m00=1-c-m,this.m10=h-g,this.m20=u+f,this.m01=h+g,this.m11=1-a-m,this.m21=l-d,this.m02=u-f,this.m12=l+d,this.m22=1-a-c,this}get m00(){return this[0]}set m00(t){this[0]=t}get m01(){return this[1]}set m01(t){this[1]=t}get m02(){return this[2]}set m02(t){this[2]=t}get m03(){return this[3]}set m03(t){this[3]=t}get m10(){return this[4]}set m10(t){this[4]=t}get m11(){return this[5]}set m11(t){this[5]=t}get m12(){return this[6]}set m12(t){this[6]=t}get m13(){return this[7]}set m13(t){this[7]=t}get m20(){return this[8]}set m20(t){this[8]=t}get m21(){return this[9]}set m21(t){this[9]=t}get m22(){return this[10]}set m22(t){this[10]=t}get m23(){return this[11]}set m23(t){this[11]=t}get m30(){return this[12]}set m30(t){this[12]=t}get m31(){return this[13]}set m31(t){this[13]=t}get m32(){return this[14]}set m32(t){this[14]=t}get m33(){return this[15]}set m33(t){this[15]=t}debug(t="Mat4"){const e=r([this.m00,this.m01,this.m02,this.m03]),i=r([this.m10,this.m11,this.m12,this.m13]),n=r([this.m20,this.m21,this.m22,this.m23]),s=r([this.m30,this.m31,this.m32,this.m33]);console.log(t),console.log("   ",[e[0],i[0],n[0],s[0]].join(" | ")),console.log("   ",[e[1],i[1],n[1],s[1]].join(" | ")),console.log("   ",[e[2],i[2],n[2],s[2]].join(" | ")),console.log("   ",[e[3],i[3],n[3],s[3]].join(" | "))}}class h extends Float32Array{constructor(t=0,e=0,i=0,r=1){return super(4),t instanceof h?(this.x=t.x,this.y=t.y,this.z=t.z,void(this.w=t.w)):t instanceof o?(this.x=t.x,this.y=t.y,this.z=t.z,void(this.w=r)):(this.x=t,this.y=e,this.z=i,void(this.w=r))}reset(t=0,e=0,i=0,r=1){return this.x=t,this.y=e,this.z=i,this.w=r,this}from(t){const[e,i,r,n]=t;return this.x=e,this.y=i,this.z=r,this.w=n,this}clone(){return new h(this)}isEqual(t){const[e,i,r,n]=t;return e===this.x&&i===this.y&&r===this.z&&n===this.w}isClose({x:t,y:e,z:i,w:r},n=1e-6){return!(Math.abs(t-this.x)>n||Math.abs(e-this.y)>n||Math.abs(i-this.z)>n||Math.abs(r-this.w)>n)}applyMatrix(t){const{x:e,y:i,z:r,w:n}=this;return this.x=e*t.m00+i*t.m10+r*t.m20+n*t.m30,this.y=e*t.m01+i*t.m11+r*t.m21+n*t.m31,this.z=e*t.m02+i*t.m12+r*t.m22+n*t.m32,this.w=e*t.m03+i*t.m13+r*t.m23+n*t.m33,this}get x(){return this[0]}set x(t){this[0]=t}get y(){return this[1]}set y(t){this[1]=t}get z(){return this[2]}set z(t){this[2]=t}get w(){return this[3]}set w(t){this[3]=t}add(...t){for(const e of t)this[0]+=e[0],this[1]+=e[1],this[2]+=e[2],e.length>3&&(this[3]+=e[3]);return this}subtract(t){return this[0]-=t[0],this[1]-=t[1],this[2]-=t[2],t.length>3&&(this[3]-=t[3]),this}scale(t){return this[0]*=t,this[1]*=t,this[2]*=t,this[3]*=t,this}dot(t){return this[0]*t[0]+this[1]*t[1]+this[2]*t[2]+this[3]*t[3]}get size(){return Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2]+this[3]*this[3])}normalize(){const t=this[0]*this[0]+this[1]*this[1]+this[2]*this[2]+this[3]*this[3];return 0===t?this:this.scale(1/Math.sqrt(t))}debug(t="vec4"){const{x:e,y:i,z:r,w:n}=this,s=[e,i,r,n].map((t=>t.toFixed(6)));console.log(`${t}:   `,s.join(" | "))}}class c extends h{constructor(t=0,e=0,i=0,r=1){"number"==typeof t?super(t,e,i,r):super(t)}clone(){return new c(this)}multiply(t){const[e,i,r,n]=this,[s,o,a,h]=t;return this[0]=h*e+s*n-o*r+a*i,this[1]=h*i+s*r+o*n-a*e,this[2]=h*r-s*i+o*e+a*n,this[3]=h*n-s*e-o*i-a*r,this}fromSlerp(t,e,i){const[r,n,s,o]=t;let a,h,[c,u,l,m]=e,d=r*c+n*u+s*l+o*m;if(d<0&&(d=-d,c=-c,u=-u,l=-l,m=-m),1-d>1e-6){const t=Math.acos(d),e=1/Math.sin(t);a=Math.sin((1-i)*t)*e,h=Math.sin(i*t)*e}else a=1-i,h=i;return this.x=a*r+h*c,this.y=a*n+h*u,this.z=a*s+h*l,this.w=a*o+h*m,this}fromAxis(t,e,i){const r=t.x+e.y+i.z;if(r>0){const n=Math.sqrt(r+1);this.w=.5*n;const s=.5/n;this.x=(e.z-i.y)*s,this.y=(i.x-t.z)*s,this.z=(t.y-e.x)*s}else{const r=[t,e,i];let n=0;e.y>t.x&&(n=1),i.z>r[n][n]&&(n=2);const s=(n+1)%3,o=(n+2)%3;let a=Math.sqrt(r[n][n]-r[s][s]-r[o][o]+1);this[n]=.5*a,a=.5/a,this[3]=(r[s][o]-r[o][s])*a,this[s]=(r[s][n]+r[n][s])*a,this[o]=(r[o][n]+r[n][o])*a}return this.normalize()}rotateAroundX(t){const e=.5*t,i=this[0],r=this[1],n=this[2],s=this[3],o=Math.sin(e),a=Math.cos(e);return this[0]=i*a+s*o,this[1]=r*a+n*o,this[2]=n*a-r*o,this[3]=s*a-i*o,this}rotateAroundY(t){const e=.5*t,i=this[0],r=this[1],n=this[2],s=this[3],o=Math.sin(e),a=Math.cos(e);return this[0]=i*a-n*o,this[1]=r*a+s*o,this[2]=n*a+i*o,this[3]=s*a-r*o,this}rotateAroundZ(t){const e=.5*t,i=this[0],r=this[1],n=this[2],s=this[3],o=Math.sin(e),a=Math.cos(e);return this[0]=i*a+r*o,this[1]=r*a-i*o,this[2]=n*a+s*o,this[3]=s*a-n*o,this}toAxisZ(t){const{x:e,y:i,z:r,w:n}=this,s=e+e,o=i+i,a=e*s,h=i*o,c=r*s,u=r*o,l=n*s,m=n*o;return t.x=c+m,t.y=u-l,t.z=1-a-h,t}face(t="+X+Y+Z"){const[e,i,r,n]=m[t];return this.x=e,this.y=i,this.z=r,this.w=n,this}}const u=Math.sqrt(2)/2,l=.5,m={"+X+Y+Z":[0,0,0,1],"-Z+Y+X":[0,+u,0,+u],"-X+Y-Z":[0,1,0,0],"+Z+Y-X":[0,-u,0,+u],"+X+Z-Y":[+u,0,0,+u],"+Y+Z+X":[+l,+l,+l,+l],"-X+Z+Y":[0,+u,+u,0],"-Y+Z-X":[+l,-l,-l,+l],"+X-Y-Z":[1,0,0,0],"+X-Z+Y":[-u,0,0,+u],"-X-Y+Z":[0,0,1,0],"-X-Z-Y":[0,+u,-u,0],"+Y+X-Z":[+u,+u,0,0],"+Y-X+Z":[0,0,+u,+u],"+Y-Z-X":[+l,+l,-l,-l],"-Y+X+Z":[0,0,-u,+u],"-Y-X-Z":[+u,-u,0,0],"-Y-Z+X":[+l,-l,+l,-l],"+Z+X+Y":[+l,+l,+l,-l],"+Z-X-Y":[+l,-l,+l,+l],"+Z-Y+X":[+u,0,+u,0],"-Z+X-Y":[+l,+l,-l,+l],"-Z-X+Y":[+l,-l,-l,-l],"-Z-Y-X":[+u,0,-u,0]};class d{_matrix=new a(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);_position=new o(0,0,0);_orientation=new c(0,0,0,1);_scale=new o(1,1,1);dirty=!1;_updateCount=0;get updateCount(){return this._updateCount}get matrix(){if(this.dirty){const t=this._matrix;t.m03=0,t.m13=0,t.m23=0,t.m33=1;const[e,i,r]=this._position;t.m30=e,t.m31=i,t.m32=r,t.fromQuat(this._orientation);const[n,s,o]=this._scale;t.m00*=n,t.m01*=n,t.m03*=n,t.m10*=s,t.m11*=s,t.m13*=s,t.m20*=o,t.m21*=o,t.m23*=o,this.dirty=!1}return this._matrix}set matrix(t){this._matrix.from(t),this._updateCount++,this.dirty=!1}get position(){return this._position}set position(t){this.setDirty(),this._position.from(t)}setPosition(t,e,i){return this.setDirty(),this._position.reset(t,e,i),this}get scale(){return this._scale}set scale(t){this.setDirty(),this._scale.from(t)}setScale(t,e,i){return this.setDirty(),this._scale.reset(t,e,i),this}get orientation(){return this._orientation}set orientation(t){this.setDirty(),this._orientation.from(t)}setOrientation(t,e,i,r){this.setDirty(),this._orientation.reset(t,e,i,r)}setDirty(){this._updateCount++,this.dirty=!0}}class f extends Float32Array{static fromMix(t,e,i=.5){const r=1-i,n=r*t.x+i*e.x,s=r*t.y+i*e.y;return new f(n,s)}static distance(t,e){const i=e.x-t.x,r=e.y-t.y;return Math.sqrt(i*i+r*r)}constructor(t=0,e=0){if(super(2),"number"!=typeof t)return this.x=t[0],void(this.y=t[1]);this.x=t,this.y=e}clone(){return new f(this)}isEqual(t){const[e,i]=t;return e===this.x&&i===this.y}isClose(t,e=1e-6){const[i,r]=t;return!(Math.abs(i-this.x)>e||Math.abs(r-this.y)>e)}from(t){const[e,i]=t;return this.x=e,this.y=i,this}fromMix(t,e,i){const[r,n]=t,[o,a]=e;return this.reset(s(r,o,i),s(n,a,i))}reset(t,e){return this[0]=t,this[1]=e,this}get x(){return this[0]}set x(t){this[0]=t}get y(){return this[1]}set y(t){this[1]=t}add(...t){for(const e of t)this[0]+=e.x,this[1]+=e.y;return this}addWithScale(t,e){return this[0]+=t.x*e,this[1]+=t.y*e,this}subtract(t){return this[0]-=t[0],this[1]-=t[1],this}scale(t){return this[0]*=t,this[1]*=t,this}dot(t){return this[0]*t[0]+this[1]*t[1]}get size(){return Math.sqrt(this[0]*this[0]+this[1]*this[1])}normalize(){const t=this[0]*this[0]+this[1]*this[1];return 0===t?this:this.scale(1/Math.sqrt(t))}random(){return this[0]=Math.random()-.5,this[1]=Math.random()-.5,this}debug(t="vec2"){const{x:e,y:i}=this,r=[e,i].map((t=>t.toFixed(6)));console.log(`${t}:   `,r.join(" | "),"   length:",Math.sqrt(e*e+i*i))}}class g{listeners=new Set;addListener(t){this.listeners.add(t)}removeListener(t){this.listeners.delete(t)}dispatch(t){this.listeners.forEach((e=>e(t)))}}class p{static incrementalId=1;eventTransformChange=new g;name;_screenWidth=1920;_screenHeight=1080;_screenAspectRatio=1920/1080;_dirtyModelView=!0;dirtyModelViewInverse=!0;_dirtyAxis=!0;_dirtyProjection=!0;dirtyProjectionInverse=!0;_near=.001;_far=1/0;_axisX=new o;_axisY=new o;_axisZ=new o;_matrixModelView=new a;_matrixModelViewInverse=new a;_matrixProjectionInverse=new a;_orientation=new c(0,0,0,1);_shift=new o(0,0,0);_target=new o(0,0,0);_position=new o(0,0,0);_distance=10;_zoom=1;tmpMat3=new n;tmpVec3=new o;constructor(t={}){this.name=t.name??"TgdCamera#"+p.incrementalId++,this._near=t.near??.001,this._far=t.far??1e6,this._distance=t.distance??10,this._zoom=t.zoom??1;const[e,i,r]=t.target??[0,0,0];this.target.reset(e,i,r);const[n,s,o,a]=t.orientation??[0,0,0,1];this.orientation.reset(n,s,o,a)}get near(){return this._near}set near(t){t!==this._near&&(this._near=t,this.dirtyProjection=!0)}get far(){return this._far}set far(t){t!==this._far&&(this._far=t,this.dirtyProjection=!0)}get screenAspectRatio(){return this._screenAspectRatio}get screenWidth(){return this._screenWidth}set screenWidth(t){t!==this._screenWidth&&(this._screenWidth=t,this.dirtyProjection=!0,this._screenAspectRatio=this._screenWidth/this._screenHeight)}get screenHeight(){return this._screenHeight}set screenHeight(t){t!==this._screenHeight&&(this._screenHeight=t,this.dirtyProjection=!0,this._screenAspectRatio=this._screenWidth/this._screenHeight)}get spaceHeightAtTarget(){return this.getSpaceHeightAtTarget()}set spaceHeightAtTarget(t){this.setSpaceHeightAtTarget(t)}get spaceWidthAtTarget(){return this.screenWidth*this.spaceHeightAtTarget/this.screenHeight}set spaceWidthAtTarget(t){this.setSpaceHeightAtTarget(t*this.screenHeight/this.screenWidth)}face(t){this._orientation.face(t),this.dirtyModelView=!0,this.dirtyAxis=!0}from(t){const{_orientation:e,_target:i,distance:r,zoom:n,screenWidth:s,screenHeight:o}=t;return this._orientation.from(e),this._target.from(i),this.distance=r,this.zoom=n,this.screenWidth=s,this.screenHeight=o,this.dirtyModelView=!0,this.dirtyAxis=!0,this.copyProjectionFrom(t),this}get axisX(){return this.updateAxisIfNeeded(),this._axisX}get axisY(){return this.updateAxisIfNeeded(),this._axisY}get axisZ(){return this.updateAxisIfNeeded(),this._axisZ}get matrixModelView(){return this.updateIfNeeded(),this._matrixModelView}get matrixModelViewInverse(){return this.dirtyModelViewInverse&&(this._matrixModelViewInverse.invert(this.matrixModelView),this.dirtyModelViewInverse=!1),this._matrixModelViewInverse}get matrixProjectionInverse(){return this.dirtyProjectionInverse&&(this._matrixProjectionInverse.invert(this.matrixProjection),this.dirtyProjectionInverse=!1),this._matrixProjectionInverse}get orientation(){return this._orientation}set orientation(t){const{_orientation:e}=this;if(t.isEqual(e))return;const[i,r,n,s]=t;e.x=i,e.y=r,e.z=n,e.w=s,this.dirtyModelView=!0,this.dirtyAxis=!0}setOrientation(t,e,i,r){const{_orientation:n}=this;return n.x=t,n.y=e,n.z=i,n.w=r,this.dirtyModelView=!0,this.dirtyAxis=!0,this}get position(){return this.updateIfNeeded(),this._position}get target(){return this._target}set target(t){this._target.from(t),this.dirtyModelView=!0}setTarget(t,e,i){const{_target:r}=this;return r.x=t,r.y=e,r.z=i,this.dirtyModelView=!0,this}get shift(){return this._shift}set shift(t){this._shift.from(t),this.dirtyModelView=!0}setShift(t,e,i){const{_shift:r}=this;return r.x=t,r.y=e,r.z=i,this.dirtyModelView=!0,this}get x(){return this._target.x}set x(t){const{_target:e}=this;t!==e.x&&(e.x=t,this.dirtyModelView=!0)}get y(){return this._target.y}set y(t){const{_target:e}=this;t!==e.y&&(e.y=t,this.dirtyModelView=!0)}get z(){return this._target.z}set z(t){const{_target:e}=this;t!==e.z&&(e.z=t,this.dirtyModelView=!0)}get distance(){return this._distance}set distance(t){this._distance!==t&&(this._distance=t,this.dirtyModelView=!0)}get zoom(){return this._zoom}set zoom(t){this._zoom!==t&&(this._zoom=t,this.dirtyModelView=!0)}moveTarget(t,e,i){const{_target:r}=this;this.updateAxisIfNeeded();const{_axisX:n,_axisY:s,_axisZ:o,tmpVec3:a}=this;a.from(n).scale(t).addWithScale(s,e).addWithScale(o,i),r.x+=a.x,r.y+=a.y,r.z+=a.z,this.dirtyModelView=!0}moveShift(t,e,i){const[r,n,s]=this._shift;this._shift.reset(t+r,e+n,i+s),this._dirtyModelView=!0}orbitAroundX(t){this.updateAxisIfNeeded();const{_axisX:e,_axisY:i,_axisZ:r,_orientation:n}=this;return i.rotateAround(e,t),r.rotateAround(e,t),n.fromAxis(e,i,r),this.dirtyModelView=!0,this}orbitAroundY(t){this.updateAxisIfNeeded();const{_axisX:e,_axisY:i,_axisZ:r,_orientation:n}=this;return e.rotateAround(i,t),r.rotateAround(i,t),n.fromAxis(e,i,r),this.dirtyModelView=!0,this}orbitAroundZ(t){this.updateAxisIfNeeded();const{_axisX:e,_axisY:i,_axisZ:r,_orientation:n}=this;return e.rotateAround(r,t),i.rotateAround(r,t),n.fromAxis(e,i,r),this.dirtyModelView=!0,this}debug(t){this._orientation.debug(`${t??this.name} quaternion:`)}updateAxisIfNeeded(){this.dirtyAxis&&this.updateAxis()}updateAxis(){const{tmpMat3:t}=this;t.fromQuat(this._orientation),t.toAxis(this._axisX,this._axisY,this._axisZ),this.dirtyAxis=!1}updateIfNeeded(){if(!this.dirtyModelView)return;const{tmpMat3:t,tmpVec3:e,_position:i}=this,r=this._matrixModelView;this.updateAxis();const n=this._distance,{x:s,y:o,z:a}=this._shift,{x:h,y:c,z:u}=this._target,{x:l,y:m,z:d}=this._axisZ;i.x=h+n*l,i.y=c+n*m,i.z=u+n*d,i.addWithScale(this._axisX,s),i.addWithScale(this._axisY,o),i.addWithScale(this._axisZ,a),e.from(i).applyMatrix(t.transpose()).scale(-1),r.m30=e.x,r.m31=e.y,r.m32=e.z,r.fromMat3(t),this.dirtyModelView=!1}get dirtyModelView(){return this._dirtyModelView}set dirtyModelView(t){this._dirtyModelView=t,t&&(this.dirtyModelViewInverse=!0,this.eventTransformChange.dispatch(this))}get dirtyAxis(){return this._dirtyAxis}set dirtyAxis(t){this._dirtyAxis=t}get dirtyProjection(){return this._dirtyProjection}set dirtyProjection(t){this._dirtyProjection=t,t&&(this.dirtyProjectionInverse=!0)}}class x extends p{_matrixProjection=new a;_spaceHeight=10;_ray={origin:new o,direction:new o};constructor(t={}){super(t),this.spaceHeight=t.spaceHeight??10}copyProjectionFrom(t){return this.spaceHeight=t.spaceHeight,this}castRay(t,e){const{origin:i,direction:r}=this._ray;r.from(this.axisZ);const n=.5*this.spaceHeight,s=n*this.screenAspectRatio;return i.from(this.position).addWithScale(this.axisX,s*t).addWithScale(this.axisY,n*e),this._ray}get spaceHeight(){return this._spaceHeight}set spaceHeight(t){t!==this._spaceHeight&&(this._spaceHeight=t,this.dirtyProjection=!0)}get near(){return this._near}set near(t){t!==this._near&&(this._near=t,this.dirtyProjection=!0)}get far(){return this._far}set far(t){t!==this._far&&(this._far=t,this.dirtyProjection=!0)}get matrixProjection(){return this.updateProjectionIfNeeded(),this._matrixProjection}getSpaceHeightAtTarget(){return this.spaceHeight}setSpaceHeightAtTarget(t){this.spaceHeight=t}updateProjectionIfNeeded(){if(!this.dirtyProjection)return;const{near:t,far:e,screenAspectRatio:i,_spaceHeight:r,zoom:n}=this,s=r/(n+n),o=-s,a=s*i,h=-a,c=this._matrixProjection,u=1/(h-a),l=1/(o-s),m=1/(t-e);c[0]=-2*u,c[1]=0,c[2]=0,c[3]=0,c[4]=0,c[5]=-2*l,c[6]=0,c[7]=0,c[8]=0,c[9]=0,c[10]=m,c[11]=0,c[12]=(h+a)*u,c[13]=(s+o)*l,c[14]=t*m,c[15]=1,this.dirtyProjection=!0}}class v extends p{_matrixProjection=new a;_fovy=Math.PI/4;_ray={origin:new o,direction:new o};constructor(t={}){super(t),this._fovy=t.fovy??Math.PI/4}copyProjectionFrom(t){return this.fovy=t.fovy,this.near=t.near,this.far=t.far,this}castRay(t,e){const{origin:i,direction:r}=this._ray;i.from(this.position);const n=Math.atan(this.fovy),s=n*this.screenAspectRatio;return r.from(i).subtract(this.axisZ).addWithScale(this.axisX,s*t).addWithScale(this.axisY,n*e).subtract(i).normalize(),this._ray}get fovy(){return this._fovy}set fovy(t){t!==this._fovy&&(this._fovy=t,this.dirtyProjection=!0)}get matrixProjection(){return this.updateProjectionIfNeeded(),this._matrixProjection}getSpaceHeightAtTarget(){return 2*Math.tan(.5*this.fovy)*this.distance}setSpaceHeightAtTarget(t){this.distance=t/(2*Math.tan(.5*this.fovy))}updateProjectionIfNeeded(){if(!this.dirtyProjection)return;const t=this._fovy,e=this.screenAspectRatio,i=this._near,r=this._far,n=this._matrixProjection,s=this.zoom/Math.tan(t/2);if(n[0]=s/e,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=s,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[11]=-1,n[12]=0,n[13]=0,n[15]=0,r!==1/0){const t=1/(i-r);n[10]=(r+i)*t,n[14]=2*r*i*t}else n[10]=-1,n[14]=-2*i;this.dirtyProjection=!0}}class y{gl;buffer;_target;_usage;constructor(t,e,i){this.gl=t;const r=t.createBuffer();if(!r)throw Error("Unable to create WebGLBuffer!");this._target=i?.target??"ARRAY_BUFFER",this._usage=i?.usage??"STATIC_DRAW",this.buffer=r,e&&this.bufferData(e,i)}get target(){return this._target}bind(t){const{gl:e,buffer:i}=this;this._target=t??this._target,e.bindBuffer(e[this._target],i)}bufferData(t,e={}){const{gl:i}=this;this.bind(e.target),this._usage=e.usage??this._usage,i.bufferData(i[this._target],t,i[this._usage])}delete(){const{gl:t,buffer:e}=this;t.deleteBuffer(e)}}class w{eventKeyPress=new g;keysDown=new Set;keysUp=new Set;attached=!1;constructor(){document.addEventListener("keydown",this.handleKeyDown),document.addEventListener("keyup",this.handleKeyUp),this.attached=!0}detach(){this.attached&&(document.removeEventListener("keydown",this.handleKeyDown),document.removeEventListener("keyup",this.handleKeyUp),this.attached=!1)}isUp(...t){return!this.isDown(...t)}isDown(...t){for(const e of t)if(!this.keysDown.has(e))return!1;return!0}hasClicked(t){return!!this.keysUp.has(t)&&(this.keysUp.delete(t),!0)}handleKeyDown=t=>{this.keysDown.add(t.key),this.keysUp.delete(t.key)};handleKeyUp=t=>{this.keysDown.delete(t.key),this.keysUp.add(t.key),this.eventKeyPress.dispatch(t)}}class b{canvas;eventTap=new g;eventMoveStart=new g;eventMove=new g;eventMoveEnd=new g;eventZoom=new g;tapDelay=300;controlKeys={altKey:!1,ctrlKey:!1,metaKey:!1,shiftKey:!1};start={x:0,y:0,t:0,fingersCount:1};current={x:0,y:0,t:0,fingersCount:1};previous={x:0,y:0,t:0,fingersCount:1};pointerEvent=null;constructor(t){this.canvas=t,t.addEventListener("pointerdown",this.handlePointerDown,!0),t.addEventListener("wheel",this.handleCanvasWheel),t.addEventListener("contextmenu",this.handleContextMenu),t.addEventListener("pointermove",this.handlePointerMove),t.addEventListener("pointerup",this.handlePointerUp)}detach(){const{canvas:t}=this;t&&(t.removeEventListener("pointerdown",this.handlePointerDown),t.removeEventListener("wheel",this.handleCanvasWheel),t.removeEventListener("contextmenu",this.handleContextMenu),t.removeEventListener("pointermove",this.handlePointerMove),t.removeEventListener("pointerup",this.handlePointerUp))}handleContextMenu=t=>{t.preventDefault()};handleCanvasWheel=t=>{let e=t.deltaX+t.deltaY+t.deltaZ;e=e>0?1:-1,this.eventZoom.dispatch({current:this.getPoint(t),direction:e,preventDefault:()=>t.preventDefault(),...this.controlKeys})};handlePointerDown=t=>{if(!t.isPrimary)return;this.canvas.setPointerCapture(t.pointerId),t.preventDefault(),t.stopPropagation(),this.pointerEvent=t;const e=this.getPoint(t);this.start=this.current=this.previous=e,this.eventMoveStart.dispatch({start:e,current:e,previous:e,...this.controlKeys})};handlePointerMove=t=>{t.isPrimary&&this.pointerEvent&&this.canvas&&(this.previous=this.current,this.current=this.getPoint(t),this.eventMove.dispatch({start:this.start,current:this.current,previous:this.previous,...this.controlKeys}))};handlePointerUp=t=>{t.isPrimary&&this.pointerEvent&&(t.preventDefault(),this.current=this.getPoint(t),this.eventMoveEnd.dispatch({start:this.start,current:this.current,previous:this.previous,...this.controlKeys}),this.pointerEvent=null,t.timeStamp-this.start.t<this.tapDelay&&this.eventTap.dispatch({...this.start,...this.controlKeys}))};getPoint(t){this.controlKeys={altKey:t.altKey||2===t.buttons,ctrlKey:t.ctrlKey,metaKey:t.metaKey,shiftKey:t.shiftKey};const{left:e,top:i,width:r,height:n}=this.canvas.getBoundingClientRect();return{x:2*((t.clientX-e)/r-.5),y:-2*((t.clientY-i)/n-.5),t:t.timeStamp,fingersCount:1}}}class _{canvas;_keyboard=null;_pointer=null;constructor(t){this.canvas=t}get keyboard(){return this._keyboard||(this._keyboard=new w),this._keyboard}get pointer(){return this._pointer||(this._pointer=new b(this.canvas)),this._pointer}}let A=1;class E{keys=new Map;objects=new Map;references=new Map;create(t,e){const i=e??this.makeKeyFromInput(t)??"TgdResource:"+A++,r=this.references.get(i)??0;if(r<1){const e=this.actualCreate(t,i);return this.keys.set(e,i),this.objects.set(i,e),this.references.set(i,1),e}const n=this.objects.get(i);if(!n)throw Error("[TgdResource.create] Panic!");return this.references.set(i,r+1),n}delete(t){const e=this.keys.get(t);if(!e)return;const i=this.references.get(e)??0;i<1||(i>1?this.references.set(e,i-1):(this.keys.delete(t),this.objects.delete(e),this.references.delete(e),this.actualDelete(t)))}makeKeyFromInput(t){return null}}class T{gl;code;program;shaders;uniformsLocations;constructor(t,e){this.gl=t,this.code=e;const i=t.createProgram();if(!i)throw Error("Unable to create WebGLProgram!");const r=this.createShader("VERTEX_SHADER",e.vert);t.attachShader(i,r);const n=this.createShader("FRAGMENT_SHADER",e.frag);if(t.attachShader(i,n),t.linkProgram(i),!t.getProgramParameter(i,t.LINK_STATUS)){const r=t.getProgramInfoLog(i)??"";console.warn(r);const n=P(r);throw R("Vertex Shader",e.vert,n),R("Fragment Shader",e.frag,n),new Error("Could NOT link WebGL2 program!\n"+r)}this.program=i,this.shaders=[r,n],this.uniformsLocations=this.getUniformsLocations(),t.detachShader(i,r),t.deleteShader(r),t.detachShader(i,n),t.deleteShader(n)}toCode({indent:t=""}={}){return["function createProgram(gl: WebGL2RenderingContext) {","  const prg = gl.createProgram()","  const vertexShader = gl.createShader(gl.VERTEX_SHADER)",`  gl.shaderSource(vertexShader, \`${this.code.vert}\`)`,"  gl.compileShader(vertexShader)","  const fragmentShader = gl.createShader(gl.FRAGMENT_SHADER)",`  gl.shaderSource(fragmentShader, \`${this.code.frag}\`)`,"  gl.compileShader(fragmentShader)","  gl.attachShader(prg, vertexShader)","  gl.attachShader(prg, fragmentShader)","  gl.linkProgram(prg)","  return prg","}"].map((e=>`${t}${e}`)).join("\n")}hasAttribute(t){const{gl:e,program:i}=this;return e.getAttribLocation(i,t)>=0}getAttribLocation(t){const{gl:e,program:i}=this,r=e.getAttribLocation(i,t);if(r<0)throw Error(`Attribute "${t}" not found!`);return r}getUniformLocation(t){const{uniformsLocations:e}=this,i=Object.keys(e);if(0===t.length)return console.warn(`Uniform "${t}" has not been found: there is no active uniform in this program!`),0;const r=e[t];return r||console.warn(`No active uniform found with name "${t}"!\nAvailable names are: ${i.join(", ")}.`),r}uniform1f(t,e){const{gl:i}=this;i.uniform1f(this.getUniformLocation(t),e)}uniform2f(t,e,i){const{gl:r}=this;r.uniform2f(this.getUniformLocation(t),e,i)}uniform3f(t,e,i,r){const{gl:n}=this;n.uniform3f(this.getUniformLocation(t),e,i,r)}uniform3fv(t,e){const{gl:i}=this;i.uniform3fv(this.getUniformLocation(t),e)}uniform4f(t,e,i,r,n){const{gl:s}=this;s.uniform4f(this.getUniformLocation(t),e,i,r,n)}uniform4fv(t,e){const{gl:i}=this;i.uniform4fv(this.getUniformLocation(t),e)}uniform1i(t,e){const{gl:i}=this;i.uniform1i(this.getUniformLocation(t),e)}uniform2i(t,e,i){const{gl:r}=this;r.uniform2i(this.getUniformLocation(t),e,i)}uniform3i(t,e,i,r){const{gl:n}=this;n.uniform3i(this.getUniformLocation(t),e,i,r)}uniform4i(t,e,i,r,n){const{gl:s}=this;s.uniform4i(this.getUniformLocation(t),e,i,r,n)}uniform1ui(t,e){const{gl:i}=this;i.uniform1ui(this.getUniformLocation(t),e)}uniform2ui(t,e,i){const{gl:r}=this;r.uniform2ui(this.getUniformLocation(t),e,i)}uniform3ui(t,e,i,r){const{gl:n}=this;n.uniform3ui(this.getUniformLocation(t),e,i,r)}uniform4ui(t,e,i,r,n){const{gl:s}=this;s.uniform4ui(this.getUniformLocation(t),e,i,r,n)}uniformMatrix4fv(t,e){const{gl:i}=this;i.uniformMatrix4fv(this.getUniformLocation(t),!1,e)}use(){const{gl:t,program:e}=this;t.useProgram(e)}delete(){const{gl:t}=this;this.shaders.forEach((e=>t.deleteShader(e))),t.deleteProgram(this.program)}createShader(t,e){const{gl:i}=this,r=i.createShader(i[t]);if(!r)throw Error(`Unable to create a WebGLShader of type "${t}"!`);i.shaderSource(r,e),i.compileShader(r);const n=i.getShaderInfoLog(r);if(n)throw console.error(`Error in ${t} code:`,n),R(t,e,P(n)),Error(`Unable to compile ${t}!`);return r}getUniformsLocations(){const{gl:t,program:e}=this,i=t.getProgramParameter(e,t.ACTIVE_UNIFORMS);if("number"!=typeof i)throw Error("Unable to get the number of uniforms in a WebGLProgram!");const r={};for(let n=0;n<i;n++){const i=t.getActiveUniform(e,n);if(!i)continue;const s=t.getUniformLocation(e,i.name);if(null===s)throw Error(`Unable to get location for uniform "${i.name}"!`);r[i.name]=s}return r}}const M=/^ERROR:[ \t]+([0-9]+):([0-9]+):/g;function P(t){const e=[],i=[];for(const r of t.split("\n")){M.lastIndex=-1;const t=M.exec(r);t&&(e.push(parseInt(t[2],10)),i.push(r.substring(t[0].length).trim()))}return{lines:e,messages:i}}function S(t,e=!1){return`color:#fff;background:${t};font-family:monospace;font-size:80%;font-weight:${e?"bolder":"100"}`}function R(t,e,i){console.log(`%c${t}`,"font-weight:bolder;font-size:120%"),e.split("\n").forEach(((t,e)=>{const r=e+1,n=(1e-4*r).toFixed(4).substring(2),s=i.lines.includes(r)?"#f00":"#000";console.log(`%c${n}  %c${t}`,S(s),S(s,!0)),i.lines.includes(r)&&console.error(i.messages[i.lines.indexOf(r)])}))}class C extends E{gl;constructor(t){super(),this.gl=t}actualCreate(t){return new T(this.gl,t)}actualDelete(t){t instanceof T&&t.delete()}makeKeyFromInput(t){return JSON.stringify(t)}}class I{static async image(t){return new Promise((e=>{const i=new Image;i.onload=()=>e(i),i.onerror=()=>{console.error("Unable to load image: ",t),e(null)},i.src=t}))}static async canvas(t){const e=await I.image(t);if(!e)return null;const i=document.createElement("canvas");i.width=e.naturalWidth,i.height=e.naturalHeight;const r=i.getContext("2d");if(!r)throw Error("Unable to get a 2D context!");return r.drawImage(e,0,0),i}}function U(t,e){const i=t.spaceHeightAtTarget,r=t.distance,n=t.zoom,a=new c(t.orientation),h=new o(t.target),u=new o(t.shift),l=e.spaceHeightAtTarget??i,m=e.distance??r,d=e.zoom??n,f=new c(e.orientation??a),g=new o(e.target??h),p=new o(e.shift??u),x=new c,v=new o,y=new o;return e=>{t.spaceHeightAtTarget=s(i,l,e),t.distance=s(r,m,e),t.zoom=s(n,d,e),t.orientation=x.fromSlerp(a,f,e).normalize(),t.target=v.fromMix(h,g,e),t.shift=y.fromMix(u,p,e)}}function L(t,e,i){const r=document.createElement("canvas");r.width=t,r.height=e;const n=r.getContext("2d",i);if(!n)throw Error("Unable to create 2D context!");return{canvas:r,ctx:n}}function V(t){return 1-(1-t)*(1-t)}function F(t){return 1+2.70158*Math.pow(t-1,3)+1.70158*Math.pow(t-1,2)}async function N(t){return(await fetch(t)).arrayBuffer()}class z{context;id;glTexture;eventImageUpdate=new g;options;_width=0;_height=0;_image=null;constructor(t,e,i={}){this.context=t,this.id=e;const{gl:r}=t;this.options={wrapS:"REPEAT",wrapT:"REPEAT",wrapR:"REPEAT",minFilter:"NEAREST_MIPMAP_LINEAR",magFilter:"LINEAR",width:1,height:1,internalFormat:"RGBA",...i};const n=r.createTexture();if(!n)throw Error("Unable to create a WebGLTexture!");this.glTexture=n;const{wrapS:s="CLAMP_TO_EDGE",wrapT:o="CLAMP_TO_EDGE",wrapR:a="CLAMP_TO_EDGE",minFilter:h="LINEAR",magFilter:c="LINEAR",generateMipMap:u=!1,width:l=1,height:m=1,internalFormat:d="RGBA",data:f}=this.options;this._width=l,this._height=m;const g=this.options.format??d;r.bindTexture(r.TEXTURE_2D,n),r.texImage2D(r.TEXTURE_2D,0,r[d],l,m,0,r[g],r.UNSIGNED_BYTE,f??null),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r[s]),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r[o]),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_R,r[a]),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r[h]),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r[c]),i.image?this.loadImage(i.image):u&&r.generateMipmap(r.TEXTURE_2D)}getParameter(t){const{context:e,glTexture:i}=this,{gl:r}=e;return r.bindTexture(r.TEXTURE_2D,i),r.getTexParameter(r.TEXTURE_2D,r[t])}makePalette(t,e=0){const i=e>0?e:t.length,r=Math.ceil(t.length/i),{canvas:n,ctx:s}=L(i,r);let o=0;for(let e=0;e<r;e++)for(let r=0;r<i;r++)s.fillStyle=t[o++],s.fillRect(r,e,1,1);this.loadImage(n)}fillHorizontalGradient(t,...e){this.fillGradient(t,1,1,0,...e)}fillverticalGradient(t,...e){this.fillGradient(1,t,0,1,...e)}fillGradient(t,e,i,r,...n){const{canvas:s,ctx:o}=L(t,e),a=o.createLinearGradient(0,0,t*i,e*r);for(let t=0;t<n.length;t++)a.addColorStop(t/(n.length-1),n[t]);o.fillStyle=a,o.fillRect(0,0,t,e),this.loadImage(s),s.style.position="fixed"}delete(){this.context.gl.deleteTexture(this.glTexture)}get image(){return this._image}get width(){return this._width}get height(){return this._height}bind(){const{gl:t}=this.context;t.bindTexture(t.TEXTURE_2D,this.glTexture)}activate(t,e,i=0){const{context:r,glTexture:n}=this,{gl:s}=r;s.activeTexture(s.TEXTURE0+i),s.bindTexture(s.TEXTURE_2D,n),t.uniform1i(e,i)}loadImage(t){if("string"==typeof t)return void I.image(t).then((e=>{e?(this.loadImage(e),this.context.paint()):console.error("[TgdTexture2D] Unable to load image:",t)})).catch(console.error);const{context:e,glTexture:i}=this,{gl:r}=e;r.bindTexture(r.TEXTURE_2D,i),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,!0),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,t),r.generateMipmap(r.TEXTURE_2D),this._width=t.width,this._height=t.height,this._image=t,this.eventImageUpdate.dispatch(this)}}class D{context;texture;_width=0;_height=0;numberOfImagesToLoad=6;constructor(t,e){this.context=t;const{gl:i}=t,r=i.createTexture();if(!r)throw Error("Unable to create a WebGLTexture!");this.texture=r,this.loadImage(i.TEXTURE_CUBE_MAP_POSITIVE_X,e.imagePosX),this.loadImage(i.TEXTURE_CUBE_MAP_NEGATIVE_X,e.imageNegX),this.loadImage(i.TEXTURE_CUBE_MAP_POSITIVE_Y,e.imagePosY),this.loadImage(i.TEXTURE_CUBE_MAP_NEGATIVE_Y,e.imageNegY),this.loadImage(i.TEXTURE_CUBE_MAP_POSITIVE_Z,e.imagePosZ),this.loadImage(i.TEXTURE_CUBE_MAP_NEGATIVE_Z,e.imageNegZ)}delete(){this.context.gl.deleteTexture(this.texture)}get ready(){return 0===this.numberOfImagesToLoad}get width(){return this._width}get height(){return this._height}bind(){const{gl:t}=this.context;t.bindTexture(t.TEXTURE_CUBE_MAP,this.texture)}activate(t,e,i=0){if(!this.ready)return;const{context:r,texture:n}=this,{gl:s}=r;s.activeTexture(s.TEXTURE0+i),s.bindTexture(s.TEXTURE_CUBE_MAP,n),t.uniform1i(e,i)}loadImage(t,e){if("string"==typeof e)return void I.image(e).then((i=>{i?this.loadImage(t,i):console.error(`[TgdTextureCube] Unable to load image "${e}":`,e)})).catch((t=>{console.error(`[TgdTextureCube] Unable to load image "${e}":`,t)}));const{width:i,height:r}=e;if(i!==r)throw Error(`Images in a CubeMap must be squares, but we got ${i}×${r}!`);if(0===this._width)this._width=i,this._height=r;else if(this._width!==i||this._height!==r)throw Error(`Images in a CubeMap must all have the same size, but we got ${this._width}×${this._height} and ${i}×${r}!`);const{context:n,texture:s}=this,{gl:o}=n;o.bindTexture(o.TEXTURE_CUBE_MAP,s),o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,e instanceof Image),o.texImage2D(t,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,e),this.numberOfImagesToLoad--,0===this.numberOfImagesToLoad&&(o.generateMipmap(o.TEXTURE_CUBE_MAP),o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_MIN_FILTER,o.LINEAR_MIPMAP_LINEAR),n.paint())}}class O extends E{context;constructor(t){super(),this.context=t}getDefaultEmpty(){return this.create({width:1,height:1},"@tgd/DefaultTexture2D")}actualCreate(t,e){return new z(this.context,e,t)}actualDelete(t){t instanceof z&&t.delete()}}class $ extends E{context;constructor(t){super(),this.context=t}actualCreate(t){return new D(this.context,t)}actualDelete(t){t instanceof D&&t.delete()}}class B{gl;datasets;vao;drawBuffers=[];elemBuffer=null;constructor(t,e,i,r){this.gl=t,this.datasets=i;const n=t.createVertexArray();if(!n)throw Error("Unable to create VertexArrayObject!");if(this.vao=n,e&&i){if(t.bindVertexArray(n),this.drawBuffers=i.map((i=>{const r=new y(t,i.data,{target:i.target,usage:i.usage});return r.bind(),i.defineAttributes(t,e),r})),r){const e=new y(t,r,{target:"ELEMENT_ARRAY_BUFFER"});e.bind(),this.elemBuffer=e}t.bindVertexArray(null)}}toCode({indent:t=""}={}){const e=["function createVAO(","  gl: WebGL2RenderingContext,",`  prg: WebGLProgram${this.datasets?.map(((t,e)=>`, data${e}: ArrayBuffer`)).join("")}`,") {","  const vao = gl.createVertexArray()","  gl.bindVertexArray(vao)"];return this.datasets?.forEach(((i,r)=>{e.push(`  const buff${r} = gl.createBuffer()`,`  gl.bindBuffer(gl.${i.target}, buff${r})`,`  gl.bufferData(gl.${i.target}, data${r}, gl.${i.usage})`,i.toCode({indent:`${t}  `}))})),e.push("  return vao","}"),e.map((e=>`${t}${e}`)).join("\n")}bind(){this.gl.bindVertexArray(this.vao)}unbind(){this.gl.bindVertexArray(null)}delete(){const{gl:t,vao:e,drawBuffers:i,elemBuffer:r}=this;t.deleteVertexArray(e),i.forEach((t=>t.delete())),r&&r.delete()}}class X{active=!0}class j extends X{active=!0;onEnter;onExit;painters;constructor(t=[],{onEnter:e,onExit:i}={}){super(),this.onEnter=e,this.onExit=i,this.painters=[...t]}forEachChild(t){this.painters.forEach(((e,i)=>t(e,i)))}has(t){return this.painters.includes(t)}add(...t){for(const e of t)this.painters.push(e)}remove(...t){for(const e of t){const t=this.painters.indexOf(e);t<0||(this.painters.splice(t,1),e.delete())}}removeAll(){for(const t of this.painters)t.delete();this.painters.splice(0,this.painters.length)}delete(){for(const t of this.painters)t.delete();this.painters.splice(0,this.painters.length)}paint(t,e){if(this.active){this.onEnter?.(t,e);for(const i of this.painters)i.active&&i.paint(t,e);this.onExit?.(t,e)}}}class Z{animations=new Map;schedule(t){const{action:e,duration:i,easingFunction:r,repeat:n}=t;return this.animations.set(t,{start:-1,duration:i,inverseDuration:1/i,action:r?t=>e(r(t)):e,loop:1,repeat:n??1,cancel:()=>this.cancel(t)}),t}cancel(t){this.animations.delete(t)}paint(t){if(0===this.animations.size)return!1;for(const e of this.animations.values()){e.start<0&&(e.start=t);const i=Math.min(1,e.inverseDuration*(t-e.start));e.action(i),t>e.start+e.duration&&e.loop++,e.loop>e.repeat&&e.cancel()}return!0}}class k{canvas;options;static incrementalId=1;name;gl;inputs;programs;textures2D;_texturesCube=null;_camera;observer;painters;isPlaying=!1;requestAnimationFrame=-1;lastTime=-1;animationManager=new Z;constructor(t,e={}){this.canvas=t,this.options=e;const i=t.getContext("webgl2",e);if(!i)throw Error("Unable to create a WebGL2 context!");this.gl=i,this.programs=new C(i),this.textures2D=new O(this),this.observer=new ResizeObserver((()=>{const r=t.clientWidth,n=t.clientHeight;t.width=r,t.height=n,i.viewport(0,0,r,n),this.paint(),e.onResize?.(this,t.clientWidth,t.clientHeight)})),this.observer.observe(t),this.inputs=new _(t),this._camera=new v,this.painters=new j,this.name=e.name??"TgdContext#"+k.incrementalId++,t.style.touchAction="none"}get camera(){return this._camera}set camera(t){t!==this._camera&&(this._camera.eventTransformChange.removeListener(this.paint),t.eventTransformChange.addListener(this.paint),this._camera=t,this.paint())}get texturesCube(){return this._texturesCube||(this._texturesCube=new $(this)),this._texturesCube}animSchedule(t){const e=this.animationManager.schedule(t);return this.paint(),e}animCancel(t){this.animationManager.cancel(t)}get onEnter(){return this.painters.onEnter}set onEnter(t){this.painters.onEnter=t}get onExit(){return this.painters.onExit}set onExit(t){this.painters.onExit=t}get width(){return this.gl.drawingBufferWidth}get height(){return this.gl.drawingBufferHeight}get playing(){return this.isPlaying}set playing(t){t!==this.isPlaying&&(t&&this.paint(),this.isPlaying=t)}play(){this.playing=!0}pause(){this.playing=!1}has(t){return this.painters.has(t)}add(...t){this.painters.add(...t)}remove(...t){this.painters.remove(...t)}removeAll(){this.painters.removeAll()}createBuffer(t,e){return new y(this.gl,t,e)}createFramebuffer(){const t=this.gl.createFramebuffer();if(!t)throw Error("Unable to create a WebGL2 Framebuffer!");return t}createVAO(t,e,i){return new B(this.gl,t,e,i)}takeSnapshot(t){const e=t.getContext("2d");if(!e)throw Error("[TgdContext.takeSnapshot] We cannot get a 2D context for the target canvas! Maybe it already has another type of context.");const{width:i,height:r}=t,n=function(t,e){const i=document.createElement("canvas");return i.width=t,i.height=e,i}(i,r),s=new k(n,this.options);this.painters.forEachChild((t=>s.add(t))),s.actualPaint(this.lastTime),s.gl.finish(),e.drawImage(n,0,0)}lookupWebglConstant(t){const{gl:e}=this;for(const i in e)if(e[i]===t)return i;return`Unknown gl[${t}]`}paint=()=>{window.cancelAnimationFrame(this.requestAnimationFrame),this.requestAnimationFrame=window.requestAnimationFrame(this.actualPaint)};actualPaint=t=>{const{lastTime:e,gl:i}=this;if(e<0)return this.lastTime=t,void this.paint();const r=t-this.lastTime;this.lastTime=t,this._camera.screenWidth=i.drawingBufferWidth,this._camera.screenHeight=i.drawingBufferHeight,this.painters.paint(t,r),(this.animationManager.paint(t)||this.isPlaying)&&this.paint()};destroy(){window.cancelAnimationFrame(this.requestAnimationFrame),this.playing=!1,this.painters.delete(),this.observer.unobserve(this.canvas)}stateReset(){const{gl:t}=this,e=t.getParameter(t.MAX_VERTEX_ATTRIBS),i=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,i);for(let i=0;i<e;++i)t.disableVertexAttribArray(i),t.vertexAttribPointer(i,4,t.FLOAT,!1,0,0),t.vertexAttrib1f(i,0);t.deleteBuffer(i);const r=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS);for(let e=0;e<r;++e)t.activeTexture(t.TEXTURE0+e),t.bindTexture(t.TEXTURE_CUBE_MAP,null),t.bindTexture(t.TEXTURE_2D,null);return t.activeTexture(t.TEXTURE0),t.useProgram(null),t.bindBuffer(t.ARRAY_BUFFER,null),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindRenderbuffer(t.RENDERBUFFER,null),t.disable(t.BLEND),t.disable(t.CULL_FACE),t.disable(t.DEPTH_TEST),t.disable(t.DITHER),t.disable(t.SCISSOR_TEST),t.blendColor(0,0,0,0),t.blendEquation(t.FUNC_ADD),t.blendFunc(t.ONE,t.ZERO),t.clearColor(0,0,0,0),t.clearDepth(1),t.clearStencil(-1),t.colorMask(!0,!0,!0,!0),t.cullFace(t.BACK),t.depthFunc(t.LESS),t.depthMask(!0),t.depthRange(0,1),t.frontFace(t.CCW),t.hint(t.GENERATE_MIPMAP_HINT,t.DONT_CARE),t.lineWidth(1),t.pixelStorei(t.PACK_ALIGNMENT,4),t.pixelStorei(t.UNPACK_ALIGNMENT,4),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),t.polygonOffset(0,0),t.sampleCoverage(1,!1),t.scissor(0,0,t.canvas.width,t.canvas.height),t.stencilFunc(t.ALWAYS,0,4294967295),t.stencilMask(4294967295),t.stencilOp(t.KEEP,t.KEEP,t.KEEP),t.viewport(0,0,t.canvas.width,t.canvas.height),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT|t.STENCIL_BUFFER_BIT),t}}class W{context;eventChange=new g;minZoom=.001;maxZoom=1/0;enabled=!0;speedZoom=1;speedOrbit=1;speedPanning=1;inertiaZoom=0;inertiaOrbit=0;inertiaPanning=0;fixedTarget=!1;onZoomRequest;animOrbit=null;constructor(t,{minZoom:e=.001,maxZoom:i=1/0,speedZoom:r=1,speedOrbit:n=1,speedPanning:s=1,inertiaZoom:o=0,inertiaOrbit:a=0,inertiaPanning:h=0,fixedTarget:c=!1,onZoomRequest:u=H}={}){this.context=t;const{inputs:l}=t;l.pointer.eventMoveStart.addListener(this.handleMoveStart),l.pointer.eventMoveEnd.addListener(this.handleMoveEnd),l.pointer.eventMove.addListener(this.handleMove),l.pointer.eventZoom.addListener(this.handleZoom),this.speedOrbit=n,this.speedZoom=r,this.speedPanning=s,this.inertiaOrbit=a,this.inertiaZoom=o,this.inertiaPanning=h,this.fixedTarget=c,this.minZoom=e,this.maxZoom=i,this.onZoomRequest=u}detach(){const{inputs:t}=this.context;t.pointer.eventMove.removeListener(this.handleMove),t.pointer.eventZoom.removeListener(this.handleZoom)}handleMove=t=>{if(!this.enabled)return;if(t.current.t-t.previous.t<=0)return;const{context:e}=this,{keyboard:i}=e.inputs;return t.altKey||2===t.current.fingersCount?this.handlePan(t):i.isDown("z")?this.handleRotateAroundZ(t):void this.orbit(t.current.x-t.previous.x,t.current.y-t.previous.y,t.shiftKey)};orbit(t,e,i){const{context:r}=this,{camera:n}=r,{keyboard:s}=r.inputs,o=3*(i?.1:1)*this.speedOrbit,a=t*o,h=e*o;s.isDown("x")||n.orbitAroundY(-a),s.isDown("y")||n.orbitAroundX(h),this.fireOrbitChange()}handleMoveStart=()=>{if(!this.enabled)return;const{animOrbit:t,context:e}=this;t&&e.animCancel(t)};handleMoveEnd=t=>{if(!this.enabled)return;const{context:e,inertiaOrbit:i}=this;if(i>0){const r=i/(t.current.t-t.previous.t),n=t.shiftKey,s=r*(t.current.x-t.previous.x),o=r*(t.current.y-t.previous.y);let a=0;this.animOrbit={duration:i,action:t=>{const e=t-a;a=t,this.orbit(s*e,o*e,n)},easingFunction:V},e.animSchedule(this.animOrbit)}};handlePan(t){const{fixedTarget:e,speedPanning:i,context:r}=this,{camera:n}=r,s=.5*i*(1/n.zoom),o=(t.current.x-t.previous.x)*s*n.spaceWidthAtTarget,a=(t.current.y-t.previous.y)*s*n.spaceHeightAtTarget;e?n.moveShift(-o,-a,0):n.moveTarget(-o,-a,0),this.fireOrbitChange()}handleRotateAroundZ(t){const{camera:e}=this.context,i=t.previous.x,r=t.previous.y;if(Math.abs(i)+Math.abs(r)===0)return;const n=t.current.x,s=t.current.y;if(Math.abs(n)+Math.abs(s)===0)return;const o=i*n+r*s,a=i*s-r*n,h=Math.atan2(a,o)*this.speedOrbit;e.orbitAroundZ(-h),this.fireOrbitChange()}fireOrbitChange(){this.context.paint(),this.eventChange.dispatch(this.context.camera)}handleZoom=t=>{if(!this.enabled||0===this.speedZoom||!this.onZoomRequest({altKey:t.altKey,ctrlKey:t.ctrlKey,metaKey:t.metaKey,shiftKey:t.shiftKey,x:t.current.x,y:t.current.y}))return;const{context:e}=this,{camera:i}=e;let r=.1*this.speedZoom;this.context.inputs.keyboard.isDown("Shift")&&(r*=.1);const n=-t.direction*r;var s,o,a;i.zoom=(s=i.zoom*(1+n),o=this.minZoom,a=this.maxZoom,s<o?o:s>a?a:s),t.preventDefault(),this.fireZoomChange()};fireZoomChange(){this.context.paint()}}const H=()=>!0;class Y{stride;definitions;_data=new ArrayBuffer(0);_count=0;target;usage;constructor(t,e={}){this.target=e.target??"ARRAY_BUFFER",this.usage=e.usage??"STATIC_DRAW";const i=e.divisor??0;let r=0;const n={},s={};for(const e of Object.keys(t)){const o=e;n[e]=new ArrayBuffer(0);const a={dimension:G[t[o]],byteOffset:r,bytesPerElement:Float32Array.BYTES_PER_ELEMENT,divisor:i,getter:(t,e)=>(e>=t.byteLength&&(e%=t.byteLength),t.getFloat32(e,!0)),setter(t,e,i){t.setFloat32(e,i,!0)}};s[e]=a,r+=a.bytesPerElement*a.dimension}this.definitions=s,this.stride=r}get data(){return this._data}get count(){return this._count}set count(t){this._count!==t&&(this._count=t,this._data=K(this._data,t*this.stride))}getAttribAccessor(t){const e=this.getDef(t),i=new DataView(this.data),r=this.stride;return{get(t,n=0){const s=e.byteOffset+r*t+n*e.bytesPerElement;return e.getter(i,s)},set(t,n,s=0){const o=e.byteOffset+r*n+s*e.bytesPerElement;e.setter(i,o,t)}}}set(t,e,{byteOffset:i=0,byteStride:r,first:n=0,count:s=1/0,targetFirst:o=0}={}){const{bytesPerElement:a,dimension:h,byteOffset:c}=this.getDef(t),u=e instanceof ArrayBuffer?e:e.buffer,l=a*h,m=r??l;let d=i+m*n;const f=this.stride;let g=o*f+c;this.count=Math.max(this.count,Math.min(s,Math.floor((u.byteLength-d)/m)));const p=u.byteLength-m+1,x=this._data.byteLength+c-f+1,v=new Uint8Array(u),y=new Uint8Array(this._data);let w=0;for(;w<s&&d<p&&g<x;)y.set(v.subarray(d,d+l),g),w++,d+=m,g+=f}getDef(t){const e=this.definitions[t];if(!e)throw Error(`[TgdDataset] Attribute "${String(t)}" not found in this DataSet!\nAvailable names are: ${Object.keys(this.definitions).map((t=>JSON.stringify(t))).join(", ")}.`);return e}defineAttributes(t,e){let i=0;const{definitions:r}=this;for(const n of Object.keys(r)){const s=r[n];if(e.hasAttribute(n)){const r=e.getAttribLocation(n);t.enableVertexAttribArray(r),t.vertexAttribPointer(r,s.dimension,t.FLOAT,!1,this.stride,i),t.vertexAttribDivisor(r,s.divisor)}i+=s.dimension*s.bytesPerElement}}toCode({indent:t=""}={}){const e=[];let i=0;const{definitions:r}=this;for(const t of Object.keys(r)){const n=r[t],s=`$${t}`;e.push(`const ${s} = gl.getAttribLocation(prg, "${t}")`,`gl.enableVertexAttribArray(${s})`,"gl.vertexAttribPointer(",`  ${s},`,`  ${n.dimension},  // Dimension`,"  gl.FLOAT,","  false,",`  ${this.stride},   // Stride`,`  ${i}   // Offset`,")",`gl.vertexAttribDivisor(${s}, ${n.divisor})`),i+=n.dimension*n.bytesPerElement}return e.map((e=>`${t}${e}`)).join("\n")}}const G={float:1,vec2:2,vec3:3,vec4:4},K="function"==typeof ArrayBuffer.prototype.transfer?function(t,e){return t.transfer(e)}:function(t,e){const i=new ArrayBuffer(e??t.byteLength);return new Uint8Array(i).set(new Uint8Array(t)),i};class q extends X{context;vao;prg;translateAndScale;constructor(t,{x:e=0,y:i=0,z:r=0,scale:n=1}={}){super(),this.context=t;const s=t.programs.create({vert:"#version 300 es\n\nprecision mediump float;\n\nuniform vec4 uniTS;\nuniform mat4 uniModelViewMatrix;\nuniform mat4 uniProjectionMatrix;\n\nin vec3 attPos;\nin vec4 attColor;\n\nout vec4 varColor;\n\nvoid main() {\n    varColor = attColor;\n    vec3 translate = uniTS.xyz;\n    float scale = uniTS.w;\n    gl_Position = uniProjectionMatrix \n        * uniModelViewMatrix \n        * vec4(attPos * scale + translate, 1.0);\n}\n",frag:"#version 300 es\n\nprecision mediump float;\n\nin vec4 varColor;\n\nout vec4 FragColor;\n\nvoid main() {\n    FragColor = varColor;\n}"});this.prg=s;const o=new Y({attPos:"vec3",attColor:"vec4"});o.set("attPos",new Float32Array([0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,-1,-0,-0,0,0,0,-0,-1,-0,0,0,0,-0,-0,-1]));const a=.25;o.set("attColor",new Float32Array([1,0,0,1,1,0,0,1,0,1,0,1,0,1,0,1,0,0,1,1,0,0,1,1,a,0,0,1,a,0,0,1,0,a,0,1,0,a,0,1,0,0,a,1,0,0,a,1])),this.vao=t.createVAO(s,[o]),this.translateAndScale=new h(e,i,r,n)}get x(){return this.translateAndScale.x}set x(t){this.translateAndScale.x=t}get y(){return this.translateAndScale.y}set y(t){this.translateAndScale.y=t}get z(){return this.translateAndScale.z}set z(t){this.translateAndScale.z=t}get scale(){return this.translateAndScale.w}set scale(t){this.translateAndScale.w=t}delete(){this.vao.delete()}paint(){const{context:t,prg:e,vao:i,translateAndScale:r}=this,{gl:n,camera:s}=t;e.use(),e.uniform4fv("uniTS",r),e.uniformMatrix4fv("uniModelViewMatrix",s.matrixModelView),e.uniformMatrix4fv("uniProjectionMatrix",s.matrixProjection),i.bind(),n.drawArrays(n.LINES,0,12)}}class J extends X{context;texture;program;vao;zoom=1;x=0;y=0;z=1;constructor(t,e,{x:i=0,y:r=0,z:n=1,zoom:s=1}={}){super(),this.context=t,this.x=i,this.y=r,this.z=n,this.zoom=s,this.texture=e,this.program=t.programs.create({vert:"#version 300 es\n\nuniform float uniZoom;\nuniform vec2 uniScale;\nuniform vec2 uniScroll;\nuniform float uniZ;\nin vec2 attPoint;\nin vec2 attUV;\nout vec2 varUV;\n\nvoid main() {\n    varUV = (attUV + uniScroll) * uniZoom;\n    float x = uniScale.x * attPoint.x;\n    float y = uniScale.y * attPoint.y;\n    gl_Position = vec4(x, y, uniZ, 1.0);\n}",frag:"#version 300 es\n\nprecision mediump float;\n\nuniform sampler2D uniTexture;\nin vec2 varUV;\nout vec4 FragColor;\n\nvoid main() {\n    FragColor = texture(uniTexture, varUV);\n}"});const o=new Y({attPoint:"vec2",attUV:"vec2"});o.set("attPoint",new Float32Array([-1,-1,1,-1,-1,1,1,1])),o.set("attUV",new Float32Array([0,0,1,0,0,1,1,1])),this.vao=t.createVAO(this.program,[o])}delete(){const{vao:t}=this;t.delete()}paint(){const{gl:t}=this.context,{vao:e,program:i,texture:r,zoom:n,x:s,y:o,z:a}=this;i.use();const{width:h,height:c}=this.context,u=r.width*c>r.height*h,l=u?r.width*c/(h*r.height):1,m=u?1:r.height*h/(c*r.width);i.uniform2f("uniScale",l,m),i.uniform2f("uniScroll",s,o),i.uniform1f("uniZoom",1/n),i.uniform1f("uniZ",a),r.activate(i,"uniTexture"),e.bind(),t.drawArrays(t.TRIANGLE_STRIP,0,4)}}class Q extends X{context;options;clearMask;red=1;green=.7;blue=0;alpha=1;depth=1;constructor(t,e={}){super(),this.context=t,this.options=e;const{gl:i}=t,r=e.color??[0,0,0,1],n=e.depth??1;this.clearMask=0;let s=!1;if(e.color&&(this.clearMask|=i.COLOR_BUFFER_BIT,s=!0),"number"==typeof e.depth&&(this.clearMask|=i.DEPTH_BUFFER_BIT,s=!0),!s)throw Error("[TgdPainterClear] You must give at least a color or a depth in the constructor!");[this.red,this.green,this.blue,this.alpha]=r,this.depth=n}delete(){}paint(){const{clearMask:t,context:e,red:i,green:r,blue:n,alpha:s,depth:o,options:a}=this,{gl:h}=e;a.color&&h.clearColor(i,r,n,s),"number"==typeof a.depth&&h.clearDepth(o),h.clear(t)}}class tt extends X{context;enabled;func;mask;rangeMin;rangeMax;constructor(t,{enabled:e=!0,func:i="LESS",mask:r=!0,rangeMin:n=0,rangeMax:s=1}={}){super(),this.context=t,this.enabled=e,this.func=i,this.mask=r,this.rangeMin=n,this.rangeMax=s}delete(){}paint(){const{gl:t}=this.context,{enabled:e}=this;if(!e)return void t.disable(t.DEPTH_TEST);const{func:i,mask:r,rangeMin:n,rangeMax:s}=this;t.enable(t.DEPTH_TEST),t.depthFunc(t[i]),t.depthMask(r),t.depthRange(n,s)}update(){}}function et(t,e=""){if("string"==typeof t)return`${e}${t}`;if(!t)return"";const i=`${e}    `;return t.filter((t=>null!==t)).filter((t=>!Array.isArray(t)||t.length>0)).map((t=>et(t,i))).join("\n")}function it(t,e,i="----------------------------------------"){const r=Object.keys(t);return 0===r.length?[]:[`// ${i}`,...r.map((i=>`${e} ${t[i]} ${i};`))]}function rt(t,e="Util functions"){const i=Object.keys(t);if(0===i.length)return[];const r=[`// ${e}`];return i.forEach((e=>{r.push(`${e} {`,t[e],"}","")})),r}class nt{precision="mediump";uniforms;varying;outputs;functions;mainCode;constructor({precision:t="mediump",uniforms:e={},outputs:i={FragColor:"vec4"},varying:r={},functions:n={},mainCode:s=["FragColor = vec4(1, 0.667, 0, 1);"]}={}){this.precision=t,this.uniforms=e,this.outputs=i,this.varying=r,this.functions=n,this.mainCode=s}get code(){return et(["#version 300 es",`precision ${this.precision} float;`,...it(this.uniforms,"uniform"),...it(this.varying,"in"),...it(this.outputs,"out"),...rt(this.functions),"","void main() {",this.mainCode,"}"])}}class st{precision="mediump";uniforms;attributes;varying;functions;mainCode;constructor({precision:t="mediump",uniforms:e={},attributes:i={},varying:r={},functions:n={},mainCode:s=[]}={}){this.precision=t,this.uniforms=e,this.attributes=i,this.varying=r,this.functions=n,this.mainCode=s}get code(){return et(["#version 300 es",`precision ${this.precision} float;`,...it(this.uniforms,"uniform"),...it(this.attributes,"in"),...it(this.varying,"out"),...rt(this.functions),"","void main() {",this.mainCode,"}"])}}class ot extends X{context;texture;z=0;programs;filters;program;filter;vao;framebuffer;texture2=null;constructor(t,e){if(super(),this.context=t,this.z=e.z??.9999,this.texture=e.texture,this.filters=e.filters,this.filters.length<1)throw Error("[TgdPainterFilter] filters is expected to have at least one element!");this.programs=e.filters.map((e=>{const i=new st({attributes:{attPoint:"vec2",attUV:"vec2"},varying:{varUV:"vec2"},uniforms:{uniZ:"float"},mainCode:["varUV = attUV;","gl_Position = vec4(",["attPoint,","uniZ,","1.0"],");"]}).code,r=new nt({varying:{varUV:"vec2"},uniforms:{uniWidth:"float",uniHeight:"float",uniInverseWidth:"float",uniInverseHeight:"float",texSource:"sampler2D",...e.uniforms},mainCode:e.fragmentShaderCode}).code;return t.programs.create({vert:i,frag:r})})),this.filter=this.filters.pop(),this.program=this.programs.pop();const i=new Y({attPoint:"vec2",attUV:"vec2"});i.set("attPoint",new Float32Array([-1,-1,1,-1,-1,1,1,1])),i.set("attUV",new Float32Array([0,0,1,0,0,1,1,1])),this.vao=t.createVAO(this.program,[i]),this.filters.length>0?this.framebuffer=t.createFramebuffer():this.framebuffer=null}delete(){const{vao:t,framebuffer:e,context:i}=this;t.delete(),e&&i.gl.deleteFramebuffer(e)}paint(t){const{context:e,vao:i,program:r,filter:n,z:s}=this,{gl:o}=e,a=this.paintFirstFilters(t),h=e.width,c=e.height;r.use(),r.uniform1f("uniZ",s),r.uniform1f("uniWidth",h),r.uniform1f("uniInverseWidth",1/h),r.uniform1f("uniHeight",c),r.uniform1f("uniInverseHeight",1/c),n.setUniforms(r,t),a.activate(r,"uniTexture"),i.bind(),o.drawArrays(o.TRIANGLE_STRIP,0,4)}paintFirstFilters(t){const{framebuffer:e,texture:i}=this;if(!e)return i;let r=this.getSecondTexture();if(!r)return i;const{context:n,programs:s,filters:o,z:a,vao:h}=this,{gl:c}=n,u=n.width,l=n.height;let m=i;for(let i=0;i<s.length;i++){const n=s[i],d=o[i];c.bindFramebuffer(c.FRAMEBUFFER,e),c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,r.glTexture,0),n.use(),n.uniform1f("uniZ",a),n.uniform1f("uniWidth",u),n.uniform1f("uniInverseWidth",1/u),n.uniform1f("uniHeight",l),n.uniform1f("uniInverseHeight",1/l),d.setUniforms(n,t),m.activate(n,"uniTexture"),h.bind(),c.drawArrays(c.TRIANGLE_STRIP,0,4);const f=m;m=r,r=f}return c.bindFramebuffer(c.FRAMEBUFFER,null),m}getSecondTexture(){const{context:t,texture:e,texture2:i}=this,r=e.width,n=e.height;return n<=0||r<=0?null:i&&i.width===r&&i.height===n?i:(i&&t.textures2D.delete(i),this.texture2=this.context.textures2D.create({width:r,height:n,internalFormat:"RGB",generateMipMap:!0}),this.texture2)}}class at extends X{logicFunction;constructor(t){super(),this.logicFunction=t}delete(){}paint(t,e){this.logicFunction(t,e)}}class ht{attPosition;attNormal;attUV;count;_dataset;_drawMode;_elementsBuff;_elementsType;constructor(t){const{dataset:e,drawMode:i,attPosition:r="POSITION",attNormal:n="NORMAL",attUV:s="TEXCOORD_0"}=t;this._dataset=e,this._drawMode=i;const o=function(t){if(!t)return t;if(t instanceof Uint16Array)return{buff:new DataView(t.buffer),type:WebGL2RenderingContext.UNSIGNED_SHORT,count:t.length};if(t instanceof Uint8Array)return{buff:new DataView(t.buffer),type:WebGL2RenderingContext.UNSIGNED_BYTE,count:t.length};if(t instanceof Uint32Array)return{buff:new DataView(t.buffer),type:WebGL2RenderingContext.UNSIGNED_INT,count:t.length};let e=t.buff.byteLength;return t.type===WebGL2RenderingContext.UNSIGNED_SHORT?e>>=1:t.type===WebGL2RenderingContext.UNSIGNED_INT&&(e>>=2),{...t,count:e}}(t.elements);this._elementsBuff=o?.buff??void 0,this._elementsType=o?.type??0,this.attPosition=r,this.attNormal=n,this.attUV=s,this.count=o?.count??e.count}get dataset(){return this._dataset}get drawMode(){return this._drawMode}get elementsBuff(){return this._elementsBuff}get elementsType(){return this._elementsType}}class ct extends ht{constructor({sizeX:t=1,sizeY:e=1,sizeZ:i=1}={}){const r=.5*t,n=.5*e,s=.5*i,o=new Y({POSITION:"vec3",NORMAL:"vec3",TEXCOORD_0:"vec2"});o.set("POSITION",new Float32Array([-r,+n,-s,+r,+n,+s,+r,+n,-s,+r,+n,+s,-r,-n,+s,+r,-n,+s,-r,+n,+s,-r,-n,-s,-r,-n,+s,+r,-n,-s,-r,-n,+s,-r,-n,-s,+r,+n,-s,+r,-n,+s,+r,-n,-s,-r,+n,-s,+r,-n,-s,-r,-n,-s,-r,+n,-s,-r,+n,+s,+r,+n,+s,+r,+n,+s,-r,+n,+s,-r,-n,+s,-r,+n,+s,-r,+n,-s,-r,-n,-s,+r,-n,-s,+r,-n,+s,-r,-n,+s,+r,+n,-s,+r,+n,+s,+r,-n,+s,-r,+n,-s,+r,+n,-s,+r,-n,-s])),o.set("TEXCOORD_0",new Float32Array([.875,.5,.625,.75,.625,.5,.625,.75,.375,1,.375,.75,.625,0,.375,.25,.375,0,.375,.5,.125,.75,.125,.5,.625,.5,.375,.75,.375,.5,.625,.25,.375,.5,.375,.25,.875,.5,.875,.75,.625,.75,.625,.75,.625,1,.375,1,.625,0,.625,.25,.375,.25,.375,.5,.375,.75,.125,.75,.625,.5,.625,.75,.375,.75,.625,.25,.625,.5,.375,.5])),o.set("NORMAL",new Float32Array([0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,0,0,-1,0,0,-1,0,0,-1])),super({dataset:o,drawMode:"TRIANGLES"})}}class ut{varyings={};uniforms={}}class lt{color;_direction=new o;constructor(t={}){this.color=t.color??new h(.8,.8,.8,1),this.direction=t.direction??new o(0,0,-1)}get direction(){return this._direction}set direction(t){this._direction.from(t).normalize()}}const mt=new h(.8,.8,.8,1);class dt extends ut{light=new lt;ambient=new lt({color:new h(.8,.8,.8,0)});varyings;uniforms={uniLight:"vec3",uniLightDir:"vec3",uniAmbient:"vec3"};fragmentShaderCode;vertexShaderCode;texture;lightColor=new o;ambientColor=new o;constructor(t={}){super();const e=t.color??mt;t.light&&(this.light=t.light),t.ambient&&(this.ambient=t.ambient);const i=!(e instanceof h);this.texture=i?e:null,this.fragmentShaderCode=["float light = -dot(varNormal, uniLightDir);",i?"vec4 color = texture(texDiffuse, varUV);":`vec4 color = vec4(${e.join(", ")});`,"float spec = max(0.0, reflect(uniLightDir, varNormal).z);","spec = pow(spec, 20.0);","color = vec4(","  color.rgb * (","    mix(uniAmbient, uniLight, light)","  ) + vec3(spec),","  1.0",");","return color;"],this.vertexShaderCode=["varNormal = mat3(uniModelViewMatrix) * NORMAL;"],this.varyings={varNormal:"vec3"},i&&(this.vertexShaderCode.push("varUV = TEXCOORD_0;"),this.varyings.varUV="vec2",this.uniforms.texDiffuse="sampler2D")}setUniforms(t){t.uniform3fv("uniLightDir",this.light.direction),this.lightColor.from(this.light.color).scale(this.light.color.w),t.uniform3fv("uniLight",this.lightColor),this.ambientColor.from(this.ambient.color).scale(this.ambient.color.w),t.uniform3fv("uniAmbient",this.ambientColor);const{texture:e}=this;e&&e.activate(t,"texDiffuse")}}new h(.6,1,.9,1);class ft extends X{context;matrixTransfo=new a;prg;vao;elementsType;count;material;geometry;drawMode=0;bboxMin=null;bboxMax=null;constructor(t,e){super(),this.context=t;const{material:i,geometry:r}=e;this.geometry=r,this.material=i,this.drawMode="number"==typeof r.drawMode?r.drawMode:t.gl[r.drawMode];const n=new st({uniforms:{uniTransfoMatrix:"mat4",uniModelViewMatrix:"mat4",uniProjectionMatrix:"mat4",...i.uniforms},attributes:{[r.attPosition]:"vec4",[r.attNormal]:"vec3",[r.attUV]:"vec2"},varying:i.varyings,functions:{"void applyMaterial()":i.vertexShaderCode},mainCode:["gl_Position = uniProjectionMatrix * uniModelViewMatrix * uniTransfoMatrix * POSITION;","applyMaterial();"]}).code,s=new nt({uniforms:i.uniforms,outputs:{FragColor:"vec4"},varying:i.varyings,functions:{"vec4 applyMaterial()":i.fragmentShaderCode},mainCode:["FragColor = applyMaterial();"]}).code;console.log("🚀 [mesh] vert = ",n),console.log("🚀 [mesh] frag = ",s);const o=t.programs.create({vert:n,frag:s});this.prg=o,this.vao=t.createVAO(o,[r.dataset],r.elementsBuff),this.elementsType=r.elementsType,this.count=r.count}computeBoundingBox(){if(this.bboxMin&&this.bboxMax)return{min:this.bboxMin,max:this.bboxMax};const{dataset:t}=this.geometry,{get:e}=t.getAttribAccessor("POSITION"),i=new o(e(0,0),e(0,1),e(0,2)),r=new o(i);for(let n=1;n<t.count;n++){const t=e(n,0),s=e(n,1),o=e(n,2);i.x=Math.min(i.x,t),r.x=Math.max(r.x,t),i.y=Math.min(i.y,s),r.y=Math.max(r.y,s),i.z=Math.min(i.z,o),r.z=Math.max(r.z,o)}return this.bboxMin=i,this.bboxMax=r,{min:i,max:r}}paint=()=>{const{context:t,prg:e,geometry:i,material:r,drawMode:n,count:s,matrixTransfo:o}=this,{gl:a,camera:h}=t;a.enable(a.CULL_FACE),a.cullFace(a.BACK),e.use(),r.setUniforms(e),e.uniformMatrix4fv("uniTransfoMatrix",o),e.uniformMatrix4fv("uniModelViewMatrix",h.matrixModelView),e.uniformMatrix4fv("uniProjectionMatrix",h.matrixProjection),this.vao.bind(),i.elementsBuff?a.drawElements(n,s,this.elementsType,0):a.drawArrays(n,0,s),this.vao.unbind()};delete(){this.vao.delete()}}class gt extends ft{constructor(t,e){const{asset:i,meshIndex:r,primitiveIndex:n=0}=e,s=function(t,e,i,r){const n=t.getMeshPrimitive(e,i).material??-1;if(-1===n)return pt;const s=t.getMaterial(n).pbrMetallicRoughness;if(!s)return pt;if(s.baseColorTexture){const e=t.getMaterial(n).pbrMetallicRoughness?.baseColorTexture?.index,i=t.getTexture2DOptions(e??0);return r.textures2D.create(i)}return s.baseColorFactor?new h(...s.baseColorFactor):pt}(i,r,n,t),o=new dt({color:s});if(s instanceof h){const e=new Y({POSITION:"vec3",NORMAL:"vec3"});i.setAttrib(e,"POSITION",r,n),i.setAttrib(e,"NORMAL",r,n),super(t,{geometry:new ht({dataset:e,elements:i.getMeshPrimitiveIndices(r,n),drawMode:"TRIANGLES"}),material:o})}else{const e=new Y({POSITION:"vec3",NORMAL:"vec3",TEXCOORD_0:"vec2"});i.setAttrib(e,"POSITION",r,n),i.setAttrib(e,"NORMAL",r,n),i.setAttrib(e,"TEXCOORD_0",r,n),super(t,{geometry:new ht({dataset:e,elements:i.getMeshPrimitiveIndices(r,n),drawMode:"TRIANGLES"}),material:o})}}}const pt=new h(.8,.8,.8,1);class xt extends X{parentTransfo=new d;transfo=new d;matrixTransfo=new a;parentUpdateCount=0;updateCount=0;childrenNodes=[];children=[];constructor(t={}){super();const{children:e=[]}=t;e.forEach((t=>this.add(t)))}delete(){for(const t of this.children)t.delete();for(const t of this.childrenNodes)t.delete()}add(...t){for(const e of t)e instanceof xt?this.childrenNodes.push(e):this.children.push(e)}remove(...t){for(const e of t)if(e instanceof xt){const t=this.childrenNodes.indexOf(e);t>-1&&this.childrenNodes.splice(t,1)}else{const t=this.children.indexOf(e);t>-1&&this.children.splice(t,1)}}paint(t,e){const{transfo:i,parentTransfo:r,matrixTransfo:n,parentUpdateCount:s,updateCount:o,children:a,childrenNodes:h}=this;(i.updateCount>o||r.updateCount>s)&&(this.updateCount=i.updateCount,this.parentUpdateCount=r.updateCount,n.from(r.matrix).multiply(i.matrix));for(const i of a)i.matrixTransfo=n,i.paint(t,e);for(const i of h)i.parentTransfo.matrix=n,i.paint(t,e)}}class vt extends X{context;colorTexture;minRadius=0;radiusMultiplier=1;radiusConstant=1;radiusSwitch=0;light=1;shiftZ=0;vao;prg;vertexCount;instanceCount;constructor(t,e,{roundness:i=3,minRadius:r=0}={}){if(super(),this.context=t,this.minRadius=r,i>125)throw Error("[TgdPainterSegments] Max roundness is 125!");if(i<0)throw Error("[TgdPainterSegments] Min roundness is 0!");const n=t.textures2D.create({magFilter:"NEAREST",minFilter:"NEAREST",wrapR:"CLAMP_TO_EDGE",wrapS:"CLAMP_TO_EDGE",wrapT:"CLAMP_TO_EDGE"});n.makePalette(["#f00","#0f0","#00f"]),this.colorTexture=n;const s=t.programs.create({vert:"#version 300 es\n\nprecision mediump float;\n\nuniform sampler2D uniTexture;\nuniform mat4 uniModelViewMatrix;\nuniform mat4 uniProjectionMatrix;\n// Minimal value for the radius.\nuniform float uniMinRadius;\n// Multiply all radii by this value.\nuniform float uniRadiusMultiplier;\n// When uniRadiusSwitch == 1.0,\n// we use uniRadiusConstant as radius. \nuniform float uniRadiusConstant;\n// 0.0 means we will use the radius defined\n// in the attribute attAxyzr or attBaxyz.\n// 1.0 means we use uniRadiusConstant for\n// all vertices.\nuniform float uniRadiusSwitch;\n// Multiply the color by this value;\nuniform float uniLight;\n// Push the segments away from camera of `uniShiftZ`.\n// This can be used if you want contours on the segments:\n// just increase `uniRadiusMultiplier`, set a low `uniLight`,\n// and set a small positive `uniShiftZ`.\nuniform float uniShiftZ;\n\n//===================\n// Vertex attributes\n//-------------------\n\n// Position of the vertex, relative to\n// the current center and assuming a\n// radius of 1.\n// Z tells you what tip is your center: 0 for A and 1 for B.\nin vec3 attOffset;\n\n//=====================\n// Instance attributes\n//---------------------\n\n// Coords and radious of tip A.\nin vec4 attAxyzr;\n// Coords and radious of tip B.\nin vec4 attBxyzr;\n// The color is taken from a texture.\nin vec2 attAuv;\nin vec2 attBuv;\n// 0 means that nothing modifies the initial radius,\n// except the minRadius.\nin float attAinfluence;\nin float attBinfluence;\n\n\nout vec4 varColor;\n\n\nvec3 worldToCamera(vec3 v);\nfloat getRadius(float tip);\nmat3 getTransfoMatrix(float tip, vec3 camA, vec3 camB);\n\nvoid main() {\n    vec3 camA = worldToCamera(attAxyzr.xyz);\n    vec3 camB = worldToCamera(attBxyzr.xyz);\n    float tip = attOffset.z;\n    vec2 uv = mix(attAuv, attBuv, tip);\n    varColor = texture(uniTexture, uv)\n        *   vec4(uniLight, uniLight, uniLight, 1.0);\n    float radius = getRadius(tip);\n    mat3 transfo = getTransfoMatrix(tip, camA, camB);\n    vec3 point = transfo * vec3(attOffset.xy * radius, 1.0);\n    point.z -= uniShiftZ;\n    gl_Position = \n        uniProjectionMatrix \n        * vec4(point, 1);\n}\n\nfloat getRadius(float tip) {\n    float influence = mix(attAinfluence, attBinfluence, tip);\n    float originalRadius = mix(\n        attAxyzr.w,\n        attBxyzr.w,\n        tip\n    );\n    float modifiedRadius = mix(\n        originalRadius,\n        uniRadiusConstant,\n        uniRadiusSwitch\n    ) * uniRadiusMultiplier;\n    float radius = mix(\n        originalRadius,\n        modifiedRadius,\n        influence\n    );\n    return max(uniMinRadius, radius);\n}\n\nvec3 worldToCamera(vec3 v) {\n    vec4 result = uniModelViewMatrix * vec4(v, 1.0);\n    return result.xyz;\n}\n\nmat3 getTransfoMatrix(float tip, vec3 camA, vec3 camB) {\n    // What is the current tip?\n    vec3 camO = mix(camA, camB, tip);\n    vec2 A = camA.xy;\n    vec2 B = camB.xy;\n    vec3 Y = vec3(\n        A == B ? vec2(0, 1) : normalize(A - B),\n        0\n    );\n    vec3 X = vec3(Y.y, -Y.x, 0);\n    return mat3(X, Y, camO);\n}",frag:"#version 300 es\n\nprecision mediump float;\n\nin vec4 varColor;\nout vec4 FragColor;\n\n\nvoid main() {\n    if (varColor.a < 1.0) discard;\n    else FragColor = varColor;\n}\n"});this.prg=s;const{capsule:o,elements:a}=function(t){const e=[0,0,0,1,0,0,-1,0,0,0,0,1,1,0,1,-1,0,1],i=[0,3,1,3,4,1,0,2,5,3,0,5];if(t>0){let r=1,n=4,s=6;for(let o=0;o<t;o++){const a=Math.PI*(o+1)/(t+1),h=Math.cos(a),c=Math.sin(a);e.push(h,c,0),i.push(0,r,s),r=s,s++,e.push(h,-c,1),i.push(3,s,n),n=s,s++}i.push(0,r,2),i.push(3,5,n)}const r=new Y({attOffset:"vec3"});return r.set("attOffset",new Float32Array(e)),{capsule:r,elements:new Uint8Array(i)}}(i),h=e.makeDataset();this.vao=t.createVAO(s,[o,h],a),this.vertexCount=a.length,this.instanceCount=h.count}delete(){this.vao.delete()}paint(t,e){const{context:i,prg:r,vao:n,colorTexture:s,vertexCount:o,instanceCount:a,light:h,radiusMultiplier:c,radiusConstant:u,radiusSwitch:l,shiftZ:m}=this,{gl:d,camera:f}=i;r.use();const g=this.minRadius*f.spaceHeightAtTarget/(f.zoom*f.screenHeight);r.uniform1f("uniMinRadius",g),r.uniform1f("uniLight",h),r.uniform1f("uniShiftZ",m),r.uniform1f("uniRadiusMultiplier",c),r.uniform1f("uniRadiusConstant",u),r.uniform1f("uniRadiusSwitch",l),s.activate(r,"uniTexture"),r.uniformMatrix4fv("uniModelViewMatrix",f.matrixModelView),r.uniformMatrix4fv("uniProjectionMatrix",f.matrixProjection),n.bind(),d.drawElementsInstanced(d.TRIANGLES,o,d.UNSIGNED_BYTE,0,a)}}class yt{_count=0;attAxyzr=[];attAuv=[];attAinfluence=[];attBxyzr=[];attBuv=[];attBinfluence=[];get count(){return this._count}add(t,e,i=[0,0],r=[0,0],n=1,s=1){this.attAxyzr.push(...t),this.attAuv.push(...i),this.attAinfluence.push(n),this.attBxyzr.push(...e),this.attBuv.push(...r),this.attBinfluence.push(s),this._count++}makeDataset(){const t=new Y({attAxyzr:"vec4",attAuv:"vec2",attAinfluence:"float",attBxyzr:"vec4",attBuv:"vec2",attBinfluence:"float"},{divisor:1});return t.set("attAxyzr",new Float32Array(this.attAxyzr)),t.set("attAuv",new Float32Array(this.attAuv)),t.set("attAinfluence",new Float32Array(this.attAinfluence)),t.set("attBxyzr",new Float32Array(this.attBxyzr)),t.set("attBuv",new Float32Array(this.attBuv)),t.set("attBinfluence",new Float32Array(this.attBinfluence)),t}}class wt extends X{context;camera;texture;program;vao;matrix=new a;tmpMat=new a;constructor(t,e){super(),this.context=t,this.camera=e.camera??new v,this.texture=t.texturesCube.create(e),this.program=t.programs.create({vert:"#version 300 es\n\nin vec4 attPoint;\n\nout vec4 varPoint;\n\nvoid main() {\n    varPoint = attPoint;\n    gl_Position = vec4(attPoint.xy, 0.99999, 1.0);\n}",frag:"#version 300 es\n\nprecision highp float;\n\nuniform samplerCube uniTexture;\nuniform mat4 uniMatrix;\n\nin vec4 varPoint;\n\nout vec4 FragColor;\n\nvoid main() {\n    vec4 t = uniMatrix * varPoint;\n    FragColor = texture(uniTexture, normalize(t.xyz / t.w));\n}"});const i=new Y({attPoint:"vec2"});i.set("attPoint",new Float32Array([-1,1,1,1,-1,-1,1,-1])),this.vao=t.createVAO(this.program,[i])}delete(){const{vao:t}=this;t.delete()}paint(){const{context:t,vao:e,program:i,texture:r}=this,{gl:n}=t;i.use(),i.uniformMatrix4fv("uniMatrix",this.matrix),r.activate(i,"uniTexture"),e.bind(),n.drawArrays(n.TRIANGLE_STRIP,0,4);const{camera:s,matrix:o,tmpMat:a}=this;s!==t.camera&&(s.orientation=t.camera.orientation),o.from(s.matrixProjection),a.fromMat3(s.matrixModelView),a.m30=0,a.m31=0,a.m32=0,a.m33=1,a.m03=0,a.m13=0,a.m23=0,o.multiply(a).invert()}}class bt extends X{context;texture;prg;vao;constructor(t){super(),this.context=t,this.texture=t.textures2D.create({minFilter:"LINEAR",magFilter:"LINEAR"}),this.setTips();const e=new Y({attPos:"vec3",attUV:"vec2"});e.set("attPos",new Float32Array([1,0,0,0,1,0,0,0,1,-1,0,0,0,-1,0,0,0,-1]));const i=1/3;e.set("attUV",new Float32Array([0,0,i,0,2*i,0,0,.5,i,.5,2*i,.5]));const r=t.programs.create({vert:"#version 300 es\n\nprecision mediump float;\n\nuniform mat4 uniModelViewMatrix;\nuniform mat4 uniProjectionMatrix;\nuniform float uniScreenHeight;\n\n/**\n * Position of the tip.\n */\nin vec4 attPos;\nin vec2 attUV;\n\nout vec2 varUV;\n\nvoid main() {\n    varUV = attUV;\n    vec4 point = uniModelViewMatrix * attPos;\n    gl_Position = uniProjectionMatrix * point;\n    point.y += 0.3;\n    point = uniProjectionMatrix * point;\n    gl_PointSize = uniScreenHeight * abs(gl_Position.y / gl_Position.w - point.y / point.w);\n}\n",frag:"#version 300 es\n\nprecision mediump float;\n\nuniform sampler2D uniTexture;\n\nin vec2 varUV;\nout vec4 FragColor;\n\n\nvoid main() {\n    vec2 uv = varUV + gl_PointCoord * vec2(0.333333333, 0.5);\n    FragColor = texture(uniTexture, uv);\n    if (FragColor.w < 1.0) {\n        discard;\n    }\n}\n"}),n=t.createVAO(r,[e]);this.prg=r,this.vao=n}delete(){this.vao.delete()}paint(){const{context:t,prg:e,vao:i}=this,{gl:r,camera:n}=t;e.use(),this.texture.activate(e,"uniTexture"),e.uniform1f("uniScreenHeight",t.height),e.uniformMatrix4fv("uniModelViewMatrix",n.matrixModelView),e.uniformMatrix4fv("uniProjectionMatrix",n.matrixProjection),i.bind(),r.drawArrays(r.POINTS,0,6)}setTips(){const t=256,{canvas:e,ctx:i}=L(768,512);_t(i,0,0,t,"X","#f00","#fff"),_t(i,1,0,t,"Y","#0f0","#000"),_t(i,2,0,t,"Z","#00f","#fff"),_t(i,0,1,t,"","#f00","#500"),_t(i,1,1,t,"","#0f0","#050"),_t(i,2,1,t,"","#00f","#005"),this.texture.loadImage(e)}}function _t(t,e,i,r,n,s,o="#fff"){const a=(e+.5)*r,h=(i+.5)*r,c=.45*r;t.fillStyle=s,t.beginPath(),t.ellipse(a,h,c,c,0,0,2*Math.PI),t.fill(),n?(t.font=`bold ${.5*r}px sans-serif`,t.fillStyle=o,t.textAlign="center",t.textBaseline="middle",t.fillText(n,a,h)):(t.fillStyle=o,t.beginPath(),t.ellipse(a,h,.8*c,.8*c,0,0,2*Math.PI),t.fill())}class At{options;eventTipClick=new g;_canvas=null;context=null;cameraExternal=null;cameraInternal=new v({fovy:Math.PI/3,distance:2.7,near:.01,far:10});orbiter=null;tipsPainter=null;constructor(t={}){this.options=t,t.canvas&&(this.canvas=t.canvas)}attachCamera(t){this.detach(),this.cameraExternal=t,this.attach()}detach(){const t=this.cameraExternal;t&&(t.eventTransformChange.removeListener(this.handleExternalToInternal),this.cameraExternal=null)}attach(){const t=this.cameraExternal;t&&t.eventTransformChange.addListener(this.handleExternalToInternal),this.context?.paint()}handleExternalToInternal=t=>{this.cameraInternal.orientation=t.orientation};handleInternalToExternal=t=>{const{cameraExternal:e}=this;e&&(e.orientation=t.orientation)};get canvas(){return this._canvas}set canvas(t){if(t===this._canvas)return;if(this._canvas=t,this.context){this.context.inputs.pointer.eventTap.removeListener(this.handleTap),this.context.destroy(),this.context=null;const{orbiter:t}=this;t&&(t.detach(),t.eventChange.removeListener(this.handleInternalToExternal))}if(this.tipsPainter?.delete(),!t)return;const e=new k(t,{alpha:!0,depth:!0,antialias:!0,name:"GizmoCanvas",...this.options});e.inputs.pointer.eventTap.addListener(this.handleTap),this.context=e,e.camera=this.cameraInternal,this.orbiter=new W(e,{speedPanning:0,speedZoom:0}),this.orbiter.eventChange.addListener(this.handleInternalToExternal);const i=new bt(e);this.tipsPainter=i,e.add(new Q(e,{color:[0,0,0,0],depth:1}),new tt(e,{enabled:!0}),i),e.paint()}handleTap=t=>{const e=this.context?.camera;if(!e)return;const{origin:i,direction:r}=e.castRay(t.x,t.y);let n=1,s=Et[0];for(const t of Et){const e=t.distanceToLineSquared(i,r);e<n&&(n=e,s=t)}if(n<1){const t=new o,i=new o,r=s;t.from(this.findAxisX()),t.isClose(r)?(i.from(this.findAxisY()),t.from(i).cross(r)):i.from(r).cross(t);const n=(new c).fromAxis(t,i,r);n.isEqual(e.orientation)&&n.rotateAroundY(Math.PI),this.eventTipClick.dispatch({from:new c(e.orientation),to:n})}};findAxisX(){let t=0,e=Et[0];const i=new o,r=new n;r.fromQuat(this.cameraInternal.orientation).transpose();for(const n of Et)i.from(n).applyMatrix(r),i.x>t&&(t=i.x,e=n);return e}findAxisY(){let t=0,e=Et[0];const i=new o,r=new n;r.fromQuat(this.cameraInternal.orientation).transpose();for(const n of Et)i.from(n).applyMatrix(r),i.y>t&&(t=i.y,e=n);return e}}const Et=[new o(1,0,0),new o(0,1,0),new o(0,0,1),new o(-1,0,0),new o(0,-1,0),new o(0,0,-1)];class Tt{uniforms={};fragmentShaderCode=["vec4 color = texture(texSource, varUV);","return color;"];setUniforms=(t,e)=>{};constructor(t={}){const{uniforms:e,fragmentShaderCode:i,setUniforms:r}=t;e&&(this.uniforms=e),i&&(this.fragmentShaderCode=i),r&&(this.setUniforms=r)}}const Mt=new f(1,0);class Pt extends Tt{constructor(t={}){const{size:e=4,direction:i=Mt}=t,r=i.size,n=r>0?1/r:1,s=i.x*n,o=i.y*n,a=["vec2 s;","float f;"];let h=0;for(let t=0;t<e-1;t+=2){const i=e-t;h+=i,a.push(`s = ${t+1.4} * dir;`,`f = ${i.toFixed(1)};`,"color += f * texture(texSource, varUV + s);","color += f * texture(texSource, varUV - s);")}1&e&&(a.push(`s = ${e} * dir;`,"color += texture(texSource, varUV + s);","color += texture(texSource, varUV - s);"),h++),h=h+h+e+1,super({fragmentShaderCode:["vec2 dir = vec2(",[`uniInverseWidth * ${s.toFixed(9)},`,`uniInverseHeight * ${o.toFixed(9)}`],");",`vec4 color = ${(e+1).toFixed(1)} * texture(texSource, varUV);`,...a,`FragColor = color * ${(1/h).toFixed(9)};`],uniforms:{uniHueShift:"float"}})}}class St extends Tt{hueShift=0;constructor(){super({fragmentShaderCode:["vec4 color = texture(texSource, varUV);","vec3 rgb = color.rgb;","const vec3 k = vec3(0.5773502691896258);","float cosAngle = cos(uniHueShift);","FragColor = vec4(",["rgb * cosAngle ","+ cross(k, rgb) * sin(uniHueShift) ","+ k * dot(k, rgb) * (1.0 - cosAngle),","color.a"],");"],uniforms:{uniHueShift:"float"}})}get hueShiftInRadians(){return this.hueShift}set hueShiftInRadians(t){this.hueShift=t}get hueShiftInDegrees(){return 180*this.hueShift/Math.PI}set hueShiftInDegrees(t){this.hueShift=t*Math.PI/180}setUniforms=(t,e)=>{t.uniform1f("uniHueShift",this.hueShift)}}function Rt(t){return!!t&&!Array.isArray(t)&&"object"==typeof t}function Ct(t,e,i="data"){if("unknown"===e)return;if("null"===e){if(null!==t)throw Error(`Expected ${i} to be null and not a ${typeof t}!`);return}if("string"==typeof e){if(typeof t!==e)throw Error(`Expected ${i} to be a ${e} and not a ${typeof t}!`);return}if(Array.isArray(e)){const[r]=e;switch(r){case"array":return void function(t,e,i){if(!Array.isArray(t))throw Error(`Expected ${e} to be an array and not a ${typeof t}!`);const[,r]=i;for(let i=0;i<t.length;i+=1)Ct(t[i],r,`${e}[${i}]`)}(t,i,e);case"map":return void function(t,e,i){if(!Rt(t))throw Error(`Expected ${e} to be an object and not a ${typeof t}!`);const[,r]=i;for(const i of Object.keys(t))"string"==typeof i&&Ct(t[i],r,`${e}[${i}]`)}(t,i,e);case"?":return void function(t,e,i){if(void 0===t)return;const[,r]=i;Ct(t,r,e)}(t,i,e);case"|":return void function(t,e,i){const[,...r]=i;let n=Error(`No type has been defined for this alternative: ${JSON.stringify(i)}!`);for(const i of r)try{return void Ct(t,i,e)}catch(t){t instanceof Error&&(n=t)}throw n}(t,i,e);case"tuple":return void function(t,e,[,...i]){if(function(t,e="data"){if(!Array.isArray(t))throw Error(`${e} was expected to be an Array but we got ${typeof t}!`)}(t),i.length!==t.length)throw Error(`Expected ${e} to have ${i.length} elements, not ${t.length}!`);for(let r=0;r<i.length;r++){const n=i[r];Ct(t[r],n,`${e}[$i]`)}}(t,i,e);case"partial":return void function(t,e,[,i]){!function(t,e="data"){if(!Rt(t))throw Error(`${e} was expected to be an object but we got ${typeof t}!`)}(t,e);for(const r of Object.keys(i)){if("string"!=typeof r)continue;const n=t[r];void 0!==n&&Ct(n,i[r],`${e}.${r}`)}}(t,i,e);case"literal":return void function(t,e,i){const[,...r]=i;for(const e of r)if(t===e)return;throw Error(`Expected ${e} to be a literal (${r.map((t=>`"${t}"`)).join(" | ")})!`)}(t,i,e);default:if(r.startsWith("array("))return void function(t,e,i,r){if(!Array.isArray(t))throw Error(`Expected ${e} to be an array and not a ${typeof t}!`);if(t.length!==r)throw Error(`${e} was expected to have a length of ${r}, but we got ${t.length}!`);const[,n]=i;for(let i=0;i<t.length;i+=1)Ct(t[i],n,`${e}[${i}]`)}(t,i,e,parseInt(r.substring(6,r.length-1),10));throw Error(`Don't know how to create a type guard for this kind of type: ${JSON.stringify(e)}`)}}if("object"!=typeof t)throw Error(`Expected ${i} to be an object and not a ${typeof t}!`);const r=t;for(const t of Object.keys(e))"string"==typeof t&&Ct(r[t],e[t],`${i}.${t}`)}function It(t){Ct(t,["partial",{accessors:["array",{bufferView:["?","number"],byteOffset:["?","number"],componentType:"number",normalized:["?","boolean"],count:"number",type:"string",name:["?","string"]}],meshes:["array",{name:"string",primitives:["array",{attributes:["map","number"],indices:["?","number"],mode:["?","number"],material:["?","number"]}]}],images:["array",["partial",{bufferView:"number",mimeType:"string",name:"string",uri:"string"}]],bufferViews:["array",{buffer:"number",byteLength:"number",byteOffset:["?","number"],byteStride:["?","number"],target:["?","number"]}],materials:["array",Lt],samplers:["array",["partial",{minFilter:"number",magFilter:"number",wrapS:"number",wrapT:"number",name:"string"}]],textures:["array",["partial",{sampler:"number",source:"number",name:"string"}]]}])}const Ut={index:"number",texCoord:["?","number"]},Lt=["partial",{name:"string",pbrMetallicRoughness:["partial",{baseColorFactor:["array(4)","number"],baseColorTexture:Ut,metallicFactor:"number",roughnessFactor:"number",metalicRoughnessTexture:Ut}],normalTexture:{...Ut,scale:["?","number"]},occlusionTexture:{...Ut,strength:["?","number"]},emissiveTexture:Ut,alphaMode:["literal","OPAQUE","MASK","BLEND"],alphaCutoff:"number",doubleSided:"boolean"}];class Vt{gltf;chunks;cacheImages=new Map;cacheImageURLs=new Map;cacheBufferViewDatas=new Map;constructor(t){try{const e=function(t){const e=new DataView(t);if(1179937895!==e.getUint32(0,!0))throw Error("Invalid magic number for GLB file!");const i=e.getUint32(4,!0);if(2!==i)throw Error(`We support only version 2, but this file is in version ${i}!`);const r=e.getUint32(8,!0);let n={};const s=[];let o=12;for(;o<r;){const i=e.getUint32(o,!0);o+=4;const r=e.getUint32(o,!0);o+=4;const a=t.slice(o,o+i);if(o+=i,1313821514===r){const t=(new TextDecoder).decode(a);try{const e=JSON.parse(t);console.log(e),It(e),n=e}catch(e){throw console.error("Unable to parse this JSON file:",t),console.error(e),Error("Invalid JSON data in the chunk!")}}else{if(5130562!==r)throw Error(`We got an invalid chunk type: 0x${r.toString(16).padStart(8,"0")}!`);s.push(a)}}return{gltf:n,chunks:s}}(t);this.gltf=e.gltf,this.chunks=e.chunks}catch(t){const e=t instanceof Error?t.message:JSON.stringify(t);throw Error(`[TgdParserGLTransfertFormatBinary] ${e}`)}}getScenes(){return this.gltf.scenes??[]}getScene(t){const e=this.gltf.scenes?.[t];if(!e)throw Error(`Asset has no scene with index #${t}!`);return e}getNode(t){const e=this.gltf.nodes?.[t];if(!e)throw Error(`Asset has no node with index #${t}!`);return e}getAccessor(t=0){const e=this.gltf.accessors?.[t];if(!e)throw Error(`Asset has no accessor with index #${t}!`);return e}getMaterial(t){const e=this.gltf.materials?.[t];if(!e)throw Error(`Asset has no material with index #${t}!`);return e}getMesh(t=0){const e=this.gltf.meshes?.[t];if(!e)throw Error(`Asset has no mesh with index #${t}!`);return e}getMeshPrimitive(t=0,e=0){const i=this.getMesh(t).primitives[e];if(!i)throw Error(`Asset has no primitive #${e} in mesh #${t}!`);return i}getMeshPrimitiveIndices(t=0,e=0){const i=this.getMeshPrimitive(t,e),r=this.getAccessor(i.indices??0),n=this.getBufferViewData(r.bufferView??0);return{type:r.componentType,buff:n,elemCount:r.count}}getTexture2DOptions(t){const e=this.gltf.textures?.[t];if(!e)throw Error(`Asset has no texture with index #${t}!`);const i=e.source??e.extensions?.EXT_texture_webp?.source??0;return{image:this.getImageURL(i)}}async loadImage(t){const e=this.cacheImages.get(t);if(e)return e;const i=this.getImageURL(t);if(!i)return;const r=new Promise(((e,r)=>{const n=new Image;n.src=i,n.onload=()=>{e(n)},n.onerror=()=>{console.error(`Unable to load image #${t}!`,this.gltf.images?.[t]),r()}}));return this.cacheImages.set(t,r),r}getImageURL(t){const e=this.cacheImageURLs.get(t);if(e)return e;const{gltf:i}=this,r=i.images?.[t];if(!r)return;if(r.uri)return r.uri;if("number"!=typeof r.bufferView)return;const n=this.getBufferViewData(r.bufferView);if(!n)return;const s=new Blob([n],{type:r.mimeType}),o=URL.createObjectURL(s);return this.cacheImageURLs.set(t,o),o}getBufferViewData(t){const e=this.cacheBufferViewDatas.get(t);if(e)return e;const{gltf:i}=this,r=i.bufferViews?.[t];if(!r)throw Error(`No bufferView with index #${t}!`);const n=this.chunks[r.buffer],s=r.byteOffset??0,o=n.slice(s,s+r.byteLength);return this.cacheBufferViewDatas.set(t,o),o}setAttrib(t,e,i=0,r=0,n){const{gltf:s}=this,o=s.meshes?.[i].primitives[r].attributes[n??e]??-1,a=s.accessors?.[o];if(!a)throw Error(`No attribute "${n??e}" for primitive #${r} of mesh #${i}!`);const h=a.bufferView??0,c=s.bufferViews?.[h];if(!c)throw Error(`No bufferView with index #${h}!`);const u=this.getBufferViewData(h);t.set(e,u,{byteStride:c.byteStride,byteOffset:a.byteOffset,count:a.count})}}class Ft{name="Mesh";attPosition=[];attNormal=[];attUV=[];elements=[];elementIndex=0;mapVertices=new Map;points=[];normals=[];verticesPerTriangle=[];normalPerTriangle=[];trianglesPerVertex=[];uvs=[];parse(t,{computeNormals:e}={}){this.reset();const{onVertex:i,onNormal:r,onTexture:n,onFace:s,onObject:o,name:a,elements:h}=this;!function(t,e={}){const{onVertex:i,onNormal:r,onTexture:n,onFace:s,onObject:o}=e;for(const e of function*(t){const e=t.length;let i=0,r=0;for(;i>-1&&i<e&&(i=t.indexOf("\n",r),!(i<0));)yield t.substring(r,i).trim(),r=i+1;return t.substring(r).trim()}(t)){const t=e.trimStart();if(i&&t.startsWith("v ")){const e=t.substring(2).split(" ").map((t=>Number(t)));Nt(e)&&i(...e)}else if(s&&t.startsWith("f "))s(t.substring(2).split(" ").map((t=>{const[e,i,r]=t.split("/");return{vertex:Number(e)-1,normal:r?Number(r)-1:void 0,uv:i?Number(i)-1:void 0}})));else if(r&&t.startsWith("vn ")){const e=t.substring(3).split(" ").map((t=>Number(t)));Nt(e)&&r(...e)}else if(n&&t.startsWith("vt ")){const[e,i,r]=t.substring(3).split(" ").map((t=>Number(t)));n(e,i,r)}else o&&t.startsWith("o ")&&o(t.substring(2))}}(t,{onVertex:i,onNormal:r,onTexture:n,onFace:s,onObject:o}),e&&this.computeNormals();const c={name:a,count:h.length,attPosition:new Float32Array(this.attPosition)};this.attNormal.length>0&&(c.attNormal=new Float32Array(this.attNormal)),this.attUV.length>0&&(c.attUV=new Float32Array(this.attUV));const{elementIndex:u}=this;return u<=256?{...c,type:"UNSIGNED_BYTE",elements:new Uint8Array(h)}:u<=65536?{...c,type:"UNSIGNED_SHORT",elements:new Uint16Array(h)}:{...c,type:"UNSIGNED_INT",elements:new Uint32Array(h)}}computeNormals(){const t=new o,e=new o,i=new o;this.normalPerTriangle.forEach(((r,n)=>{const[s,o,a]=this.verticesPerTriangle[n];this.readVertexInto(s,t),this.readVertexInto(o,e).subtract(t),this.readVertexInto(a,i).subtract(t),r.from(e.cross(i).normalize())})),this.attNormal=[];for(let t=0;t<this.elementIndex;t++){const e=new o(0,0,0);this.trianglesPerVertex[t].forEach((t=>e.add(this.normalPerTriangle[t])));const[i,r,n]=e.normalize();this.attNormal.push(i,r,n)}}reset(){this.name="Mesh",this.attPosition=[],this.attNormal=[],this.attUV=[],this.elements=[],this.elementIndex=0,this.points=[],this.normals=[],this.verticesPerTriangle=[],this.trianglesPerVertex=[],this.normalPerTriangle=[],this.uvs=[],this.mapVertices.clear(),this.mapVertices.clear()}onObject=t=>{this.name=t};onVertex=(t,e,i)=>{this.points.push([t,e,i])};onNormal=(t,e,i)=>{this.normals.push([t,e,i])};onTexture=(t,e)=>{this.uvs.push([t,e])};onFace=t=>{if(3!==t.length)throw Error("We can only deal with triangles!");const e=t.map(this.getElem);this.elements.push(...e),this.normalPerTriangle.push(new o(0,0,0)),this.verticesPerTriangle.push(e);const i=this.normalPerTriangle.length-1;e.forEach((t=>{this.trianglesPerVertex[t]??=[],this.trianglesPerVertex[t].push(i)}))};getElem=t=>{const e=this.key(t),i=this.mapVertices.get(e)??-1;if(i>-1)return i;const[r,n,s]=this.points[t.vertex];if(this.attPosition.push(r,n,s),"number"==typeof t.normal){const[e,i,r]=this.normals[t.normal];this.attNormal.push(e,i,r)}if("number"==typeof t.uv){const[e,i]=this.uvs[t.uv];this.attUV.push(e,i)}return this.mapVertices.set(e,this.elementIndex),this.elementIndex++};key(t){return`${t.vertex}/${t.normal}`}readVertexInto(t,e){const i=this.attPosition,r=3*t;return e.reset(i[r+0],i[r+1],i[r+2]),e}}function Nt(t){return 3===t.length}}}]);