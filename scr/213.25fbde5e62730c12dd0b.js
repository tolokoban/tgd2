"use strict";(self.webpackChunk_tolokoban_tgd=self.webpackChunk_tolokoban_tgd||[]).push([[213],{4213:(t,e,i)=>{function n(t){if(t instanceof Uint8Array)return WebGL2RenderingContext.UNSIGNED_BYTE;if(t instanceof Uint16Array)return WebGL2RenderingContext.UNSIGNED_SHORT;if(t instanceof Uint32Array)return WebGL2RenderingContext.UNSIGNED_INT;throw Error("[webglElementTypeFromDataView] drawElements() and drawElementsInstanced() can only be fed with Uint8Array, Uint16Array or Uint32Array!")}function r(t){if(s)for(const e in s)if(s[e]===t)return e;return`${t}`}i.d(e,{P6:()=>w,xN:()=>R,Gb:()=>qt,tf:()=>tt,pw:()=>et,I9:()=>mt,Ei:()=>Jt,vA:()=>ee,Li:()=>ie,Ch:()=>ne,i0:()=>re,HB:()=>se,oq:()=>St,U5:()=>Nt,rB:()=>Lt,$H:()=>Ft,qD:()=>Ot,M3:()=>Bt,_9:()=>m,tb:()=>S,b6:()=>Et,o5:()=>vt,iF:()=>bt,AN:()=>At,D$:()=>Tt,K7:()=>Mt,ZJ:()=>Ct,g6:()=>Vt,dR:()=>$t,bu:()=>zt,$f:()=>jt,Ip:()=>Zt,FX:()=>de,qj:()=>fe,a6:()=>ht,HI:()=>x,_u:()=>be,HT:()=>Wt,hN:()=>c,o:()=>u,ZV:()=>xt,vR:()=>N,P1:()=>U,bj:()=>F,Cd:()=>st,oj:()=>O,vS:()=>xe,TC:()=>pe,V_:()=>Ee,Lm:()=>n,aM:()=>W,Tf:()=>H,Eg:()=>Z,d7:()=>K});const s=document.createElement("canvas").getContext("webgl2");function o(t,e=6){const i=Math.pow(10,e),n=[];let r=0;for(const s of t){const t=(Math.round(s*i)/i).toFixed(e);r=Math.max(r,t.length),n.push(t)}return n.map((t=>t.padStart(r," ")))}function a(t,e,i){return t<e?e:t>i?i:t}function h(t,e,i){return(1-i)*t+i*e}class c extends Float32Array{static newFrom([t,e,i]){return new c(t,e,i)}static newFromMix([t,e,i],[n,r,s],o=.5){const a=1-o;return new c(a*t+o*n,a*e+o*r,a*i+o*s)}static distance(t,e){const i=e.x-t.x,n=e.y-t.y,r=e.z-t.z;return Math.sqrt(i*i+n*n+r*r)}constructor(t=0,e=0,i=0){if(super(3),"number"!=typeof t)return this.x=t[0],this.y=t[1],void(this.z=t[2]);this.x=t,this.y=e,this.z=i}clone(){return new c(this)}mix(t,e=.5){return this.x=(1-e)*this.x+e*t.x,this.y=(1-e)*this.y+e*t.y,this.z=(1-e)*this.z+e*t.z,this}isEqual(t){const[e,i,n]=t;return e===this.x&&i===this.y&&n===this.z}isClose(t,e=1e-6){const[i,n,r]=t;return!(Math.abs(i-this.x)>e||Math.abs(n-this.y)>e||Math.abs(r-this.z)>e)}rotateAround(t,e){const i=Math.cos(e),n=Math.sin(e),[r,s,o]=this,[a,h,c]=t,u=h*o-c*s,l=c*r-a*o,d=a*s-h*r,m=(r*a+s*h+o*c)*(1-i);return this.x=r*i+u*n+a*m,this.y=s*i+l*n+h*m,this.z=o*i+d*n+c*m,this}applyMatrix(t){const{x:e,y:i,z:n}=this;return this.x=e*t.m00+i*t.m10+n*t.m20,this.y=e*t.m01+i*t.m11+n*t.m21,this.z=e*t.m02+i*t.m12+n*t.m22,this}from(t){const[e,i,n]=t;return this.x=e,this.y=i,this.z=n,this}fromMix(t,e,i){const[n,r,s]=t,[o,a,c]=e;return this.reset(h(n,o,i),h(r,a,i),h(s,c,i))}reset(t,e,i){return this[0]=t,this[1]=e,this[2]=i,this}distanceToLineSquared(t,e){const[i,n,r]=this,[s,o,a]=t,[h,c,u]=e,l=h*(i-s)+c*(n-o)+u*(r-a),d=i-(s+l*h),m=n-(o+l*c),f=r-(a+l*u);return d*d+m*m+f*f}get x(){return this[0]}set x(t){this[0]=t}get y(){return this[1]}set y(t){this[1]=t}get z(){return this[2]}set z(t){this[2]=t}add(...t){for(const e of t)this[0]+=e.x,this[1]+=e.y,this[2]+=e.z;return this}addWithScale(t,e){return this[0]+=t.x*e,this[1]+=t.y*e,this[2]+=t.z*e,this}subtract(t){return this[0]-=t[0],this[1]-=t[1],this[2]-=t[2],this}scale(t){return this[0]*=t,this[1]*=t,this[2]*=t,this}dot(t){return this[0]*t[0]+this[1]*t[1]+this[2]*t[2]}get size(){return Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2])}normalize(){const t=this[0]*this[0]+this[1]*this[1]+this[2]*this[2];return 0===t?this:this.scale(1/Math.sqrt(t))}cross(t){const[e,i,n]=this,[r,s,o]=t;return this[0]=i*o-s*n,this[1]=n*r-o*e,this[2]=e*s-r*i,this}random(){return this[0]=Math.random()-.5,this[1]=Math.random()-.5,this[2]=Math.random()-.5,this}debug(t="vec3"){const{x:e,y:i,z:n}=this,r=[e,i,n].map((t=>t.toFixed(6)));console.log(`${t}:   `,r.join(" | "),"   length:",Math.sqrt(e*e+i*i+n*n))}}class u extends Float32Array{constructor(t=0,e=0,i=0,n=1){if(super(4),t instanceof u)return this.x=t.x,this.y=t.y,this.z=t.z,void(this.w=t.w);if(t instanceof c)return this.x=t.x,this.y=t.y,this.z=t.z,void(this.w=n);if(Array.isArray(t)){if("number"==typeof e){const[i,n,r]=t;return this.x=null!=i?i:0,this.y=null!=n?n:0,this.z=null!=r?r:0,void(this.w=e)}{const[e,i,n,r]=t;return this.x=null!=e?e:0,this.y=null!=i?i:0,this.z=null!=n?n:0,void(this.w=null!=r?r:1)}}this.x=t,this.y=e,this.z=i,this.w=n}reset(t=0,e=0,i=0,n=1){return this.x=t,this.y=e,this.z=i,this.w=n,this}from(t){const[e,i,n,r]=t;return this.x=e,this.y=i,this.z=n,this.w=r,this}clone(){return new u(this)}mix(t,e=.5){return this.x=(1-e)*this.x+e*t.x,this.y=(1-e)*this.y+e*t.y,this.z=(1-e)*this.z+e*t.z,this.w=(1-e)*this.w+e*t.w,this}isEqual(t){const[e,i,n,r]=t;return e===this.x&&i===this.y&&n===this.z&&r===this.w}isClose({x:t,y:e,z:i,w:n},r=1e-6){return!(Math.abs(t-this.x)>r||Math.abs(e-this.y)>r||Math.abs(i-this.z)>r||Math.abs(n-this.w)>r)}applyMatrix(t){const{x:e,y:i,z:n,w:r}=this;return this.x=e*t.m00+i*t.m10+n*t.m20+r*t.m30,this.y=e*t.m01+i*t.m11+n*t.m21+r*t.m31,this.z=e*t.m02+i*t.m12+n*t.m22+r*t.m32,this.w=e*t.m03+i*t.m13+n*t.m23+r*t.m33,this}get x(){return this[0]}set x(t){this[0]=t}get y(){return this[1]}set y(t){this[1]=t}get z(){return this[2]}set z(t){this[2]=t}get w(){return this[3]}set w(t){this[3]=t}add(...t){for(const e of t)this[0]+=e[0],this[1]+=e[1],this[2]+=e[2],e.length>3&&(this[3]+=e[3]);return this}subtract(t){return this[0]-=t[0],this[1]-=t[1],this[2]-=t[2],t.length>3&&(this[3]-=t[3]),this}scale(t){return this[0]*=t,this[1]*=t,this[2]*=t,this[3]*=t,this}dot(t){return this[0]*t[0]+this[1]*t[1]+this[2]*t[2]+this[3]*t[3]}get size(){return Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2]+this[3]*this[3])}normalize(){const t=this[0]*this[0]+this[1]*this[1]+this[2]*this[2]+this[3]*this[3];return 0===t?this:this.scale(1/Math.sqrt(t))}debug(t="vec4"){const{x:e,y:i,z:n,w:r}=this,s=[e,i,n,r].map((t=>t.toFixed(6)));console.log(`${t}:   `,s.join(" | "))}}class l extends Float32Array{constructor(t=1,e=0,i=0,n=0,r=1,s=0,o=0,a=0,h=1){if("number"==typeof t&&"number"==typeof e&&"number"==typeof i)super([t,e,i,n,r,s,o,a,h]);else if((t instanceof c||t instanceof u)&&(e instanceof c||e instanceof u)&&(i instanceof c||i instanceof u)){const n=t,r=e,s=i;super([n.x,n.y,n.z,r.x,r.y,r.z,s.x,s.y,s.z])}else{if(!(t instanceof l))throw console.error("[TgdMat3] m00, m01, m02 = ",t,e,i),console.error("[TgdMat3] m10, m11, m12 = ",n,r,s),console.error("[TgdMat3] m20, m21, m22 = ",o,a,h),Error("Invalid TgdMat3 initialization!");super(t)}}multiply(t){const[e,i,n,r,s,o,a,h,c]=this,[u,l,d,m,f,g,p,x,E]=t;return this.m00=e*u+r*l+a*d,this.m10=e*m+r*f+a*g,this.m20=e*p+r*x+a*E,this.m01=i*u+s*l+h*d,this.m11=i*m+s*f+h*g,this.m21=i*p+s*x+h*E,this.m02=n*u+o*l+c*d,this.m12=n*m+o*f+c*g,this.m22=n*p+o*x+c*E,this}transpose(){let t=this.m10;return this.m10=this.m01,this.m01=t,t=this.m20,this.m20=this.m02,this.m02=t,t=this.m21,this.m21=this.m12,this.m12=t,this}fromQuat({x:t,y:e,z:i,w:n}){const r=t+t,s=e+e,o=i+i,a=t*r,h=e*r,c=e*s,u=i*r,l=i*s,d=i*o,m=n*r,f=n*s,g=n*o;return this.m00=1-c-d,this.m10=h-g,this.m20=u+f,this.m01=h+g,this.m11=1-a-d,this.m21=l-m,this.m02=u-f,this.m12=l+m,this.m22=1-a-c,this}toAxis(t,e,i){return this.toAxisX(t),this.toAxisY(e),this.toAxisZ(i)}toAxisX(t){return t.x=this.m00,t.y=this.m01,t.z=this.m02,this}toAxisY(t){return t.x=this.m10,t.y=this.m11,t.z=this.m12,this}toAxisZ(t){return t.x=this.m20,t.y=this.m21,t.z=this.m22,this}scale(t){return this[0]*=t,this[1]*=t,this[2]*=t,this[3]*=t,this[4]*=t,this[5]*=t,this[6]*=t,this[7]*=t,this[8]*=t,this}get m00(){return this[0]}set m00(t){this[0]=t}get m01(){return this[1]}set m01(t){this[1]=t}get m02(){return this[2]}set m02(t){this[2]=t}get m10(){return this[3]}set m10(t){this[3]=t}get m11(){return this[4]}set m11(t){this[4]=t}get m12(){return this[5]}set m12(t){this[5]=t}get m20(){return this[6]}set m20(t){this[6]=t}get m21(){return this[7]}set m21(t){this[7]=t}get m22(){return this[8]}set m22(t){this[8]=t}debug(t="Mat3"){const e=o([this.m00,this.m01,this.m02]),i=o([this.m10,this.m11,this.m12]),n=o([this.m20,this.m21,this.m22]);console.log(t),console.log("   ",[e[0],i[0],n[0]].join(" | ")),console.log("   ",[e[1],i[1],n[1]].join(" | ")),console.log("   ",[e[2],i[2],n[2]].join(" | "))}}class d extends Float32Array{constructor(t=1,e=0,i=0,n=0,r=0,s=1,o=0,a=0,h=0,c=0,u=1,l=0,d=0,m=0,f=0,g=1){super("number"==typeof t?[t,e,i,n,r,s,o,a,h,c,u,l,d,m,f,g]:t)}multiply(t){const[e,i,n,r,s,o,a,h,c,u,l,d,m,f,g,p]=this,[x,E,v,b,A,_,y,T,w,R,M,C,P,S,L,N]=t;return this.m00=e*x+s*E+c*v+m*b,this.m10=e*A+s*_+c*y+m*T,this.m20=e*w+s*R+c*M+m*C,this.m30=e*P+s*S+c*L+m*N,this.m01=i*x+o*E+u*v+f*b,this.m11=i*A+o*_+u*y+f*T,this.m21=i*w+o*R+u*M+f*C,this.m31=i*P+o*S+u*L+f*N,this.m02=n*x+a*E+l*v+g*b,this.m12=n*A+a*_+l*y+g*T,this.m22=n*w+a*R+l*M+g*C,this.m32=n*P+a*S+l*L+g*N,this.m03=r*x+h*E+d*v+p*b,this.m13=r*A+h*_+d*y+p*T,this.m23=r*w+h*R+d*M+p*C,this.m33=r*P+h*S+d*L+p*N,this}invert(t){const[e,i,n,r,s,o,a,h,c,u,l,d,m,f,g,p]=null!=t?t:this,x=e*o-i*s,E=e*a-n*s,v=e*h-r*s,b=i*a-n*o,A=i*h-r*o,_=n*h-r*a,y=c*f-u*m,T=c*g-l*m,w=c*p-d*m,R=u*g-l*f,M=u*p-d*f,C=l*p-d*g,P=x*C-E*M+v*R+b*w-A*T+_*y;if(!P)return this;const S=1/P;return this[0]=(o*C-a*M+h*R)*S,this[1]=(n*M-i*C-r*R)*S,this[2]=(f*_-g*A+p*b)*S,this[3]=(l*A-u*_-d*b)*S,this[4]=(a*w-s*C-h*T)*S,this[5]=(e*C-n*w+r*T)*S,this[6]=(g*v-m*_-p*E)*S,this[7]=(c*_-l*v+d*E)*S,this[8]=(s*M-o*w+h*y)*S,this[9]=(i*w-e*M-r*y)*S,this[10]=(m*A-f*v+p*x)*S,this[11]=(u*v-c*A-d*x)*S,this[12]=(o*T-s*R-a*y)*S,this[13]=(e*R-i*T+n*y)*S,this[14]=(f*E-m*b-g*x)*S,this[15]=(c*b-u*E+l*x)*S,this}get translation(){const{m30:t,m31:e,m32:i}=this;return new c(t,e,i)}set translation(t){const[e,i,n]=t;this.m30=e,this.m31=i,this.m32=n}toTanslation(t){return t.x=this.m30,t.y=this.m31,t.z=this.m32,this}translate(t){const[e,i,n]=t;return this.m30+=e,this.m31+=i,this.m32+=n,this}from(t){const[e,i,n,r,s,o,a,h,c,u,l,d,m,f,g,p]=t;return this.m00=e,this.m01=i,this.m02=n,this.m03=r,this.m10=s,this.m11=o,this.m12=a,this.m13=h,this.m20=c,this.m21=u,this.m22=l,this.m23=d,this.m30=m,this.m31=f,this.m32=g,this.m33=p,this}fromMat3(t){return this.m00=t.m00,this.m01=t.m01,this.m02=t.m02,this.m10=t.m10,this.m11=t.m11,this.m12=t.m12,this.m20=t.m20,this.m21=t.m21,this.m22=t.m22,this}toAxis(t,e,i){return this.toAxisX(t),this.toAxisY(e),this.toAxisZ(i)}toAxisX(t){return t.x=this.m00,t.y=this.m01,t.z=this.m02,this}toAxisY(t){return t.x=this.m10,t.y=this.m11,t.z=this.m12,this}toAxisZ(t){return t.x=this.m20,t.y=this.m21,t.z=this.m22,this}fromQuat({x:t,y:e,z:i,w:n}){const r=t+t,s=e+e,o=i+i,a=t*r,h=e*r,c=e*s,u=i*r,l=i*s,d=i*o,m=n*r,f=n*s,g=n*o;return this.m00=1-c-d,this.m10=h-g,this.m20=u+f,this.m01=h+g,this.m11=1-a-d,this.m21=l-m,this.m02=u-f,this.m12=l+m,this.m22=1-a-c,this}get m00(){return this[0]}set m00(t){this[0]=t}get m01(){return this[1]}set m01(t){this[1]=t}get m02(){return this[2]}set m02(t){this[2]=t}get m03(){return this[3]}set m03(t){this[3]=t}get m10(){return this[4]}set m10(t){this[4]=t}get m11(){return this[5]}set m11(t){this[5]=t}get m12(){return this[6]}set m12(t){this[6]=t}get m13(){return this[7]}set m13(t){this[7]=t}get m20(){return this[8]}set m20(t){this[8]=t}get m21(){return this[9]}set m21(t){this[9]=t}get m22(){return this[10]}set m22(t){this[10]=t}get m23(){return this[11]}set m23(t){this[11]=t}get m30(){return this[12]}set m30(t){this[12]=t}get m31(){return this[13]}set m31(t){this[13]=t}get m32(){return this[14]}set m32(t){this[14]=t}get m33(){return this[15]}set m33(t){this[15]=t}debug(t="Mat4"){const e=o([this.m00,this.m01,this.m02,this.m03]),i=o([this.m10,this.m11,this.m12,this.m13]),n=o([this.m20,this.m21,this.m22,this.m23]),r=o([this.m30,this.m31,this.m32,this.m33]);console.log(t),console.log("   ",[e[0],i[0],n[0],r[0]].join(" | ")),console.log("   ",[e[1],i[1],n[1],r[1]].join(" | ")),console.log("   ",[e[2],i[2],n[2],r[2]].join(" | ")),console.log("   ",[e[3],i[3],n[3],r[3]].join(" | "))}}class m{static radiansToDegrees(t){return 180*t*m.INVERSE_PI}static degreesToRadians(t){return t*Math.PI*m.INVERSE_180}}m.TAU=2*Math.PI,m.INVERSE_TAU=.5/Math.PI,m.INVERSE_PI=1/Math.PI,m.INVERSE_180=1/180;const f=new c,g=new c,p=new c;class x extends u{static fromMatrix(t){const e=new x;return e.fromMatrix(t),e}constructor(t=0,e=0,i=0,n=1){"number"==typeof t?super(t,e,i,n):super(t)}clone(){return new x(this)}multiply(t){const[e,i,n,r]=this,[s,o,a,h]=t;return this[0]=h*e+s*r-o*n+a*i,this[1]=h*i+s*n+o*r-a*e,this[2]=h*n-s*i+o*e+a*r,this[3]=h*r-s*e-o*i-a*n,this}fromSlerp(t,e,i){const[n,r,s,o]=t;let a,h,[c,u,l,d]=e,m=n*c+r*u+s*l+o*d;if(m<0&&(m=-m,c=-c,u=-u,l=-l,d=-d),1-m>1e-6){const t=Math.acos(m),e=1/Math.sin(t);a=Math.sin((1-i)*t)*e,h=Math.sin(i*t)*e}else a=1-i,h=i;return this.x=a*n+h*c,this.y=a*r+h*u,this.z=a*s+h*l,this.w=a*o+h*d,this}fromAxis(t,e,i){const n=t.x+e.y+i.z;if(n>0){const r=Math.sqrt(n+1);this.w=.5*r;const s=.5/r;this.x=(e.z-i.y)*s,this.y=(i.x-t.z)*s,this.z=(t.y-e.x)*s}else{const n=[t,e,i];let r=0;e.y>t.x&&(r=1),i.z>n[r][r]&&(r=2);const s=(r+1)%3,o=(r+2)%3;let a=Math.sqrt(n[r][r]-n[s][s]-n[o][o]+1);this[r]=.5*a,a=.5/a,this[3]=(n[s][o]-n[o][s])*a,this[s]=(n[s][r]+n[r][s])*a,this[o]=(n[o][r]+n[r][o])*a}return this.normalize()}fromMatrix(t){return f.x=t.m00,f.y=t.m01,f.z=t.m02,g.x=t.m10,g.y=t.m11,g.z=t.m12,p.x=t.m20,p.y=t.m21,p.z=t.m22,this.fromAxis(f,g,p)}rotateAround(t,e){return this.toAxisX(f),this.toAxisY(g),this.toAxisZ(p),f.rotateAround(t,e),g.rotateAround(t,e),p.rotateAround(t,e),this.fromAxis(f,g,p)}static rotateAroundX(t){return(new x).rotateAroundX(t)}rotateAroundX(t){const e=.5*t,i=this[0],n=this[1],r=this[2],s=this[3],o=Math.sin(e),a=Math.cos(e);return this[0]=i*a+s*o,this[1]=n*a+r*o,this[2]=r*a-n*o,this[3]=s*a-i*o,this}static rotateAroundY(t){return(new x).rotateAroundY(t)}rotateAroundY(t){const e=.5*t,i=this[0],n=this[1],r=this[2],s=this[3],o=Math.sin(e),a=Math.cos(e);return this[0]=i*a-r*o,this[1]=n*a+s*o,this[2]=r*a+i*o,this[3]=s*a-n*o,this}static rotateAroundZ(t){return(new x).rotateAroundZ(t)}rotateAroundZ(t){const e=.5*t,i=this[0],n=this[1],r=this[2],s=this[3],o=Math.sin(e),a=Math.cos(e);return this[0]=i*a+n*o,this[1]=n*a-i*o,this[2]=r*a+s*o,this[3]=s*a-r*o,this}toAxisX(t){const[e,i,n,r]=this,s=e+e,o=i+i,a=n+n,h=i*s,c=i*o,u=n*s,l=n*a,d=r*o,m=r*a;return t.x=1-c-l,t.y=h-m,t.z=u+d,t}toAxisY(t){const[e,i,n,r]=this,s=e+e,o=n+n,a=e*s,h=i*s,c=n*(i+i),u=n*o,l=r*s,d=r*o;return t.x=h+d,t.y=1-a-u,t.z=c-l,t}toAxisZ(t){const{x:e,y:i,z:n,w:r}=this,s=e+e,o=i+i,a=e*s,h=i*o,c=n*s,u=n*o,l=r*s,d=r*o;return t.x=c-d,t.y=u+l,t.z=1-a-h,t}toMatrix(t){const e=new c,i=new c,n=new c;return this.toAxisX(e),this.toAxisY(i),this.toAxisZ(n),t.m00=e.x,t.m10=e.y,t.m20=e.z,t.m01=i.x,t.m11=i.y,t.m21=i.z,t.m02=n.x,t.m12=n.y,t.m22=n.z,t}face(t="+X+Y+Z"){const[e,i,n,r]=b[t];return this.x=e,this.y=i,this.z=n,this.w=r,this}}const E=Math.sqrt(2)/2,v=.5,b={"+X+Y+Z":[0,0,0,1],"-Z+Y+X":[0,+E,0,+E],"-X+Y-Z":[0,1,0,0],"+Z+Y-X":[0,-E,0,+E],"+X+Z-Y":[+E,0,0,+E],"+Y+Z+X":[+v,+v,+v,+v],"-X+Z+Y":[0,+E,+E,0],"-Y+Z-X":[+v,-v,-v,+v],"+X-Y-Z":[1,0,0,0],"+X-Z+Y":[-E,0,0,+E],"-X-Y+Z":[0,0,1,0],"-X-Z-Y":[0,+E,-E,0],"+Y+X-Z":[+E,+E,0,0],"+Y-X+Z":[0,0,+E,+E],"+Y-Z-X":[+v,+v,-v,-v],"-Y+X+Z":[0,0,-E,+E],"-Y-X-Z":[+E,-E,0,0],"-Y-Z+X":[+v,-v,+v,-v],"+Z+X+Y":[+v,+v,+v,-v],"+Z-X-Y":[+v,-v,+v,+v],"+Z-Y+X":[+E,0,+E,0],"-Z+X-Y":[+v,+v,-v,+v],"-Z-X+Y":[+v,-v,-v,-v],"-Z-Y-X":[+E,0,-E,0]};class A{constructor(){this._matrix=new d(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this._position=new c(0,0,0),this._orientation=new x(0,0,0,1),this._scale=new c(1,1,1),this.tmpMat3=new l,this.tmpVec3=new c,this.dirty=!1,this._updateCount=0}get updateCount(){return this._updateCount}get matrix(){if(this.dirty){const t=this._matrix;t.m03=0,t.m13=0,t.m23=0,t.m33=1;const[e,i,n]=this._position;t.m30=e,t.m31=i,t.m32=n,t.fromQuat(this._orientation);const[r,s,o]=this._scale;t.m00*=r,t.m01*=r,t.m03*=r,t.m10*=s,t.m11*=s,t.m13*=s,t.m20*=o,t.m21*=o,t.m23*=o,this.dirty=!1}return this._matrix}set matrix(t){this._matrix.from(t),this._updateCount++,this.dirty=!1}get position(){return this._position}set position(t){this.setDirty(),this._position.from(t)}setPosition(t,e,i){return this.setDirty(),this._position.reset(t,e,i),this}get scale(){return this._scale}set scale(t){this.setDirty(),this._scale.from(t)}setScale(t,e,i){return this.setDirty(),this._scale.reset(t,e,i),this}get orientation(){return this._orientation}set orientation(t){this.setDirty(),this._orientation.from(t)}setOrientation(t,e,i,n){this.setDirty(),this._orientation.reset(t,e,i,n)}orbitAroundX(t){return this.tmpMat3.fromQuat(this._orientation),this.tmpMat3.toAxisX(this.tmpVec3),this._orientation.rotateAround(this.tmpVec3,t),this.setDirty(),this}orbitAroundY(t){return this.tmpMat3.fromQuat(this._orientation),this.tmpMat3.toAxisY(this.tmpVec3),this._orientation.rotateAround(this.tmpVec3,t),this.setDirty(),this}orbitAroundZ(t){return this.tmpMat3.fromQuat(this._orientation),this.tmpMat3.toAxisZ(this.tmpVec3),this._orientation.rotateAround(this.tmpVec3,t),this.setDirty(),this}setDirty(){this._updateCount++,this.dirty=!0}}class _ extends Float32Array{static fromMix(t,e,i=.5){const n=1-i,r=n*t.x+i*e.x,s=n*t.y+i*e.y;return new _(r,s)}static distance(t,e){const i=e.x-t.x,n=e.y-t.y;return Math.sqrt(i*i+n*n)}constructor(t=0,e=0){if(super(2),"number"!=typeof t)return this.x=t[0],void(this.y=t[1]);this.x=t,this.y=e}clone(){return new _(this)}mix(t,e=.5){return this.x=(1-e)*this.x+e*t.x,this.y=(1-e)*this.y+e*t.y,this}isEqual(t){const[e,i]=t;return e===this.x&&i===this.y}isClose(t,e=1e-6){const[i,n]=t;return!(Math.abs(i-this.x)>e||Math.abs(n-this.y)>e)}from(t){const[e,i]=t;return this.x=e,this.y=i,this}fromMix(t,e,i){const[n,r]=t,[s,o]=e;return this.reset(h(n,s,i),h(r,o,i))}reset(t,e){return this[0]=t,this[1]=e,this}get x(){return this[0]}set x(t){this[0]=t}get y(){return this[1]}set y(t){this[1]=t}add(...t){for(const e of t)this[0]+=e.x,this[1]+=e.y;return this}addWithScale(t,e){return this[0]+=t.x*e,this[1]+=t.y*e,this}subtract(t){return this[0]-=t[0],this[1]-=t[1],this}scale(t){return this[0]*=t,this[1]*=t,this}dot(t){return this[0]*t[0]+this[1]*t[1]}get size(){return Math.sqrt(this[0]*this[0]+this[1]*this[1])}normalize(){const t=this[0]*this[0]+this[1]*this[1];return 0===t?this:this.scale(1/Math.sqrt(t))}random(){return this[0]=Math.random()-.5,this[1]=Math.random()-.5,this}debug(t="vec2"){const{x:e,y:i}=this,n=[e,i].map((t=>t.toFixed(6)));console.log(`${t}:   `,n.join(" | "),"   length:",Math.sqrt(e*e+i*i))}}class y{constructor(){this.listeners=new Set}addListener(t){this.listeners.add(t)}removeListener(t){this.listeners.delete(t)}dispatch(t){this.listeners.forEach((e=>e(t)))}}class T{constructor(t={}){var e,i,n,r,s,o,a;this.eventTransformChange=new y,this._screenWidth=1920,this._screenHeight=1080,this._screenAspectRatio=1920/1080,this._dirtyModelView=!0,this.dirtyModelViewInverse=!0,this._dirtyAxis=!0,this._dirtyProjection=!0,this.dirtyProjectionInverse=!0,this._near=.001,this._far=1/0,this._axisX=new c,this._axisY=new c,this._axisZ=new c,this._matrixModelView=new d,this._matrixModelViewInverse=new d,this._matrixProjectionInverse=new d,this._orientation=new x(0,0,0,1).face("+X+Z-Y"),this._shift=new c(0,0,0),this._target=new c(0,0,0),this._position=new c(0,0,0),this._distance=10,this._zoom=1,this.tmpMat3=new l,this.tmpVec3=new c,this.name=null!==(e=t.name)&&void 0!==e?e:"TgdCamera#"+T.incrementalId++,this._near=null!==(i=t.near)&&void 0!==i?i:.001,this._far=null!==(n=t.far)&&void 0!==n?n:1e6,this._distance=null!==(r=t.distance)&&void 0!==r?r:10,this._zoom=null!==(s=t.zoom)&&void 0!==s?s:1;const[h,u,m]=null!==(o=t.target)&&void 0!==o?o:[0,0,0];this.target.reset(h,u,m);const[f,g,p,E]=null!==(a=t.orientation)&&void 0!==a?a:[0,0,0,1];this.orientation.reset(f,g,p,E)}getCurrentState(){return{distance:this.distance,orientation:this.orientation.clone(),shift:this.shift.clone(),spaceHeightAtTarget:this.spaceHeightAtTarget,target:this.target.clone(),zoom:this.zoom}}get near(){return this._near}set near(t){t!==this._near&&(this._near=t,this.dirtyProjection=!0)}get far(){return this._far}set far(t){t!==this._far&&(this._far=t,this.dirtyProjection=!0)}get screenAspectRatio(){return this._screenAspectRatio}get screenWidth(){return this._screenWidth}set screenWidth(t){t!==this._screenWidth&&(this._screenWidth=t,this.dirtyProjection=!0,this._screenAspectRatio=this._screenWidth/this._screenHeight)}get screenHeight(){return this._screenHeight}set screenHeight(t){t!==this._screenHeight&&(this._screenHeight=t,this.dirtyProjection=!0,this._screenAspectRatio=this._screenWidth/this._screenHeight)}get spaceHeightAtTarget(){return this.getSpaceHeightAtTarget()}set spaceHeightAtTarget(t){this.setSpaceHeightAtTarget(t)}get spaceWidthAtTarget(){return this.screenWidth*this.spaceHeightAtTarget/this.screenHeight}set spaceWidthAtTarget(t){this.setSpaceHeightAtTarget(t*this.screenHeight/this.screenWidth)}face(t){this._orientation.face(t),this.dirtyModelView=!0,this.dirtyAxis=!0}from(t){const{_orientation:e,_target:i,distance:n,zoom:r,screenWidth:s,screenHeight:o}=t;return this._orientation.from(e),this._target.from(i),this.distance=n,this.zoom=r,this.screenWidth=s,this.screenHeight=o,this.dirtyModelView=!0,this.dirtyAxis=!0,this.copyProjectionFrom(t),this}fromTransfo(t){const e=t.m30,i=t.m31,n=t.m32;return this.setTarget(e,i,n),this._orientation.fromMatrix(t),this.dirtyModelView=!0,this.dirtyAxis=!0,this}get axisX(){return this.updateAxisIfNeeded(),this._axisX}get axisY(){return this.updateAxisIfNeeded(),this._axisY}get axisZ(){return this.updateAxisIfNeeded(),this._axisZ}get matrixModelView(){return this.updateIfNeeded(),this._matrixModelView}get matrixModelViewInverse(){return this.dirtyModelViewInverse&&(this._matrixModelViewInverse.invert(this.matrixModelView),this.dirtyModelViewInverse=!1),this._matrixModelViewInverse}get matrixProjectionInverse(){return this.dirtyProjectionInverse&&(this._matrixProjectionInverse.invert(this.matrixProjection),this.dirtyProjectionInverse=!1),this._matrixProjectionInverse}get orientation(){return this._orientation}set orientation(t){const{_orientation:e}=this;if(t.isEqual(e))return;const[i,n,r,s]=t;e.x=i,e.y=n,e.z=r,e.w=s,this.dirtyModelView=!0,this.dirtyAxis=!0}setOrientation(t,e,i,n){const{_orientation:r}=this;return r.x=t,r.y=e,r.z=i,r.w=n,this.dirtyModelView=!0,this.dirtyAxis=!0,this}get position(){return this.updateIfNeeded(),this._position}get target(){return this._target}set target(t){this._target.from(t),this.dirtyModelView=!0}setTarget(t,e,i){const{_target:n}=this;return n.x=t,n.y=e,n.z=i,this.dirtyModelView=!0,this}get shift(){return this._shift}set shift(t){this._shift.from(t),this.dirtyModelView=!0}setShift(t,e,i){const{_shift:n}=this;return n.x=t,n.y=e,n.z=i,this.dirtyModelView=!0,this}get x(){return this._target.x}set x(t){const{_target:e}=this;t!==e.x&&(e.x=t,this.dirtyModelView=!0)}get y(){return this._target.y}set y(t){const{_target:e}=this;t!==e.y&&(e.y=t,this.dirtyModelView=!0)}get z(){return this._target.z}set z(t){const{_target:e}=this;t!==e.z&&(e.z=t,this.dirtyModelView=!0)}get distance(){return this._distance}set distance(t){this._distance!==t&&(this._distance=t,this.dirtyModelView=!0)}get zoom(){return this._zoom}set zoom(t){this._zoom!==t&&(this._zoom=t,this.dirtyModelView=!0)}moveTarget(t,e,i){const{_target:n}=this;this.updateAxisIfNeeded();const{_axisX:r,_axisY:s,_axisZ:o,tmpVec3:a}=this;a.from(r).scale(t).addWithScale(s,e).addWithScale(o,i),n.x+=a.x,n.y+=a.y,n.z+=a.z,this.dirtyModelView=!0}moveShift(t,e,i){const[n,r,s]=this._shift;this._shift.reset(t+n,e+r,i+s),this._dirtyModelView=!0}orbitAroundX(t){this.updateAxisIfNeeded();const{_axisX:e,_axisY:i,_axisZ:n,_orientation:r}=this;return i.rotateAround(e,t),n.rotateAround(e,t),r.fromAxis(e,i,n),this.dirtyModelView=!0,this}orbitAroundY(t){this.updateAxisIfNeeded();const{_axisX:e,_axisY:i,_axisZ:n,_orientation:r}=this;return e.rotateAround(i,t),n.rotateAround(i,t),r.fromAxis(e,i,n),this.dirtyModelView=!0,this}orbitAroundZ(t){this.updateAxisIfNeeded();const{_axisX:e,_axisY:i,_axisZ:n,_orientation:r}=this;return e.rotateAround(n,t),i.rotateAround(n,t),r.fromAxis(e,i,n),this.dirtyModelView=!0,this}debug(t){const e=null!=t?t:this.name;this._orientation.debug(`${e} orientation`),this._target.debug(`${e} target`),this._position.debug(`${e} position`),this.matrixModelView.debug(`${e} matrixModelView`),this.matrixProjection.debug(`${e} matrixProjection`)}updateAxisIfNeeded(){this.dirtyAxis&&this.updateAxis()}updateAxis(){const{tmpMat3:t}=this;t.fromQuat(this._orientation),t.toAxis(this._axisX,this._axisY,this._axisZ),this.dirtyAxis=!1}updateIfNeeded(){if(!this.dirtyModelView)return;const{tmpMat3:t,tmpVec3:e,_position:i}=this,n=this._matrixModelView;this.updateAxis();const r=this._distance,{x:s,y:o,z:a}=this._shift,{x:h,y:c,z:u}=this._target,{x:l,y:d,z:m}=this._axisZ;i.x=h+r*l,i.y=c+r*d,i.z=u+r*m,i.addWithScale(this._axisX,s),i.addWithScale(this._axisY,o),i.addWithScale(this._axisZ,a),e.from(i).applyMatrix(t.transpose()).scale(-1),n.m30=e.x,n.m31=e.y,n.m32=e.z,n.fromMat3(t),this.dirtyModelView=!1}get dirtyModelView(){return this._dirtyModelView}set dirtyModelView(t){this._dirtyModelView=t,t&&(this.dirtyModelViewInverse=!0,this.eventTransformChange.dispatch(this))}get dirtyAxis(){return this._dirtyAxis}set dirtyAxis(t){this._dirtyAxis=t}get dirtyProjection(){return this._dirtyProjection}set dirtyProjection(t){this._dirtyProjection=t,t&&(this.dirtyProjectionInverse=!0)}}T.incrementalId=1;class w{constructor(t){this.camera=t,this.matrixTransfo=new d}paint(t,e){this.camera.fromTransfo(this.matrixTransfo)}delete(){}}class R extends T{constructor(t={}){var e;super(t),this._matrixProjection=new d,this._fovy=Math.PI/4,this._ray={origin:new c,direction:new c},this._fovy=null!==(e=t.fovy)&&void 0!==e?e:Math.PI/4}copyProjectionFrom(t){return this.fovy=t.fovy,this.near=t.near,this.far=t.far,this}castRay(t,e){const{origin:i,direction:n}=this._ray;i.from(this.position);const r=Math.atan(this.fovy),s=r*this.screenAspectRatio;return n.from(i).subtract(this.axisZ).addWithScale(this.axisX,s*t).addWithScale(this.axisY,r*e).subtract(i).normalize(),this._ray}get fovy(){return this._fovy}set fovy(t){t!==this._fovy&&(this._fovy=t,this.dirtyProjection=!0)}get matrixProjection(){return this.updateProjectionIfNeeded(),this._matrixProjection}getSpaceHeightAtTarget(){return 2*Math.tan(.5*this.fovy)*this.distance}setSpaceHeightAtTarget(t){this.distance=t/(2*Math.tan(.5*this.fovy))}updateProjectionIfNeeded(){if(!this.dirtyProjection)return;const t=this._fovy,e=this.screenAspectRatio,i=this._near,n=this._far,r=this._matrixProjection,s=this.zoom/Math.tan(t/2);if(r[0]=s/e,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=s,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=-1,r[12]=0,r[13]=0,r[15]=0,n!==1/0){const t=1/(i-n);r[10]=(n+i)*t,r[14]=2*n*i*t}else r[10]=-1,r[14]=-2*i;this.dirtyProjection=!0}}class M{constructor(){this.eventKeyPress=new y,this.keysDown=new Set,this.keysUp=new Set,this.attached=!1,this.handleKeyDown=t=>{this.keysDown.add(t.key),this.keysUp.delete(t.key)},this.handleKeyUp=t=>{this.keysDown.delete(t.key),this.keysUp.add(t.key),this.eventKeyPress.dispatch(t)},document.addEventListener("keydown",this.handleKeyDown),document.addEventListener("keyup",this.handleKeyUp),this.attached=!0}detach(){this.attached&&(document.removeEventListener("keydown",this.handleKeyDown),document.removeEventListener("keyup",this.handleKeyUp),this.attached=!1)}isUp(...t){return!this.isDown(...t)}isDown(...t){for(const e of t)if(!this.keysDown.has(e))return!1;return!0}hasClicked(t){return!!this.keysUp.has(t)&&(this.keysUp.delete(t),!0)}}class C{constructor(t){this.canvas=t,this.eventTap=new y,this.eventMoveStart=new y,this.eventMove=new y,this.eventMoveEnd=new y,this.eventZoom=new y,this.tapDelay=300,this.controlKeys={altKey:!1,ctrlKey:!1,metaKey:!1,shiftKey:!1},this.start={x:0,y:0,t:0,fingersCount:1},this.current={x:0,y:0,t:0,fingersCount:1},this.previous={x:0,y:0,t:0,fingersCount:1},this.pointerEvent=null,this.handleContextMenu=t=>{t.preventDefault()},this.handleCanvasWheel=t=>{let e=t.deltaX+t.deltaY+t.deltaZ;e=e>0?1:-1,this.eventZoom.dispatch(Object.assign({current:this.getPoint(t),direction:e,preventDefault:()=>t.preventDefault()},this.controlKeys))},this.handlePointerDown=t=>{if(!t.isPrimary)return;this.canvas.setPointerCapture(t.pointerId),t.preventDefault(),t.stopPropagation(),this.pointerEvent=t;const e=this.getPoint(t);this.start=this.current=this.previous=e,this.eventMoveStart.dispatch(Object.assign({start:e,current:e,previous:e},this.controlKeys))},this.handlePointerMove=t=>{t.isPrimary&&this.pointerEvent&&this.canvas&&(this.previous=this.current,this.current=this.getPoint(t),this.eventMove.dispatch(Object.assign({start:this.start,current:this.current,previous:this.previous},this.controlKeys)))},this.handlePointerUp=t=>{t.isPrimary&&this.pointerEvent&&(t.preventDefault(),this.current=this.getPoint(t),this.eventMoveEnd.dispatch(Object.assign({start:this.start,current:this.current,previous:this.previous},this.controlKeys)),this.pointerEvent=null,t.timeStamp-this.start.t<this.tapDelay&&this.eventTap.dispatch(Object.assign(Object.assign({},this.start),this.controlKeys)))},t.addEventListener("pointerdown",this.handlePointerDown,!0),t.addEventListener("wheel",this.handleCanvasWheel),t.addEventListener("contextmenu",this.handleContextMenu),t.addEventListener("pointermove",this.handlePointerMove),t.addEventListener("pointerup",this.handlePointerUp)}detach(){const{canvas:t}=this;t&&(t.removeEventListener("pointerdown",this.handlePointerDown),t.removeEventListener("wheel",this.handleCanvasWheel),t.removeEventListener("contextmenu",this.handleContextMenu),t.removeEventListener("pointermove",this.handlePointerMove),t.removeEventListener("pointerup",this.handlePointerUp))}getPoint(t){this.controlKeys={altKey:t.altKey||2===t.buttons,ctrlKey:t.ctrlKey,metaKey:t.metaKey,shiftKey:t.shiftKey};const{left:e,top:i,width:n,height:r}=this.canvas.getBoundingClientRect();return{x:2*((t.clientX-e)/n-.5),y:-2*((t.clientY-i)/r-.5),t:t.timeStamp,fingersCount:1}}}class P{constructor(t){this.canvas=t,this._keyboard=null,this._pointer=null}get keyboard(){return this._keyboard||(this._keyboard=new M),this._keyboard}get pointer(){return this._pointer||(this._pointer=new C(this.canvas)),this._pointer}}class S{constructor(){this.name="Painter/"+S.counter++,this.active=!0}debugHierarchy(){return{[this.active?this.name:`${this.name} (Inactive)`]:null}}}S.log=new class{constructor(){this.level=0,this.lookupTable=new Map}lookup(t,e){var i;if("number"!=typeof e)return JSON.stringify(e);const{lookupTable:n}=this;if(0===n.size)for(const e in t){const i=t[e];"number"==typeof i&&n.set(i,`gl.${e}`)}return null!==(i=n.get(e))&&void 0!==i?i:`gl[${e}]`}call(t,e){const i="  ".repeat(this.level);console.log(`${i}>>>`,t),this.level++;const n=Date.now();try{return e()}catch(t){throw console.error(t),t}finally{this.level--,console.log(`${i}<<<`,t,`(${Date.now()-n} ms)`)}}stateDepth(t){if(console.log("// [State] Depth"),t.getParameter(t.DEPTH_TEST)){console.log("gl.enable( gl.DEPTH_TEST )"),console.log("gl.depthFunc(",this.lookup(t,t.getParameter(t.DEPTH_FUNC)),")"),console.log("gl.depthMask(",this.lookup(t,t.getParameter(t.DEPTH_WRITEMASK)),")");const[e,i]=t.getParameter(t.DEPTH_RANGE);console.log("gl.depthRange(",e,",",i,")")}else console.log("gl.disable( gl.DEPTH_TEST )")}},S.counter=0;class L extends S{constructor(t=[],{onEnter:e,onExit:i,name:n}={}){super(),this.active=!0,this.onEnter=e,this.onExit=i,this.painters=[...t],this.name=null!=n?n:`Group/${this.name}`}forEachChild(t){this.painters.forEach(((e,i)=>t(e,i)))}has(t){return this.painters.includes(t)}add(...t){for(const e of t)this.painters.push(e)}addFirst(...t){for(let e=t.length-1;e>=0;e--){const i=t[e];this.painters.unshift(i)}}remove(...t){for(const e of t){const t=this.painters.indexOf(e);t<0||(this.painters.splice(t,1),e.delete())}}removeAll(){for(const t of this.painters)t.delete();this.painters.splice(0,this.painters.length)}delete(){for(const t of this.painters)t.delete();this.painters.splice(0,this.painters.length)}paint(t,e){var i,n;if(this.active){null===(i=this.onEnter)||void 0===i||i.call(this,t,e);for(const i of this.painters)i.active&&i.paint(t,e);null===(n=this.onExit)||void 0===n||n.call(this,t,e)}}debugHierarchy(){return{[this.active?this.name:`${this.name} (Inactive)`]:this.painters.map((t=>t.debugHierarchy()))}}}function N(t,e){var i,n,r,s,o,a;const u=t.spaceHeightAtTarget,l=t.distance,d=t.zoom,m=new x(t.orientation),f=new c(t.target),g=new c(t.shift),p=null!==(i=e.spaceHeightAtTarget)&&void 0!==i?i:u,E=null!==(n=e.distance)&&void 0!==n?n:l,v=null!==(r=e.zoom)&&void 0!==r?r:d,b=new x(null!==(s=e.orientation)&&void 0!==s?s:m),A=new c(null!==(o=e.target)&&void 0!==o?o:f),_=new c(null!==(a=e.shift)&&void 0!==a?a:g),y=new x,T=new c,w=new c;return e=>{t.spaceHeightAtTarget=h(u,p,e),t.distance=h(l,E,e),t.zoom=h(d,v,e),t.orientation=y.fromSlerp(m,b,e).normalize(),t.target=T.fromMix(f,A,e),t.shift=w.fromMix(g,_,e)}}function U({from:t,to:e,action:i}){const[n,r,s]=t,[o,a,c]=e,u=[0,0,0];return t=>{u[0]=h(n,o,t),u[1]=h(r,a,t),u[2]=h(s,c,t),i(u)}}function F(t,e,i){const n=document.createElement("canvas");n.width=t,n.height=e;const r=n.getContext("2d",i);if(!r)throw Error("Unable to create 2D context!");return{canvas:n,ctx:r}}function I(t){return 1-(1-t)*(1-t)}function O(t){return 1+2.70158*Math.pow(t-1,3)+1.70158*Math.pow(t-1,2)}var D,B,V,$,G,k,z;!function(t){t[t.NEVER=WebGL2RenderingContext.NEVER]="NEVER",t[t.LESS=WebGL2RenderingContext.LESS]="LESS",t[t.EQUAL=WebGL2RenderingContext.EQUAL]="EQUAL",t[t.LEQUAL=WebGL2RenderingContext.LEQUAL]="LEQUAL",t[t.GREATER=WebGL2RenderingContext.GREATER]="GREATER",t[t.NOTEQUAL=WebGL2RenderingContext.NOTEQUAL]="NOTEQUAL",t[t.GEQUAL=WebGL2RenderingContext.GEQUAL]="GEQUAL",t[t.ALWAYS=WebGL2RenderingContext.ALWAYS]="ALWAYS"}(D||(D={})),function(t){t[t.FUNC_ADD=WebGL2RenderingContext.FUNC_ADD]="FUNC_ADD",t[t.FUNC_SUBTRACT=WebGL2RenderingContext.FUNC_SUBTRACT]="FUNC_SUBTRACT",t[t.FUNC_REVERSE_SUBTRACT=WebGL2RenderingContext.FUNC_REVERSE_SUBTRACT]="FUNC_REVERSE_SUBTRACT",t[t.MIN=WebGL2RenderingContext.MIN]="MIN",t[t.MAX=WebGL2RenderingContext.MAX]="MAX"}(B||(B={})),function(t){t[t.ZERO=WebGL2RenderingContext.ZERO]="ZERO",t[t.ONE=WebGL2RenderingContext.ONE]="ONE",t[t.SRC_COLOR=WebGL2RenderingContext.SRC_COLOR]="SRC_COLOR",t[t.ONE_MINUS_SRC_COLOR=WebGL2RenderingContext.ONE_MINUS_SRC_COLOR]="ONE_MINUS_SRC_COLOR",t[t.DST_COLOR=WebGL2RenderingContext.DST_COLOR]="DST_COLOR",t[t.ONE_MINUS_DST_COLOR=WebGL2RenderingContext.ONE_MINUS_DST_COLOR]="ONE_MINUS_DST_COLOR",t[t.SRC_ALPHA=WebGL2RenderingContext.SRC_ALPHA]="SRC_ALPHA",t[t.ONE_MINUS_SRC_ALPHA=WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA]="ONE_MINUS_SRC_ALPHA",t[t.DST_ALPHA=WebGL2RenderingContext.DST_ALPHA]="DST_ALPHA",t[t.ONE_MINUS_DST_ALPHA=WebGL2RenderingContext.ONE_MINUS_DST_ALPHA]="ONE_MINUS_DST_ALPHA",t[t.CONSTANT_COLOR=WebGL2RenderingContext.CONSTANT_COLOR]="CONSTANT_COLOR",t[t.ONE_MINUS_CONSTANT_COLOR=WebGL2RenderingContext.ONE_MINUS_CONSTANT_COLOR]="ONE_MINUS_CONSTANT_COLOR",t[t.CONSTANT_ALPHA=WebGL2RenderingContext.CONSTANT_ALPHA]="CONSTANT_ALPHA",t[t.ONE_MINUS_CONSTANT_ALPHA=WebGL2RenderingContext.ONE_MINUS_CONSTANT_ALPHA]="ONE_MINUS_CONSTANT_ALPHA",t[t.SRC_ALPHA_SATURATE=WebGL2RenderingContext.SRC_ALPHA_SATURATE]="SRC_ALPHA_SATURATE"}(V||(V={})),function(t){t[t.NEVER=WebGL2RenderingContext.NEVER]="NEVER",t[t.LESS=WebGL2RenderingContext.LESS]="LESS",t[t.EQUAL=WebGL2RenderingContext.EQUAL]="EQUAL",t[t.LEQUAL=WebGL2RenderingContext.LEQUAL]="LEQUAL",t[t.GREATER=WebGL2RenderingContext.GREATER]="GREATER",t[t.NOTEQUAL=WebGL2RenderingContext.NOTEQUAL]="NOTEQUAL",t[t.GEQUAL=WebGL2RenderingContext.GEQUAL]="GEQUAL",t[t.ALWAYS=WebGL2RenderingContext.ALWAYS]="ALWAYS"}($||($={})),function(t){t[t.KEEP=WebGL2RenderingContext.KEEP]="KEEP",t[t.ZERO=WebGL2RenderingContext.ZERO]="ZERO",t[t.REPLACE=WebGL2RenderingContext.REPLACE]="REPLACE",t[t.INCR=WebGL2RenderingContext.INCR]="INCR",t[t.INCR_WRAP=WebGL2RenderingContext.INCR_WRAP]="INCR_WRAP",t[t.DECR=WebGL2RenderingContext.DECR]="DECR",t[t.DECR_WRAP=WebGL2RenderingContext.DECR_WRAP]="DECR_WRAP",t[t.INVERT=WebGL2RenderingContext.INVERT]="INVERT"}(G||(G={})),function(t){t[t.FRONT=WebGL2RenderingContext.FRONT]="FRONT",t[t.BACK=WebGL2RenderingContext.BACK]="BACK",t[t.FRONT_AND_BACK=WebGL2RenderingContext.FRONT_AND_BACK]="FRONT_AND_BACK"}(k||(k={})),function(t){t[t.ALPHA=WebGL2RenderingContext.ALPHA]="ALPHA",t[t.RGB=WebGL2RenderingContext.RGB]="RGB",t[t.RGBA=WebGL2RenderingContext.RGBA]="RGBA",t[t.LUMINANCE=WebGL2RenderingContext.LUMINANCE]="LUMINANCE",t[t.LUMINANCE_ALPHA=WebGL2RenderingContext.LUMINANCE_ALPHA]="LUMINANCE_ALPHA"}(z||(z={}));const W={off:{enabled:!1,equationColor:B.FUNC_ADD,equationAlpha:B.FUNC_ADD,functionColorSrc:V.SRC_ALPHA,functionColorDst:V.ONE_MINUS_SRC_ALPHA,functionAlphaSrc:V.ONE,functionAlphaDst:V.ZERO},alpha:{enabled:!0,equationColor:B.FUNC_ADD,equationAlpha:B.FUNC_ADD,functionColorSrc:V.SRC_ALPHA,functionColorDst:V.ONE_MINUS_SRC_ALPHA,functionAlphaSrc:V.ONE,functionAlphaDst:V.ZERO}};function X(t,e){e.enabled?t.enable(t.BLEND):t.disable(t.BLEND),t.blendEquationSeparate(e.equationColor,e.equationAlpha),t.blendFuncSeparate(e.functionColorSrc,e.functionColorDst,e.functionAlphaSrc,e.functionAlphaDst)}const H={off:{enabled:!1,cullFace:k.BACK},back:{enabled:!0,cullFace:k.BACK},front:{enabled:!0,cullFace:k.FRONT}};function j(t,e){e.enabled?t.enable(t.CULL_FACE):t.disable(t.CULL_FACE),t.cullFace(e.cullFace)}const Z={off:{enabled:!1,func:D.LESS,mask:!0,rangeMin:0,rangeMax:1},less:{enabled:!0,func:D.LESS,mask:!0,rangeMin:0,rangeMax:1},lessOrEqual:{enabled:!0,func:D.LEQUAL,mask:!0,rangeMin:0,rangeMax:1}};function Y(t,e){e.enabled?t.enable(t.DEPTH_TEST):t.disable(t.DEPTH_TEST),t.depthFunc(e.func),t.depthMask(e.mask),t.depthRange(e.rangeMin,e.rangeMax)}const K={off:{enabled:!1,maskBack:0,maskFront:0,functionBack:$.ALWAYS,functionBackMask:0,functionBackRef:0,functionFront:$.ALWAYS,functionFrontMask:0,functionFrontRef:0,operationBack1FailStencil:G.KEEP,operationBack2FailDepth:G.KEEP,operationBack3Pass:G.KEEP,operationFront1FailStencil:G.KEEP,operationFront2FailDepth:G.KEEP,operationFront3Pass:G.KEEP},write:t=>({enabled:!0,maskBack:255,maskFront:255,functionBack:$.ALWAYS,functionBackRef:t,functionBackMask:255,functionFront:$.ALWAYS,functionFrontRef:t,functionFrontMask:255,operationBack1FailStencil:G.KEEP,operationBack2FailDepth:G.KEEP,operationBack3Pass:G.REPLACE,operationFront1FailStencil:G.KEEP,operationFront2FailDepth:G.KEEP,operationFront3Pass:G.REPLACE}),paintIfEqual:t=>({enabled:!0,maskBack:0,maskFront:0,functionBack:$.EQUAL,functionBackRef:t,functionBackMask:255,functionFront:$.EQUAL,functionFrontRef:t,functionFrontMask:255,operationBack1FailStencil:G.KEEP,operationBack2FailDepth:G.KEEP,operationBack3Pass:G.KEEP,operationFront1FailStencil:G.KEEP,operationFront2FailDepth:G.KEEP,operationFront3Pass:G.KEEP})};function q(t,e){e.enabled?(t.enable(t.STENCIL_TEST),t.stencilFuncSeparate(t.FRONT,e.functionFront,e.functionFrontRef,e.functionFrontMask),t.stencilFuncSeparate(t.BACK,e.functionBack,e.functionBackRef,e.functionBackMask),t.stencilOpSeparate(t.FRONT,e.operationFront1FailStencil,e.operationFront2FailDepth,e.operationFront3Pass),t.stencilOpSeparate(t.BACK,e.operationBack1FailStencil,e.operationBack2FailDepth,e.operationBack3Pass),t.stencilMaskSeparate(t.FRONT,e.maskFront),t.stencilMaskSeparate(t.BACK,e.maskBack)):t.disable(t.STENCIL_TEST)}function Q(t){const e=Boolean(t.getParameter(t.STENCIL_TEST));return e?{enabled:e,maskBack:t.getParameter(t.STENCIL_BACK_WRITEMASK),maskFront:t.getParameter(t.STENCIL_WRITEMASK),functionFront:t.getParameter(t.STENCIL_FUNC),functionFrontMask:t.getParameter(t.STENCIL_VALUE_MASK),functionFrontRef:t.getParameter(t.STENCIL_REF),functionBack:t.getParameter(t.STENCIL_BACK_FUNC),functionBackMask:t.getParameter(t.STENCIL_BACK_VALUE_MASK),functionBackRef:t.getParameter(t.STENCIL_BACK_REF),operationFront1FailStencil:t.getParameter(t.STENCIL_FAIL),operationFront2FailDepth:t.getParameter(t.STENCIL_PASS_DEPTH_FAIL),operationFront3Pass:t.getParameter(t.STENCIL_PASS_DEPTH_PASS),operationBack1FailStencil:t.getParameter(t.STENCIL_BACK_FAIL),operationBack2FailDepth:t.getParameter(t.STENCIL_BACK_PASS_DEPTH_FAIL),operationBack3Pass:t.getParameter(t.STENCIL_BACK_PASS_DEPTH_PASS)}:Object.assign({},K.off)}class J{constructor(){this.animations=new Map}schedule(t){const{action:e,duration:i,easingFunction:n,repeat:r}=t;return this.animations.set(t,{start:-1,duration:i,inverseDuration:1/i,action:n?t=>e(n(t)):e,loop:1,repeat:null!=r?r:1,cancel:()=>this.cancel(t),onEnd:t.onEnd}),t}cancel(t){this.animations.delete(t)}paint(t){var e;if(0===this.animations.size)return!1;for(const i of this.animations.values()){i.start<0&&(i.start=t);const n=Math.min(1,i.inverseDuration*(t-i.start));for(i.action(n);t>i.start+i.duration;){try{null===(e=i.onEnd)||void 0===e||e.call(i)}catch(t){console.error("Animation.onEnd() failed for",i),console.error(t)}i.loop++,i.start+=i.duration}i.loop>i.repeat&&i.cancel()}return!0}}class tt{constructor(t,e={}){var i,n;this.canvas=t,this.options=e,this.isPlaying=!1,this.requestAnimationFrame=-1,this.lastTime=-1,this.timeShift=0,this.animationManager=new J,this.paint=()=>{window.cancelAnimationFrame(this.requestAnimationFrame),this.requestAnimationFrame=window.requestAnimationFrame(this.actualPaint)},this.actualPaint=t=>{this.timeShift=t-Date.now();const{lastTime:e,gl:i}=this;if(e<0)return this.lastTime=t,void this.paint();const n=t-this.lastTime;this.lastTime=t,this._camera.screenWidth=i.drawingBufferWidth,this._camera.screenHeight=i.drawingBufferHeight,this.painters.paint(t,n),(this.animationManager.paint(t)||this.isPlaying)&&this.paint()},console.log("🚀 [context] options = ",e);const r=t.getContext("webgl2",e);if(!r)throw Error("Unable to create a WebGL2 context!");e.enableTextureFloatStorage&&r.getExtension("EXT_color_buffer_float"),this.implementationColorReadFormat=r.getParameter(r.IMPLEMENTATION_COLOR_READ_FORMAT),this.implementationColorReadType=r.getParameter(r.IMPLEMENTATION_COLOR_READ_TYPE),this.gl=r,this.observer=new ResizeObserver((()=>{var i;const n=t.clientWidth,s=t.clientHeight;t.width=n,t.height=s,r.viewport(0,0,n,s),this.paint(),null===(i=e.onResize)||void 0===i||i.call(e,this,t.clientWidth,t.clientHeight)})),this.observer.observe(t),this.inputs=new P(t),this._camera=null!==(i=e.camera)&&void 0!==i?i:new R,this.painters=new L,this.name=null!==(n=e.name)&&void 0!==n?n:"Context#"+tt.incrementalId++,this.painters.name=this.name,t.style.touchAction="none"}get time(){return Date.now()+this.timeShift}debugHierarchy(){return this.painters.debugHierarchy()}get camera(){return this._camera}set camera(t){t!==this._camera&&(this._camera.eventTransformChange.removeListener(this.paint),t.eventTransformChange.addListener(this.paint),this._camera=t,this.paint())}animSchedule(t){const e=this.animationManager.schedule(t);return this.paint(),e}animCancel(t){this.animationManager.cancel(t)}get onEnter(){return this.painters.onEnter}set onEnter(t){this.painters.onEnter=t}get onExit(){return this.painters.onExit}set onExit(t){this.painters.onExit=t}get width(){return this.gl.drawingBufferWidth}get height(){return this.gl.drawingBufferHeight}get playing(){return this.isPlaying}set playing(t){t!==this.isPlaying&&(t&&this.paint(),this.isPlaying=t)}play(){this.playing=!0}pause(){this.playing=!1}has(t){return this.painters.has(t)}add(...t){this.painters.add(...t)}addFirst(...t){this.painters.addFirst(...t)}remove(...t){this.painters.remove(...t)}removeAll(){this.painters.removeAll()}takeSnapshot(t){const e=t.getContext("2d");if(!e)throw Error("[TgdContext.takeSnapshot] We cannot get a 2D context for the target canvas! Maybe it already has another type of context.");const{width:i,height:n}=t,r=function(t,e){const i=document.createElement("canvas");return i.width=t,i.height=e,i}(i,n),s=new tt(r,this.options);this.painters.forEachChild((t=>s.add(t))),s.actualPaint(this.lastTime),s.gl.finish(),e.drawImage(r,0,0)}lookupWebglConstant(t){const{gl:e}=this;for(const i in e)if(e[i]===t)return i;return`Unknown gl[${t}]`}destroy(){window.cancelAnimationFrame(this.requestAnimationFrame),this.playing=!1,this.painters.delete(),this.observer.unobserve(this.canvas)}stateReset(){const{gl:t}=this,e=t.getParameter(t.MAX_VERTEX_ATTRIBS),i=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,i);for(let i=0;i<e;++i)t.disableVertexAttribArray(i),t.vertexAttribPointer(i,4,t.FLOAT,!1,0,0),t.vertexAttrib1f(i,0);t.deleteBuffer(i);const n=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS);for(let e=0;e<n;++e)t.activeTexture(t.TEXTURE0+e),t.bindTexture(t.TEXTURE_CUBE_MAP,null),t.bindTexture(t.TEXTURE_2D,null);return t.activeTexture(t.TEXTURE0),t.useProgram(null),t.bindBuffer(t.ARRAY_BUFFER,null),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindRenderbuffer(t.RENDERBUFFER,null),t.disable(t.BLEND),t.disable(t.CULL_FACE),t.disable(t.DEPTH_TEST),t.disable(t.DITHER),t.disable(t.SCISSOR_TEST),t.blendColor(0,0,0,0),t.blendEquation(t.FUNC_ADD),t.blendFunc(t.ONE,t.ZERO),t.clearColor(0,0,0,0),t.clearDepth(1),t.clearStencil(-1),t.colorMask(!0,!0,!0,!0),t.cullFace(t.BACK),t.depthFunc(t.LESS),t.depthMask(!0),t.depthRange(0,1),t.frontFace(t.CCW),t.hint(t.GENERATE_MIPMAP_HINT,t.DONT_CARE),t.lineWidth(1),t.pixelStorei(t.PACK_ALIGNMENT,4),t.pixelStorei(t.UNPACK_ALIGNMENT,4),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),t.polygonOffset(0,0),t.sampleCoverage(1,!1),t.scissor(0,0,t.canvas.width,t.canvas.height),t.stencilFunc(t.ALWAYS,0,4294967295),t.stencilMask(4294967295),t.stencilOp(t.KEEP,t.KEEP,t.KEEP),t.viewport(0,0,t.canvas.width,t.canvas.height),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT|t.STENCIL_BUFFER_BIT),t}}tt.incrementalId=1;class et{constructor(t,{geo:e,minZoom:i=.001,maxZoom:n=1/0,speedZoom:r=1,speedOrbit:s=1,speedPanning:o=1,inertiaZoom:h=0,inertiaOrbit:c=0,inertiaPanning:u=0,fixedTarget:l=!1,onZoomRequest:d=it}={}){this.context=t,this.id="Orbit-"+et.counter++,this.eventChange=new y,this.minZoom=.001,this.maxZoom=1/0,this.speedZoom=1,this.speedOrbit=1,this.speedPanning=1,this.inertiaZoom=0,this.inertiaOrbit=0,this.inertiaPanning=0,this.fixedTarget=!1,this._enabled=!0,this.animOrbit=null,this.disabledUntil=0,this.handleMove=t=>{if(!this.enabled)return;if(t.current.t-t.previous.t<=0)return;const{context:e}=this,{keyboard:i}=e.inputs;if(t.altKey||2===t.current.fingersCount)return this.handlePan(t);if(this.geo){const e=i.isDown("Shift")?.2:2,n=i.isDown("x")?0:e*(t.previous.x-t.current.x),r=i.isDown("y")?0:e*(t.previous.y-t.current.y),s=this.geo.lng+n,o=this.geo.lat+r;this.orbitGeo(o,s)}else{if(i.isDown("z"))return this.handleRotateAroundZ(t);this.orbit(t.current.x-t.previous.x,t.current.y-t.previous.y,t.shiftKey)}},this.handleMoveStart=()=>{if(!this.enabled)return;const{animOrbit:t,context:e}=this;t&&e.animCancel(t)},this.handleMoveEnd=t=>{if(!this.enabled)return;const{context:e,inertiaOrbit:i}=this;if(i>0){const n=i/(t.current.t-t.previous.t),r=t.shiftKey,s=n*(t.current.x-t.previous.x),o=n*(t.current.y-t.previous.y);let a=0;this.animOrbit={duration:i,action:t=>{const e=t-a;a=t,this.geo||this.orbit(s*e,o*e,r)},easingFunction:I},e.animSchedule(this.animOrbit)}},this.handleZoom=t=>{if(!this.enabled||0===this.speedZoom||!this.onZoomRequest({altKey:t.altKey,ctrlKey:t.ctrlKey,metaKey:t.metaKey,shiftKey:t.shiftKey,x:t.current.x,y:t.current.y}))return;const{context:e}=this,{camera:i}=e;let n=.1*this.speedZoom;this.context.inputs.keyboard.isDown("Shift")&&(n*=.1);const r=-t.direction*n;i.zoom=a(i.zoom*(1+r),this.minZoom,this.maxZoom),t.preventDefault(),this.fireZoomChange()},this.geo=void 0,e&&(this.geo=Object.assign({lat:0,lng:0,minLat:-Math.PI/2,maxLat:+Math.PI/2,minLng:-Number.MAX_VALUE,maxLng:+Number.MAX_VALUE},e)),this.cameraInitialState=t.camera.getCurrentState();const{inputs:m}=t;m.pointer.eventMoveStart.addListener(this.handleMoveStart),m.pointer.eventMoveEnd.addListener(this.handleMoveEnd),m.pointer.eventMove.addListener(this.handleMove),m.pointer.eventZoom.addListener(this.handleZoom),this.speedOrbit=s,this.speedZoom=r,this.speedPanning=o,this.inertiaOrbit=c,this.inertiaZoom=h,this.inertiaPanning=u,this.fixedTarget=l,this.minZoom=i,this.maxZoom=n,this.onZoomRequest=d,this.geo&&this.orbitGeo(this.geo.lat,this.geo.lng)}get enabled(){return this.context.time>this.disabledUntil&&this._enabled}set enabled(t){this._enabled=t}reset(t,e){const{context:i}=this;this.disableForSomeTime(t),i.animSchedule({action:N(i.camera,this.cameraInitialState),duration:t,easingFunction:e})}disableForSomeTime(t){this.disabledUntil=Math.max(this.disabledUntil,this.context.time+t)}detach(){const{inputs:t}=this.context;t.pointer.eventMove.removeListener(this.handleMove),t.pointer.eventZoom.removeListener(this.handleZoom)}orbit(t,e,i){const{context:n}=this,{camera:r}=n,{keyboard:s}=n.inputs,o=3*(i?.1:1)*this.speedOrbit,a=t*o,h=e*o;s.isDown("x")||r.orbitAroundY(-a),s.isDown("y")||r.orbitAroundX(h),this.fireOrbitChange()}orbitGeo(t,e){const{geo:i}=this;if(!i)return;t=a(t,i.minLat,i.maxLat),i.lat=t,e=a(e,i.minLng,i.maxLng),i.lng=e;const{orientation:n}=this.cameraInitialState,r=nt(t,e),s=nt(t+Math.PI/2,e),o=new c(s).cross(r),h=new l;n.toMatrix(h);const u=new l(o,s,r);u.multiply(h),this.context.camera.orientation=x.fromMatrix(u)}handlePan(t){const{fixedTarget:e,speedPanning:i,context:n}=this,{camera:r}=n,s=.5*i*(1/r.zoom),o=(t.current.x-t.previous.x)*s*r.spaceWidthAtTarget,a=(t.current.y-t.previous.y)*s*r.spaceHeightAtTarget;e?r.moveShift(-o,-a,0):r.moveTarget(-o,-a,0),this.fireOrbitChange()}handleRotateAroundZ(t){const{camera:e}=this.context,i=t.previous.x,n=t.previous.y;if(Math.abs(i)+Math.abs(n)===0)return;const r=t.current.x,s=t.current.y;if(Math.abs(r)+Math.abs(s)===0)return;const o=i*r+n*s,a=i*s-n*r,h=Math.atan2(a,o)*this.speedOrbit;e.orbitAroundZ(-h),this.fireOrbitChange()}fireOrbitChange(){this.context.paint(),this.eventChange.dispatch(this.context.camera)}fireZoomChange(){this.context.paint()}}et.counter=0;const it=()=>!0;function nt(t,e){const i=Math.cos(t),n=Math.sin(t),r=i*Math.cos(e),s=i*Math.sin(e);return new c(s,n,r)}function rt(t){if("string"==typeof t)return!0;if(!Array.isArray(t))return!1;for(const e of t)if(!rt(e))return!1;return!0}function st(t,e=""){if("string"==typeof t)return`${e}${t}`;if(!t)return"";const i=`${e}    `;return t.filter((t=>null!==t)).filter((t=>!Array.isArray(t)||t.length>0)).map((t=>st(t,i))).join("\n")}function ot(t,e,i="----------------------------------------"){const n=Object.keys(t);return 0===n.length?[]:[`// ${i}`,...n.map((i=>`${e} ${t[i]} ${i};`))]}function at(t,e="Util functions"){if(rt(t))return[t];const i=Object.keys(t);if(0===i.length)return[];const n=[`// ${e}`];return i.forEach((e=>{n.push(`${e} {`,t[e],"}","")})),n}class ht{constructor({gl:t},e){var i;this.code=e,this.gl=t;const n=t.createProgram();if(!n)throw Error("Unable to create WebGLProgram!");const r=st(e.vert),s=this.createShader("VERTEX_SHADER",r);t.attachShader(n,s);const o=st(e.frag),a=this.createShader("FRAGMENT_SHADER",o);if(t.attachShader(n,a),t.linkProgram(n),!t.getProgramParameter(n,t.LINK_STATUS)){const e=null!==(i=t.getProgramInfoLog(n))&&void 0!==i?i:"";console.warn(e);const s=ut(e),a=[dt("Vertex Shader",r,s),dt("Fragment Shader",o,s)].join("\n");throw new Error(a)}this.program=n,this.shaders=[s,a],this.uniformsLocations=this.getUniformsLocations(),t.detachShader(n,s),t.deleteShader(s),t.detachShader(n,a),t.deleteShader(a)}toCode({indent:t=""}={}){return["function createProgram(gl: WebGL2RenderingContext) {","  const prg = gl.createProgram()","  const vertexShader = gl.createShader(gl.VERTEX_SHADER)",`  gl.shaderSource(vertexShader, \`${st(this.code.vert)}\`)`,"  gl.compileShader(vertexShader)","  const fragmentShader = gl.createShader(gl.FRAGMENT_SHADER)",`  gl.shaderSource(fragmentShader, \`${st(this.code.frag)}\`)`,"  gl.compileShader(fragmentShader)","  gl.attachShader(prg, vertexShader)","  gl.attachShader(prg, fragmentShader)","  gl.linkProgram(prg)","  return prg","}"].map((e=>`${t}${e}`)).join("\n")}hasAttribute(t){const{gl:e,program:i}=this;return e.getAttribLocation(i,t)>=0}getAttribLocation(t){const{gl:e,program:i}=this,n=e.getAttribLocation(i,t);if(n<0)throw Error(`Attribute "${t}" not found!`);return n}getUniformLocation(t){const{uniformsLocations:e}=this,i=Object.keys(e);if(0===t.length)return console.warn(`Uniform "${t}" has not been found: there is no active uniform in this program!`),0;const n=e[t];return n||console.warn(`No active uniform found with name "${t}"!\nAvailable names are: ${i.join(", ")}.`),n}uniform1f(t,e){const{gl:i}=this;i.uniform1f(this.getUniformLocation(t),e)}uniform2f(t,e,i){const{gl:n}=this;n.uniform2f(this.getUniformLocation(t),e,i)}uniform3f(t,e,i,n){const{gl:r}=this;r.uniform3f(this.getUniformLocation(t),e,i,n)}uniform3fv(t,e){const{gl:i}=this;i.uniform3fv(this.getUniformLocation(t),e)}uniform4f(t,e,i,n,r){const{gl:s}=this;s.uniform4f(this.getUniformLocation(t),e,i,n,r)}uniform4fv(t,e){const{gl:i}=this;i.uniform4fv(this.getUniformLocation(t),e)}uniform1i(t,e){const{gl:i}=this;i.uniform1i(this.getUniformLocation(t),e)}uniform2i(t,e,i){const{gl:n}=this;n.uniform2i(this.getUniformLocation(t),e,i)}uniform3i(t,e,i,n){const{gl:r}=this;r.uniform3i(this.getUniformLocation(t),e,i,n)}uniform4i(t,e,i,n,r){const{gl:s}=this;s.uniform4i(this.getUniformLocation(t),e,i,n,r)}uniform1ui(t,e){const{gl:i}=this;i.uniform1ui(this.getUniformLocation(t),e)}uniform2ui(t,e,i){const{gl:n}=this;n.uniform2ui(this.getUniformLocation(t),e,i)}uniform3ui(t,e,i,n){const{gl:r}=this;r.uniform3ui(this.getUniformLocation(t),e,i,n)}uniform4ui(t,e,i,n,r){const{gl:s}=this;s.uniform4ui(this.getUniformLocation(t),e,i,n,r)}uniformMatrix3fv(t,e){const{gl:i}=this;i.uniformMatrix3fv(this.getUniformLocation(t),!1,e)}uniformMatrix4fv(t,e){const{gl:i}=this;i.uniformMatrix4fv(this.getUniformLocation(t),!1,e)}use(){const{gl:t,program:e}=this;t.useProgram(e)}delete(){const{gl:t}=this;this.shaders.forEach((e=>t.deleteShader(e))),t.deleteProgram(this.program)}debug(t="TgdProgram"){console.log(t);const{code:e}=this;dt("Vertex Shader",st(e.vert)),dt("Fragment Shader",st(e.frag))}createShader(t,e){const{gl:i}=this,n=i.createShader(i[t]);if(!n)throw Error(`Unable to create a WebGLShader of type "${t}"!`);i.shaderSource(n,e),i.compileShader(n);const r=i.getShaderInfoLog(n);if(r){console.error(`Error in ${t} code:`,r);const i=ut(r);throw Error(dt(t,e,i))}return n}getUniformsLocations(){const{gl:t,program:e}=this,i=t.getProgramParameter(e,t.ACTIVE_UNIFORMS);if("number"!=typeof i)throw Error("Unable to get the number of uniforms in a WebGLProgram!");const n={};for(let r=0;r<i;r++){const i=t.getActiveUniform(e,r);if(!i)continue;const s=t.getUniformLocation(e,i.name);if(null===s)throw Error(`Unable to get location for uniform "${i.name}"!`);n[i.name]=s}return n}}const ct=/^ERROR:[ \t]+([0-9]+):([0-9]+):/g;function ut(t){const e=[],i=[];for(const n of t.split("\n")){ct.lastIndex=-1;const t=ct.exec(n);t&&(e.push(parseInt(t[2],10)),i.push(n.substring(t[0].length).trim()))}return{lines:e,messages:i}}function lt(t,e=!1){return`color:#fff;background:${t};font-family:monospace;font-size:80%;font-weight:${e?"bolder":"100"};margin:0;color:${e?"#777":"#fff"}`}function dt(t,e,i={lines:[],messages:[]}){const n=[t],r=[`%c${t}`],s=["font-weight:bolder;font-size:120%"];let o=!1;return e.split("\n").forEach(((t,e)=>{const a=e+1,h=`${a}`.padStart(5," "),c=i.lines.includes(a)?"#f00":"#000";r.push(`%c${h}  %c${t}`),n.push(`${h}  ${t}`),s.push(lt(c,!0),lt(c,!1)),i.lines.includes(a)&&(o=!0,r.push(`%c${i.messages[i.lines.indexOf(a)]}`),n.push(`##### ${i.messages[i.lines.indexOf(a)]}`),s.push("color:#f33;background:#333;font-weight:bold"),console.error())})),console.log(r.join("\n"),...s),o?n.join("\n"):""}class mt{constructor(t,e={}){var i,n;this.attributesDefinition=t,this.options=e,this.stride=0,this.definitions={},this._data=new ArrayBuffer(0),this._count=0,this.target=null!==(i=e.target)&&void 0!==i?i:"ARRAY_BUFFER",this.usage=null!==(n=e.usage)&&void 0!==n?n:"STATIC_DRAW",this.initialize(t,e)}initialize(t,e={}){var i;for(const e of Object.keys(t)){const i=t[e];this.attributesDefinition[e]=i}const n=null!==(i=e.divisor)&&void 0!==i?i:0;let r=0;const s={},o={};for(const e of Object.keys(t)){s[e]=new ArrayBuffer(0);const i={dimension:ft[t[e]],byteOffset:r,bytesPerElement:Float32Array.BYTES_PER_ELEMENT,divisor:n,getter:(t,e)=>(e>=t.byteLength&&(e%=t.byteLength),t.getFloat32(e,!0)),setter(t,e,i){t.setFloat32(e,i,!0)}};o[e]=i,r+=i.bytesPerElement*i.dimension}this.definitions=o,this.stride=r,this._data=gt(this._data,this.count*this.stride)}assertAttribType(t,...e){const i=this.attributesDefinition[t];if(!i)throw Error(`Attribute "${t}" does not exist! Available names are: ${Object.keys(this.attributesDefinition).join(", ")}.`);if(!e.includes(i))throw Error(`Attribute "${t}" is of type "${i}", which is not ${e.join(" nor ")}!`);return this}addAttributes(t){const e=this.clone();for(const e of Object.keys(t)){const i=this.attributesDefinition[e],n=t[e];if(i&&i!==n)throw Error(`It is not allowed to change the type of attribute "${e}" from "${i}" to "${n}"! Prefer removing the attribute first.`)}this.initialize(Object.assign(Object.assign({},this.attributesDefinition),t),this.options);const i=this;i.count=e.count;for(const t of e.attributesNames)try{const{get:n}=e.getAttribAccessor(t),{set:r}=i.getAttribAccessor(t);for(let i=0;i<e.count;i++){const e=this.getDef(t);for(let t=0;t<e.dimension;t++)r(n(i,t),i,t)}}catch(e){const i=e instanceof Error?e.message:JSON.stringify(e);throw new Error(`Unable to clone attribute "${t}"!\n${i}`)}}clone(){const t=new mt(structuredClone(this.attributesDefinition),this.options);t.count=this.count;const e=new DataView(this._data),i=new DataView(t._data);for(let t=0;t<e.byteLength;t++)i.setUint8(t,e.getUint8(t));return t}get data(){return this._data}get count(){return this._count}set count(t){this._count!==t&&(this._count=t,this._data=gt(this._data,t*this.stride))}get attributesNames(){return Object.keys(this.attributesDefinition)}getAttribAccessor(t){const e=this.getDef(t),i=new DataView(this.data),n=this.stride;return{get(t,r=0){const s=e.byteOffset+n*t+r*e.bytesPerElement;return e.getter(i,s)},set(t,r,s=0){const o=e.byteOffset+n*r+s*e.bytesPerElement;e.setter(i,o,t)}}}set(t,e,{byteOffset:i=0,byteStride:n,first:r=0,count:s=1/0,targetFirst:o=0}={}){const{bytesPerElement:a,dimension:h,byteOffset:c}=this.getDef(t),u=e instanceof ArrayBuffer?e:e.buffer,l=a*h,d=null!=n?n:l;let m=i+d*r;const f=this.stride;let g=o*f+c;this.count=Math.max(this.count,Math.min(s,Math.floor((u.byteLength-m)/d)));const p=u.byteLength-d+1,x=this._data.byteLength+c-f+1,E=new Uint8Array(u),v=new Uint8Array(this._data);let b=0;for(;b<s&&m<p&&g<x;)v.set(E.subarray(m,m+l),g),b++,m+=d,g+=f}getDef(t){const e=this.definitions[t];if(!e)throw Error(`[TgdDataset] Attribute "${String(t)}" not found in this DataSet!\nAvailable names are: ${Object.keys(this.definitions).map((t=>JSON.stringify(t))).join(", ")}.`);return e}defineAttributes(t,e){let i=0;const{definitions:n}=this;for(const r of Object.keys(n)){const s=n[r];if(e.hasAttribute(r)){const n=e.getAttribLocation(r);t.enableVertexAttribArray(n),t.vertexAttribPointer(n,s.dimension,t.FLOAT,!1,this.stride,i),t.vertexAttribDivisor(n,s.divisor)}i+=s.dimension*s.bytesPerElement}}toCode({indent:t=""}={}){const e=[];let i=0;const{definitions:n}=this;for(const t of Object.keys(n)){const r=n[t],s=`$${t}`;e.push(`const ${s} = gl.getAttribLocation(prg, "${t}")`,`gl.enableVertexAttribArray(${s})`,"gl.vertexAttribPointer(",`  ${s},`,`  ${r.dimension},  // Dimension`,"  gl.FLOAT,","  false,",`  ${this.stride},   // Stride`,`  ${i}   // Offset`,")",`gl.vertexAttribDivisor(${s}, ${r.divisor})`),i+=r.dimension*r.bytesPerElement}return e.map((e=>`${t}${e}`)).join("\n")}debug(t="Dataset"){console.log(t,"   count:",this.count,"   target:",this.target,"   usage:",this.usage);const e=[["Name","type","offset"]];for(const t of Object.keys(this.definitions)){const i=this.definitions[t];e.push([t,this.attributesDefinition[t],`${i.byteOffset}`])}const i=[0,1,2].map((t=>e.reduce(((e,i)=>Math.max(e,i[t].length)),0)));e.forEach((([t,e,n])=>console.log(`%c${t.padEnd(i[0]+2)}${e.padStart(i[1]+2)}${n.padStart(i[2]+2)}`,"font-family:monospace")));for(const t of Object.keys(this.definitions)){const e=this.definitions[t];if(!e)continue;const{get:i}=this.getAttribAccessor(t),n=[];for(let t=0;t<this.count;t++){const r=[];for(let n=0;n<e.dimension;n++)r.push(i(t,n));n.push(r)}console.log(`Attribute "${t}":`,n)}}}const ft={float:1,vec2:2,vec3:3,vec4:4},gt="function"==typeof ArrayBuffer.prototype.transfer?function(t,e){return t.transfer(e)}:function(t,e){const i=new ArrayBuffer(null!=e?e:t.byteLength);return new Uint8Array(i).set(new Uint8Array(t)),i};class pt{constructor(t,e={}){var i,n;this.gl=t;const r=t.createBuffer();if(!r)throw Error("Unable to create WebGLBuffer!");this._target=null!==(i=null==e?void 0:e.target)&&void 0!==i?i:"ARRAY_BUFFER",this._usage=null!==(n=null==e?void 0:e.usage)&&void 0!==n?n:"STATIC_DRAW",this.buffer=r;const{data:s}=e;s&&this.bufferData(Object.assign(Object.assign({},e),{data:s}))}get target(){return this._target}bind(t){const{gl:e,buffer:i}=this;this._target=null!=t?t:this._target,e.bindBuffer(e[this._target],i)}bufferData(t){var e,i;const{gl:n}=this;this._usage=null!==(e=t.usage)&&void 0!==e?e:this._usage,this._target=null!==(i=t.target)&&void 0!==i?i:this._target,this.bind(t.target),n.bufferData(n[this._target],t.data,n[this._usage])}delete(){const{gl:t,buffer:e}=this;t.deleteBuffer(e)}}class xt{constructor(t,e,i,n){this.gl=t,this.program=e,this.datasets=i,this.elements=n,this.drawBuffers=[],this.elemBuffer=null;const r=t.createVertexArray();if(!r)throw Error("Unable to create VertexArrayObject!");if(this.vao=r,e&&i){if(t.bindVertexArray(r),this.drawBuffers=i.map((i=>{const n=new pt(t,{data:i.data,target:i.target,usage:i.usage});return n.bind(),i.defineAttributes(t,e),n})),n){const e=new pt(t,{data:n,target:"ELEMENT_ARRAY_BUFFER"});e.bind(),this.elemBuffer=e}t.bindVertexArray(null)}}getBuffer(t){return this.drawBuffers[t]}toCode({indent:t=""}={}){var e,i;const n=["function createVAO(","  gl: WebGL2RenderingContext,",`  prg: WebGLProgram${null===(e=this.datasets)||void 0===e?void 0:e.map(((t,e)=>`, data${e}: ArrayBuffer`)).join("")}`,") {","  const vao = gl.createVertexArray()","  gl.bindVertexArray(vao)"];return null===(i=this.datasets)||void 0===i||i.forEach(((e,i)=>{n.push(`  const buff${i} = gl.createBuffer()`,`  gl.bindBuffer(gl.${e.target}, buff${i})`,`  gl.bufferData(gl.${e.target}, data${i}, gl.${e.usage})`,e.toCode({indent:`${t}  `}))})),n.push("  return vao","}"),n.map((e=>`${t}${e}`)).join("\n")}debug(t="TgdVertexArray"){console.log(t),this.program&&this.program.debug(),this.datasets&&this.datasets.forEach(((t,e)=>t.debug(`   Dataset #${e}`))),this.elements&&console.log("Elements:",this.elements)}bind(){this.gl.bindVertexArray(this.vao)}unbind(){this.gl.bindVertexArray(null)}delete(){const{gl:t,vao:e,drawBuffers:i,elemBuffer:n}=this;t.deleteVertexArray(e),i.forEach((t=>t.delete())),n&&n.delete()}}class Et extends S{constructor(t,e,{x:i=0,y:n=0,z:r=.999999,zoom:s=1,scaleX:o=1,scaleY:a=1}={}){super(),this.context=t,this.zoom=1,this.x=0,this.y=0,this.z=1,this.x=i,this.y=n,this.z=r,this.zoom=s,this.texture=e,this.program=new ht(t,{vert:"#version 300 es\n\nuniform float uniZoom;\nuniform vec2 uniScale;\nuniform vec2 uniScroll;\nuniform float uniZ;\nin vec2 attPoint;\nin vec2 attUV;\nout vec2 varUV;\n\nvoid main() {\n    varUV = (attUV + uniScroll) * uniZoom;\n    float x = uniScale.x * attPoint.x;\n    float y = uniScale.y * attPoint.y;\n    gl_Position = vec4(x, y, uniZ, 1.0);\n}",frag:"#version 300 es\n\nprecision mediump float;\n\nuniform sampler2D uniTexture;\nin vec2 varUV;\nout vec4 FragColor;\n\nvoid main() {\n    FragColor = texture(uniTexture, varUV);\n}"});const h=new mt({attPoint:"vec2",attUV:"vec2"});h.set("attPoint",new Float32Array([-1*o,1*a,1*o,1*a,-1*o,-1*a,1*o,-1*a])),h.set("attUV",new Float32Array([0,0,1,0,0,1,1,1])),this.vao=new xt(t.gl,this.program,[h])}delete(){const{vao:t}=this;t.delete()}paint(){const{gl:t}=this.context,{vao:e,program:i,texture:n,zoom:r,x:s,y:o,z:a}=this;i.use();const{width:h,height:c}=this.context,u=n.width*c>n.height*h,l=u?n.width*c/(h*n.height):1,d=u?1:n.height*h/(c*n.width);i.uniform2f("uniScale",l,d),i.uniform2f("uniScroll",s,o),i.uniform1f("uniZoom",1/r),i.uniform1f("uniZ",a),n.activate(0,i,"uniTexture"),t.disable(t.CULL_FACE),e.bind(),t.drawArrays(t.TRIANGLE_STRIP,0,4)}}class vt extends S{constructor({gl:t},e={}){var i,n,r,s;super(),this.options=e,this.red=1,this.green=.7,this.blue=0,this.alpha=1,this.depth=1,this.stencil=0,this.name=null!==(i=e.name)&&void 0!==i?i:`Clear/${this.name}`,this.gl=t;const o=null!==(n=e.color)&&void 0!==n?n:[0,0,0,1],a=null!==(r=e.depth)&&void 0!==r?r:1,h=null!==(s=e.stencil)&&void 0!==s?s:0;this.clearMask=0;let c=!1;if(void 0!==e.color&&(this.clearMask|=t.COLOR_BUFFER_BIT,c=!0),"number"==typeof e.depth&&(this.clearMask|=t.DEPTH_BUFFER_BIT,c=!0),"number"==typeof e.stencil&&(this.clearMask|=t.STENCIL_BUFFER_BIT,c=!0),!c)throw Error("[TgdPainterClear] You must give at least a color or a depth in the constructor!");[this.red,this.green,this.blue,this.alpha]=o,this.depth=a,this.stencil=h}delete(){}paint(){const{clearMask:t,gl:e,red:i,green:n,blue:r,alpha:s,depth:o,stencil:a,options:h}=this;h.color&&e.clearColor(i,n,r,s),"number"==typeof h.depth&&e.clearDepth(o),"number"==typeof h.stencil&&(e.stencilMask(255),e.clearStencil(a)),e.clear(t)}}class bt extends S{constructor(t){super(),this.context=t,this.program=new ht(t,{vert:"#version 300 es\n\nin vec2 attPoint;\n\nvoid main() {\n    gl_Position = vec4(attPoint, 0.0, 1.0);\n}",frag:"#version 300 es\n\nprecision mediump float;\n\nuniform vec4 uniColor;\nout vec4 FragColor;\n\nvoid main() {\n    FragColor = uniColor;\n}"});const e=new mt({attPoint:"vec2"});e.set("attPoint",new Float32Array([-1,1,1,1,-1,-1,1,-1])),this.vao=new xt(t.gl,this.program,[e])}paint(t,e){const{context:i,program:n,vao:r}=this,{gl:s}=i,o=Q(s);s.disable(s.DEPTH_TEST),s.disable(s.CULL_FACE);const a=([t,e,i],r)=>{n.uniform4f("uniColor",t,e,i,1),s.stencilFunc(s.EQUAL,r,255),s.drawArrays(s.TRIANGLE_STRIP,0,4)};s.disable(s.STENCIL_TEST),s.clearColor(.5,.5,.5,1),s.clear(s.COLOR_BUFFER_BIT),n.use(),r.bind(),s.enable(s.STENCIL_TEST),s.stencilOp(s.KEEP,s.KEEP,s.KEEP),a([0,0,0],0),a([1,0,0],1),a([0,1,0],2),a([0,0,1],3),a([0,1,1],4),a([1,0,1],5),a([1,1,0],6),a([1,1,1],7),r.unbind(),q(s,o)}delete(){}}class At extends S{constructor({gl:t},{enabled:e=!0,func:i="LESS",mask:n=!0,rangeMin:r=0,rangeMax:s=1}={}){super(),this.gl=t,this.enabled=e,this.func=i,this.mask=n,this.rangeMin=r,this.rangeMax=s}delete(){}paint(){const{gl:t}=this,{enabled:e}=this;if(!e)return void t.disable(t.DEPTH_TEST);const{func:i,mask:n,rangeMin:r,rangeMax:s}=this;t.enable(t.DEPTH_TEST),t.depthFunc(t[i]),t.depthMask(n),t.depthRange(r,s)}update(){}}class _t{constructor({precision:t="mediump",uniforms:e={},attributes:i={},varying:n={},functions:r={},mainCode:s=[]}={}){this.precision="mediump",this.precision=t,this.uniforms=e,this.attributes=i,this.varying=n,this.functions=r,this.mainCode=s}get code(){return st(["#version 300 es",`precision ${this.precision} float;`,...ot(this.uniforms,"uniform"),...ot(this.attributes,"in"),...ot(this.varying,"out"),...at(this.functions),"","void main() {",this.mainCode,"}"])}}class yt{constructor({precision:t="mediump",uniforms:e={},outputs:i={FragColor:"vec4"},varying:n={},functions:r={},mainCode:s=["FragColor = vec4(1, 0.667, 0, 1);"]}={}){this.precision="mediump",this.precision=t,this.uniforms=e,this.outputs=i,this.varying=n,this.functions=r,this.mainCode=s}get code(){return st(["#version 300 es",`precision ${this.precision} float;`,...ot(this.uniforms,"uniform"),...ot(this.varying,"in"),...ot(this.outputs,"out"),...at(this.functions),"","void main() {",this.mainCode,"}"])}}class Tt extends S{constructor(t,e){var i,n;super(),this.context=t,this.z=0,this.textures=null,this.texturesWith=-1,this.texturesHeight=-1,this.z=null!==(i=e.z)&&void 0!==i?i:.999999,this.texture=e.texture;const r=e.filters;if(r.length<1)throw Error("[TgdPainterFilter] filters is expected to have at least one element!");const s=e.filters.map((e=>{const i=new _t({attributes:{attPoint:"vec2",attUV:"vec2"},varying:{varUV:"vec2"},uniforms:{uniZ:"float"},mainCode:["varUV = attUV;","gl_Position = vec4(",["attPoint,","uniZ,","1.0"],");"]}).code,n=new yt({uniforms:Object.assign({uniWidth:"float",uniHeight:"float",uniTexture:"sampler2D"},e.uniforms),varying:{varUV:"vec2"},mainCode:e.fragmentShaderCode,functions:e.extraFunctions}).code;return new ht(t,{vert:i,frag:n})})),o=s.map((i=>Rt(t,i,e.flipY?-1:1)));this.program=s.pop(),this.programs=s,this.filter=r.pop(),this.filters=r;const a=o.pop();this.vaos=o;const h=o.length+(e.flipY?1:0);this.vao=h%2==0?a:Rt(t,this.program,-1);const c=t.gl.createFramebuffer();if(!c)throw Error("Unable to create a WebGL Framebuffer!");this.framebuffer=c,this.name=null!==(n=e.name)&&void 0!==n?n:`Filter/${this.name}`}delete(){const{context:t,textures:e,vaos:i,vao:n,framebuffer:r}=this,{gl:s}=t;i.forEach((t=>t.delete())),n.delete(),s.deleteFramebuffer(r),e&&e.forEach((t=>s.deleteTexture(t)))}paint(t){const{vaos:e,texture:i,z:n,context:r}=this,{gl:s}=this.program;let o=i.glTexture;if(e.length>0){const{programs:i,filters:a,framebuffer:h}=this,c=s.getParameter(s.FRAMEBUFFER_BINDING),u=this.getTextures(s);let l=0,d=u[l];for(let c=0;c<e.length;c++)s.bindFramebuffer(s.FRAMEBUFFER,h),s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,d,0),wt(t,e[c],i[c],a[c],o,n,r),l=1-l,o=d,d=u[l];s.bindFramebuffer(s.FRAMEBUFFER,c)}wt(t,this.vao,this.program,this.filter,o,n,r),s.bindVertexArray(null)}getTextures(t){const e=this.texture;return this.textures&&this.texturesWith===e.width&&this.texturesHeight===e.height?[...this.textures]:(this.textures&&this.textures.forEach((e=>t.deleteTexture(e))),this.texturesWith=e.width,this.texturesHeight=e.height,this.textures=[0,1].map((()=>{const i=t.createTexture();return t.bindTexture(t.TEXTURE_2D,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,e.width,e.height,0,t.RGBA,t.UNSIGNED_BYTE,null),i})),this.textures)}}function wt(t,e,i,n,r,s,o){const{gl:a}=i;i.use(),i.uniform1f("uniZ",s),n.setUniforms(i,t,o),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,r),i.uniform1i("uniTexture",0),e.bind(),a.drawArrays(a.TRIANGLE_STRIP,0,4)}function Rt(t,e,i=1){const n=new mt({attPoint:"vec2",attUV:"vec2"});n.set("attPoint",new Float32Array([-1,1*i,1,1*i,-1,-1*i,1,-1*i])),n.set("attUV",new Float32Array([0,0,1,0,0,1,1,1]));const r=new xt(t.gl,e,[n]);if(!r)throw Error("Unable to create WebGL VAO!");return r}class Mt extends L{constructor(t,e={}){super(e.children),this.context=t,this.options=e,this.dirty=!0,this._width=0,this._height=0,this._framebuffer=null,this._depthBuffer=null,this._stencilBuffer=null,this.textureColor0=e.textureColor0,this.textureColor1=e.textureColor1,this.textureColor2=e.textureColor2,this.textureColor3=e.textureColor3,this.textureDepth=e.textureDepth,this.onEnter=e.onEnter,this.onExit=e.onExit;const{gl:i}=this.context;this.drawBuffers=[this.textureColor0?i.COLOR_ATTACHMENT0:i.NONE,this.textureColor1?i.COLOR_ATTACHMENT1:i.NONE,this.textureColor2?i.COLOR_ATTACHMENT2:i.NONE,this.textureColor3?i.COLOR_ATTACHMENT3:i.NONE]}get width(){return this._width}set width(t){this._width!==t&&(this._width=t,this.dirty=!0)}get height(){return this._height}set height(t){this._height!==t&&(this._height=t,this.dirty=!0)}updateTextureForColor(t,e){if(!t)return;const{context:i,width:n,height:r}=this,{gl:s}=i;t.resize(n,r),s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0+e,s.TEXTURE_2D,t,0)}createTextureForDepth(){const t=this.textureDepth;if(!t)return;const{context:e,width:i,height:n}=this,{gl:r}=e;t.resize(i,n),r.framebufferTexture2D(r.FRAMEBUFFER,r.DEPTH_ATTACHMENT,r.TEXTURE_2D,t,0)}createDepthBuffer(t){if(!1!==this.options.depthBuffer){const{width:e,height:i}=this,n=t.createRenderbuffer();if(!n)throw Error("Unable to create WebGLRenderBuffer for depth!");this._depthBuffer=n,t.bindRenderbuffer(t.RENDERBUFFER,n),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,e,i),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,n)}}createStencilBuffer(t){if(!1!==this.options.stencilBuffer){const{width:e,height:i}=this,n=t.createRenderbuffer();if(!n)throw Error("Unable to create WebGLRenderBuffer for stencil!");this._stencilBuffer=n,t.bindRenderbuffer(t.RENDERBUFFER,n),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_STENCIL,e,i),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,t.RENDERBUFFER,n)}}createFramebufferIfNeeded(){if(!this.dirty)return;const{context:t}=this,{gl:e}=t;this.delete(),this._framebuffer=function(t){const e=t.createFramebuffer();if(!e)throw Error("Unable to create a WebGLFramebuffer!");return e}(e),e.bindFramebuffer(e.FRAMEBUFFER,this._framebuffer),this.updateTextureForColor(this.textureColor0,0),this.updateTextureForColor(this.textureColor1,1),this.updateTextureForColor(this.textureColor2,2),this.updateTextureForColor(this.textureColor3,3),this.createTextureForDepth(),this.createDepthBuffer(e),this.createStencilBuffer(e);const i=e.checkFramebufferStatus(e.FRAMEBUFFER);i!==e.FRAMEBUFFER_COMPLETE&&console.error(`Your Framebuffer is incomplete: ${r(i)}!`),this.dirty=!1}paint(t,e){const{context:i,options:n}=this,{gl:r}=i,{viewportMatchingScale:s=1}=n;this.width=Math.round(i.width*s),this.height=Math.round(i.height*s),this.createFramebufferIfNeeded(),r.bindFramebuffer(r.FRAMEBUFFER,this._framebuffer),r.drawBuffers(this.drawBuffers),super.paint(t,e),r.bindFramebuffer(r.FRAMEBUFFER,null)}delete(){const{context:t,_framebuffer:e,_depthBuffer:i,_stencilBuffer:n}=this,{gl:r}=t;e&&(r.deleteFramebuffer(e),this._framebuffer=null),i&&(r.deleteRenderbuffer(i),this._depthBuffer=null),n&&(r.deleteRenderbuffer(n),this._stencilBuffer=null)}}class Ct extends S{constructor(t,e={}){var i;super(),this.logicFunction=t,this.name=null!==(i=e.name)&&void 0!==i?i:`Logic/${this.name}`}delete(){}paint(t,e){this.logicFunction(t,e)}}class Pt{static make(t){var e,i,n;const r={},{count:s,drawMode:o,elements:a,attPosition:h,attNormal:c,attUV:u}=t;r[h.name]=null!==(e=h.type)&&void 0!==e?e:"vec3",c&&(r[c.name]=null!==(i=c.type)&&void 0!==i?i:"vec3"),u&&(r[u.name]=null!==(n=u.type)&&void 0!==n?n:"vec2");const l=new mt(r);return l.set(h.name,h.data),c&&l.set(c.name,c.data),u&&l.set(u.name,u.data),new Pt({dataset:l,count:s,drawMode:o,elements:a})}constructor(t){var e;const{dataset:i,drawMode:r="TRIANGLES",attPosition:s="POSITION",attNormal:o="NORMAL",attUV:a="TEXCOORD_0"}=t;this._dataset=i,this.drawMode=r;const{elements:h}=t;this.elements=h,this._elementsType=h?n(h):0,this.attPosition=s,this.attNormal=o,this.attUV=a,this.count=null!==(e=null==h?void 0:h.length)&&void 0!==e?e:i.count,t.computeNormalsIfMissing&&this.computeNormals()}get dataset(){return this._dataset}get elementsType(){return this._elementsType}getElement(t){var e,i;return null!==(i=null===(e=this.elements)||void 0===e?void 0:e[t])&&void 0!==i?i:-1}computeNormals(){let t=[];if(this.drawMode!==WebGL2RenderingContext.TRIANGLES&&"TRIANGLES"!==this.drawMode)return void console.error("We don't know how to compute normals for this draw mode:",this.drawMode);t=this.computeNormalsForTrianglesDrawMode();const e=this.attNormal;this.dataset.addAttributes({[e]:"vec3"});const i=[];for(let e=0;e<t.length;e++){const[n,r,s]=t[e];i.push(n,r,s)}this.dataset.set(e,new Float32Array(i))}computeNormalsForTrianglesDrawMode(){const t=this.dataset,e=new Map,i=(t,i,n,r)=>{const s=function(t,e,i){const n=new c(e).subtract(t),r=new c(i).subtract(t);return n.cross(r).normalize()}(i,n,r),o=e.get(t);o?o.add(s):e.set(t,new c(s.x,s.y,s.z))},{get:n}=t.getAttribAccessor(this.attPosition),r=new Set;let s=0;for(let t=0;t<this.count;t+=3){const e=this.getElement(t+0);r.add(e),s=Math.max(s,e);const o=this.getElement(t+1);r.add(o),s=Math.max(s,o);const a=this.getElement(t+2);r.add(a),s=Math.max(s,a);const h=new c(n(e,0),n(e,1),n(e,2)),u=new c(n(o,0),n(o,1),n(o,2)),l=new c(n(a,0),n(a,1),n(a,2));i(e,h,u,l),i(o,u,l,h),i(a,l,h,u)}const o=[];for(let t=0;t<=s;t++){const i=e.get(t);i?(i.normalize(),o.push(i)):o.push(new c)}return o}}class St extends Pt{constructor({sizeX:t=1,sizeY:e=1,vecX:i=[1,0,0],vecY:n=[0,0,1]}={}){const r=(r,s)=>{const o=r*t,a=s*e;return[o*i[0]+a*n[0],o*i[1]+a*n[1],o*i[2]+a*n[2]]},s=new mt({POSITION:"vec3",NORMAL:"vec3",TEXCOORD_0:"vec2"}),o=.5;s.set("POSITION",new Float32Array([...r(+o,-o),...r(-o,-o),...r(+o,+o),...r(-o,+o)])),s.set("TEXCOORD_0",new Float32Array([1,1,0,1,1,0,0,0]));const[a,h,u]=new c(i).normalize().cross(new c(n).normalize());s.set("NORMAL",new Float32Array([a,h,u,a,h,u,a,h,u,a,h,u])),super({dataset:s,drawMode:"TRIANGLE_STRIP"})}}class Lt{constructor(){this.varyings={},this.uniforms={}}}class Nt{constructor(t={}){var e,i;this._direction=new c,this.color=null!==(e=t.color)&&void 0!==e?e:new u(.8,.8,.8,1),this.direction=null!==(i=t.direction)&&void 0!==i?i:new c(0,0,-1)}get direction(){return this._direction}set direction(t){this._direction.from(t).normalize()}}const Ut=new u(.8,.8,.8,1);class Ft extends Lt{constructor(t={}){var e;super(),this.light=new Nt,this.ambient=new Nt({color:new u(.8,.8,.8,0)}),this.specularExponent=20,this.specularIntensity=1,this.uniforms={uniLight:"vec3",uniLightDir:"vec3",uniAmbient:"vec3",uniSpecularExponent:"float",uniSpecularIntensity:"float"},this.lightColor=new c,this.ambientColor=new c;const i=null!==(e=t.color)&&void 0!==e?e:Ut;t.light&&(this.light=t.light),t.ambient&&(this.ambient=t.ambient),"number"==typeof t.specularExponent&&(this.specularExponent=t.specularExponent),"number"==typeof t.specularIntensity&&(this.specularIntensity=t.specularIntensity);const n=!(i instanceof u);this.texture=n?i:null,this.fragmentShaderCode=["vec3 normal = normalize(varNormal);","float light = -dot(normal, uniLightDir);",n?"vec4 color = texture(texDiffuse, varUV);":`vec4 color = vec4(${i.join(", ")});`,"float spec = max(0.0, reflect(uniLightDir, normal).z);","spec = pow(spec, uniSpecularExponent) * uniSpecularIntensity;","color = vec4(","  color.rgb * (","    uniAmbient + uniLight * light","  ) + vec3(spec),","  1.0",");","return color;"],this.vertexShaderCode=["varNormal = mat3(uniModelViewMatrix) * NORMAL;"],this.varyings={varNormal:"vec3"},n&&(this.vertexShaderCode.push("varUV = TEXCOORD_0;"),this.varyings.varUV="vec2",this.uniforms.texDiffuse="sampler2D")}setUniforms(t){t.uniform3fv("uniLightDir",this.light.direction),this.lightColor.from(this.light.color).scale(this.light.color.w),t.uniform3fv("uniLight",this.lightColor),this.ambientColor.from(this.ambient.color).scale(this.ambient.color.w),t.uniform3fv("uniAmbient",this.ambientColor),t.uniform1f("uniSpecularExponent",this.specularExponent),t.uniform1f("uniSpecularIntensity",this.specularIntensity);const{texture:e}=this;e&&e.activate(0,t,"texDiffuse")}}new u(.6,1,.9,1);const It=[.111,.333,.999,1];class Ot extends Lt{constructor(t={}){var e,i,n;super(),this.expansion=.02,this.uniforms={uniColor:"vec4",uniExpansion:"float"},this.color=new u(null!==(e=t.color)&&void 0!==e?e:It),this.expansion=null!==(i=t.expansion)&&void 0!==i?i:.02,this.fragmentShaderCode=["return uniColor;"],this.vertexShaderCode=[],this.varyings={},this.vertexShaderCodeForGetPosition=[`return pos + uniExpansion * vec4(${null!==(n=t.attNormal)&&void 0!==n?n:"NORMAL"}, 0.0);`]}setUniforms(t){t.uniform4fv("uniColor",this.color),t.uniform1f("uniExpansion",this.expansion)}}const Dt=[.111,.333,.999,1];class Bt extends Lt{constructor(t={}){var e;super(),this.uniforms={uniColor:"vec4"},this.color=new u(null!==(e=t.color)&&void 0!==e?e:Dt),this.fragmentShaderCode=["return uniColor;"],this.vertexShaderCode=[],this.varyings={}}setUniforms(t){t.uniform4fv("uniColor",this.color)}}class Vt extends S{constructor(t,e){var i,n;super(),this.context=t,this.matrixTransfoGlobal=new d,this.drawMode=0,this.bboxMin=null,this.bboxMax=null,this.paint=(t,e)=>{const{context:i,prg:n,geometry:r,material:s,drawMode:o,count:a,matrixTransfoGlobal:h}=this,{gl:c,camera:u}=i;n.use(),s.setUniforms(n,t,e),n.uniformMatrix4fv("uniTransfoMatrix",h),n.uniformMatrix4fv("uniModelViewMatrix",u.matrixModelView),n.uniformMatrix4fv("uniProjectionMatrix",u.matrixProjection),this.vao.bind(),r.elements?c.drawElements(o,a,this.elementsType,0):c.drawArrays(o,0,a),this.vao.unbind()};const{material:r,geometry:s}=e;this.geometry=s,this.material=r,this.drawMode="number"==typeof s.drawMode?s.drawMode:t.gl[s.drawMode];const o=new _t({uniforms:Object.assign({uniTransfoMatrix:"mat4",uniModelViewMatrix:"mat4",uniProjectionMatrix:"mat4"},r.uniforms),attributes:{[s.attPosition]:"vec4",[s.attNormal]:"vec3",[s.attUV]:"vec2"},varying:r.varyings,functions:{"void applyMaterial()":st(r.vertexShaderCode),"vec4 getPosition(vec4 pos)":null!==(i=r.vertexShaderCodeForGetPosition)&&void 0!==i?i:"return pos;"},mainCode:["gl_Position = uniProjectionMatrix * uniModelViewMatrix * uniTransfoMatrix * getPosition(POSITION);","applyMaterial();"]}).code,a=new yt({uniforms:r.uniforms,outputs:{FragColor:"vec4"},varying:r.varyings,functions:{"vec4 applyMaterial()":st(r.fragmentShaderCode)},mainCode:["FragColor = applyMaterial();"]}).code,h=new ht(t,{vert:o,frag:a});h.debug(),this.prg=h,this.vao=new xt(t.gl,h,[s.dataset],s.elements),this.elementsType=s.elementsType,this.count=s.count,this.name=null!==(n=e.name)&&void 0!==n?n:`Mesh/${this.name}`}computeBoundingBox(){if(this.bboxMin&&this.bboxMax)return{min:this.bboxMin,max:this.bboxMax};const{dataset:t}=this.geometry,{get:e}=t.getAttribAccessor("POSITION"),i=new c(e(0,0),e(0,1),e(0,2)),n=new c(i);for(let r=1;r<t.count;r++){const t=e(r,0),s=e(r,1),o=e(r,2);i.x=Math.min(i.x,t),n.x=Math.max(n.x,t),i.y=Math.min(i.y,s),n.y=Math.max(n.y,s),i.z=Math.min(i.z,o),n.z=Math.max(n.z,o)}return this.bboxMin=i,this.bboxMax=n,{min:i,max:n}}delete(){this.vao.delete()}}class $t extends Vt{constructor(t,e){var i;const{asset:n,meshIndex:r=0,primitiveIndex:s=0,materialFactory:o=kt}=e,a=function(t,e,i,n){var r,s,o;const a=null!==(r=t.getMeshPrimitive(e,i).material)&&void 0!==r?r:-1;if(-1===a)return Gt;const h=t.getMaterial(a),c=h.pbrMetallicRoughness;if(!c){const e=h.emissiveTexture;return e?t.createTexture2D(n,null!==(s=e.index)&&void 0!==s?s:0):Gt}if(c.baseColorTexture){const e=null===(o=c.baseColorTexture)||void 0===o?void 0:o.index;return t.createTexture2D(n,null!=e?e:0)}return c.baseColorFactor?new u(...c.baseColorFactor):Gt}(n,r,s,t),h=o({color:a});let c=!1;const l={POSITION:"vec3",NORMAL:"vec3"};n.getMeshPrimitive().attributes.TEXCOORD_0&&(l.TEXCOORD_0="vec2");const d=new mt(l);n.setAttrib(d,"POSITION",r,s),n.getMeshPrimitive().attributes.NORMAL?n.setAttrib(d,"NORMAL",r,s):(console.warn("No normals found! We will apply smooth shading."),c=!0),n.getMeshPrimitive().attributes.TEXCOORD_0&&n.setAttrib(d,"TEXCOORD_0",r,s),super(t,{geometry:new Pt({dataset:d,elements:n.getMeshPrimitiveIndices(r,s),drawMode:"TRIANGLES",computeNormalsIfMissing:c}),material:h}),this.name=null!==(i=e.name)&&void 0!==i?i:`Gltf/${this.name}`}}const Gt=new u(.9,.5,.1,1);function kt({color:t}){return new Ft({color:t,light:new Nt({color:new u(1,1,1,1),direction:new c(1,.2,0)}),ambient:new Nt({color:new u(.75,.75,.75,1)})})}class zt extends S{constructor(t={}){super(),this.parentTransfo=new A,this.transfo=new A,this.matrixTransfo=new d,this.parentUpdateCount=0,this.updateCount=0,this.childrenNodes=[],this.children=[];const{children:e=[]}=t;e.forEach((t=>this.add(t)))}delete(){for(const t of this.children)t.delete();for(const t of this.childrenNodes)t.delete()}add(...t){for(const e of t)e instanceof zt?this.childrenNodes.push(e):this.children.push(e)}remove(...t){for(const e of t)if(e instanceof zt){const t=this.childrenNodes.indexOf(e);t>-1&&this.childrenNodes.splice(t,1)}else{const t=this.children.indexOf(e);t>-1&&this.children.splice(t,1)}}paint(t,e){const{transfo:i,parentTransfo:n,matrixTransfo:r,parentUpdateCount:s,updateCount:o,children:a,childrenNodes:h}=this;(i.updateCount>o||n.updateCount>s)&&(this.updateCount=i.updateCount,this.parentUpdateCount=n.updateCount,r.from(n.matrix).multiply(i.matrix));for(const i of a)i.matrixTransfo=r,i.paint(t,e);for(const i of h)i.parentTransfo.matrix=r,i.paint(t,e)}}class Wt{constructor(t,e){this._texture=null,this._width=0,this._height=0;const{gl:i}=t;this.gl=i,this.name="Texture2D/"+Wt.counter++;const n=i.createTexture();if(!n)throw Error("Unable to create a WebGLTexture!");this._texture=n,this.setParams({magFilter:"LINEAR",minFilter:"LINEAR",wrapS:"REPEAT",wrapT:"REPEAT",wrapR:"REPEAT"}),this.storage=Object.assign({width:1,height:1,internalFormat:"RGBA8",levels:1,flipY:!1},e),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,this.storage.flipY),"number"==typeof(null==e?void 0:e.width)&&"number"==typeof(null==e?void 0:e.height)&&this.resize(null==e?void 0:e.width,null==e?void 0:e.height)}get width(){return this._width}get height(){return this._height}resize(t,e){if(t===this.width&&e===this.height)return;const{gl:i,storage:n}=this;this._width=n.width=t,this._height=n.height=e;const{internalFormat:r,levels:s}=this.storage;if(r.startsWith("COMPRESSED_")&&!i.getExtension("WEBGL_compressed_texture_etc"))throw Error('Your browser does not support extension "WEBGL_compressed_texture_etc" on this device!');this.bind(),i.texStorage2D(i.TEXTURE_2D,s,i[r],t,e)}get glTexture(){if(this._texture)return this._texture;throw Error(`Texture "${this.name}" has been deleted!`)}bind(){this.gl.bindTexture(this.gl.TEXTURE_2D,this.glTexture)}loadBitmap(t,e={}){const{storage:i,gl:n}=this,{level:r=0}=e;return this._width=t.width,this._height=t.height,this.bind(),n.texImage2D(n.TEXTURE_2D,r,n[i.internalFormat],n[function(t){for(const[e,i]of Xt)if(i.has(t))return e;throw Error(`There is no compatible format for internalFormat "${t}" and type "UNSIGNED_BYTE"!`)}(i.internalFormat)],n.UNSIGNED_BYTE,t),this}loadData(t,e){const{level:i=0,width:n,height:r,internalFormat:s,format:o,offset:a=0}=e,{gl:h}=this;return this.bind(),h.texImage2D(h.TEXTURE_2D,i,h.RGB,n,r,0,h.RGB,h.UNSIGNED_BYTE,t),this}activate(t,e,i){const{gl:n}=this;return n.activeTexture(n.TEXTURE0+t),this.bind(),e&&i&&e.uniform1i(i,t),this}generateMipmap(){const{gl:t}=this;return this.bind(),t.generateMipmap(t.TEXTURE_2D),this}setParams(t){return this.bind(),function(t,{wrapS:e,wrapT:i,wrapR:n,minFilter:r,magFilter:s}){e&&t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t[e]),i&&t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t[i]),n&&t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_R,t[n]),r&&t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t[r]),s&&t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t[s])}(this.gl,t),this}set textureBaseLevel(t){const{gl:e}=this;this.bind(),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_BASE_LEVEL,t)}get textureBaseLevel(){const{gl:t}=this;return this.bind(),t.getTexParameter(t.TEXTURE_2D,t.TEXTURE_BASE_LEVEL)}set textureMaxLevel(t){const{gl:e}=this;this.bind(),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAX_LEVEL,t)}get textureMaxLevel(){const{gl:t}=this;return this.bind(),t.getTexParameter(t.TEXTURE_2D,t.TEXTURE_MAX_LEVEL)}getParameter(t){const{gl:e,glTexture:i}=this;return e.bindTexture(e.TEXTURE_2D,i),e.getTexParameter(e.TEXTURE_2D,e[t])}}Wt.counter=0;const Xt=[["RGB",new Set(["RGB","RGB8","RGB565","SRGB8","RGB8_SNORM","RGB565","R11F_G11F_B10F","RGB9_E5","RGB16F","R11F_G11F_B10F","RGB9_E5","RGB32F","RGB16F","R11F_G11F_B10F","RGB9_E5"])],["RGBA",new Set(["RGBA","RGBA8","RGB5_A1","RGBA4","SRGB8_ALPHA8","RGBA8_SNORM","RGBA4","RGB5_A1","RGB10_A2","RGB5_A1","RGBA16F","RGBA32F","RGBA16F"])],["RG",new Set(["RG8"])],["RED",new Set(["R8"])]];class Ht{constructor(t,e){this.context=t,this._width=0,this._height=0,this.numberOfImagesToLoad=6;const{gl:i}=t,n=i.createTexture();if(!n)throw Error("Unable to create a WebGLTexture!");this.texture=n,this.loadImage(i.TEXTURE_CUBE_MAP_POSITIVE_X,e.imagePosX),this.loadImage(i.TEXTURE_CUBE_MAP_NEGATIVE_X,e.imageNegX),this.loadImage(i.TEXTURE_CUBE_MAP_POSITIVE_Y,e.imagePosY),this.loadImage(i.TEXTURE_CUBE_MAP_NEGATIVE_Y,e.imageNegY),this.loadImage(i.TEXTURE_CUBE_MAP_POSITIVE_Z,e.imagePosZ),this.loadImage(i.TEXTURE_CUBE_MAP_NEGATIVE_Z,e.imageNegZ)}delete(){this.context.gl.deleteTexture(this.texture)}get ready(){return 0===this.numberOfImagesToLoad}get width(){return this._width}get height(){return this._height}bind(){const{gl:t}=this.context;t.bindTexture(t.TEXTURE_CUBE_MAP,this.texture)}activate(t,e,i){if(!this.ready)return;const{context:n,texture:r}=this,{gl:s}=n;s.activeTexture(s.TEXTURE0+t),s.bindTexture(s.TEXTURE_CUBE_MAP,r),e.uniform1i(i,t)}loadImage(t,e){const{width:i,height:n}=e;if(i!==n)throw Error(`Images in a CubeMap must be squares, but we got ${i}×${n}!`);if(0===this._width)this._width=i,this._height=n;else if(this._width!==i||this._height!==n)throw Error(`Images in a CubeMap must all have the same size, but we got ${this._width}×${this._height} and ${i}×${n}!`);const{context:r,texture:s}=this,{gl:o}=r;o.bindTexture(o.TEXTURE_CUBE_MAP,s),o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,e instanceof Image),o.texImage2D(t,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,e),this.numberOfImagesToLoad--,0===this.numberOfImagesToLoad&&(o.generateMipmap(o.TEXTURE_CUBE_MAP),o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_MIN_FILTER,o.LINEAR_MIPMAP_LINEAR),r.paint())}}class jt extends S{constructor(t,e){var i;super(),this.context=t,this.matrix=new d,this.tmpMat=new d,this.camera=null!==(i=e.camera)&&void 0!==i?i:new R,this.texture=new Ht(t,e),this.program=new ht(t,{vert:"#version 300 es\n\nin vec4 attPoint;\n\nout vec4 varPoint;\n\nvoid main() {\n    varPoint = attPoint;\n    gl_Position = vec4(attPoint.xy, 0.99999, 1.0);\n}",frag:"#version 300 es\n\nprecision highp float;\n\nuniform samplerCube uniTexture;\nuniform mat4 uniMatrix;\n\nin vec4 varPoint;\n\nout vec4 FragColor;\n\nvoid main() {\n    vec4 t = uniMatrix * varPoint;\n    FragColor = texture(uniTexture, normalize(t.xyz / t.w));\n}"});const n=new mt({attPoint:"vec2"});n.set("attPoint",new Float32Array([-1,1,1,1,-1,-1,1,-1])),this.vao=new xt(t.gl,this.program,[n])}delete(){const{vao:t}=this;t.delete()}paint(){const{context:t,vao:e,program:i,texture:n}=this,{gl:r}=t;i.use(),i.uniformMatrix4fv("uniMatrix",this.matrix),n.activate(0,i,"uniTexture"),e.bind(),r.drawArrays(r.TRIANGLE_STRIP,0,4);const{camera:s,matrix:o,tmpMat:a}=this;s!==t.camera&&(s.orientation=t.camera.orientation),o.from(s.matrixProjection),a.fromMat3(s.matrixModelView),a.m30=0,a.m31=0,a.m32=0,a.m33=1,a.m03=0,a.m13=0,a.m23=0,o.multiply(a).invert()}}class Zt extends L{constructor(t,{color:e,blend:i,depth:n,cull:r,stencil:s,name:o,children:a=[],onEnter:h,onExit:c}={}){const{gl:u}=t,l=[],d=[],m=function(t){return!0===t?[!0,!0,!0,!0]:!1===t?[!1,!1,!1,!1]:t}(e);Array.isArray(m)&&(l.push((()=>{this._color=u.getParameter(u.COLOR_WRITEMASK),u.colorMask(...m)})),d.push((()=>{var t;u.colorMask(...null!==(t=this._color)&&void 0!==t?t:[!0,!0,!0,!0])}))),i&&(l.push((()=>{this._blend=function(t){return{enabled:Boolean(t.getParameter(t.BLEND)),equationAlpha:t.getParameter(t.BLEND_EQUATION_ALPHA),equationColor:t.getParameter(t.BLEND_EQUATION_RGB),functionAlphaDst:t.getParameter(t.BLEND_DST_ALPHA),functionAlphaSrc:t.getParameter(t.BLEND_SRC_ALPHA),functionColorDst:t.getParameter(t.BLEND_DST_RGB),functionColorSrc:t.getParameter(t.BLEND_SRC_ALPHA)}}(u),X(u,i)})),d.push((()=>{this._blend&&X(u,this._blend)}))),n&&(l.push((()=>{this._depth=function(t){const[e,i]=t.getParameter(t.DEPTH_RANGE);return{enabled:Boolean(t.getParameter(t.DEPTH_TEST)),func:Number(t.getParameter(t.DEPTH_FUNC)),mask:Boolean(t.getParameter(t.DEPTH_WRITEMASK)),rangeMin:e,rangeMax:i}}(u),Y(u,n)})),d.push((()=>{this._depth&&Y(u,this._depth)}))),r&&(l.push((()=>{this._cull=function(t){return{enabled:Boolean(t.getParameter(t.CULL_FACE)),cullFace:t.getParameter(t.CULL_FACE_MODE)}}(u),j(u,r)})),d.push((()=>{this._cull&&j(u,this._cull)}))),s&&(l.push((()=>{this._stencil=Q(u),q(u,s)})),d.push((()=>{this._stencil&&q(u,this._stencil)}))),super(a,{onEnter(t,e){null==h||h(t,e),l.forEach((t=>t()))},onExit(t,e){d.forEach((t=>t())),null==c||c(t,e)}}),this.name=null!=o?o:`State/${this.name}`}}class Yt extends S{constructor(t){super(),this.context=t,this.texture=new Wt(t).loadBitmap(function(){const t=256,{canvas:e,ctx:i}=F(768,512);return Kt(i,0,0,t,"X","#f00","#fff"),Kt(i,1,0,t,"Y","#0f0","#000"),Kt(i,2,0,t,"Z","#00f","#fff"),Kt(i,0,1,t,"","#f00","#500"),Kt(i,1,1,t,"","#0f0","#050"),Kt(i,2,1,t,"","#00f","#005"),e}()).setParams({minFilter:"LINEAR",magFilter:"LINEAR"}).generateMipmap();const e=new mt({attPos:"vec3",attUV:"vec2"});e.set("attPos",new Float32Array([1,0,0,0,1,0,0,0,1,-1,0,0,0,-1,0,0,0,-1]));const i=1/3;e.set("attUV",new Float32Array([0,0,i,0,2*i,0,0,.5,i,.5,2*i,.5]));const n=new ht(t,{vert:"#version 300 es\n\nprecision mediump float;\n\nuniform mat4 uniModelViewMatrix;\nuniform mat4 uniProjectionMatrix;\nuniform float uniScreenHeight;\n\n/**\n * Position of the tip.\n */\nin vec4 attPos;\nin vec2 attUV;\n\nout vec2 varUV;\n\nvoid main() {\n    varUV = attUV;\n    vec4 point = uniModelViewMatrix * attPos;\n    gl_Position = uniProjectionMatrix * point;\n    point.y += 0.3;\n    point = uniProjectionMatrix * point;\n    gl_PointSize = uniScreenHeight * abs(gl_Position.y / gl_Position.w - point.y / point.w);\n}\n",frag:"#version 300 es\n\nprecision mediump float;\n\nuniform sampler2D uniTexture;\n\nin vec2 varUV;\nout vec4 FragColor;\n\n\nvoid main() {\n    vec2 uv = varUV + gl_PointCoord * vec2(0.333333333, 0.5);\n    FragColor = texture(uniTexture, uv);\n    if (FragColor.w < 1.0) {\n        discard;\n    }\n}\n"}),r=new xt(t.gl,n,[e]);this.prg=n,this.vao=r}delete(){this.vao.delete()}paint(){const{context:t,prg:e,vao:i}=this,{gl:n,camera:r}=t;e.use(),this.texture.activate(0),e.uniform1i("uniTexture",0),e.uniform1f("uniScreenHeight",t.height),e.uniformMatrix4fv("uniModelViewMatrix",r.matrixModelView),e.uniformMatrix4fv("uniProjectionMatrix",r.matrixProjection),i.bind(),n.drawArrays(n.POINTS,0,6)}}function Kt(t,e,i,n,r,s,o="#fff"){const a=(e+.5)*n,h=(i+.5)*n,c=.45*n;t.fillStyle=s,t.beginPath(),t.ellipse(a,h,c,c,0,0,2*Math.PI),t.fill(),r?(t.font=`bold ${.5*n}px sans-serif`,t.fillStyle=o,t.textAlign="center",t.textBaseline="middle",t.fillText(r,a,h)):(t.fillStyle=o,t.beginPath(),t.ellipse(a,h,.8*c,.8*c,0,0,2*Math.PI),t.fill())}class qt{constructor(t={}){this.options=t,this.eventTipClick=new y,this._canvas=null,this.context=null,this.cameraExternal=null,this.cameraInternal=new R({fovy:Math.PI/3,distance:2.7,near:.01,far:10}),this.orbiter=null,this.tipsPainter=null,this.handleExternalToInternal=t=>{this.cameraInternal.orientation=t.orientation},this.handleInternalToExternal=t=>{const{cameraExternal:e}=this;e&&(e.orientation=t.orientation)},this.handleTap=t=>{var e;const i=null===(e=this.context)||void 0===e?void 0:e.camera;if(!i)return;const{origin:n,direction:r}=i.castRay(t.x,t.y);let s=1,o=Qt[0];for(const t of Qt){const e=t.distanceToLineSquared(n,r);e<s&&(s=e,o=t)}if(s<1){const t=new c,e=new c,n=o;t.from(this.findAxisX()),t.isClose(n)?(e.from(this.findAxisY()),t.from(e).cross(n)):e.from(n).cross(t);const r=(new x).fromAxis(t,e,n);r.isEqual(i.orientation)&&r.rotateAroundY(Math.PI),this.eventTipClick.dispatch({from:new x(i.orientation),to:r})}},t.canvas&&(this.canvas=t.canvas)}attachCamera(t){this.detach(),this.cameraExternal=t,this.attach()}detach(){const t=this.cameraExternal;t&&(t.eventTransformChange.removeListener(this.handleExternalToInternal),this.cameraExternal=null)}attach(){var t;const e=this.cameraExternal;e&&e.eventTransformChange.addListener(this.handleExternalToInternal),null===(t=this.context)||void 0===t||t.paint()}get canvas(){return this._canvas}set canvas(t){var e;if(t===this._canvas)return;if(this._canvas=t,this.context){this.context.inputs.pointer.eventTap.removeListener(this.handleTap),this.context.destroy(),this.context=null;const{orbiter:t}=this;t&&(t.detach(),t.eventChange.removeListener(this.handleInternalToExternal))}if(null===(e=this.tipsPainter)||void 0===e||e.delete(),!t)return;const i=new tt(t,Object.assign({alpha:!0,depth:!0,antialias:!0,name:"GizmoCanvas"},this.options));i.inputs.pointer.eventTap.addListener(this.handleTap),this.context=i,i.camera=this.cameraInternal,this.orbiter=new et(i,{speedPanning:0,speedZoom:0}),this.orbiter.eventChange.addListener(this.handleInternalToExternal);const n=new Yt(i);this.tipsPainter=n,i.add(new vt(i,{color:[0,0,0,0],depth:1}),new At(i,{enabled:!0}),n),i.paint()}findAxisX(){let t=0,e=Qt[0];const i=new c,n=new l;n.fromQuat(this.cameraInternal.orientation).transpose();for(const r of Qt)i.from(r).applyMatrix(n),i.x>t&&(t=i.x,e=r);return e}findAxisY(){let t=0,e=Qt[0];const i=new c,n=new l;n.fromQuat(this.cameraInternal.orientation).transpose();for(const r of Qt)i.from(r).applyMatrix(n),i.y>t&&(t=i.y,e=r);return e}}const Qt=[new c(1,0,0),new c(0,1,0),new c(0,0,1),new c(-1,0,0),new c(0,-1,0),new c(0,0,-1)];class Jt{constructor(t={}){this.uniforms={},this.fragmentShaderCode=["vec4 color = texture(uniTexture, varUV);","return color;"],this.extraFunctions={},this.setUniforms=(t,e,i)=>{};const{uniforms:e,fragmentShaderCode:i,extraFunctions:n,setUniforms:r}=t;e&&(this.uniforms=e),i&&(this.fragmentShaderCode=i),n&&(this.extraFunctions=n),r&&(this.setUniforms=r)}}const te=new _(1,0);class ee extends Jt{constructor(t={}){const{size:e=4}=t,i=function(t){if(void 0===t)return te;if("number"==typeof t){const e=m.degreesToRadians(t);return new _(Math.cos(e),Math.sin(e))}return t}(t.direction),n=i.size,r=n>0?1/n:1,s=i.x*r,o=i.y*r,a=["vec2 s;","float f;"];let h=0;for(let t=0;t<e-1;t+=2){const i=e-t;h+=i,a.push(`s = ${t+1.4} * dir;`,`f = ${i.toFixed(1)};`,"color += f * texture(uniTexture, varUV + s);","color += f * texture(uniTexture, varUV - s);")}1&e&&(a.push(`s = ${e} * dir;`,"color += texture(uniTexture, varUV + s);","color += texture(uniTexture, varUV - s);"),h++),h=h+h+e+1,super({fragmentShaderCode:["vec2 dir = vec2(",[`uniInverseWidth * ${s.toFixed(9)},`,`uniInverseHeight * ${o.toFixed(9)}`],");",`vec4 color = ${(e+1).toFixed(1)} * texture(uniTexture, varUV);`,...a,`FragColor = color * ${(1/h).toFixed(9)};`],uniforms:{uniHueShift:"float",uniInverseWidth:"float",uniInverseHeight:"float"},setUniforms(t,e){t.uniform1f("uniInverseWidth",1/t.gl.drawingBufferWidth),t.uniform1f("uniInverseHeight",1/t.gl.drawingBufferHeight)}})}}class ie extends Jt{constructor(t={}){const{strength:e=1}=t;super({fragmentShaderCode:["vec2 dir = (varUV - vec2(0.5)) * 0.01 * uniStrength;","float r = texture(uniTexture, varUV + dir).r;","float g = texture(uniTexture, varUV).g;","float b = texture(uniTexture, varUV - dir).b;","FragColor = vec4(r, g, b, 1);"],uniforms:{uniStrength:"float"},setUniforms:(t,e)=>{t.uniform1f("uniStrength",this.strength),t.uniform1f("uniInverseHeight",1/t.gl.drawingBufferHeight)}}),this.strength=1,this.strength=e}}class ne extends Jt{constructor({hueShiftInDegrees:t=0}={}){super({fragmentShaderCode:["vec4 color = texture(uniTexture, varUV);","vec3 rgb = color.rgb;","const vec3 k = vec3(0.5773502691896258);","float cosAngle = cos(uniHueShift);","FragColor = vec4(",["rgb * cosAngle ","+ cross(k, rgb) * sin(uniHueShift) ","+ k * dot(k, rgb) * (1.0 - cosAngle),","color.a"],");"],uniforms:{uniHueShift:"float"}}),this.hueShift=0,this.setUniforms=(t,e)=>{t.uniform1f("uniHueShift",this.hueShift)},this.hueShiftInDegrees=t}get hueShiftInRadians(){return this.hueShift}set hueShiftInRadians(t){this.hueShift=t}get hueShiftInDegrees(){return 180*this.hueShift/Math.PI}set hueShiftInDegrees(t){this.hueShift=t*Math.PI/180}}class re extends Jt{constructor(){super({fragmentShaderCode:["vec2 uv = varUV;","vec4 color = texture(uniTexture, uv);","FragColor = color;"],uniforms:{uniZoom:"float",uniTranslation:"vec2"}})}}class se extends Jt{constructor({zoom:t=1}={}){super({fragmentShaderCode:["vec2 uv = (varUV - vec2(0.5) - uniTranslation) * uniZoom + vec2(0.5);","vec4 color = texture(uniTexture, uv);","FragColor = color;"],uniforms:{uniZoom:"float",uniTranslation:"vec2"}}),this.zoom=1,this.setUniforms=(t,e)=>{t.uniform1f("uniZoom",1/this.zoom),t.uniform2f("uniTranslation",this.translation.x,this.translation.y)},this.zoom=t,this.translation=new _}}var oe=i(7417);function ae(t){return!!t&&!Array.isArray(t)&&"object"==typeof t}function he(t,e,i="data"){if("unknown"===e)return;if("null"===e){if(null!==t)throw Error(`Expected ${i} to be null and not a ${typeof t}!`);return}if("string"==typeof e){if(typeof t!==e)throw Error(`Expected ${i} to be a ${e} and not a ${typeof t}!`);return}if(Array.isArray(e)){const[n]=e;switch(n){case"array":return void function(t,e,i){if(!Array.isArray(t))throw Error(`Expected ${e} to be an array and not a ${typeof t}!`);const[,n]=i;for(let i=0;i<t.length;i+=1)he(t[i],n,`${e}[${i}]`)}(t,i,e);case"map":return void function(t,e,i){if(!ae(t))throw Error(`Expected ${e} to be an object and not a ${typeof t}!`);const[,n]=i;for(const i of Object.keys(t))"string"==typeof i&&he(t[i],n,`${e}[${i}]`)}(t,i,e);case"?":return void function(t,e,i){if(void 0===t)return;const[,n]=i;he(t,n,e)}(t,i,e);case"|":return void function(t,e,i){const[,...n]=i;let r=Error(`No type has been defined for this alternative: ${JSON.stringify(i)}!`);for(const i of n)try{return void he(t,i,e)}catch(t){t instanceof Error&&(r=t)}throw r}(t,i,e);case"tuple":return void function(t,e,[,...i]){if(function(t,e="data"){if(!Array.isArray(t))throw Error(`${e} was expected to be an Array but we got ${typeof t}!`)}(t),i.length!==t.length)throw Error(`Expected ${e} to have ${i.length} elements, not ${t.length}!`);for(let n=0;n<i.length;n++){const r=i[n];he(t[n],r,`${e}[$i]`)}}(t,i,e);case"partial":return void function(t,e,[,i]){!function(t,e="data"){if(!ae(t))throw Error(`${e} was expected to be an object but we got ${typeof t}!`)}(t,e);for(const n of Object.keys(i)){if("string"!=typeof n)continue;const r=t[n];void 0!==r&&he(r,i[n],`${e}.${n}`)}}(t,i,e);case"literal":return void function(t,e,i){const[,...n]=i;for(const e of n)if(t===e)return;throw Error(`Expected ${e} to be a literal (${n.map((t=>`"${t}"`)).join(" | ")})!`)}(t,i,e);default:if(n.startsWith("array("))return void function(t,e,i,n){if(!Array.isArray(t))throw Error(`Expected ${e} to be an array and not a ${typeof t}!`);if(t.length!==n)throw Error(`${e} was expected to have a length of ${n}, but we got ${t.length}!`);const[,r]=i;for(let i=0;i<t.length;i+=1)he(t[i],r,`${e}[${i}]`)}(t,i,e,parseInt(n.substring(6,n.length-1),10));throw Error(`Don't know how to create a type guard for this kind of type: ${JSON.stringify(e)}`)}}if("object"!=typeof t)throw Error(`Expected ${i} to be an object and not a ${typeof t}!`);const n=t;for(const t of Object.keys(e))"string"==typeof t&&he(n[t],e[t],`${i}.${t}`)}function ce(t){he(t,["partial",{accessors:["array",{bufferView:["?","number"],byteOffset:["?","number"],componentType:"number",normalized:["?","boolean"],count:"number",type:"string",name:["?","string"]}],meshes:["array",{name:"string",primitives:["array",{attributes:["map","number"],indices:["?","number"],mode:["?","number"],material:["?","number"]}]}],images:["array",["partial",{bufferView:"number",mimeType:"string",name:"string",uri:"string"}]],bufferViews:["array",{buffer:"number",byteLength:"number",byteOffset:["?","number"],byteStride:["?","number"],target:["?","number"]}],materials:["array",le],samplers:["array",["partial",{minFilter:"number",magFilter:"number",wrapS:"number",wrapT:"number",name:"string"}]],textures:["array",["partial",{sampler:"number",source:"number",name:"string"}]]}])}const ue={index:"number",texCoord:["?","number"]},le=["partial",{name:"string",pbrMetallicRoughness:["partial",{baseColorFactor:["array(4)","number"],baseColorTexture:ue,metallicFactor:"number",roughnessFactor:"number",metalicRoughnessTexture:ue}],normalTexture:Object.assign(Object.assign({},ue),{scale:["?","number"]}),occlusionTexture:Object.assign(Object.assign({},ue),{strength:["?","number"]}),emissiveTexture:ue,alphaMode:["literal","OPAQUE","MASK","BLEND"],alphaCutoff:"number",doubleSided:"boolean"}];class de{constructor(t){this.cacheImages=new Map,this.cacheImageURLs=new Map,this.cacheBufferViewDatas=new Map;try{const e=function(t){const e=new DataView(t);if(1179937895!==e.getUint32(0,!0))throw Error("Invalid magic number for GLB file!");const i=e.getUint32(4,!0);if(2!==i)throw Error(`We support only version 2, but this file is in version ${i}!`);const n=e.getUint32(8,!0);let r={};const s=[];let o=12;for(;o<n;){const i=e.getUint32(o,!0);o+=4;const n=e.getUint32(o,!0);o+=4;const a=t.slice(o,o+i);if(o+=i,1313821514===n){const t=(new TextDecoder).decode(a);try{const e=JSON.parse(t);ce(e),r=e}catch(e){throw console.error("Unable to parse this JSON file:",t),console.error(e),Error("Invalid JSON data in the chunk!")}}else{if(5130562!==n)throw Error(`We got an invalid chunk type: 0x${n.toString(16).padStart(8,"0")}!`);s.push(a)}}return{gltf:r,chunks:s}}(t);this.gltf=e.gltf,this.chunks=e.chunks}catch(t){const e=t instanceof Error?t.message:JSON.stringify(t);throw Error(`[TgdParserGLTransfertFormatBinary] ${e}`)}}getScenes(){var t;return null!==(t=this.gltf.scenes)&&void 0!==t?t:[]}getScene(t){var e;const i=null===(e=this.gltf.scenes)||void 0===e?void 0:e[t];if(!i)throw Error(`Asset has no scene with index #${t}!`);return i}getNode(t){var e;const i=null===(e=this.gltf.nodes)||void 0===e?void 0:e[t];if(!i)throw Error(`Asset has no node with index #${t}!`);return i}getAccessor(t=0){var e;const i=null===(e=this.gltf.accessors)||void 0===e?void 0:e[t];if(!i)throw Error(`Asset has no accessor with index #${t}!`);return i}getMaterial(t){var e;const i=null===(e=this.gltf.materials)||void 0===e?void 0:e[t];if(!i)throw Error(`Asset has no material with index #${t}!`);return i}getMesh(t=0){var e;const i=null===(e=this.gltf.meshes)||void 0===e?void 0:e[t];if(!i)throw Error(`Asset has no mesh with index #${t}!`);return i}getMeshPrimitive(t=0,e=0){const i=this.getMesh(t).primitives[e];if(!i)throw Error(`Asset has no primitive #${e} in mesh #${t}!`);return i}getMeshPrimitiveIndices(t=0,e=0){var i,n;const r=this.getMeshPrimitive(t,e),s=this.getAccessor(null!==(i=r.indices)&&void 0!==i?i:0),o=this.getBufferViewData(null!==(n=s.bufferView)&&void 0!==n?n:0,s.componentType);return function(t){if(!(t instanceof Uint8Array||t instanceof Uint16Array||t instanceof Uint32Array))throw Error("Only Uint8Array, Uint16Array or Uint32Array are allowed for elements!")}(o),o}getAccessorByAttributeName(t,e){const{attributes:i}=t;if(!i||0===Object.keys(i).length)throw Error("No attributes found!");const n=i[e];if("number"!=typeof n)throw Error(`No attribute with name "${e}"!\nAvailable names are: ${Object.keys(i).map((t=>JSON.stringify(t))).join(", ")}.`);try{return this.getAccessor(n)}catch(t){const i=t instanceof Error?t.message:JSON.stringify(t);throw Error(`Attribute "${e}" pointed to an inexisting accessor!\n${i}`)}}createTexture2D(t,e){var i,n,r,s,o;const a=null===(i=this.gltf.textures)||void 0===i?void 0:i[e];if(!a)throw Error(`Asset has no texture with index #${e}!`);const h=null!==(o=null!==(n=a.source)&&void 0!==n?n:null===(s=null===(r=a.extensions)||void 0===r?void 0:r.EXT_texture_webp)||void 0===s?void 0:s.source)&&void 0!==o?o:0,c=this.getImageURL(h),u=new Wt(t);return c?function(t){return new Promise((e=>{const i=new Image;i.src=t,i.onload=()=>e(i),i.onerror=()=>e(null)}))}(c).then((t=>{t?u.loadBitmap(t):console.error("Unable to load this file:",c)})).catch(console.error):console.error(`[GLTF] texture index #${e} is empty!`),u}loadImage(t){return(0,oe.sH)(this,void 0,void 0,(function*(){const e=this.cacheImages.get(t);if(e)return e;const i=this.getImageURL(t);if(!i)return;const n=new Promise(((e,n)=>{const r=new Image;r.src=i,r.onload=()=>{e(r)},r.onerror=()=>{var e;console.error(`Unable to load image #${t}!`,null===(e=this.gltf.images)||void 0===e?void 0:e[t]),n()}}));return this.cacheImages.set(t,n),n}))}getImageURL(t){var e;const i=this.cacheImageURLs.get(t);if(i)return i;const{gltf:n}=this,r=null===(e=n.images)||void 0===e?void 0:e[t];if(!r)return;if(r.uri)return r.uri;if("number"!=typeof r.bufferView)return;const s=this.getBufferViewData(r.bufferView,"Uint8");if(!s)return;const o=new Blob([s],{type:r.mimeType}),a=URL.createObjectURL(o);return this.cacheImageURLs.set(t,a),a}getBufferViewData(t,e="Float32"){var i,n,r,s,o;if("number"!=typeof t)return this.getBufferViewData(null!==(i=t.bufferView)&&void 0!==i?i:0,t.componentType);const a=t,h=this.cacheBufferViewDatas.get(a);if(h)return h;const{gltf:c}=this,u=null===(n=c.bufferViews)||void 0===n?void 0:n[a];if(!u)throw Error(`No bufferView with index #${a}!`);const l=this.chunks[u.buffer],d=null!==(r=u.byteOffset)&&void 0!==r?r:0,m=function(t,e){switch(e){case 5120:return new Int8Array(t);case 5121:return new Uint8Array(t);case 5122:return new Int16Array(t);case 5123:return new Uint16Array(t);case 5125:return new Uint32Array(t);default:return new Float32Array(t)}}(l.slice(d,d+u.byteLength),function(t){if("number"==typeof t)return t;switch(t){case"Int8":return 5120;case"Uint8":return 5121;case"Int16":return 5122;case"Uint16":return 5123;case"Uint32":return 5125;default:return WebGL2RenderingContext.FLOAT}throw new Error("Function not implemented.")}(null!==(o=null!=e?e:null===(s=this.findAccessorForBufferView(a))||void 0===s?void 0:s.componentType)&&void 0!==o?o:"Float32"));return this.cacheBufferViewDatas.set(a,m),m}findAccessorForBufferView(t){var e;return(null!==(e=this.gltf.accessors)&&void 0!==e?e:[]).find((e=>e.bufferView===t))}setAttrib(t,e,i=0,n=0,r){var s,o,a,h,c;const{gltf:u}=this,l=null!==(o=null===(s=u.meshes)||void 0===s?void 0:s[i].primitives[n].attributes[null!=r?r:e])&&void 0!==o?o:-1,d=null===(a=u.accessors)||void 0===a?void 0:a[l];if(!d)throw Error(`No attribute "${null!=r?r:e}" for primitive #${n} of mesh #${i}!`);const m=null!==(h=d.bufferView)&&void 0!==h?h:0,f=null===(c=u.bufferViews)||void 0===c?void 0:c[m];if(!f)throw Error(`No bufferView with index #${m}!`);const g=this.getBufferViewData(m,d.componentType);t.set(e,g,{byteStride:f.byteStride,byteOffset:d.byteOffset,count:d.count})}makeGeometry({computeNormals:t,meshIndex:e=0,primitiveIndex:i=0,attPositionName:n="POSITION",attNormalName:r="NORMAL",attTextureCoordsName:s="TEXCOORD_0"}={}){const o=this.getMeshPrimitive(e,i);try{const{attributes:a}=o;if(!a)throw Error("No attributes found!");const h=this.getMeshPrimitiveIndices(e,i),c={[n]:"vec3"};"string"==typeof a[r]&&(c[r]="vec3"),"string"==typeof a[s]&&(c[s]="vec2");const u=new mt(c);return u.set(n,me(this.getBufferViewData(this.getAccessorByAttributeName(o,n)))),"string"==typeof a[r]&&u.set(r,me(this.getBufferViewData(this.getAccessorByAttributeName(o,r)))),"string"==typeof a[s]&&u.set(s,me(this.getBufferViewData(this.getAccessorByAttributeName(o,s)))),new Pt({computeNormalsIfMissing:t,dataset:u,elements:h,attPosition:n,attNormal:r,attUV:s})}catch(t){const n=t instanceof Error?t.message:JSON.stringify(t);throw Error(`Error in primitive #${i} of mesh #${e}:\n${n}`)}}}function me(t){if(t instanceof Float32Array)return t;throw new Error("We were expecting a Float32Array!")}class fe{constructor(t){this.name="Mesh",this.attPosition=[],this.attNormal=[],this.attUV=[],this.elements=[],this.elementIndex=0,this.mapVertices=new Map,this.points=[],this.normals=[],this.verticesPerTriangle=[],this.normalPerTriangle=[],this.trianglesPerVertex=[],this.uvs=[],this.onObject=t=>{this.name=t},this.onVertex=(t,e,i)=>{this.points.push([t,e,i])},this.onNormal=(t,e,i)=>{this.normals.push([t,e,i])},this.onTexture=(t,e)=>{this.uvs.push([t,e])},this.onFace=t=>{if(3!==t.length)throw Error("We can only deal with triangles!");const e=t.map(this.getElem);this.elements.push(...e),this.normalPerTriangle.push(new c(0,0,0)),this.verticesPerTriangle.push(e);const i=this.normalPerTriangle.length-1;e.forEach((t=>{var e,n;null!==(e=(n=this.trianglesPerVertex)[t])&&void 0!==e||(n[t]=[]),this.trianglesPerVertex[t].push(i)}))},this.getElem=t=>{var e;const i=this.key(t),n=null!==(e=this.mapVertices.get(i))&&void 0!==e?e:-1;if(n>-1)return n;const[r,s,o]=this.points[t.vertex];if(this.attPosition.push(r,s,o),"number"==typeof t.normal){const[e,i,n]=this.normals[t.normal];this.attNormal.push(e,i,n)}if("number"==typeof t.uv){const[e,i]=this.uvs[t.uv];this.attUV.push(e,i)}return this.mapVertices.set(i,this.elementIndex),this.elementIndex++},this.reset();const{onVertex:e,onNormal:i,onTexture:n,onFace:r,onObject:s}=this;!function(t,e={}){const{onVertex:i,onNormal:n,onTexture:r,onFace:s,onObject:o}=e;for(const e of function*(t){const e=t.length;let i=0,n=0;for(;i>-1&&i<e&&(i=t.indexOf("\n",n),!(i<0));)yield t.substring(n,i).trim(),n=i+1;return t.substring(n).trim()}(t)){const t=e.trimStart();if(i&&t.startsWith("v ")){const e=t.substring(2).split(" ").map((t=>Number(t)));ge(e)&&i(...e)}else if(s&&t.startsWith("f "))s(t.substring(2).split(" ").map((t=>{const[e,i,n]=t.split("/");return{vertex:Number(e)-1,normal:n?Number(n)-1:void 0,uv:i?Number(i)-1:void 0}})));else if(n&&t.startsWith("vn ")){const e=t.substring(3).split(" ").map((t=>Number(t)));ge(e)&&n(...e)}else if(r&&t.startsWith("vt ")){const[e,i,n]=t.substring(3).split(" ").map((t=>Number(t)));r(e,i,n)}else o&&t.startsWith("o ")&&o(t.substring(2))}}(t,{onVertex:e,onNormal:i,onTexture:n,onFace:r,onObject:s})}makeGeometry({computeNormals:t}={}){const e={attPosition:{name:"POSITION",data:new Float32Array(this.attPosition)},computeNormalsIfMissing:t};this.attNormal.length>0&&(e.attNormal={name:"NORMAL",data:new Float32Array(this.attNormal)}),this.attUV.length>0&&(e.attUV={name:"TEXTCOORDS_0",data:new Float32Array(this.attUV)});const{elements:i,elementIndex:n}=this;return e.elements=n<=256?new Uint8Array(i):n<=65536?new Uint16Array(i):new Uint32Array(i),Pt.make(e)}computeNormals(){const t=new c,e=new c,i=new c;this.normalPerTriangle.forEach(((n,r)=>{const[s,o,a]=this.verticesPerTriangle[r];this.readVertexInto(s,t),this.readVertexInto(o,e).subtract(t),this.readVertexInto(a,i).subtract(t),n.from(e.cross(i).normalize())})),this.attNormal=[];for(let t=0;t<this.elementIndex;t++){const e=new c(0,0,0);this.trianglesPerVertex[t].forEach((t=>e.add(this.normalPerTriangle[t])));const[i,n,r]=e.normalize();this.attNormal.push(i,n,r)}}reset(){this.name="Mesh",this.attPosition=[],this.attNormal=[],this.attUV=[],this.elements=[],this.elementIndex=0,this.points=[],this.normals=[],this.verticesPerTriangle=[],this.trianglesPerVertex=[],this.normalPerTriangle=[],this.uvs=[],this.mapVertices.clear(),this.mapVertices.clear()}key(t){return`${t.vertex}/${t.normal}`}readVertexInto(t,e){const i=this.attPosition,n=3*t;return e.reset(i[n+0],i[n+1],i[n+2]),e}}function ge(t){return 3===t.length}function pe(t){return(0,oe.sH)(this,void 0,void 0,(function*(){try{const e=yield fetch(t);if(!e.ok)throw Error(`Unable to load GLB from url "${t}"!\nError #${e.status}: ${e.statusText}`);const i=yield e.arrayBuffer();return new de(i)}catch(t){return console.error(t),null}}))}function xe(t){return(0,oe.sH)(this,void 0,void 0,(function*(){try{const e=yield fetch(t);return yield e.arrayBuffer()}catch(t){return console.error(t),null}}))}function Ee(t){return(0,oe.sH)(this,void 0,void 0,(function*(){return new Promise((e=>{const i=new Image;i.onload=()=>e(i),i.onerror=()=>{console.error("Unable to load image: ",t),e(null)},i.src=t}))}))}class ve{static computeByteLength(t,e,i,n){let r=t*i*n;for(;3&r;)r++;return e*r}constructor(t,e,i,n,r){this.buffer=t,this.cols=e,this.rows=i,this.dimensions=n,this.bytesPerElement=r;const s=ve.computeByteLength(e,i,n,r);if(t.byteLength<s)throw Error(`Your data is ${t.byteLength} bytes long.\nBut for a ${e}x${i} table we need at least ${s} bytes!\nPlease use TgdTable.computeByteLength() to get the correct length (with all needed paddings).`);const o=n*r;this.bytesPerVector=o;let a=e*o,h=0;for(;3&a;)h++,a++;this.bytePadding=h,this.bytesPerRow=a,this.bytesPerElement=r,this.view=new DataView(t)}offset(t,e,i=0){return e*this.bytesPerRow+t*this.bytesPerVector+this.bytesPerElement*i}setFloat32(t,e,i,n){const r=this.offset(e,i,n);this.view.setFloat32(r,t)}getFloat32(t,e,i){const n=this.offset(t,e,i);return this.view.getFloat32(n)}setUint8(t,e,i,n){const r=this.offset(e,i,n);this.view.setUint8(r,t)}getUint8(t,e,i){const n=this.offset(t,e,i);return this.view.getUint8(n)}}class be{constructor(t,e,i){this.cols=t,this.rows=e,this.dimensions=i;const n=ve.computeByteLength(t,e,i,Uint8Array.BYTES_PER_ELEMENT),r=new ArrayBuffer(n);this.table=new ve(r,t,e,i,Uint8Array.BYTES_PER_ELEMENT)}get buffer(){return this.table.buffer}set(t,e,i,n){this.table.setUint8(t,e,i,n)}setVec(t,e,i){t.forEach(((t,n)=>this.table.setUint8(t,e,i,n)))}get(t,e,i){return this.table.getUint8(t,e,i)}}}}]);