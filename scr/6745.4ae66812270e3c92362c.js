"use strict";(self.webpackChunk_tolokoban_tgd=self.webpackChunk_tolokoban_tgd||[]).push([[6745],{6745:(t,e,n)=>{function i(t){if(t instanceof Uint8Array)return WebGL2RenderingContext.UNSIGNED_BYTE;if(t instanceof Uint16Array)return WebGL2RenderingContext.UNSIGNED_SHORT;if(t instanceof Uint32Array)return WebGL2RenderingContext.UNSIGNED_INT;throw new Error("[webglElementTypeFromDataView] drawElements() and drawElementsInstanced() can only be fed with Uint8Array, Uint16Array or Uint32Array!")}function r(t){if(s)for(const e in s)if(s[e]===t)return e;return`${t}`}n.d(e,{xNY:()=>rt,GbF:()=>Mn,tfp:()=>Qt,pwt:()=>qt,nU$:()=>Yn,I9j:()=>ue,Eim:()=>Gn,vAg:()=>Wn,LiV:()=>Xn,ChJ:()=>Hn,i0P:()=>jn,HBr:()=>Zn,ZWB:()=>Ne,oq:()=>Qe,U5Z:()=>Je,rBx:()=>qe,$Hl:()=>an,Ai9:()=>cn,qD4:()=>ln,zkP:()=>fn,M3Z:()=>mn,tbm:()=>ct,SBc:()=>ge,b6h:()=>pe,whB:()=>Ae,o57:()=>Ee,iFy:()=>Te,D$w:()=>Re,K7:()=>Ce,ZJl:()=>Se,g6h:()=>gn,dRj:()=>pn,buV:()=>En,b5H:()=>Tn,$Rn:()=>yn,$ff:()=>wn,Ipk:()=>ve,qjF:()=>Qn,a6X:()=>se,HIE:()=>Q,_uR:()=>ii,HTX:()=>nn,tSS:()=>et,hNi:()=>g,oao:()=>p,ZV_:()=>me,JAF:()=>Mt,vRM:()=>ft,$4L:()=>lt,P11:()=>dt,_b$:()=>Et,emj:()=>bt,HPH:()=>f,fTR:()=>c,P_T:()=>m,ZvP:()=>d,bj4:()=>Tt,koR:()=>Nn,OKh:()=>Sn,PS_:()=>Bn,B1P:()=>In,huU:()=>$n,EPI:()=>Cn,bKO:()=>Dn,SDv:()=>Un,jw$:()=>On,WLb:()=>Fn,Cdl:()=>ne,Wcc:()=>pt,FsI:()=>vt,ojE:()=>xt,vSU:()=>ti,TCe:()=>Jn,V_9:()=>en,jWq:()=>ei,TB8:()=>Vn,Lmp:()=>i,aMr:()=>Dt,TfJ:()=>zt,Eg5:()=>Wt,d7A:()=>jt});const s=document.createElement("canvas").getContext("webgl2");function o(t,e=6){const n=Math.pow(10,e),i=[];let r=0;for(const s of t){const t=(Math.round(s*n)/n).toFixed(e);r=Math.max(r,t.length),i.push(t)}return i.map((t=>t.padStart(r," ")))}var a=n(9077);function h(t,e,n){return t<e?e:t>n?n:t}function c(t,e,n){return(1-n)*t+n*e}const u=180/Math.PI,l=Math.PI/180;function f(t){return t*l}function d(t){return t*u}function m(t,e,n){const i=n-e;return 0===i?e:t<e?t+Math.ceil((e-t)/i)*i:t>n?t-Math.ceil((t-n)/i)*i:t}class g extends Float32Array{static newFrom([t,e,n]){return new g(t,e,n)}static newFromMix([t,e,n],[i,r,s],o=.5){const a=1-o;return new g(a*t+o*i,a*e+o*r,a*n+o*s)}static distance(t,e){const n=e.x-t.x,i=e.y-t.y,r=e.z-t.z;return Math.hypot(n,i,r)}constructor(t=0,e=0,n=0){if(super(3),"number"!=typeof t)return this.x=t[0],this.y=t[1],void(this.z=t[2]);this.x=t,this.y=e,this.z=n}clone(){return new g(this)}mix(t,e=.5){const n=1-e;return this.x=n*this.x+e*t.x,this.y=n*this.y+e*t.y,this.z=n*this.z+e*t.z,this}isEqual(t){const[e,n,i]=t;return e===this.x&&n===this.y&&i===this.z}isClose(t,e=1e-6){const[n,i,r]=t;return!(Math.abs(n-this.x)>e||Math.abs(i-this.y)>e||Math.abs(r-this.z)>e)}rotateAround(t,e){const n=Math.cos(e),i=Math.sin(e),[r,s,o]=this,[a,h,c]=t,u=h*o-c*s,l=c*r-a*o,f=a*s-h*r,d=(r*a+s*h+o*c)*(1-n);return this.x=r*n+u*i+a*d,this.y=s*n+l*i+h*d,this.z=o*n+f*i+c*d,this}applyMatrix(t){const{x:e,y:n,z:i}=this;return this.x=e*t.m00+n*t.m10+i*t.m20,this.y=e*t.m01+n*t.m11+i*t.m21,this.z=e*t.m02+n*t.m12+i*t.m22,this}applyQuaternion(t){return a.gL(this,this,t),this}from(t){const[e,n,i]=t;return this.x=e,this.y=n,this.z=i,this}fromOpposite(t){const[e,n,i]=t;return this.x=-e,this.y=-n,this.z=-i,this}fromMix(t,e,n){const[i,r,s]=t,[o,a,h]=e;return this.reset(c(i,o,n),c(r,a,n),c(s,h,n))}reset(t=0,e=0,n=0){return this[0]=t,this[1]=e,this[2]=n,this}distanceToLineSquared(t,e){const[n,i,r]=this,[s,o,a]=t,[h,c,u]=e,l=h*(n-s)+c*(i-o)+u*(r-a),f=n-(s+l*h),d=i-(o+l*c),m=r-(a+l*u);return f*f+d*d+m*m}get x(){return this[0]}set x(t){this[0]=t}get y(){return this[1]}set y(t){this[1]=t}get z(){return this[2]}set z(t){this[2]=t}add(...t){for(const e of t){const[t,n,i]=e;this[0]+=t,this[1]+=n,this[2]+=i}return this}addWithScale(t,e){return this[0]+=t.x*e,this[1]+=t.y*e,this[2]+=t.z*e,this}subtract(t){return this[0]-=t[0],this[1]-=t[1],this[2]-=t[2],this}scale(t){return this[0]*=t,this[1]*=t,this[2]*=t,this}dot(t){return this[0]*t[0]+this[1]*t[1]+this[2]*t[2]}get size(){return Math.hypot(this[0],this[1],this[2])}normalize(){const t=this[0]*this[0]+this[1]*this[1]+this[2]*this[2];return 0===t?this:this.scale(1/Math.sqrt(t))}cross(t){const[e,n,i]=this,[r,s,o]=t;return this[0]=n*o-s*i,this[1]=i*r-o*e,this[2]=e*s-r*n,this}random(){return this[0]=Math.random()-.5,this[1]=Math.random()-.5,this[2]=Math.random()-.5,this}debug(t="vec3"){const{x:e,y:n,z:i}=this,r=[e,n,i].map((t=>t.toFixed(6)));console.log(`${t}:   `,r.join(" | "),"   length:",Math.hypot(e,n,i))}}g.X=new g(1,0,0),g.Y=new g(0,1,0),g.Z=new g(0,0,1);class p extends Float32Array{static fromSlerp([t,e,n,i=0],[r,s,o,a=0],h=.5){const c=1-h;return new p(c*t+h*r,c*e+h*s,c*n+h*o,c*i+h*a)}constructor(t=0,e=0,n=0,i=1){if(super(4),t instanceof p)return this.x=t.x,this.y=t.y,this.z=t.z,void(this.w=t.w);if(t instanceof g)return this.x=t.x,this.y=t.y,this.z=t.z,void(this.w=i);if(Array.isArray(t)){if("number"==typeof e){const[n,i,r]=t;return this.x=null!=n?n:0,this.y=null!=i?i:0,this.z=null!=r?r:0,void(this.w=e)}{const[e,n,i,r]=t;return this.x=null!=e?e:0,this.y=null!=n?n:0,this.z=null!=i?i:0,void(this.w=null!=r?r:1)}}this.x=t,this.y=e,this.z=n,this.w=i}reset(t=0,e=0,n=0,i=1){return this.x=t,this.y=e,this.z=n,this.w=i,this}from(t){const[e,n,i,r]=t;return this.x=e,this.y=n,this.z=i,this.w=r,this}fromVec3(t){const[e,n,i]=t;return this.x=e,this.y=n,this.z=i,this}clone(){return new p(this)}mix(t,e=.5){return this.x=(1-e)*this.x+e*t.x,this.y=(1-e)*this.y+e*t.y,this.z=(1-e)*this.z+e*t.z,this.w=(1-e)*this.w+e*t.w,this}isEqual(t){const[e,n,i,r]=t;return e===this.x&&n===this.y&&i===this.z&&r===this.w}isClose({x:t,y:e,z:n,w:i},r=1e-6){return!(Math.abs(t-this.x)>r||Math.abs(e-this.y)>r||Math.abs(n-this.z)>r||Math.abs(i-this.w)>r)}applyMatrix(t){const{x:e,y:n,z:i,w:r}=this;return this.x=e*t.m00+n*t.m01+i*t.m02+r*t.m03,this.y=e*t.m10+n*t.m11+i*t.m12+r*t.m13,this.z=e*t.m20+n*t.m21+i*t.m22+r*t.m23,this.w=e*t.m30+n*t.m31+i*t.m32+r*t.m33,this}get x(){return this[0]}set x(t){this[0]=t}get y(){return this[1]}set y(t){this[1]=t}get z(){return this[2]}set z(t){this[2]=t}get w(){return this[3]}set w(t){this[3]=t}add(...t){for(const e of t)this[0]+=e[0],this[1]+=e[1],this[2]+=e[2],e.length>3&&(this[3]+=e[3]);return this}subtract(t){return this[0]-=t[0],this[1]-=t[1],this[2]-=t[2],t.length>3&&(this[3]-=t[3]),this}scale(t){return this[0]*=t,this[1]*=t,this[2]*=t,this[3]*=t,this}dot(t){return this[0]*t[0]+this[1]*t[1]+this[2]*t[2]+this[3]*t[3]}get size(){return Math.hypot(this[0],this[1],this[2],this[3])}normalize(){const t=this[0]*this[0]+this[1]*this[1]+this[2]*this[2]+this[3]*this[3];return 0===t?this:this.scale(1/Math.sqrt(t))}debug(t="vec4"){const{x:e,y:n,z:i,w:r}=this,s=[e,n,i,r].map((t=>t.toFixed(6)));console.log(`${t}:   `,s.join(" | "),`  (length = ${this.size})`)}}p.X=new p(1,0,0,0),p.Y=new p(0,1,0,0),p.Z=new p(0,0,1,0),p.W=new p(0,0,0,1);var v=n(3752);class x extends Float32Array{constructor(t=1,e=0,n=0,i=0,r=0,s=1,o=0,a=0,h=0,c=0,u=1,l=0,f=0,d=0,m=0,g=1){super("number"==typeof t?[t,e,n,i,r,s,o,a,h,c,u,l,f,d,m,g]:t)}reset(t=p.X,e=p.Y,n=p.Z,i=p.W){const[r,s,o,a]=t,[h,c,u,l]=e,[f,d,m,g]=n,[v,x,E,A]=i;return this.m00=r,this.m01=s,this.m02=o,this.m03=a,this.m10=h,this.m11=c,this.m12=u,this.m13=l,this.m20=f,this.m21=d,this.m22=m,this.m23=g,this.m30=v,this.m31=x,this.m32=E,this.m33=A,this}multiply(t){return v.lw(this,this,t),this}invert(t){return v.B8(this,null!=t?t:this),this}get translation(){const{m03:t,m13:e,m23:n}=this;return new g(t,e,n)}set translation(t){const[e,n,i]=t;this.m03=e,this.m13=n,this.m23=i}toTanslation(t){return t.x=this.m03,t.y=this.m13,t.z=this.m23,this}translate(t){const[e,n,i]=t;return this.m03+=e,this.m13+=n,this.m23+=i,this}from(t){var e;for(let n=0;n<this.length;n++)this[n]=null!==(e=t[n])&&void 0!==e?e:0;return this}fromMat3(t){return this.m00=t.m00,this.m01=t.m01,this.m02=t.m02,this.m10=t.m10,this.m11=t.m11,this.m12=t.m12,this.m20=t.m20,this.m21=t.m21,this.m22=t.m22,this}toAxes(t,e,n){return this.toAxisX(t),this.toAxisY(e),this.toAxisZ(n)}toAxisX(t){return t.x=this.m00,t.y=this.m01,t.z=this.m02,this}toAxisY(t){return t.x=this.m10,t.y=this.m11,t.z=this.m12,this}toAxisZ(t){return t.x=this.m20,t.y=this.m21,t.z=this.m22,this}fromQuat({x:t,y:e,z:n,w:i}){return v.I0(this,[t,e,n,i]),this}get m00(){return this[E]}set m00(t){this[E]=t}get m10(){return this[A]}set m10(t){this[A]=t}get m20(){return this[b]}set m20(t){this[b]=t}get m30(){return this[T]}set m30(t){this[T]=t}get m01(){return this[y]}set m01(t){this[y]=t}get m11(){return this[w]}set m11(t){this[w]=t}get m21(){return this[_]}set m21(t){this[_]=t}get m31(){return this[R]}set m31(t){this[R]=t}get m02(){return this[M]}set m02(t){this[M]=t}get m12(){return this[P]}set m12(t){this[P]=t}get m22(){return this[C]}set m22(t){this[C]=t}get m32(){return this[S]}set m32(t){this[S]=t}get m03(){return this[L]}set m03(t){this[L]=t}get m13(){return this[N]}set m13(t){this[N]=t}get m23(){return this[U]}set m23(t){this[U]=t}get m33(){return this[F]}set m33(t){this[F]=t}debug(t="Mat4"){const e=o([this.m00,this.m01,this.m02,this.m03]),n=o([this.m10,this.m11,this.m12,this.m13]),i=o([this.m20,this.m21,this.m22,this.m23]),r=o([this.m30,this.m31,this.m32,this.m33]);console.log(t),console.log("   ",e.join(" | ")),console.log("   ",n.join(" | ")),console.log("   ",i.join(" | ")),console.log("   ",r.join(" | "))}}const E=0,A=1,b=2,T=3,y=4,w=5,_=6,R=7,M=8,P=9,C=10,S=11,L=12,N=13,U=14,F=15;var O=n(9805);class I extends Float32Array{constructor(t=1,e=0,n=0,i=0,r=1,s=0,o=0,a=0,h=1){if("number"==typeof t&&"number"==typeof e&&"number"==typeof n)super([t,e,n,i,r,s,o,a,h]);else if((t instanceof g||t instanceof p)&&(e instanceof g||e instanceof p)&&(n instanceof g||n instanceof p)){const i=t,r=e,s=n;super([i.x,i.y,i.z,r.x,r.y,r.z,s.x,s.y,s.z])}else if(t instanceof I){const e=t;super([e.m00,e.m10,e.m20,e.m01,e.m11,e.m21,e.m02,e.m12,e.m22])}else{if(!(t instanceof x))throw console.error("[TgdMat3]",arguments),new Error("Invalid TgdMat3 initialization!");{const e=t;super([e.m00,e.m10,e.m20,e.m01,e.m11,e.m21,e.m02,e.m12,e.m22])}}}multiply(t){return O.lw(this,this,t),this}transpose(){let t=this.m10;return this.m10=this.m01,this.m01=t,t=this.m20,this.m20=this.m02,this.m02=t,t=this.m21,this.m21=this.m12,this.m12=t,this}fromQuat({x:t,y:e,z:n,w:i}){return O.I0(this,[t,e,n,i]),this}toAxes(t,e,n){return this.toAxisX(t),this.toAxisY(e),this.toAxisZ(n)}toAxisX(t){return t.x=this.m00,t.y=this.m01,t.z=this.m02,this}toAxisY(t){return t.x=this.m10,t.y=this.m11,t.z=this.m12,this}toAxisZ(t){return t.x=this.m20,t.y=this.m21,t.z=this.m22,this}scale(t){return this[0]*=t,this[1]*=t,this[2]*=t,this[3]*=t,this[4]*=t,this[5]*=t,this[6]*=t,this[7]*=t,this[8]*=t,this}get m00(){return this[B]}set m00(t){this[B]=t}get m10(){return this[D]}set m10(t){this[D]=t}get m20(){return this[$]}set m20(t){this[$]=t}get m01(){return this[V]}set m01(t){this[V]=t}get m11(){return this[z]}set m11(t){this[z]=t}get m21(){return this[G]}set m21(t){this[G]=t}get m02(){return this[k]}set m02(t){this[k]=t}get m12(){return this[W]}set m12(t){this[W]=t}get m22(){return this[X]}set m22(t){this[X]=t}debug(t="Mat3"){const e=o([this.m00,this.m01,this.m02]),n=o([this.m10,this.m11,this.m12]),i=o([this.m20,this.m21,this.m22]);console.log(t,this.slice()),console.log("   ",e.join(" | ")),console.log("   ",n.join(" | ")),console.log("   ",i.join(" | "))}}const B=0,D=1,$=2,V=3,z=4,G=5,k=6,W=7,X=8;var H=n(9007);const j=new g,Z=new g,Y=new g,K=new I;class Q extends p{static fromMatrix(t){const e=new Q;return e.fromMatrix(t),e}static fromFace(t){return(new Q).face(t)}static fromSlerp(t,e,n){return(new Q).fromSlerp(t,e,n)}constructor(t=0,e=0,n=0,i=1){if(Array.isArray(t)){const[e,n,i,r]=t;super(e,n,i,r)}else"number"==typeof t?super(t,e,n,i):super(t)}clone(){return new Q(this)}multiply(t){return H.lw(this,this,t),this}fromSlerp(t,e,n){const[i,r,s,o]=t;let a,h,[c,u,l,f]=e,d=i*c+r*u+s*l+o*f;if(d<0&&(d=-d,c=-c,u=-u,l=-l,f=-f),1-d>1e-6){const t=Math.acos(d),e=1/Math.sin(t);a=Math.sin((1-n)*t)*e,h=Math.sin(n*t)*e}else a=1-n,h=n;return this.x=a*i+h*c,this.y=a*r+h*u,this.z=a*s+h*l,this.w=a*o+h*f,this}fromAxesTransposed([t,e,n],[i,r,s],[o,a,h]){return this.fromAxes([t,i,o],[e,r,a],[n,s,h])}fromAxes(t,e,n){const[i,r,s]=n;return H.ml(this,[-i,-r,-s],t,e),this}fromMatrix(t){return H.Gn(this,t),this}rotateAround(t,e){return K.fromQuat(this).toAxes(j,Z,Y),j.rotateAround(t,e),Z.rotateAround(t,e),Y.rotateAround(t,e),this.fromAxes(j,Z,Y)}static rotateAroundX(t){return(new Q).rotateAroundX(t)}rotateAroundX(t){return this.rotateAround(g.X,t)}static rotateAroundY(t){return(new Q).rotateAroundY(t)}rotateAroundY(t){return this.rotateAround(g.Y,t)}static rotateAroundZ(t){return(new Q).rotateAroundZ(t)}rotateAroundZ(t){return this.rotateAround(g.Z,t)}toAxisX(t){const[e,n,i,r]=this,s=e+e,o=n+n,a=i+i,h=n*s,c=n*o,u=i*s,l=i*a,f=r*o,d=r*a;return t.x=1-c-l,t.y=h-d,t.z=u+f,t}toAxisY(t){const[e,n,i,r]=this,s=e+e,o=i+i,a=e*s,h=n*s,c=i*(n+n),u=i*o,l=r*s,f=r*o;return t.x=h+f,t.y=1-a-u,t.z=c-l,t}toAxisZ(t){const{x:e,y:n,z:i,w:r}=this,s=e+e,o=n+n,a=e*s,h=n*o,c=i*s,u=i*o,l=r*s,f=r*o;return t.x=c-f,t.y=u+l,t.z=1-a-h,t}toMatrix(t){const e=new g,n=new g,i=new g;return this.toAxisX(e),this.toAxisY(n),this.toAxisZ(i),t.m00=e.x,t.m01=e.y,t.m02=e.z,t.m10=n.x,t.m11=n.y,t.m12=n.z,t.m20=i.x,t.m21=i.y,t.m22=i.z,t}invert(){return H.B8(this,this),this}face(t="+X+Y+Z"){const[e,n,i,r]=tt[t];return this.x=e,this.y=n,this.z=i,this.w=r,this}}const q=Math.sqrt(2)/2,J=.5,tt={"-X-Y+Z":[0,0,1,0],"-X-Z-Y":[0,-q,+q,0],"-X+Y-Z":[0,1,0,0],"-X+Z+Y":[0,+q,+q,0],"-Y-X-Z":[+q,-q,0,0],"-Y-Z+X":[+J,-J,+J,-J],"-Y+X+Z":[0,0,-q,+q],"-Y+Z-X":[+J,-J,-J,+J],"-Z-X+Y":[+J,-J,-J,-J],"-Z-Y-X":[-q,0,+q,0],"-Z+X-Y":[+J,+J,-J,+J],"-Z+Y+X":[0,+q,0,+q],"+X-Y-Z":[1,0,0,0],"+X-Z+Y":[-q,0,0,+q],"+X+Y+Z":[0,0,0,1],"+X+Z-Y":[+q,0,0,+q],"+Y-X+Z":[0,0,+q,+q],"+Y-Z-X":[-J,-J,+J,+J],"+Y+X-Z":[+q,+q,0,0],"+Y+Z+X":[+J,+J,+J,+J],"+Z-X-Y":[+J,-J,+J,+J],"+Z-Y+X":[+q,0,+q,0],"+Z+X+Y":[+J,+J,+J,-J],"+Z+Y-X":[0,-q,0,+q]};class et{constructor(t){var e,n,i,r;this._matrix=new x(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this._position=new g(0,0,0),this._orientation=new Q(0,0,0,1),this._scale=new g(1,1,1),this._distance=0,this.tmpVec3=new g,this._axisX=new g,this._axisY=new g,this._axisZ=new g,this.dirty=!1,t&&(t instanceof et?this.from(t):(this.distance=null!==(e=t.distance)&&void 0!==e?e:this.distance,this.position=null!==(n=t.position)&&void 0!==n?n:this.position,this.orientation=null!==(i=t.orientation)&&void 0!==i?i:this.orientation,this.scale=null!==(r=t.scale)&&void 0!==r?r:this.scale),this.updateMatrix())}clone(){return new et(this)}from(t){var e,n,i,r;return this.position=null!==(e=t.position)&&void 0!==e?e:this.position,this.orientation=null!==(n=t.orientation)&&void 0!==n?n:this.orientation,this.scale=null!==(i=t.scale)&&void 0!==i?i:this.scale,this.distance=null!==(r=t.distance)&&void 0!==r?r:this.distance,this.updateMatrix(),this}fromMatrix(t){return this.matrix.from(t),this.dirty=!1,this}get matrix(){return this.updateIfNeeded(),this._matrix}set matrix(t){this._matrix.from(t),this.dirty=!1}get axisX(){return this.updateIfNeeded(),this._axisX}get axisY(){return this.updateIfNeeded(),this._axisY}get axisZ(){return this.updateIfNeeded(),this._axisZ}updateIfNeeded(){if(!this.dirty)return;const t=this._matrix;v.o1(t,this._orientation,this._position,this._scale),t.toAxisX(this._axisX),t.toAxisY(this._axisY),t.toAxisZ(this._axisZ);const e=this._distance;0!==e&&(this.tmpVec3.reset(0,0,e).applyQuaternion(this._orientation),t.m03+=this.tmpVec3.x,t.m13+=this.tmpVec3.y,t.m23+=this.tmpVec3.z),this.dirty=!1}reset(){return this.orientation.reset(),this.position.reset(),this.scale.reset(),this.dirty=!0,this}get distance(){return this._distance}set distance(t){this._distance=t,this.updateMatrix()}setDistance(t){return this.distance=t,this}get position(){return this.updateMatrix(),this._position}set position(t){this.updateMatrix(),this._position.from(t)}setPosition(t,e,n){return this.updateMatrix(),"number"==typeof t?this._position.reset(t,e,n):this._position.reset(t[0],t[1],t[2]),this}get actualPosition(){const t=this.distance;return 0===t?this.position:this.tmpVec3.from(this.position).addWithScale(this.axisZ,t)}get scale(){return this._scale}set scale(t){this.updateMatrix(),this._scale.from(t)}setScale(t,e,n){var i;return this.updateMatrix(),"number"==typeof t?this._scale.reset(t,null!=e?e:t,null!==(i=null!=n?n:e)&&void 0!==i?i:t):this._scale.reset(t[0],t[1],t[2]),this}get orientation(){return this.updateMatrix(),this._orientation}set orientation(t){this._orientation.from(t),this.updateMatrix()}setOrientation(t,e,n,i){return"number"==typeof t?this._orientation.reset(t,e,n,i):this._orientation.reset(t[0],t[1],t[2],t[3]),this.updateMatrix(),this}setEulerRotation(t,e,n){return H.A6(this._orientation,t,e,n),this.updateMatrix(),this}orbitAroundX(t){return this._orientation.rotateAround(g.X,t),this.updateMatrix(),this}orbitAroundY(t){return this._orientation.rotateAround(g.Y,t),this.updateMatrix(),this}orbitAroundZ(t){return this._orientation.rotateAround(g.Z,t),this.updateMatrix(),this}moveAlongAxes(t,e,n){return this.position.addWithScale(this.axisX,t).addWithScale(this.axisY,e).addWithScale(this.axisZ,n),this.updateMatrix(),this}debug(t="Transfo"){console.log(t),console.log("Distance:",this.distance),this.orientation.debug("Orientation"),this.scale.debug("Scale"),this.position.debug("Position"),this.matrix.debug("Matrix")}updateMatrix(){this.dirty=!0}}class nt extends Float32Array{static fromMix(t,e,n=.5){const i=1-n,r=i*t.x+n*e.x,s=i*t.y+n*e.y;return new nt(r,s)}static distance(t,e){const n=e.x-t.x,i=e.y-t.y;return Math.hypot(n,i)}constructor(t=0,e=0){if(super(2),"number"!=typeof t)return this.x=t[0],void(this.y=t[1]);this.x=t,this.y=e}clone(){return new nt(this)}mix(t,e=.5){return this.x=(1-e)*this.x+e*t.x,this.y=(1-e)*this.y+e*t.y,this}isEqual(t){const[e,n]=t;return e===this.x&&n===this.y}isClose(t,e=1e-6){const[n,i]=t;return!(Math.abs(n-this.x)>e||Math.abs(i-this.y)>e)}from(t){const[e,n]=t;return this.x=e,this.y=n,this}fromMix(t,e,n){const[i,r]=t,[s,o]=e;return this.reset(c(i,s,n),c(r,o,n))}reset(t,e){return this[0]=t,this[1]=e,this}get x(){return this[0]}set x(t){this[0]=t}get y(){return this[1]}set y(t){this[1]=t}add(...t){for(const e of t)this[0]+=e.x,this[1]+=e.y;return this}addWithScale(t,e){return this[0]+=t.x*e,this[1]+=t.y*e,this}subtract(t){return this[0]-=t[0],this[1]-=t[1],this}scale(t){return this[0]*=t,this[1]*=t,this}dot(t){return this[0]*t[0]+this[1]*t[1]}get size(){return Math.hypot(this[0],this[1])}normalize(){const t=this[0]*this[0]+this[1]*this[1];return 0===t?this:this.scale(1/Math.sqrt(t))}random(){return this[0]=Math.random()-.5,this[1]=Math.random()-.5,this}debug(t="vec2"){const{x:e,y:n}=this,i=[e,n].map((t=>t.toFixed(6)));console.log(`${t}:   `,i.join(" | "),"   length:",Math.hypot(e,n))}}class it{constructor(t={}){var e,n,i,r;this._screenWidth=1920,this._screenHeight=1080,this._screenAspectRatio=1920/1080,this._dirtyModelView=!0,this.dirtyModelViewInverse=!0,this._dirtyAxis=!0,this._dirtyProjection=!0,this.dirtyProjectionInverse=!0,this._near=.001,this._far=1/0,this._matrixModelView=new x,this._matrixProjectionInverse=new x,this._zoom=1,this.name=null!==(e=t.name)&&void 0!==e?e:"TgdCamera#"+it.incrementalId++,this._near=null!==(n=t.near)&&void 0!==n?n:.001,this._far=null!==(i=t.far)&&void 0!==i?i:1e6,this.transfo=new et(t.transfo),this.zoom=null!==(r=t.zoom)&&void 0!==r?r:1}getCurrentState(){return{distance:this.transfo.distance,orientation:this.transfo.orientation.clone(),spaceHeightAtTarget:this.spaceHeightAtTarget,position:this.transfo.position.clone(),zoom:this.zoom}}get near(){return this._near}set near(t){t!==this._near&&(this._near=t,this.dirtyProjection=!0)}get far(){return this._far}set far(t){t!==this._far&&(this._far=t,this.dirtyProjection=!0)}get screenAspectRatio(){return this._screenAspectRatio}get screenWidth(){return this._screenWidth}set screenWidth(t){t!==this._screenWidth&&(this._screenWidth=t,this.dirtyProjection=!0,this._screenAspectRatio=this._screenWidth/this._screenHeight)}get screenHeight(){return this._screenHeight}set screenHeight(t){t!==this._screenHeight&&(this._screenHeight=t,this.dirtyProjection=!0,this._screenAspectRatio=this._screenWidth/this._screenHeight)}get spaceHeightAtTarget(){return this.getSpaceHeightAtTarget()}set spaceHeightAtTarget(t){this.setSpaceHeightAtTarget(t)}get spaceWidthAtTarget(){return this.screenWidth*this.spaceHeightAtTarget/this.screenHeight}set spaceWidthAtTarget(t){this.setSpaceHeightAtTarget(t*this.screenHeight/this.screenWidth)}from(t){const{zoom:e,screenWidth:n,screenHeight:i}=t;return this.transfo.from(t.transfo),this.zoom=e,this.screenWidth=n,this.screenHeight=i,this.dirtyModelView=!0,this.copyProjectionFrom(t),this}fromTransfo(t){return this.transfo.from(t),this.dirtyModelView=!0,this}get matrixModelView(){return this._matrixModelView.invert(this.transfo.matrix)}get matrixProjectionInverse(){return this.dirtyProjectionInverse&&(this._matrixProjectionInverse.invert(this.matrixProjection),this.dirtyProjectionInverse=!1),this._matrixProjectionInverse}get zoom(){return this._zoom}set zoom(t){this._zoom!==t&&(this._zoom=t,this.transfo.setScale(t,t,t),this.dirtyModelView=!0)}toCode(t){return`// ${null!=t?t:"TgdCamera"}\n// Not implemented yet`}debug(t){const e=`${this.name}: ${null!=t?t:""}`;console.log("TgdCamera",e),console.log("    Distance:",this.transfo.distance),console.log("    Zoom:",this.zoom),this.transfo.orientation.debug("   Orientation"),this.transfo.position.debug("    Target"),this.transfo.actualPosition.debug("    Actual position"),this.matrixModelView.debug("    MatrixModelView"),this.matrixProjection.debug("    MatrixProjection")}get dirtyModelView(){return this._dirtyModelView}set dirtyModelView(t){this._dirtyModelView=t,t&&(this.dirtyModelViewInverse=!0)}get dirtyProjection(){return this._dirtyProjection}set dirtyProjection(t){this._dirtyProjection=t,t&&(this.dirtyProjectionInverse=!0)}}it.incrementalId=1;class rt extends it{constructor(t={}){var e;super(t),this._matrixProjection=new x,this._fovy=Math.PI/4,this._ray={origin:new g,direction:new g},this._fovy=null!==(e=t.fovy)&&void 0!==e?e:Math.PI/4}copyProjectionFrom(t){return this.fovy=t.fovy,this.near=t.near,this.far=t.far,this}castRay(t,e){const{transfo:n}=this,{origin:i,direction:r}=this._ray;i.from(n.actualPosition);const s=Math.atan(.5*this.fovy),o=s*this.screenAspectRatio;return r.fromOpposite(n.axisZ).addWithScale(n.axisX,o*t).addWithScale(n.axisY,s*e).normalize(),this._ray}get fovy(){return this._fovy}set fovy(t){t!==this._fovy&&(this._fovy=t,this.dirtyProjection=!0)}get matrixProjection(){return this.updateProjectionIfNeeded(),this._matrixProjection}getSpaceHeightAtTarget(){return 2*Math.tan(.5*this.fovy)*this.transfo.distance}setSpaceHeightAtTarget(t){this.transfo.setDistance(t/(2*Math.tan(.5*this.fovy)))}updateProjectionIfNeeded(){if(!this.dirtyProjection)return;const t=this._fovy,e=this.screenAspectRatio,n=this._near,i=this._far,r=this._matrixProjection;v.fN(r,t,e,n,i),r[0]*=this.zoom,r[5]*=this.zoom,this.dirtyProjection=!0}toCode(t){const e=[];return t&&e.push(`// ${t}`),e.push("const camera = new TgdCameraPerspective({"),this.name&&e.push(`  name: ${JSON.stringify(this.name)},`),e.push(`  fovy: ${this._fovy},`),e.push(`  near: ${this._near},`),e.push(`  far: ${this._far},`),e.push(`  zoom: ${this.zoom},`),e.push("  transfo: {"),e.push(`  distance: ${this.transfo.distance},`),e.push(`    position: ${JSON.stringify([...this.transfo.position])},`),e.push(`    orientation: ${JSON.stringify([...this.transfo.orientation])},`),e.push(`    scale: ${JSON.stringify([...this.transfo.scale])},`),e.push("  }"),e.push("}"),e.join("\n")}}class st{constructor(){this.listeners=new Set}addListener(t){this.listeners.add(t)}removeListener(t){this.listeners.delete(t)}dispatch(t){for(const e of this.listeners)e(t)}}class ot{constructor(){this.eventKeyPress=new st,this.keysDown=new Set,this.keysUp=new Set,this.attached=!1,this.handleKeyDown=t=>{this.keysDown.add(t.key),this.keysUp.delete(t.key)},this.handleKeyUp=t=>{this.keysDown.delete(t.key),this.keysUp.add(t.key),this.eventKeyPress.dispatch(t)},document.addEventListener("keydown",this.handleKeyDown),document.addEventListener("keyup",this.handleKeyUp),this.attached=!0}detach(){this.attached&&(document.removeEventListener("keydown",this.handleKeyDown),document.removeEventListener("keyup",this.handleKeyUp),this.attached=!1)}isUp(...t){return!this.isDown(...t)}isDown(...t){for(const e of t)if(!this.keysDown.has(e))return!1;return!0}hasClicked(t){return!!this.keysUp.has(t)&&(this.keysUp.delete(t),!0)}}class at{constructor(t){this.canvas=t,this.eventTap=new st,this.eventMoveStart=new st,this.eventMove=new st,this.eventMoveEnd=new st,this.eventZoom=new st,this.tapDelay=300,this.controlKeys={altKey:!1,ctrlKey:!1,metaKey:!1,shiftKey:!1},this.start={x:0,y:0,t:0,fingersCount:1},this.current={x:0,y:0,t:0,fingersCount:1},this.previous={x:0,y:0,t:0,fingersCount:1},this.pointerEvent=null,this.handleContextMenu=t=>{t.preventDefault()},this.handleCanvasWheel=t=>{let e=t.deltaX+t.deltaY+t.deltaZ;e=e>0?1:-1,this.eventZoom.dispatch(Object.assign({current:this.getPoint(t),direction:e,preventDefault:()=>t.preventDefault()},this.controlKeys))},this.handlePointerDown=t=>{if(!t.isPrimary)return;this.canvas.setPointerCapture(t.pointerId),t.preventDefault(),t.stopPropagation(),this.pointerEvent=t;const e=this.getPoint(t);this.start=this.current=this.previous=e,this.eventMoveStart.dispatch(Object.assign({start:e,current:e,previous:e},this.controlKeys))},this.handlePointerMove=t=>{t.isPrimary&&this.pointerEvent&&this.canvas&&(this.previous=this.current,this.current=this.getPoint(t),this.eventMove.dispatch(Object.assign({start:this.start,current:this.current,previous:this.previous},this.controlKeys)))},this.handlePointerUp=t=>{t.isPrimary&&this.pointerEvent&&(t.preventDefault(),this.current=this.getPoint(t),this.eventMoveEnd.dispatch(Object.assign({start:this.start,current:this.current,previous:this.previous},this.controlKeys)),this.pointerEvent=null,t.timeStamp-this.start.t<this.tapDelay&&this.eventTap.dispatch(Object.assign(Object.assign({},this.start),this.controlKeys)))},t.addEventListener("pointerdown",this.handlePointerDown,!0),t.addEventListener("wheel",this.handleCanvasWheel),t.addEventListener("contextmenu",this.handleContextMenu),t.addEventListener("pointermove",this.handlePointerMove),t.addEventListener("pointerup",this.handlePointerUp)}isTouching(t){return!!this.pointerEvent&&(!t||t(this.current))}detach(){const{canvas:t}=this;t&&(t.removeEventListener("pointerdown",this.handlePointerDown),t.removeEventListener("wheel",this.handleCanvasWheel),t.removeEventListener("contextmenu",this.handleContextMenu),t.removeEventListener("pointermove",this.handlePointerMove),t.removeEventListener("pointerup",this.handlePointerUp))}getPoint(t){this.controlKeys={altKey:t.altKey||2===t.buttons,ctrlKey:t.ctrlKey,metaKey:t.metaKey,shiftKey:t.shiftKey};const{left:e,top:n,width:i,height:r}=this.canvas.getBoundingClientRect();return{x:2*((t.clientX-e)/i-.5),y:-2*((t.clientY-n)/r-.5),t:t.timeStamp,fingersCount:1}}}class ht{constructor(t){this.canvas=t,this._keyboard=null,this._pointer=null}get keyboard(){return this._keyboard||(this._keyboard=new ot),this._keyboard}get pointer(){return this._pointer||(this._pointer=new at(this.canvas)),this._pointer}}class ct{constructor(){this.name="Painter/"+ct.counter++,this.active=!0}debugHierarchy(){return{[this.active?this.name:`${this.name} (Inactive)`]:null}}}ct.log=new class{constructor(){this.level=0,this.lookupTable=new Map}lookup(t,e){var n;if("number"!=typeof e)return JSON.stringify(e);const{lookupTable:i}=this;if(0===i.size)for(const e in t){const n=t[e];"number"==typeof n&&i.set(n,`gl.${e}`)}return null!==(n=i.get(e))&&void 0!==n?n:`gl[${e}]`}call(t,e){const n="  ".repeat(this.level);console.log(`${n}>>>`,t),this.level++;const i=Date.now();try{return e()}catch(t){throw console.error(t),t}finally{this.level--,console.log(`${n}<<<`,t,`(${Date.now()-i} ms)`)}}stateDepth(t){if(console.log("// [State] Depth"),t.getParameter(t.DEPTH_TEST)){console.log("gl.enable( gl.DEPTH_TEST )"),console.log("gl.depthFunc(",this.lookup(t,t.getParameter(t.DEPTH_FUNC)),")"),console.log("gl.depthMask(",this.lookup(t,t.getParameter(t.DEPTH_WRITEMASK)),")");const[e,n]=t.getParameter(t.DEPTH_RANGE);console.log("gl.depthRange(",e,",",n,")")}else console.log("gl.disable( gl.DEPTH_TEST )")}},ct.counter=0;class ut extends ct{constructor(t=[],{onEnter:e,onExit:n,name:i}={}){super(),this.active=!0,this.onEnter=e,this.onExit=n,this.painters=[...t],this.name=null!=i?i:`Group/${this.name}`}forEachChild(t){for(const[e,n]of this.painters.entries())t(n,e)}has(t){return this.painters.includes(t)}add(...t){for(const e of t)this.painters.push(e)}addFirst(...t){for(let e=t.length-1;e>=0;e--){const n=t[e];this.painters.unshift(n)}}remove(...t){for(const e of t){const t=this.painters.indexOf(e);-1!==t&&(this.painters.splice(t,1),e.delete())}}removeAll(){for(const t of this.painters)t.delete();this.painters.splice(0,this.painters.length)}delete(){for(const t of this.painters)t.delete();this.painters.splice(0,this.painters.length)}paint(t,e){var n,i;if(this.active){null===(n=this.onEnter)||void 0===n||n.call(this,t,e);for(const n of this.painters)n.active&&n.paint(t,e);null===(i=this.onExit)||void 0===i||i.call(this,t,e)}}debugHierarchy(){return{[this.active?this.name:`${this.name} (Inactive)`]:this.painters.map((t=>t.debugHierarchy()))}}}function lt(t,e,n){const i=t.clone().from(e),r=i.distance,s=i.position.clone(),o=i.scale.clone(),a=i.orientation.clone(),h=t.clone().from(n),u=h.orientation.clone(),l=h.position.clone(),f=h.scale.clone(),d=h.distance;return e=>{t.distance=c(r,d,e),t.position.fromMix(s,l,e),t.scale.fromMix(o,f,e),t.orientation.fromSlerp(a,u,e),t.updateMatrix()}}function ft(t,e){var n,i;const r=new et(t.transfo).from(e);r.debug(),"number"==typeof e.distance&&(r.distance=e.distance);const s=t.zoom,o=null!==(n=e.zoom)&&void 0!==n?n:s,a=lt(t.transfo,{},r),h=t.spaceHeightAtTarget,u=null!==(i=e.spaceHeightAtTarget)&&void 0!==i?i:t.spaceHeightAtTarget;return n=>{a(n),"number"==typeof e.spaceHeightAtTarget&&(t.spaceHeightAtTarget=c(h,u,n)),t.zoom=c(s,o,n)}}function dt({from:t,to:e,action:n}){const[i,r,s]=t,[o,a,h]=e,u=[0,0,0];return t=>{u[0]=c(i,o,t),u[1]=c(r,a,t),u[2]=c(s,h,t),n(u)}}function mt(t){return t}function gt(t){return 1-(1-t)*(1-t)}function pt(t){return t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2}function vt(t){return t<.5?16*t*t*t*t*t:1-Math.pow(-2*t+2,5)/2}function xt(t){return 1+2.70158*Math.pow(t-1,3)+1.70158*Math.pow(t-1,2)}function Et(t,e={}){if(0===t.length)return{action(){},duration:0};const{intervals:n,duration:i}=function(t){var e;const n=[];let i=0,r=0;for(const s of t){const t=s.duration+(null!==(e=s.delay)&&void 0!==e?e:0);r=i+t,n.push({animation:s,begin:i,end:r}),i+=t}return{intervals:n,duration:r}}(t);let r=null,s="???";return Object.assign(Object.assign({},e),{duration:i,onEnd(){var t,n;null===(t=null==r?void 0:r.onEnd)||void 0===t||t.call(r),null===(n=e.onEnd)||void 0===n||n.call(e)},action(t){var e,o,a;const h=t*i;for(const{animation:t,begin:i,end:c}of n)if(h>=i&&h<=c){r&&r!==t&&(null===(e=r.onEnd)||void 0===e||e.call(r)),r=t;const n=At(h,i,c,t.delay);if(n<0||n>1)return;s!==t.name&&(s=null!==(o=t.name)&&void 0!==o?o:"");const u=null!==(a=t.easingFunction)&&void 0!==a?a:mt;return void t.action(u(n))}}})}function At(t,e,n,i=0){const r=e+i;return(t-r)/(n-r)}function bt(t,e,n={}){const i=[];let r=t,s=1;for(const n of e){const e=new et(r).from(n.transfo);i.push(Object.assign(Object.assign({name:"Step#"+s++},n),{action:lt(t,r,e)})),r=e}return Et(i,n)}function Tt(t,e,n){const i=document.createElement("canvas");i.width=t,i.height=e;const r=i.getContext("2d",n);if(!r)throw new Error("Unable to create 2D context!");return{canvas:i,ctx:r}}function yt(t){return!!t&&!Array.isArray(t)&&"object"==typeof t}function wt(t){return"string"==typeof t}function _t(t){return"number"==typeof t}function Rt(t,e,n="data"){if("unknown"===e)return;if("null"===e){if(null!==t)throw new TypeError(`Expected ${n} to be null and not a ${typeof t}!`);return}if("string"==typeof e){if(typeof t!==e)throw new TypeError(`Expected ${n} to be a ${e} and not a ${typeof t}!`);return}if(Array.isArray(e)){const[i]=e;switch(i){case"array":return void function(t,e,n){if(!Array.isArray(t))throw new TypeError(`Expected ${e} to be an array and not a ${typeof t}!`);const[,i]=n;for(const[n,r]of t.entries())Rt(r,i,`${e}[${n}]`)}(t,n,e);case"map":return void function(t,e,n){if(!yt(t))throw new TypeError(`Expected ${e} to be an object and not a ${typeof t}!`);const[,i]=n;for(const n of Object.keys(t))"string"==typeof n&&Rt(t[n],i,`${e}[${n}]`)}(t,n,e);case"?":return void function(t,e,n){if(void 0===t)return;const[,i]=n;Rt(t,i,e)}(t,n,e);case"|":return void function(t,e,n){const[,...i]=n;let r=new Error(`No type has been defined for this alternative: ${JSON.stringify(n)}!`);for(const n of i)try{return void Rt(t,n,e)}catch(t){t instanceof Error&&(r=t)}throw r}(t,n,e);case"tuple":return void function(t,e,[,...n]){if(function(t,e="data"){if(!Array.isArray(t))throw new TypeError(`${e} was expected to be an Array but we got ${typeof t}!`)}(t),n.length!==t.length)throw new TypeError(`Expected ${e} to have ${n.length} elements, not ${t.length}!`);for(const[i,r]of n.entries()){const n=r;Rt(t[i],n,`${e}[$i]`)}}(t,n,e);case"partial":return void function(t,e,[,n]){!function(t,e="data"){if(!yt(t))throw new TypeError(`${e} was expected to be an object but we got ${typeof t}!`)}(t,e);for(const i of Object.keys(n)){if("string"!=typeof i)continue;const r=t[i];void 0!==r&&Rt(r,n[i],`${e}.${i}`)}}(t,n,e);case"literal":return void function(t,e,n){const[,...i]=n;for(const e of i)if(t===e)return;throw new TypeError(`Expected ${e} to be a literal (${i.map((t=>`"${t}"`)).join(" | ")})!`)}(t,n,e);default:if(i.startsWith("array("))return void function(t,e,n,i){if(!Array.isArray(t))throw new TypeError(`Expected ${e} to be an array and not a ${typeof t}!`);if(t.length!==i)throw new TypeError(`${e} was expected to have a length of ${i}, but we got ${t.length}!`);const[,r]=n;for(const[n,i]of t.entries())Rt(i,r,`${e}[${n}]`)}(t,n,e,Number.parseInt(i.slice(6,-1),10));throw new TypeError(`Don't know how to create a type guard for this kind of type: ${JSON.stringify(e)}`)}}if("object"!=typeof t)throw new TypeError(`Expected ${n} to be an object and not a ${typeof t}!`);const i=t;for(const t of Object.keys(e))"string"==typeof t&&Rt(i[t],e[t],`${n}.${t}`)}function Mt(t){return"perspective"===t.type}function Pt(t){Rt(t,["partial",{accessors:["array",{bufferView:["?","number"],byteOffset:["?","number"],componentType:"number",normalized:["?","boolean"],count:"number",type:"string",name:["?","string"]}],meshes:["array",{name:"string",primitives:["array",{attributes:["map","number"],indices:["?","number"],mode:["?","number"],material:["?","number"]}]}],images:["array",["partial",{bufferView:"number",mimeType:"string",name:"string",uri:"string"}]],bufferViews:["array",{buffer:"number",byteLength:"number",byteOffset:["?","number"],byteStride:["?","number"],target:["?","number"]}],materials:["array",St],samplers:["array",["partial",{minFilter:"number",magFilter:"number",wrapS:"number",wrapT:"number",name:"string"}]],textures:["array",["partial",{sampler:"number",source:"number",name:"string"}]]}])}const Ct={index:"number",texCoord:["?","number"]},St=["partial",{name:"string",pbrMetallicRoughness:["partial",{baseColorFactor:["array(4)","number"],baseColorTexture:Ct,metallicFactor:"number",roughnessFactor:"number",metalicRoughnessTexture:Ct}],normalTexture:Object.assign(Object.assign({},Ct),{scale:["?","number"]}),occlusionTexture:Object.assign(Object.assign({},Ct),{strength:["?","number"]}),emissiveTexture:Ct,alphaMode:["literal","OPAQUE","MASK","BLEND"],alphaCutoff:"number",doubleSided:"boolean"}];var Lt,Nt,Ut,Ft,Ot,It,Bt;!function(t){t[t.NEVER=WebGL2RenderingContext.NEVER]="NEVER",t[t.LESS=WebGL2RenderingContext.LESS]="LESS",t[t.EQUAL=WebGL2RenderingContext.EQUAL]="EQUAL",t[t.LEQUAL=WebGL2RenderingContext.LEQUAL]="LEQUAL",t[t.GREATER=WebGL2RenderingContext.GREATER]="GREATER",t[t.NOTEQUAL=WebGL2RenderingContext.NOTEQUAL]="NOTEQUAL",t[t.GEQUAL=WebGL2RenderingContext.GEQUAL]="GEQUAL",t[t.ALWAYS=WebGL2RenderingContext.ALWAYS]="ALWAYS"}(Lt||(Lt={})),function(t){t[t.FUNC_ADD=WebGL2RenderingContext.FUNC_ADD]="FUNC_ADD",t[t.FUNC_SUBTRACT=WebGL2RenderingContext.FUNC_SUBTRACT]="FUNC_SUBTRACT",t[t.FUNC_REVERSE_SUBTRACT=WebGL2RenderingContext.FUNC_REVERSE_SUBTRACT]="FUNC_REVERSE_SUBTRACT",t[t.MIN=WebGL2RenderingContext.MIN]="MIN",t[t.MAX=WebGL2RenderingContext.MAX]="MAX"}(Nt||(Nt={})),function(t){t[t.ZERO=WebGL2RenderingContext.ZERO]="ZERO",t[t.ONE=WebGL2RenderingContext.ONE]="ONE",t[t.SRC_COLOR=WebGL2RenderingContext.SRC_COLOR]="SRC_COLOR",t[t.ONE_MINUS_SRC_COLOR=WebGL2RenderingContext.ONE_MINUS_SRC_COLOR]="ONE_MINUS_SRC_COLOR",t[t.DST_COLOR=WebGL2RenderingContext.DST_COLOR]="DST_COLOR",t[t.ONE_MINUS_DST_COLOR=WebGL2RenderingContext.ONE_MINUS_DST_COLOR]="ONE_MINUS_DST_COLOR",t[t.SRC_ALPHA=WebGL2RenderingContext.SRC_ALPHA]="SRC_ALPHA",t[t.ONE_MINUS_SRC_ALPHA=WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA]="ONE_MINUS_SRC_ALPHA",t[t.DST_ALPHA=WebGL2RenderingContext.DST_ALPHA]="DST_ALPHA",t[t.ONE_MINUS_DST_ALPHA=WebGL2RenderingContext.ONE_MINUS_DST_ALPHA]="ONE_MINUS_DST_ALPHA",t[t.CONSTANT_COLOR=WebGL2RenderingContext.CONSTANT_COLOR]="CONSTANT_COLOR",t[t.ONE_MINUS_CONSTANT_COLOR=WebGL2RenderingContext.ONE_MINUS_CONSTANT_COLOR]="ONE_MINUS_CONSTANT_COLOR",t[t.CONSTANT_ALPHA=WebGL2RenderingContext.CONSTANT_ALPHA]="CONSTANT_ALPHA",t[t.ONE_MINUS_CONSTANT_ALPHA=WebGL2RenderingContext.ONE_MINUS_CONSTANT_ALPHA]="ONE_MINUS_CONSTANT_ALPHA",t[t.SRC_ALPHA_SATURATE=WebGL2RenderingContext.SRC_ALPHA_SATURATE]="SRC_ALPHA_SATURATE"}(Ut||(Ut={})),function(t){t[t.NEVER=WebGL2RenderingContext.NEVER]="NEVER",t[t.LESS=WebGL2RenderingContext.LESS]="LESS",t[t.EQUAL=WebGL2RenderingContext.EQUAL]="EQUAL",t[t.LEQUAL=WebGL2RenderingContext.LEQUAL]="LEQUAL",t[t.GREATER=WebGL2RenderingContext.GREATER]="GREATER",t[t.NOTEQUAL=WebGL2RenderingContext.NOTEQUAL]="NOTEQUAL",t[t.GEQUAL=WebGL2RenderingContext.GEQUAL]="GEQUAL",t[t.ALWAYS=WebGL2RenderingContext.ALWAYS]="ALWAYS"}(Ft||(Ft={})),function(t){t[t.KEEP=WebGL2RenderingContext.KEEP]="KEEP",t[t.ZERO=WebGL2RenderingContext.ZERO]="ZERO",t[t.REPLACE=WebGL2RenderingContext.REPLACE]="REPLACE",t[t.INCR=WebGL2RenderingContext.INCR]="INCR",t[t.INCR_WRAP=WebGL2RenderingContext.INCR_WRAP]="INCR_WRAP",t[t.DECR=WebGL2RenderingContext.DECR]="DECR",t[t.DECR_WRAP=WebGL2RenderingContext.DECR_WRAP]="DECR_WRAP",t[t.INVERT=WebGL2RenderingContext.INVERT]="INVERT"}(Ot||(Ot={})),function(t){t[t.FRONT=WebGL2RenderingContext.FRONT]="FRONT",t[t.BACK=WebGL2RenderingContext.BACK]="BACK",t[t.FRONT_AND_BACK=WebGL2RenderingContext.FRONT_AND_BACK]="FRONT_AND_BACK"}(It||(It={})),function(t){t[t.ALPHA=WebGL2RenderingContext.ALPHA]="ALPHA",t[t.RGB=WebGL2RenderingContext.RGB]="RGB",t[t.RGBA=WebGL2RenderingContext.RGBA]="RGBA",t[t.LUMINANCE=WebGL2RenderingContext.LUMINANCE]="LUMINANCE",t[t.LUMINANCE_ALPHA=WebGL2RenderingContext.LUMINANCE_ALPHA]="LUMINANCE_ALPHA"}(Bt||(Bt={}));const Dt={off:{enabled:!1,equationColor:Nt.FUNC_ADD,functionColorSrc:Ut.SRC_ALPHA,functionColorDst:Ut.ONE_MINUS_SRC_ALPHA,equationAlpha:Nt.FUNC_ADD,functionAlphaSrc:Ut.ONE,functionAlphaDst:Ut.ZERO},alpha:{enabled:!0,equationColor:Nt.FUNC_ADD,functionColorSrc:Ut.SRC_ALPHA,functionColorDst:Ut.ONE_MINUS_SRC_ALPHA,equationAlpha:Nt.FUNC_ADD,functionAlphaSrc:Ut.ONE,functionAlphaDst:Ut.ZERO},add:{enabled:!0,equationColor:Nt.FUNC_ADD,functionColorSrc:Ut.ONE,functionColorDst:Ut.ONE,equationAlpha:Nt.FUNC_ADD,functionAlphaSrc:Ut.ONE,functionAlphaDst:Ut.ZERO},premultipliedAlpha:{enabled:!0,equationColor:Nt.FUNC_ADD,functionColorSrc:Ut.ONE,functionColorDst:Ut.ONE_MINUS_SRC_ALPHA,equationAlpha:Nt.FUNC_ADD,functionAlphaSrc:Ut.ONE,functionAlphaDst:Ut.ZERO}};function $t(t,e){e.enabled?t.enable(t.BLEND):t.disable(t.BLEND),t.blendEquationSeparate(e.equationColor,e.equationAlpha),t.blendFuncSeparate(e.functionColorSrc,e.functionColorDst,e.functionAlphaSrc,e.functionAlphaDst)}function Vt(t){return{enabled:Boolean(t.getParameter(t.BLEND)),equationAlpha:t.getParameter(t.BLEND_EQUATION_ALPHA),equationColor:t.getParameter(t.BLEND_EQUATION_RGB),functionAlphaDst:t.getParameter(t.BLEND_DST_ALPHA),functionAlphaSrc:t.getParameter(t.BLEND_SRC_ALPHA),functionColorDst:t.getParameter(t.BLEND_DST_RGB),functionColorSrc:t.getParameter(t.BLEND_SRC_ALPHA)}}const zt={off:{enabled:!1,cullFace:It.BACK},back:{enabled:!0,cullFace:It.BACK},front:{enabled:!0,cullFace:It.FRONT}};function Gt(t,e){e.enabled?t.enable(t.CULL_FACE):t.disable(t.CULL_FACE),t.cullFace(e.cullFace)}function kt(t){return{enabled:Boolean(t.getParameter(t.CULL_FACE)),cullFace:t.getParameter(t.CULL_FACE_MODE)}}const Wt={off:{enabled:!1,func:Lt.ALWAYS,mask:!1,rangeMin:0,rangeMax:1},writeOnly:{enabled:!1,func:Lt.ALWAYS,mask:!0,rangeMin:0,rangeMax:1},less:{enabled:!0,func:Lt.LESS,mask:!0,rangeMin:0,rangeMax:1},lessOrEqual:{enabled:!0,func:Lt.LEQUAL,mask:!0,rangeMin:0,rangeMax:1},lessReadOnly:{enabled:!0,func:Lt.LESS,mask:!1,rangeMin:0,rangeMax:1},lessOrEqualReadOnly:{enabled:!0,func:Lt.LEQUAL,mask:!1,rangeMin:0,rangeMax:1}};function Xt(t,e){e.enabled?t.enable(t.DEPTH_TEST):t.disable(t.DEPTH_TEST),t.depthFunc(e.func),t.depthMask(e.mask),t.depthRange(e.rangeMin,e.rangeMax)}function Ht(t){const[e,n]=t.getParameter(t.DEPTH_RANGE);return{enabled:Boolean(t.getParameter(t.DEPTH_TEST)),func:Number(t.getParameter(t.DEPTH_FUNC)),mask:Boolean(t.getParameter(t.DEPTH_WRITEMASK)),rangeMin:e,rangeMax:n}}const jt={off:{enabled:!1,maskBack:0,maskFront:0,functionBack:Ft.ALWAYS,functionBackMask:0,functionBackRef:0,functionFront:Ft.ALWAYS,functionFrontMask:0,functionFrontRef:0,operationBack1FailStencil:Ot.KEEP,operationBack2FailDepth:Ot.KEEP,operationBack3Pass:Ot.KEEP,operationFront1FailStencil:Ot.KEEP,operationFront2FailDepth:Ot.KEEP,operationFront3Pass:Ot.KEEP},write:t=>({enabled:!0,maskBack:255,maskFront:255,functionBack:Ft.ALWAYS,functionBackRef:t,functionBackMask:255,functionFront:Ft.ALWAYS,functionFrontRef:t,functionFrontMask:255,operationBack1FailStencil:Ot.KEEP,operationBack2FailDepth:Ot.KEEP,operationBack3Pass:Ot.REPLACE,operationFront1FailStencil:Ot.KEEP,operationFront2FailDepth:Ot.KEEP,operationFront3Pass:Ot.REPLACE}),paintIfEqual:t=>({enabled:!0,maskBack:0,maskFront:0,functionBack:Ft.EQUAL,functionBackRef:t,functionBackMask:255,functionFront:Ft.EQUAL,functionFrontRef:t,functionFrontMask:255,operationBack1FailStencil:Ot.KEEP,operationBack2FailDepth:Ot.KEEP,operationBack3Pass:Ot.KEEP,operationFront1FailStencil:Ot.KEEP,operationFront2FailDepth:Ot.KEEP,operationFront3Pass:Ot.KEEP})};function Zt(t,e){e.enabled?(t.enable(t.STENCIL_TEST),t.stencilFuncSeparate(t.FRONT,e.functionFront,e.functionFrontRef,e.functionFrontMask),t.stencilFuncSeparate(t.BACK,e.functionBack,e.functionBackRef,e.functionBackMask),t.stencilOpSeparate(t.FRONT,e.operationFront1FailStencil,e.operationFront2FailDepth,e.operationFront3Pass),t.stencilOpSeparate(t.BACK,e.operationBack1FailStencil,e.operationBack2FailDepth,e.operationBack3Pass),t.stencilMaskSeparate(t.FRONT,e.maskFront),t.stencilMaskSeparate(t.BACK,e.maskBack)):t.disable(t.STENCIL_TEST)}function Yt(t){const e=Boolean(t.getParameter(t.STENCIL_TEST));return e?{enabled:e,maskBack:t.getParameter(t.STENCIL_BACK_WRITEMASK),maskFront:t.getParameter(t.STENCIL_WRITEMASK),functionFront:t.getParameter(t.STENCIL_FUNC),functionFrontMask:t.getParameter(t.STENCIL_VALUE_MASK),functionFrontRef:t.getParameter(t.STENCIL_REF),functionBack:t.getParameter(t.STENCIL_BACK_FUNC),functionBackMask:t.getParameter(t.STENCIL_BACK_VALUE_MASK),functionBackRef:t.getParameter(t.STENCIL_BACK_REF),operationFront1FailStencil:t.getParameter(t.STENCIL_FAIL),operationFront2FailDepth:t.getParameter(t.STENCIL_PASS_DEPTH_FAIL),operationFront3Pass:t.getParameter(t.STENCIL_PASS_DEPTH_PASS),operationBack1FailStencil:t.getParameter(t.STENCIL_BACK_FAIL),operationBack2FailDepth:t.getParameter(t.STENCIL_BACK_PASS_DEPTH_FAIL),operationBack3Pass:t.getParameter(t.STENCIL_BACK_PASS_DEPTH_PASS)}:Object.assign({},jt.off)}class Kt{constructor(){this.animations=new Map}schedule(t){var e;t.name||(t.name="TgdAnimation#"+Kt.counter++);const{action:n,duration:i,easingFunction:r,repeat:s}=t;return this.animations.set(t,{start:-1,delay:null!==(e=t.delay)&&void 0!==e?e:0,duration:i,inverseDuration:1/i,action:r?t=>n(r(t)):n,loop:1,repeat:null!=s?s:1,cancel:()=>this.cancel(t),onEnd:t.onEnd}),t}cancel(t){this.animations.delete(t)}paint(t){var e;if(0===this.animations.size)return!1;for(const n of this.animations.values()){n.start<0&&(n.start=t+n.delay);const i=t-n.start;if(i<0)continue;const r=Math.min(1,n.inverseDuration*i);for(n.action(r);t>n.start+n.duration;){try{null===(e=n.onEnd)||void 0===e||e.call(n)}catch(t){console.error("Animation.onEnd() failed for",n),console.error(t)}n.loop++,n.start+=n.duration}n.loop>n.repeat&&n.cancel()}return!0}}Kt.counter=1;class Qt{constructor(t,e={}){var n;this.canvas=t,this.options=e,this.eventPaint=new st,this._camera=new rt({transfo:{distance:15},far:100,near:.1,fovy:Math.PI/8,zoom:1}),this._fps=0,this._aspectRatio=1,this._aspectRatioInverse=1,this.paintingIsOngoing=!1,this.paintingIsQueued=!1,this.isPlaying=!1,this.requestAnimationFrame=-1,this.lastTime=-1,this.timeShift=0,this.animationManager=new Kt,this.paint=()=>{this.paintingIsOngoing?this.paintingIsQueued=!0:(this.paintingIsQueued=!1,this.paintingIsOngoing=!0,globalThis.cancelAnimationFrame(this.requestAnimationFrame),this.requestAnimationFrame=globalThis.requestAnimationFrame(this.actualPaint))},this.actualPaint=t=>{try{this.timeShift=t-Date.now();const{lastTime:e,gl:n}=this;if(e<0)return this.lastTime=t,void this.paint();const i=t-this.lastTime;this._fps=Math.round(1/i),this.lastTime=t,this._camera.screenWidth=n.drawingBufferWidth,this._camera.screenHeight=n.drawingBufferHeight,this._aspectRatio=n.drawingBufferWidth/n.drawingBufferHeight,this._aspectRatioInverse=1/this._aspectRatio;const r=.001*t,s=.001*i;this.painters.paint(r,s),this.eventPaint.dispatch(this),(this.paintingIsQueued||this.animationManager.paint(r)||this.isPlaying)&&(this.paintingIsOngoing=!1,this.paint())}catch(t){console.error(t)}finally{this.paintingIsOngoing=!1}};const i=t.getContext("webgl2",e);if(!i)throw new Error("Unable to create a WebGL2 context!");e.enableTextureFloatStorage&&i.getExtension("EXT_color_buffer_float"),this.implementationColorReadFormat=i.getParameter(i.IMPLEMENTATION_COLOR_READ_FORMAT),this.implementationColorReadType=i.getParameter(i.IMPLEMENTATION_COLOR_READ_TYPE),this.gl=i,this.observer=new ResizeObserver((()=>{const n=t.clientWidth,r=t.clientHeight,{onResize:s}=e;s?s(this,t.clientWidth,t.clientHeight):(t.width=n,t.height=r),i.viewport(0,0,t.width,t.height),this.paint()})),this.observer.observe(t),this.inputs=new ht(t),e.camera&&(this._camera=e.camera),this.painters=new ut,this.name=null!==(n=e.name)&&void 0!==n?n:"Context#"+Qt.incrementalId++,this.painters.name=this.name,t.style.touchAction="none",this.stateReset()}get fps(){return this._fps}get time(){return Date.now()+this.timeShift}debugHierarchy(){return this.painters.debugHierarchy()}get camera(){return this._camera}set camera(t){t!==this._camera&&(this._camera=t,this.paint())}animSchedule(...t){var e,n;const i=[];let r=0;for(const s of t){const t=s.duration+(null!==(e=s.delay)&&void 0!==e?e:0);s.delay=r+(null!==(n=s.delay)&&void 0!==n?n:0),r+=t,i.push(this.animationManager.schedule(s))}return this.paint(),i}animCancel(t){this.animationManager.cancel(t)}get onEnter(){return this.painters.onEnter}set onEnter(t){this.painters.onEnter=t}get onExit(){return this.painters.onExit}set onExit(t){this.painters.onExit=t}get width(){return this.gl.drawingBufferWidth}get height(){return this.gl.drawingBufferHeight}get aspectRatio(){return this._aspectRatio}get aspectRatioInverse(){return this._aspectRatioInverse}get playing(){return this.isPlaying}set playing(t){t!==this.isPlaying&&(t?this.paint():(this.paintingIsOngoing=!1,this.paintingIsQueued=!1,globalThis.cancelAnimationFrame(this.requestAnimationFrame)),this.isPlaying=t)}play(){this.playing=!0}pause(){this.playing=!1}has(t){return this.painters.has(t)}add(...t){this.painters.add(...t)}addFirst(...t){this.painters.addFirst(...t)}remove(...t){this.painters.remove(...t)}removeAll(){this.painters.removeAll()}takeSnapshot(t){const e=t.getContext("2d");if(!e)throw new Error("[TgdContext.takeSnapshot] We cannot get a 2D context for the target canvas! Maybe it already has another type of context.");const{width:n,height:i}=t,r=function(t,e){const n=document.createElement("canvas");return n.width=t,n.height=e,n}(n,i),s=new Qt(r,this.options);this.painters.forEachChild((t=>s.add(t))),s.actualPaint(this.lastTime),s.gl.finish(),e.drawImage(r,0,0)}lookupWebglConstant(t){const{gl:e}=this;for(const n in e)if(e[n]===t)return n;return`Unknown gl[${t}]`}destroy(){this.pause(),this.painters.delete(),this.observer.unobserve(this.canvas)}stateReset(){const{gl:t}=this,e=t.getParameter(t.MAX_VERTEX_ATTRIBS),n=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,n);for(let n=0;n<e;++n)t.disableVertexAttribArray(n),t.vertexAttribPointer(n,4,t.FLOAT,!1,0,0),t.vertexAttrib1f(n,0);t.deleteBuffer(n);const i=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS);for(let e=0;e<i;++e)t.activeTexture(t.TEXTURE0+e),t.bindTexture(t.TEXTURE_CUBE_MAP,null),t.bindTexture(t.TEXTURE_2D,null);return t.activeTexture(t.TEXTURE0),t.useProgram(null),t.bindBuffer(t.ARRAY_BUFFER,null),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindRenderbuffer(t.RENDERBUFFER,null),t.disable(t.BLEND),t.disable(t.CULL_FACE),t.disable(t.DEPTH_TEST),t.disable(t.DITHER),t.disable(t.SCISSOR_TEST),t.blendColor(0,0,0,0),t.blendEquation(t.FUNC_ADD),t.blendFunc(t.ONE,t.ZERO),t.clearColor(0,0,0,0),t.clearDepth(1),t.clearStencil(-1),t.colorMask(!0,!0,!0,!0),t.cullFace(t.BACK),t.depthFunc(t.LESS),t.depthMask(!0),t.depthRange(0,1),t.frontFace(t.CCW),t.hint(t.GENERATE_MIPMAP_HINT,t.DONT_CARE),t.lineWidth(1),t.pixelStorei(t.PACK_ALIGNMENT,4),t.pixelStorei(t.UNPACK_ALIGNMENT,4),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),t.polygonOffset(0,0),t.sampleCoverage(1,!1),t.scissor(0,0,t.canvas.width,t.canvas.height),t.stencilFunc(t.ALWAYS,0,4294967295),t.stencilMask(4294967295),t.stencilOp(t.KEEP,t.KEEP,t.KEEP),t.viewport(0,0,t.canvas.width,t.canvas.height),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT|t.STENCIL_BUFFER_BIT),t}}Qt.incrementalId=1;class qt{constructor(t,{geo:e,minZoom:n=.001,maxZoom:i=1/0,speedZoom:r=1,speedOrbit:s=1,speedPanning:o=1,inertiaZoom:a=0,inertiaOrbit:h=0,inertiaPanning:c=0,fixedTarget:u=!1,debug:l=!1,onZoomRequest:f=Jt}={}){this.context=t,this.id="TgdControllerCameraOrbit-"+qt.counter++,this.eventChange=new st,this.minZoom=.001,this.maxZoom=1/0,this.speedZoom=1,this.speedOrbit=1,this.speedPanning=1,this.inertiaZoom=0,this.inertiaOrbit=0,this.inertiaPanning=0,this.fixedTarget=!1,this._enabled=!0,this.animOrbit=null,this.disabledUntil=0,this.tmpQuat=new Q,this.handleMove=t=>{this.enabled&&!this.animOrbit&&this.actualMove(t)},this.actualMove=t=>{if(t.current.t-t.previous.t<=0)return;const{context:e}=this,{keyboard:n}=e.inputs;if(t.altKey||2===t.current.fingersCount)return this.handlePan(t);if(this.geo){const e=n.isDown("Shift")?.2:2,i=n.isDown("x")?0:e*(t.previous.x-t.current.x),r=n.isDown("y")?0:e*(t.previous.y-t.current.y),s=this.geo.lng+i,o=this.geo.lat+r;this.orbitGeo(o,s)}else{if(n.isDown("z"))return this.handleRotateAroundZ(t);this.orbit(t.current.x-t.previous.x,t.current.y-t.previous.y,t.shiftKey)}},this.handleMoveStart=()=>{if(!this.enabled)return;const{animOrbit:t,context:e}=this;t&&(e.animCancel(t),this.animOrbit=null)},this.handleMoveEnd=t=>{if(!this.enabled)return;const{context:e,inertiaOrbit:n}=this;if(n>0){const i=1/(t.current.t-t.previous.t),r=i*(t.current.x-t.previous.x),s=i*(t.current.y-t.previous.y),o=structuredClone(t);o.current.t=Date.now(),this.animOrbit={duration:.001*n,action:t=>{o.previous.t=o.current.t,o.previous.x=o.current.x,o.previous.y=o.current.y,o.previous.fingersCount=o.current.fingersCount,o.current.t=Date.now();const e=(1-t)*(o.current.t-o.previous.t);o.current.x+=e*r,o.current.y+=e*s,this.actualMove(o)},easingFunction:gt},e.animSchedule(this.animOrbit)}},this.handleZoom=t=>{if(!this.enabled||0===this.speedZoom||!this.onZoomRequest({altKey:t.altKey,ctrlKey:t.ctrlKey,metaKey:t.metaKey,shiftKey:t.shiftKey,x:t.current.x,y:t.current.y}))return;const{context:e}=this,{camera:n}=e;let i=.1*this.speedZoom;this.context.inputs.keyboard.isDown("Shift")&&(i*=.1);const r=-t.direction*i;n.transfo.distance=Math.max(0,n.transfo.distance+r),t.preventDefault(),this.fireZoomChange()},this.geo=void 0,e&&(this.geo=Object.assign({lat:0,lng:0,minLat:-Math.PI/2,maxLat:+Math.PI/2,minLng:-Number.MAX_VALUE,maxLng:+Number.MAX_VALUE},e)),this.cameraInitialState=t.camera.getCurrentState();const{inputs:d}=t;d.pointer.eventMoveStart.addListener(this.handleMoveStart),d.pointer.eventMoveEnd.addListener(this.handleMoveEnd),d.pointer.eventMove.addListener(this.handleMove),d.pointer.eventZoom.addListener(this.handleZoom),this.speedOrbit=s,this.speedZoom=r,this.speedPanning=o,this.inertiaOrbit=h,this.inertiaZoom=a,this.inertiaPanning=c,this.fixedTarget=u,this.minZoom=n,this.maxZoom=i,this.onZoomRequest=f,this.geo&&this.orbitGeo(this.geo.lat,this.geo.lng),globalThis.setTimeout((()=>t.paint())),l&&t.inputs.keyboard.eventKeyPress.addListener((t=>{"?"===t.key&&console.log(this.context.camera.toCode())}))}get enabled(){return this.context.time>this.disabledUntil&&this._enabled}set enabled(t){this._enabled=t}reset(t,e){const{context:n}=this;this.disableForSomeTime(t),n.animSchedule({action:ft(n.camera,this.cameraInitialState),duration:t,easingFunction:e})}disableForSomeTime(t){this.disabledUntil=Math.max(this.disabledUntil,this.context.time+t)}detach(){const{inputs:t}=this.context;t.pointer.eventMove.removeListener(this.handleMove),t.pointer.eventZoom.removeListener(this.handleZoom)}orbit(t,e,n){const{context:i}=this,{camera:r}=i,{keyboard:s}=i.inputs,o=3*(n?.1:1)*this.speedOrbit,a=t*o,h=e*o;s.isDown("x")||r.transfo.orbitAroundY(a),s.isDown("y")||r.transfo.orbitAroundX(-h),this.fireOrbitChange()}orbitGeo(t,e){const{geo:n}=this;if(!n)return;t=h(t,n.minLat,n.maxLat),n.lat=t,e=h(e,n.minLng,n.maxLng),n.lng=e;const{orientation:i}=this.cameraInitialState,r=te(t,e),s=te(t+Math.PI/2,e),o=new g(s).cross(r),a=new I;i.toMatrix(a);const c=new I(o,s,r);c.multiply(a),this.tmpQuat.fromMatrix(c),this.context.camera.transfo.orientation=this.tmpQuat,this.fireOrbitChange()}handlePan(t){const{fixedTarget:e,speedPanning:n,context:i}=this,{camera:r}=i,s=.5*n*(1/r.zoom),o=(t.current.x-t.previous.x)*s*r.spaceWidthAtTarget,a=(t.current.y-t.previous.y)*s*r.spaceHeightAtTarget;e||r.transfo.moveAlongAxes(-o,-a,0),this.fireOrbitChange()}handleRotateAroundZ(t){const{camera:e}=this.context,n=t.previous.x,i=t.previous.y;if(Math.abs(n)+Math.abs(i)===0)return;const r=t.current.x,s=t.current.y;if(Math.abs(r)+Math.abs(s)===0)return;const o=n*r+i*s,a=n*s-i*r,h=Math.atan2(a,o)*this.speedOrbit;e.transfo.orbitAroundZ(h),this.fireOrbitChange()}fireOrbitChange(){this.context.paint(),this.eventChange.dispatch(this.context.camera)}fireZoomChange(){this.context.paint()}}qt.counter=0;const Jt=()=>!0;function te(t,e){const n=Math.cos(t),i=Math.sin(t),r=n*Math.cos(e),s=n*Math.sin(e);return new g(s,i,r)}function ee(t){if("string"==typeof t)return!0;if(!Array.isArray(t))return!1;for(const e of t)if(!ee(e))return!1;return!0}function ne(t,e="",n){if("string"==typeof t)return`${e}${t}`;if(!t)return"";const i=null!=n?n:new Set;if(!Array.isArray(t))return Object.keys(t).map((e=>i.has(e)?null:(i.add(e),`// ${e}\n${t[e]}\n`))).filter((t=>wt(t))).join("\n");const r=`${e}    `;return t.filter((t=>null!==t)).filter((t=>!Array.isArray(t)||t.length>0)).map((t=>ne(t,r,i))).join("\n")}function ie(t,e,n="----------------------------------------"){const i=Object.keys(t);return 0===i.length?[]:[`// ${n}`,...i.map((n=>`${e} ${t[n]} ${n};`))]}function re(t,e){if(ee(t))return[t];const n=Object.keys(t);if(0===n.length)return[];const i=e?[`// ${e}`]:[];for(const e of n)i.push(t[e],"");return i}class se{constructor(t,e){var n;this.gl=t,this.options=e;const i=t.createProgram();if(!i)throw new Error("Unable to create WebGLProgram!");const r=ne(e.vert),s=this.createShader("VERTEX_SHADER",r);t.attachShader(i,s);const o=ne(e.frag),a=this.createShader("FRAGMENT_SHADER",o);t.attachShader(i,a);const{transformFeedback:h}=e;if(h){const e=Array.isArray(h)?t.INTERLEAVED_ATTRIBS:t[h.bufferMode],n=Array.isArray(h)?h:h.varyings;t.transformFeedbackVaryings(i,n,e)}if(t.linkProgram(i),!t.getProgramParameter(i,t.LINK_STATUS)){const e=null!==(n=t.getProgramInfoLog(i))&&void 0!==n?n:"";console.warn(e);const s=ae(e),a=[ce("Vertex Shader",r,s),ce("Fragment Shader",o,s)].join("\n");throw new Error(a)}this.program=i,this.shaders=[s,a],this.uniformsLocations=this.getUniformsLocations(),t.detachShader(i,s),t.deleteShader(s),t.detachShader(i,a),t.deleteShader(a)}toCode({indent:t=""}={}){return["function createProgram(gl: WebGL2RenderingContext) {","  const prg = gl.createProgram()","  const vertexShader = gl.createShader(gl.VERTEX_SHADER)",`  gl.shaderSource(vertexShader, \`${ne(this.options.vert)}\`)`,"  gl.compileShader(vertexShader)","  const fragmentShader = gl.createShader(gl.FRAGMENT_SHADER)",`  gl.shaderSource(fragmentShader, \`${ne(this.options.frag)}\`)`,"  gl.compileShader(fragmentShader)","  gl.attachShader(prg, vertexShader)","  gl.attachShader(prg, fragmentShader)","  gl.linkProgram(prg)","  return prg","}"].map((e=>`${t}${e}`)).join("\n")}hasAttribute(t){const{gl:e,program:n}=this;return e.getAttribLocation(n,t)>=0}getAttribLocation(t){const{gl:e,program:n}=this,i=e.getAttribLocation(n,t);if(i<0)throw new Error(`Attribute "${t}" not found!`);return i}getUniformLocation(t){const{uniformsLocations:e}=this,n=Object.keys(e);if(0===t.length)return console.warn(`Uniform "${t}" has not been found: there is no active uniform in this program!`),0;const i=e[t];return i||console.warn(`No active uniform found with name "${t}"!\nAvailable names are: ${n.join(", ")}.`),i}uniform1f(t,e){const{gl:n}=this;n.uniform1f(this.getUniformLocation(t),e)}uniform2f(t,e,n){const{gl:i}=this;i.uniform2f(this.getUniformLocation(t),e,n)}uniform3f(t,e,n,i){const{gl:r}=this;r.uniform3f(this.getUniformLocation(t),e,n,i)}uniform3fv(t,e){const{gl:n}=this;n.uniform3fv(this.getUniformLocation(t),e)}uniform4f(t,e,n,i,r){const{gl:s}=this;s.uniform4f(this.getUniformLocation(t),e,n,i,r)}uniform4fv(t,e){const{gl:n}=this;n.uniform4fv(this.getUniformLocation(t),e)}uniform1i(t,e){const{gl:n}=this;n.uniform1i(this.getUniformLocation(t),e)}uniform2i(t,e,n){const{gl:i}=this;i.uniform2i(this.getUniformLocation(t),e,n)}uniform3i(t,e,n,i){const{gl:r}=this;r.uniform3i(this.getUniformLocation(t),e,n,i)}uniform4i(t,e,n,i,r){const{gl:s}=this;s.uniform4i(this.getUniformLocation(t),e,n,i,r)}uniform1ui(t,e){const{gl:n}=this;n.uniform1ui(this.getUniformLocation(t),e)}uniform2ui(t,e,n){const{gl:i}=this;i.uniform2ui(this.getUniformLocation(t),e,n)}uniform3ui(t,e,n,i){const{gl:r}=this;r.uniform3ui(this.getUniformLocation(t),e,n,i)}uniform4ui(t,e,n,i,r){const{gl:s}=this;s.uniform4ui(this.getUniformLocation(t),e,n,i,r)}uniformMatrix3fv(t,e){const{gl:n}=this;n.uniformMatrix3fv(this.getUniformLocation(t),!1,e)}uniformMatrix4fv(t,e){const{gl:n}=this;n.uniformMatrix4fv(this.getUniformLocation(t),!1,e)}use(){const{gl:t,program:e}=this;t.useProgram(e)}delete(){const{gl:t}=this;for(const e of this.shaders)t.deleteShader(e);t.deleteProgram(this.program)}debug(t="TgdProgram"){console.log(t);const{options:e}=this;ce("Vertex Shader",ne(e.vert)),ce("Fragment Shader",ne(e.frag))}createShader(t,e){const{gl:n}=this,i=n.createShader(n[t]);if(!i)throw new Error(`Unable to create a WebGLShader of type "${t}"!`);n.shaderSource(i,e),n.compileShader(i);const r=n.getShaderInfoLog(i);if(r){console.error(`Error in ${t} code:`,r);const n=ae(r);throw new Error(ce(t,e,n))}return i}getUniformsLocations(){const{gl:t,program:e}=this,n=t.getProgramParameter(e,t.ACTIVE_UNIFORMS);if("number"!=typeof n)throw new Error("Unable to get the number of uniforms in a WebGLProgram!");const i={};for(let r=0;r<n;r++){const n=t.getActiveUniform(e,r);if(!n)continue;const s=t.getUniformLocation(e,n.name);if(null===s)throw new Error(`Unable to get location for uniform "${n.name}"!`);i[n.name]=s}return i}}const oe=/^ERROR:[ \t]+([0-9]+):([0-9]+):/g;function ae(t){const e=[],n=[];for(const i of t.split("\n")){oe.lastIndex=-1;const t=oe.exec(i);t&&(e.push(Number.parseInt(t[2],10)),n.push(i.slice(t[0].length).trim()))}return{lines:e,messages:n}}function he(t,e=!1){return`color:#fff;background:${t};font-family:monospace;font-size:80%;font-weight:${e?"bolder":"100"};margin:0;color:${e?"#777":"#fff"}`}function ce(t,e,n){const{lines:i=[],messages:r=[]}=null!=n?n:{},s=[t],o=[`%c${t}`],a=["font-weight:bolder;font-size:120%"];let h=!1;for(const[t,n]of e.split("\n").entries()){const e=t+1,c=`${e}`.padStart(5," "),u=i.includes(e)?"#f00":"#000";o.push(`%c${c}  %c${n}`),s.push(`${c}  ${n}`),a.push(he(u,!0),he(u,!1)),i.includes(e)&&(h=!0,o.push(`%c${r[i.indexOf(e)]}`),s.push(`##### ${r[i.indexOf(e)]}`),a.push("color:#f33;background:#333;font-weight:bold"),console.error())}return console.log(o.join("\n"),...a),h?s.join("\n"):""}class ue{constructor(t,e={}){var n,i;this.attributesDefinition=t,this.options=e,this.stride=0,this.definitions={},this._data=new ArrayBuffer(0),this._count=0,this.target=null!==(n=e.target)&&void 0!==n?n:"ARRAY_BUFFER",this.usage=null!==(i=e.usage)&&void 0!==i?i:"STATIC_DRAW",this.initialize(t,e)}initialize(t,e={}){var n;for(const e of Object.keys(t)){const n=t[e];this.attributesDefinition[e]=n}const i=null!==(n=e.divisor)&&void 0!==n?n:0;let r=0;const s={},o={};for(const e of Object.keys(t)){s[e]=new ArrayBuffer(0);const n={dimension:le[t[e]],byteOffset:r,bytesPerElement:Float32Array.BYTES_PER_ELEMENT,divisor:i,getter:(t,e)=>(e>=t.byteLength&&(e%=t.byteLength),t.getFloat32(e,!0)),setter(t,e,n){t.setFloat32(e,n,!0)}};o[e]=n,r+=n.bytesPerElement*n.dimension}this.definitions=o,this.stride=r,this._data=fe(this._data,this.count*this.stride)}assertAttribType(t,...e){const n=this.attributesDefinition[t];if(!n)throw new Error(`Attribute "${t}" does not exist! Available names are: ${Object.keys(this.attributesDefinition).join(", ")}.`);if(!e.includes(n))throw new Error(`Attribute "${t}" is of type "${n}", which is not ${e.join(" nor ")}!`);return this}addAttributes(t){const e=this.clone();for(const e of Object.keys(t)){const n=this.attributesDefinition[e],i=t[e];if(n&&n!==i)throw new Error(`It is not allowed to change the type of attribute "${e}" from "${n}" to "${i}"! Prefer removing the attribute first.`)}this.initialize(Object.assign(Object.assign({},this.attributesDefinition),t),this.options);const n=this;n.count=e.count;for(const t of e.attributesNames)try{const{get:i}=e.getAttribAccessor(t),{set:r}=n.getAttribAccessor(t);for(let n=0;n<e.count;n++){const e=this.getDef(t);for(let t=0;t<e.dimension;t++)r(i(n,t),n,t)}}catch(e){const n=e instanceof Error?e.message:JSON.stringify(e);throw new Error(`Unable to clone attribute "${t}"!\n${n}`)}}clone(){const t=new ue(structuredClone(this.attributesDefinition),this.options);t.count=this.count;const e=new DataView(this._data),n=new DataView(t._data);for(let t=0;t<e.byteLength;t++)n.setUint8(t,e.getUint8(t));return t}get data(){return this._data}get count(){return this._count}set count(t){this._count!==t&&(this._count=t,this._data=fe(this._data,t*this.stride))}get attributesNames(){return Object.keys(this.attributesDefinition)}getAttribAccessor(t){const e=this.getDef(t),n=new DataView(this.data),i=this.stride;return{get(t,r=0){const s=e.byteOffset+i*t+r*e.bytesPerElement;return e.getter(n,s)},set(t,r,s=0){const o=e.byteOffset+i*r+s*e.bytesPerElement;e.setter(n,o,t)}}}set(t,e,{byteOffset:n=0,byteStride:i,first:r=0,count:s=1/0,targetFirst:o=0}={}){const{bytesPerElement:a,dimension:h,byteOffset:c}=this.getDef(t),u=e instanceof ArrayBuffer?e:e.buffer,l=a*h,f=null!=i?i:l;let d=n+f*r;const m=this.stride;let g=o*m+c;this.count=Math.max(this.count,Math.min(s,Math.floor((u.byteLength-d)/f)));const p=u.byteLength-f+1,v=this._data.byteLength+c-m+1,x=new Uint8Array(u),E=new Uint8Array(this._data);let A=0;for(;A<s&&d<p&&g<v;)E.set(x.subarray(d,d+l),g),A++,d+=f,g+=m}getDef(t){const e=this.definitions[t];if(!e)throw new Error(`[TgdDataset] Attribute "${String(t)}" not found in this DataSet!\nAvailable names are: ${Object.keys(this.definitions).map((t=>JSON.stringify(t))).join(", ")}.`);return e}defineAttributes(t,e){let n=0;const{definitions:i}=this;for(const r of Object.keys(i)){const s=i[r];if(e.hasAttribute(r)){const i=e.getAttribLocation(r);t.enableVertexAttribArray(i),t.vertexAttribPointer(i,s.dimension,t.FLOAT,!1,this.stride,n),t.vertexAttribDivisor(i,s.divisor)}n+=s.dimension*s.bytesPerElement}}toCode({indent:t=""}={}){const e=[];let n=0;const{definitions:i}=this;for(const t of Object.keys(i)){const r=i[t],s=`$${t}`;e.push(`const ${s} = gl.getAttribLocation(prg, "${t}")`,`gl.enableVertexAttribArray(${s})`,"gl.vertexAttribPointer(",`  ${s},`,`  ${r.dimension},  // Dimension`,"  gl.FLOAT,","  false,",`  ${this.stride},   // Stride`,`  ${n}   // Offset`,")",`gl.vertexAttribDivisor(${s}, ${r.divisor})`),n+=r.dimension*r.bytesPerElement}return e.map((e=>`${t}${e}`)).join("\n")}debug(t="Dataset"){console.log(t,"   count:",this.count,"   target:",this.target,"   usage:",this.usage);const e=[["Name","type","offset"]];for(const t of Object.keys(this.definitions)){const n=this.definitions[t];e.push([t,this.attributesDefinition[t],`${n.byteOffset}`])}const n=[0,1,2].map((t=>e.reduce(((e,n)=>Math.max(e,n[t].length)),0)));for(const[t,i,r]of e)console.log(`%c${t.padEnd(n[0]+2)}${i.padStart(n[1]+2)}${r.padStart(n[2]+2)}`,"font-family:monospace");for(const t of Object.keys(this.definitions)){const e=this.definitions[t];if(!e)continue;const{get:n}=this.getAttribAccessor(t),i=[];for(let t=0;t<this.count;t++){const r=[];for(let i=0;i<e.dimension;i++)r.push(n(t,i));i.push(r)}console.log(`Attribute "${t}":`,i)}}}const le={float:1,vec2:2,vec3:3,vec4:4},fe="function"==typeof ArrayBuffer.prototype.transfer?function(t,e){return t.transfer(e)}:function(t,e){const n=new ArrayBuffer(null!=e?e:t.byteLength);return new Uint8Array(n).set(new Uint8Array(t)),n};class de{constructor(t,e={}){var n,i;this.gl=t;const r=t.createBuffer();if(!r)throw new Error("Unable to create WebGLBuffer!");this._target=null!==(n=null==e?void 0:e.target)&&void 0!==n?n:"ARRAY_BUFFER",this._usage=null!==(i=null==e?void 0:e.usage)&&void 0!==i?i:"STATIC_DRAW",this.buffer=r;const{data:s}=e;s&&this.bufferData(Object.assign(Object.assign({},e),{data:s}))}get target(){return this._target}bind(t){const{gl:e,buffer:n}=this;this._target=null!=t?t:this._target,e.bindBuffer(e[this._target],n)}bufferData(t){var e,n;const{gl:i}=this;this._usage=null!==(e=t.usage)&&void 0!==e?e:this._usage,this._target=null!==(n=t.target)&&void 0!==n?n:this._target,this.bind(t.target),i.bufferData(i[this._target],t.data,i[this._usage])}delete(){const{gl:t,buffer:e}=this;t.deleteBuffer(e)}}class me{constructor(t,e,n,i){this.gl=t,this.program=e,this.datasets=n,this.elements=i,this.drawBuffers=[],this.elemBuffer=null;const r=t.createVertexArray();if(!r)throw new Error("Unable to create VertexArrayObject!");if(this.vao=r,e&&n){if(t.bindVertexArray(r),this.drawBuffers=n.map((n=>{const i=new de(t,{data:n.data,target:n.target,usage:n.usage});return i.bind(),n.defineAttributes(t,e),i})),i){const e=new de(t,{data:i,target:"ELEMENT_ARRAY_BUFFER"});e.bind(),this.elemBuffer=e}t.bindVertexArray(null)}}getBuffer(t){return this.drawBuffers[t]}toCode({indent:t=""}={}){var e;const n=["function createVAO(","  gl: WebGL2RenderingContext,",`  prg: WebGLProgram${null===(e=this.datasets)||void 0===e?void 0:e.map(((t,e)=>`, data${e}: ArrayBuffer`)).join("")}`,") {","  const vao = gl.createVertexArray()","  gl.bindVertexArray(vao)"];if(this.datasets)for(const[e,i]of this.datasets.entries())n.push(`  const buff${e} = gl.createBuffer()`,`  gl.bindBuffer(gl.${i.target}, buff${e})`,`  gl.bufferData(gl.${i.target}, data${e}, gl.${i.usage})`,i.toCode({indent:`${t}  `}));return n.push("  return vao","}"),n.map((e=>`${t}${e}`)).join("\n")}debug(t="TgdVertexArray"){if(console.log(t),this.program&&this.program.debug(),this.datasets)for(const[t,e]of this.datasets.entries())e.debug(`   Dataset #${t}`);this.elements&&console.log("Elements:",this.elements)}bind(){this.gl.bindVertexArray(this.vao)}unbind(){this.gl.bindVertexArray(null)}delete(){const{gl:t,vao:e,drawBuffers:n,elemBuffer:i}=this;t.deleteVertexArray(e);for(const t of n)t.delete();i&&i.delete()}}class ge extends ct{constructor(t,{x:e=0,y:n=0,z:i=0,scale:r=1}={}){super(),this.context=t;const s=new se(t.gl,{vert:"#version 300 es\n\nprecision highp float;\n\nuniform vec4 uniTS;\nuniform mat4 uniModelViewMatrix;\nuniform mat4 uniProjectionMatrix;\n\nin vec3 attPos;\nin vec4 attColor;\n\nout vec4 varColor;\n\nvoid main() {\n    varColor = attColor;\n    vec3 translate = uniTS.xyz;\n    float scale = uniTS.w;\n    gl_Position = uniProjectionMatrix \n        * uniModelViewMatrix \n        * vec4(attPos * scale + translate, 1.0);\n}\n",frag:"#version 300 es\n\nprecision highp float;\n\nin vec4 varColor;\n\nout vec4 FragColor;\n\nvoid main() {\n    FragColor = varColor;\n}"});this.prg=s;const o=new ue({attPos:"vec3",attColor:"vec4"});o.set("attPos",new Float32Array([0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,-1,-0,-0,0,0,0,-0,-1,-0,0,0,0,-0,-0,-1]));const a=.25;o.set("attColor",new Float32Array([1,0,0,1,1,0,0,1,0,1,0,1,0,1,0,1,0,0,1,1,0,0,1,1,a,0,0,1,a,0,0,1,0,a,0,1,0,a,0,1,0,0,a,1,0,0,a,1])),this.vao=new me(t.gl,s,[o]),this.translateAndScale=new p(e,n,i,r)}get x(){return this.translateAndScale.x}set x(t){this.translateAndScale.x=t}get y(){return this.translateAndScale.y}set y(t){this.translateAndScale.y=t}get z(){return this.translateAndScale.z}set z(t){this.translateAndScale.z=t}get scale(){return this.translateAndScale.w}set scale(t){this.translateAndScale.w=t}delete(){this.vao.delete()}paint(){const{context:t,prg:e,vao:n,translateAndScale:i}=this,{gl:r,camera:s}=t;e.use(),e.uniform4fv("uniTS",i),e.uniformMatrix4fv("uniModelViewMatrix",s.matrixModelView),e.uniformMatrix4fv("uniProjectionMatrix",s.matrixProjection),n.bind(),r.drawArrays(r.LINES,0,12)}}class pe extends ct{constructor(t,{texture:e,x:n=0,y:i=0,z:r=.999999,zoom:s=1,scaleX:o=1,scaleY:a=1,mode:h="cover"}={}){super(),this.context=t,this.zoom=1,this.x=0,this.y=0,this.z=1,this.mode="cover",this.texture=e,this.mode=h,this.x=n,this.y=i,this.z=r,this.zoom=s,this.texture=e,this.program=new se(t.gl,{vert:"#version 300 es\n\nuniform float uniZoom;\nuniform vec2 uniScale;\nuniform vec2 uniScroll;\nuniform float uniZ;\nin vec2 attPoint;\nin vec2 attUV;\nout vec2 varUV;\n\nvoid main() {\n    varUV = (attUV + uniScroll) * uniZoom;\n    float x = uniScale.x * attPoint.x;\n    float y = uniScale.y * attPoint.y;\n    gl_Position = vec4(x, y, uniZ, 1.0);\n}",frag:"#version 300 es\n\nprecision highp float;\n\nuniform sampler2D uniTexture;\nin vec2 varUV;\nout vec4 FragColor;\n\nvoid main() {\n    FragColor = texture(uniTexture, varUV);\n}"});const c=new ue({attPoint:"vec2",attUV:"vec2"});c.set("attPoint",new Float32Array([-1*o,1*a,1*o,1*a,-1*o,-1*a,1*o,-1*a])),c.set("attUV",new Float32Array([0,0,1,0,0,1,1,1])),this.vao=new me(t.gl,this.program,[c])}delete(){const{program:t,vao:e}=this;t.delete(),e.delete()}paint(){const{gl:t}=this.context,{vao:e,program:n,texture:i,zoom:r,x:s,y:o,z:a,mode:h}=this;n.use();const{scaleX:c,scaleY:u}="cover"===h?this.getScaleForCover():this.getScaleForContain();n.uniform2f("uniScale",c,u),n.uniform2f("uniScroll",s,o),n.uniform1f("uniZoom",1/r),n.uniform1f("uniZ",a),null==i||i.activate(0,n,"uniTexture"),t.disable(t.CULL_FACE),e.bind(),t.drawArrays(t.TRIANGLE_STRIP,0,4)}getScaleForCover(){const{texture:t,context:e}=this;if(!t)return{scaleX:1,scaleY:1};const{drawingBufferWidth:n,drawingBufferHeight:i}=e.gl,r=t.width*i>t.height*n;return{scaleX:r?t.width*i/(n*t.height):1,scaleY:r?1:t.height*n/(i*t.width)}}getScaleForContain(){const{texture:t,context:e}=this;if(!t)return{scaleX:1,scaleY:1};const{drawingBufferWidth:n,drawingBufferHeight:i}=e.gl,r=n/i,s=t.width/t.height;return n/t.width>i/t.height?{scaleX:s/r,scaleY:1}:{scaleX:1,scaleY:r/s}}}class ve extends ut{static do(t,e){const{onEnterActions:n,onExitActions:i}=xe({color:{red:!0,green:!0,blue:!0,alpha:!0}},t.gl,t);for(const t of n)t();e();for(const t of i)t()}static debug(t){const e=Ht(t);console.log("Depth:",{enabled:e.enabled,func:r(e.func),mask:e.mask,range:[e.rangeMin,e.rangeMax]}),console.log("Cull:",kt(t)),console.log("Blend:",Vt(t))}constructor(t,e={}){var n;super(e.children),this.color={red:!0,green:!0,blue:!0,alpha:!0};const{gl:i}=t,{onEnterActions:r,onExitActions:s}=xe(this,i,e);this.onEnter=(t,n)=>{var i;null===(i=e.onEnter)||void 0===i||i.call(e,t,n);for(const t of r)t()},this.onExit=(t,n)=>{var i;for(const t of s)t();null===(i=e.onExit)||void 0===i||i.call(e,t,n)},this.name=null!==(n=e.name)&&void 0!==n?n:`State/${this.name}`}}function xe(t,e,n){const{color:i,blend:r,depth:s,cull:o,stencil:a}=n,h=[],c=[],u=function(t){return!0===t?[!0,!0,!0,!0]:!1===t?[!1,!1,!1,!1]:t}(i),[l,f,d,m]=null!=u?u:[!0,!0,!0,!0];if(t.color.red=l,t.color.green=f,t.color.blue=d,t.color.alpha=m,Array.isArray(u)){let n;h.push((()=>{n=e.getParameter(e.COLOR_WRITEMASK),e.colorMask(t.color.red,t.color.green,t.color.blue,t.color.alpha)})),c.push((()=>{e.colorMask(...null!=n?n:[!0,!0,!0,!0])}))}if(r){let t;h.push((()=>{t=Vt(e),$t(e,r)})),c.push((()=>{t&&$t(e,t)}))}if(s){let t;h.push((()=>{t=Ht(e),Xt(e,s)})),c.push((()=>{t&&Xt(e,t)}))}if(o){let t;h.push((()=>{t=kt(e),Gt(e,o)})),c.push((()=>{t&&Gt(e,t)}))}if(a){let t;h.push((()=>{t=Yt(e),Zt(e,a)})),c.push((()=>{t&&Zt(e,t)}))}return{onEnterActions:h,onExitActions:c}}class Ee extends ct{constructor({gl:t},e={}){var n,i,r,s;super(),this.options=e,this.red=1,this.green=.7,this.blue=0,this.alpha=1,this.depth=1,this.stencil=0,this.name=null!==(n=e.name)&&void 0!==n?n:`Clear/${this.name}`,this.gl=t;const o=null!==(i=e.color)&&void 0!==i?i:[0,0,0,1],a=null!==(r=e.depth)&&void 0!==r?r:1,h=null!==(s=e.stencil)&&void 0!==s?s:0;this.clearMask=0;let c=!1;if(void 0!==e.color&&(this.clearMask|=t.COLOR_BUFFER_BIT,c=!0),"number"==typeof e.depth&&(this.clearMask|=t.DEPTH_BUFFER_BIT,c=!0),"number"==typeof e.stencil&&(this.clearMask|=t.STENCIL_BUFFER_BIT,c=!0),!c)throw new Error("[TgdPainterClear] You must give at least a color or a depth in the constructor!");[this.red,this.green,this.blue,this.alpha]=o,this.depth=a,this.stencil=h}delete(){}paint(){const{clearMask:t,gl:e,red:n,green:i,blue:r,alpha:s,depth:o,stencil:a,options:h}=this;h.color&&e.clearColor(n,i,r,s),"number"==typeof h.depth&&e.clearDepth(o),"number"==typeof h.stencil&&(e.stencilMask(255),e.clearStencil(a)),e.clear(t)}}class Ae extends ct{constructor(t,{background:e,children:n}){super(),this.context=t,this.depthTexture=null;const{gl:i}=t,r=i.createFramebuffer();if(!r)throw new Error("Unable to create a WebGL2 Frame buffer!");this.framebuffer=r,this.clear=new Ee(t,{depth:1}),this.texture=e,this.program=new se(t.gl,{vert:"#version 300 es\n\nuniform float uniScale;\nin vec2 attPoint;\nin vec2 attUV;\nout vec2 varUV;\n\nvoid main() {\n    vec2 s = vec2(uniScale, 1.0);\n    vec2 o = vec2(0.5, 0);\n    varUV = o + (attUV - o) * s;\n    gl_Position = vec4(attPoint, 1.0, 1.0);\n}",frag:"#version 300 es\n\nprecision highp float;\n\nuniform sampler2D uniTexture;\nuniform sampler2D uniDepth;\nin vec2 varUV;\nout vec4 FragColor;\n\nvoid main() {\n    vec3 color = texture(uniTexture, varUV).rgb;\n    float depth = texture(uniDepth, varUV).r;\n    FragColor = vec4(color, 1.0);\n    gl_FragDepth = depth;\n    gl_FragDepth = dot(cos(varUV * 30.0), cos(varUV * 30.0));\n    FragColor = vec4(vec3(gl_FragDepth) * color, 1.0);\n}"});const s=new ue({attPoint:"vec2",attUV:"vec2"});s.set("attPoint",new Float32Array([-1,1,1,1,-1,-1,1,-1])),s.set("attUV",new Float32Array([0,0,1,0,0,1,1,1])),this.vao=new me(t.gl,this.program,[s]),this.renderer=new ve(t,{children:n,depth:Wt.less,cull:zt.back,blend:Dt.off,color:!1})}delete(){const{context:t,vao:e,framebuffer:n,depthTexture:i}=this,{gl:r}=t;r.deleteFramebuffer(n),i&&r.deleteTexture(i),e.delete()}paint(t,e){const{context:n,vao:i,program:r,texture:s,depthTexture:o}=this,{gl:a}=n;this.paintDepthBuffer(t,e),r.use();const h=this.getScale();r.uniform1f("uniScale",h),s.activate(0,r,"uniTexture"),o&&(a.activeTexture(a.TEXTURE1),a.bindTexture(a.TEXTURE_2D,o),r.uniform1i("uniDepth",1)),i.bind(),ve.do({gl:a,cull:zt.off,depth:Wt.writeOnly},(()=>a.drawArrays(a.TRIANGLE_STRIP,0,4))),i.unbind()}paintDepthBuffer(t,e){const{context:n,framebuffer:i,clear:s,renderer:o,texture:a}=this,{gl:h}=n,{drawingBufferWidth:c,drawingBufferHeight:u}=h;h.bindFramebuffer(h.FRAMEBUFFER,i),h.viewport(0,0,c,u),this.depthTexture&&h.deleteTexture(this.depthTexture);const l=h.createTexture();if(!l)throw new Error("Unable to create a WebGL2 Texture!");this.depthTexture=l,h.bindTexture(h.TEXTURE_2D,l);const f=h.DEPTH_COMPONENT24,d=h.DEPTH_COMPONENT,m=h.UNSIGNED_INT;h.texImage2D(h.TEXTURE_2D,0,f,c,u,0,d,m,null),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MIN_FILTER,h.NEAREST),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MAG_FILTER,h.NEAREST);const g=be(a.getParameter("TEXTURE_WRAP_S"),h.CLAMP_TO_EDGE),p=be(a.getParameter("TEXTURE_WRAP_T"),h.CLAMP_TO_EDGE);h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_S,g),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_T,p),h.framebufferTexture2D(h.FRAMEBUFFER,h.DEPTH_ATTACHMENT,h.TEXTURE_2D,l,0);const v=h.checkFramebufferStatus(h.FRAMEBUFFER);v!==h.FRAMEBUFFER_COMPLETE&&console.error(`Your Framebuffer is incomplete: ${r(v)}!`),s.paint(),o.paint(t,e),h.bindFramebuffer(h.FRAMEBUFFER,null)}getScale(){const{texture:t,context:e}=this,{drawingBufferWidth:n,drawingBufferHeight:i}=e.gl;return n/i/(t.width/t.height)}}function be(t,e){return"number"==typeof t?t:e}class Te extends ct{constructor(t){super(),this.context=t,this.program=new se(t.gl,{vert:"#version 300 es\n\nin vec2 attPoint;\n\nvoid main() {\n    gl_Position = vec4(attPoint, 0.0, 1.0);\n}",frag:"#version 300 es\n\nprecision highp float;\n\nuniform vec4 uniColor;\nout vec4 FragColor;\n\nvoid main() {\n    FragColor = uniColor;\n}"});const e=new ue({attPoint:"vec2"});e.set("attPoint",new Float32Array([-1,1,1,1,-1,-1,1,-1])),this.vao=new me(t.gl,this.program,[e])}paint(t,e){const{context:n,program:i,vao:r}=this,{gl:s}=n,o=Yt(s);s.disable(s.DEPTH_TEST),s.disable(s.CULL_FACE);const a=([t,e,n],r)=>{i.uniform4f("uniColor",t,e,n,1),s.stencilFunc(s.EQUAL,r,255),s.drawArrays(s.TRIANGLE_STRIP,0,4)};s.disable(s.STENCIL_TEST),s.clearColor(.5,.5,.5,1),s.clear(s.COLOR_BUFFER_BIT),i.use(),r.bind(),s.enable(s.STENCIL_TEST),s.stencilOp(s.KEEP,s.KEEP,s.KEEP),a([0,0,0],0),a([1,0,0],1),a([0,1,0],2),a([0,0,1],3),a([0,1,1],4),a([1,0,1],5),a([1,1,0],6),a([1,1,1],7),r.unbind(),Zt(s,o)}delete(){}}class ye extends ct{constructor({gl:t},{enabled:e=!0,func:n="LESS",mask:i=!0,rangeMin:r=0,rangeMax:s=1}={}){super(),this.gl=t,this.enabled=e,this.func=n,this.mask=i,this.rangeMin=r,this.rangeMax=s}delete(){}paint(){const{gl:t}=this,{enabled:e}=this;if(!e)return void t.disable(t.DEPTH_TEST);const{func:n,mask:i,rangeMin:r,rangeMax:s}=this;t.enable(t.DEPTH_TEST),t.depthFunc(t[n]),t.depthMask(i),t.depthRange(r,s)}update(){}}class we{constructor({precision:t="highp",uniforms:e={},attributes:n={},varying:i={},functions:r={},mainCode:s=[]}={}){this.precision=t,this.uniforms=e,this.attributes=n,this.varying=i,this.functions=r,this.mainCode=s}get code(){return ne(["#version 300 es",`precision ${this.precision} float;`,...ie(this.uniforms,"uniform"),...ie(this.attributes,"in"),...ie(this.varying,"out"),...re(this.functions),"","void main() {",this.mainCode,"}"])}}class _e{constructor({precision:t="highp",uniforms:e={},outputs:n={FragColor:"vec4"},varying:i={},functions:r={},mainCode:s=["FragColor = vec4(1, 0.667, 0, 1);"]}={}){this.precision="mediump",this.precision=t,this.uniforms=e,this.outputs=n,this.varying=i,this.functions=r,this.mainCode=s}get code(){return ne(["#version 300 es",`precision ${this.precision} float;`,...ie(this.uniforms,"uniform"),...ie(this.varying,"in"),...ie(this.outputs,"out"),...re(this.functions),"","void main() {",this.mainCode,"}"])}}class Re extends ct{constructor(t,e){var n,i,r;super(),this.context=t,this.z=0,this.textures=null,this.texturesWith=-1,this.texturesHeight=-1,this.z=null!==(n=e.z)&&void 0!==n?n:.999999,this.texture=e.texture;const s=null!==(i=e.filters)&&void 0!==i?i:[];if(0===s.length)throw new Error("[TgdPainterFilter] filters is expected to have at least one element!");const o=s.map((e=>{const n=new we({attributes:{attPoint:"vec2",attUV:"vec2"},varying:{varUV:"vec2"},uniforms:{uniZ:"float"},mainCode:["varUV = attUV;","gl_Position = vec4(",["attPoint,","uniZ,","1.0"],");"]}).code,i=new _e({uniforms:Object.assign({uniWidth:"float",uniHeight:"float",uniTexture:"sampler2D"},e.uniforms),varying:{varUV:"vec2"},mainCode:e.fragmentShaderCode,functions:e.extraFunctions}).code;return new se(t.gl,{vert:n,frag:i})})),a=o.map((n=>Pe(t,n,e.flipY?-1:1)));this.program=o.pop(),this.programs=o,this.filter=s.pop(),this.filters=s;const h=a.pop();this.vaos=a;const c=a.length+(e.flipY?1:0);this.vao=c%2==0?h:Pe(t,this.program,-1);const u=t.gl.createFramebuffer();if(!u)throw new Error("Unable to create a WebGL Framebuffer!");this.framebuffer=u,this.name=null!==(r=e.name)&&void 0!==r?r:`Filter/${this.name}`}delete(){const{context:t,textures:e,vaos:n,vao:i,framebuffer:r}=this,{gl:s}=t;for(const t of n)t.delete();if(i.delete(),s.deleteFramebuffer(r),e)for(const t of e)s.deleteTexture(t)}paint(t,e){const{vaos:n,texture:i,z:r,context:s}=this,{gl:o}=this.program;let a=null==i?void 0:i.glTexture;if(a){if(n.length>0){const{programs:i,filters:h,framebuffer:c}=this,u=o.getParameter(o.FRAMEBUFFER_BINDING),l=this.getTextures(o);let f=0,d=l[f];for(const[u,m]of n.entries())o.bindFramebuffer(o.FRAMEBUFFER,c),o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,d,0),Me(t,e,m,i[u],h[u],a,r,s),f=1-f,a=d,d=l[f];o.bindFramebuffer(o.FRAMEBUFFER,u)}Me(t,e,this.vao,this.program,this.filter,a,r,s),o.bindVertexArray(null)}else console.warn("[TgdPainterFilter] Input texture is undefined!")}getTextures(t){var e;const{width:n,height:i}=null!==(e=this.texture)&&void 0!==e?e:{width:64,height:64};if(this.textures&&this.texturesWith===n&&this.texturesHeight===i)return[...this.textures];if(this.textures)for(const e of this.textures)t.deleteTexture(e);return this.texturesWith=n,this.texturesHeight=i,this.textures=[0,1].map((()=>{const e=t.createTexture();return t.bindTexture(t.TEXTURE_2D,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,n,i,0,t.RGBA,t.UNSIGNED_BYTE,null),e})),this.textures}}function Me(t,e,n,i,r,s,o,a){const{gl:h}=i;i.use(),i.uniform1f("uniZ",o),r.setUniforms({context:a,program:i,time:t,delay:e}),h.activeTexture(h.TEXTURE0),h.bindTexture(h.TEXTURE_2D,s),i.uniform1i("uniTexture",0),n.bind(),h.drawArrays(h.TRIANGLE_STRIP,0,4)}function Pe(t,e,n=1){const i=new ue({attPoint:"vec2",attUV:"vec2"});i.set("attPoint",new Float32Array([-1,1*n,1,1*n,-1,-1*n,1,-1*n])),i.set("attUV",new Float32Array([0,0,1,0,0,1,1,1]));const r=new me(t.gl,e,[i]);if(!r)throw new Error("Unable to create WebGL VAO!");return r}class Ce extends ut{constructor(t,e){super(e.children),this.context=t,this.options=e,this.dirty=!0,this._width=0,this._height=0,this._framebuffer=null,this._depthBuffer=null,this._stencilBuffer=null;const{textureColor0:n,textureColor1:i,textureColor2:r,textureColor3:s}=e;n||i||r||s||console.error("[TgdPainterFramebuffer] You gave no color texture in the constructor: nothing will be rendered!",e),this.textureColor0=n,this.textureColor1=i,this.textureColor2=r,this.textureColor3=s,this.textureDepth=e.textureDepth,this.onEnter=e.onEnter,this.onExit=e.onExit;const{gl:o}=this.context;this.drawBuffers=[this.textureColor0?o.COLOR_ATTACHMENT0:o.NONE,this.textureColor1?o.COLOR_ATTACHMENT1:o.NONE,this.textureColor2?o.COLOR_ATTACHMENT2:o.NONE,this.textureColor3?o.COLOR_ATTACHMENT3:o.NONE]}get width(){return this._width}set width(t){this._width!==t&&(this._width=t,this.dirty=!0)}get height(){return this._height}set height(t){this._height!==t&&(this._height=t,this.dirty=!0)}updateTextureForColor(t,e){if(!t)return;const{context:n,width:i,height:r}=this,{gl:s}=n;t.resize(i,r),s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0+e,s.TEXTURE_2D,t.glTexture,0)}createTextureForDepth(){const t=this.textureDepth;if(!t)return;const{context:e,width:n,height:i}=this,{gl:r}=e;t.resize(n,i),r.framebufferTexture2D(r.FRAMEBUFFER,r.DEPTH_ATTACHMENT,r.TEXTURE_2D,t.glTexture,0)}createDepthBuffer(t){if(!1===this.options.depthBuffer)return;const{width:e,height:n}=this,i=t.createRenderbuffer();if(!i)throw new Error("Unable to create WebGLRenderBuffer for depth!");this._depthBuffer=i,t.bindRenderbuffer(t.RENDERBUFFER,i),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,e,n),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,i)}createStencilBuffer(t){if(!1!==this.options.stencilBuffer){const{width:e,height:n}=this,i=t.createRenderbuffer();if(!i)throw new Error("Unable to create WebGLRenderBuffer for stencil!");this._stencilBuffer=i,t.bindRenderbuffer(t.RENDERBUFFER,i),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_STENCIL,e,n),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,t.RENDERBUFFER,i)}}createFramebufferIfNeeded(){if(!this.dirty)return;const{context:t}=this,{gl:e}=t;this.delete(),this._framebuffer=function(t){const e=t.createFramebuffer();if(!e)throw new Error("Unable to create a WebGLFramebuffer!");return e}(e),e.bindFramebuffer(e.FRAMEBUFFER,this._framebuffer),this.updateTextureForColor(this.textureColor0,0),this.updateTextureForColor(this.textureColor1,1),this.updateTextureForColor(this.textureColor2,2),this.updateTextureForColor(this.textureColor3,3),this.createTextureForDepth(),this.createDepthBuffer(e),this.createStencilBuffer(e);const n=e.checkFramebufferStatus(e.FRAMEBUFFER);n!==e.FRAMEBUFFER_COMPLETE&&console.error(`Your Framebuffer is incomplete: ${r(n)}!`),this.dirty=!1}paint(t,e){const{context:n,options:i}=this,{gl:r}=n,{viewportMatchingScale:s=1}=i;this.width=Math.round(n.width*s),this.height=Math.round(n.height*s),this.createFramebufferIfNeeded(),r.bindFramebuffer(r.FRAMEBUFFER,this._framebuffer),r.drawBuffers(this.drawBuffers),super.paint(t,e),r.bindFramebuffer(r.FRAMEBUFFER,null)}delete(){const{context:t,_framebuffer:e,_depthBuffer:n,_stencilBuffer:i}=this,{gl:r}=t;e&&(r.deleteFramebuffer(e),this._framebuffer=null),n&&(r.deleteRenderbuffer(n),this._depthBuffer=null),i&&(r.deleteRenderbuffer(i),this._stencilBuffer=null)}}class Se extends ct{constructor(t,e={}){var n;super(),this.logicFunction=t,this.name=null!==(n=e.name)&&void 0!==n?n:`Logic/${this.name}`}delete(){}paint(t,e){this.logicFunction(t,e)}}class Le{static make(t){var e,n,i;const r={},{count:s,drawMode:o,elements:a,attPosition:h,attNormal:c,attUV:u}=t;r[h.name]=null!==(e=h.type)&&void 0!==e?e:"vec3",c&&(r[c.name]=null!==(n=c.type)&&void 0!==n?n:"vec3"),u&&(r[u.name]=null!==(i=u.type)&&void 0!==i?i:"vec2");const l=new ue(r);return l.set(h.name,h.data),c&&l.set(c.name,c.data),u&&l.set(u.name,u.data),new Le({dataset:l,count:s,drawMode:o,elements:a})}constructor(t){var e;const{dataset:n,drawMode:r="TRIANGLES",attPosition:s="POSITION",attNormal:o="NORMAL",attUV:a="TEXCOORD_0"}=t;this._dataset=n,this.drawMode=r;const{elements:h}=t;this.elements=h,this._elementsType=h?i(h):0,this.attPosition=s,this.attNormal=o,this.attUV=a,this.count=null!==(e=null==h?void 0:h.length)&&void 0!==e?e:n.count,t.computeNormalsIfMissing&&this.computeNormals()}get dataset(){return this._dataset}get elementsType(){return this._elementsType}getElement(t){var e,n;return null!==(n=null===(e=this.elements)||void 0===e?void 0:e[t])&&void 0!==n?n:-1}computeNormals(){let t=[];if(this.drawMode!==WebGL2RenderingContext.TRIANGLES&&"TRIANGLES"!==this.drawMode)return void console.error("We don't know how to compute normals for this draw mode:",this.drawMode);t=this.computeNormalsForTrianglesDrawMode();const e=this.attNormal;this.dataset.addAttributes({[e]:"vec3"});const n=[];for(const[e,i,r]of t)n.push(e,i,r);this.dataset.set(e,new Float32Array(n))}computeNormalsForTrianglesDrawMode(){const t=this.dataset,e=new Map,n=(t,n,i,r)=>{const s=function(t,e,n){const i=new g(e).subtract(t),r=new g(n).subtract(t);return i.cross(r).normalize()}(n,i,r),o=e.get(t);o?o.add(s):e.set(t,new g(s.x,s.y,s.z))},{get:i}=t.getAttribAccessor(this.attPosition),r=new Set;let s=0;for(let t=0;t<this.count;t+=3){const e=this.getElement(t+0);r.add(e),s=Math.max(s,e);const o=this.getElement(t+1);r.add(o),s=Math.max(s,o);const a=this.getElement(t+2);r.add(a),s=Math.max(s,a);const h=new g(i(e,0),i(e,1),i(e,2)),c=new g(i(o,0),i(o,1),i(o,2)),u=new g(i(a,0),i(a,1),i(a,2));n(e,h,c,u),n(o,c,u,h),n(a,u,h,c)}const o=[];for(let t=0;t<=s;t++){const n=e.get(t);n?(n.normalize(),o.push(n)):o.push(new g)}return o}}class Ne extends Le{static fromBoundingBox(t,e){const[n,i,r]=t,[s,o,a]=e;return new Ne({sizeX:s-n,sizeY:o-i,sizeZ:a-r})}constructor({sizeX:t=1,sizeY:e=1,sizeZ:n=1,uvs:i="sameOnEachFace"}={}){const r=.5*t,s=.5*e,o=.5*n,a=new ue({POSITION:"vec3",NORMAL:"vec3",TEXCOORD_0:"vec2"});a.set("POSITION",new Float32Array([...Fe("+x+y+z",r,s,o),...Fe("+y+z+x",r,s,o),...Fe("+z+x+y",r,s,o),...Fe("-x+z+y",r,s,o),...Fe("-y+x+z",r,s,o),...Fe("-z+y+x",r,s,o)])),a.set("TEXCOORD_0",new Float32Array(function(t){return"sameOnEachFace"===t?[...Oe,...Oe,...Oe,...Oe,...Oe,...Oe]:[...De(0,0),...De(1,0),...De(2,0),...De(0,1),...De(1,1),...De(2,1)]}(i))),a.set("NORMAL",new Float32Array([...Ve,...We,...Ze,...Ge,...He,...Ke])),super({dataset:a,drawMode:"TRIANGLES"})}}const Ue=[[-1,1],[1,1],[-1,-1],[1,-1],[-1,-1],[1,1]];function Fe(t,...e){function n(e){const n=t.charAt(e);switch(n){case"x":return 0;case"y":return 1;case"z":return 2;default:throw new Error(`Invalid coordinate name at pos ${e}: "${n}"!`)}}function i(e){const n=t.charAt(e);switch(n){case"+":return 1;case"-":return-1;default:throw new Error(`Invalid coordinate sign at pos ${e}: "${n}"!`)}}const r=[],s=i(0),o=n(1),a=i(2),h=n(3),c=i(4),u=n(5);for(const[t,n]of Ue){const i=[];i[o]=e[o]*s,i[h]=e[h]*a*t,i[u]=e[u]*c*n,r.push(...i)}return r}const Oe=[0,0,1,0,0,1,1,1,0,1,1,0],Ie=1/3,Be=.5;function De(t,e){const n=Ie*t,i=Be*e;return Oe.map(((t,e)=>e%2==0?n+Ie*t:i+Be*t))}const $e=[1,0,0],Ve=[...$e,...$e,...$e,...$e,...$e,...$e],ze=[-1,0,0],Ge=[...ze,...ze,...ze,...ze,...ze,...ze],ke=[0,1,0],We=[...ke,...ke,...ke,...ke,...ke,...ke],Xe=[0,-1,0],He=[...Xe,...Xe,...Xe,...Xe,...Xe,...Xe],je=[0,0,1],Ze=[...je,...je,...je,...je,...je,...je],Ye=[0,0,-1],Ke=[...Ye,...Ye,...Ye,...Ye,...Ye,...Ye];class Qe extends Le{constructor({sizeX:t=1,sizeY:e=1,vecX:n=[1,0,0],vecY:i=[0,0,1]}={}){const r=(r,s)=>{const o=r*t,a=s*e;return[o*n[0]+a*i[0],o*n[1]+a*i[1],o*n[2]+a*i[2]]},s=new ue({POSITION:"vec3",NORMAL:"vec3",TEXCOORD_0:"vec2"}),o=.5;s.set("POSITION",new Float32Array([...r(+o,-o),...r(-o,-o),...r(+o,+o),...r(-o,+o)])),s.set("TEXCOORD_0",new Float32Array([1,1,0,1,1,0,0,0]));const[a,h,c]=new g(n).normalize().cross(new g(i).normalize());s.set("NORMAL",new Float32Array([a,h,c,a,h,c,a,h,c,a,h,c])),super({dataset:s,drawMode:"TRIANGLE_STRIP"})}}class qe{constructor(){this.varyings={},this.uniforms={}}}class Je{constructor(t={}){var e,n;this._direction=new g,this.color=null!==(e=t.color)&&void 0!==e?e:new p(.8,.8,.8,1),this.direction=null!==(n=t.direction)&&void 0!==n?n:new g(0,0,-1)}get direction(){return this._direction}set direction(t){this._direction.from(t).normalize()}}var tn=n(7417);function en(t){return(0,tn.sH)(this,void 0,void 0,(function*(){return new Promise((e=>{const n=new Image;n.addEventListener("load",(()=>e(n))),n.addEventListener("error",(()=>{console.error("Unable to load image:",t),e(null)})),n.src=t}))}))}class nn{constructor(t,e){this.context=t,this.eventChange=new st,this._texture=null,this._width=-1,this._height=-1,this.params={magFilter:"LINEAR",minFilter:"LINEAR",wrapS:"REPEAT",wrapT:"REPEAT",wrapR:"REPEAT"};const{gl:n}=t;this.gl=n,this.name="Texture2D/"+nn.counter++,this.storage=Object.assign({width:0,height:0,internalFormat:"RGBA8",levels:1,flipY:!1,premultipliedAlpha:!1},e);const i=null==e?void 0:e.width,r=null==e?void 0:e.height;"number"==typeof i&&"number"==typeof r?this.resize(i,r):this.createTexture()}delete(){this._texture&&this.gl.deleteTexture(this._texture),this._texture=null}get width(){return this._width}get height(){return this._height}createTexture(){this.delete();const t=this.gl.createTexture();if(!t)throw new Error("Unable to create a WebGLTexture!");const{gl:e}=this;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,this.storage.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.storage.premultipliedAlpha),this._texture=t,this.setParams(this.params)}resize(t,e){if(t===this.width&&e===this.height)return;const{gl:n,storage:i}=this;this.createTexture(),this._width=t,this._height=e,i.width=t,i.height=e,this.bind(),n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,this.storage.flipY),n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.storage.premultipliedAlpha);const{internalFormat:r,levels:s}=this.storage;if(r.startsWith("COMPRESSED_")&&!n.getExtension("WEBGL_compressed_texture_etc"))throw new Error('Your browser does not support extension "WEBGL_compressed_texture_etc" on this device!');n.texStorage2D(n.TEXTURE_2D,s,n[r],t,e),this.checkError()}checkError(){const{gl:t}=this,e=t.getError();e!==t.NO_ERROR&&console.error(`[TgdTexture2D::${this.name}] Error:`,r(e))}get glTexture(){if(this._texture)return this._texture;throw new Error(`Texture "${this.name}" has been deleted!`)}bind(){this.gl.bindTexture(this.gl.TEXTURE_2D,this.glTexture)}loadBitmap(t,e={}){var n,i,r,s;if(!t)return this;if("string"==typeof t)return this.loadBitmap(en(t),e);if(!((s=t)instanceof ImageData||s instanceof HTMLImageElement||s instanceof HTMLCanvasElement||s instanceof HTMLVideoElement||s instanceof ImageBitmap))return t.then((t=>this.loadBitmap(t))).catch((t=>console.error("Unable to load texture BMP:",t))),this;const{storage:o,gl:a}=this,{level:h=0}=e;return this._width=t.width,this._height=t.height,this.bind(),a.texImage2D(a.TEXTURE_2D,h,a[o.internalFormat],a[function(t){for(const[e,n]of rn)if(n.has(t))return e;throw new Error(`There is no compatible format for internalFormat "${t}" and type "UNSIGNED_BYTE"!`)}(o.internalFormat)],a.UNSIGNED_BYTE,t),this.checkError(),e.generateMipmap&&(this.generateMipmap(),this.checkError()),null===(i=(n=this.context).paint)||void 0===i||i.call(n),null===(r=e.onLoad)||void 0===r||r.call(e),this.eventChange.dispatch(this),this}loadData(t,e){const{level:n=0,width:i,height:r,internalFormat:s="RGB",format:o="RGB"}=e,{gl:a}=this;return this.bind(),a.texImage2D(a.TEXTURE_2D,n,a[s],i,r,0,a[o],a.UNSIGNED_BYTE,t),this.checkError(),this.eventChange.dispatch(this),this}activate(t,e,n){const{gl:i}=this;return i.activeTexture(i.TEXTURE0+t),this.bind(),e&&n&&e.uniform1i(n,t),this}generateMipmap(){const{gl:t}=this;return this.bind(),t.generateMipmap(t.TEXTURE_2D),this}setParams(t){return this.bind(),function(t,{wrapS:e,wrapT:n,wrapR:i,minFilter:r,magFilter:s}){e&&t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t[e]),n&&t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t[n]),i&&t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_R,t[i]),r&&t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t[r]),s&&t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t[s])}(this.gl,t),this.params=Object.assign(Object.assign({},this.params),t),this}set textureBaseLevel(t){const{gl:e}=this;this.bind(),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_BASE_LEVEL,t)}get textureBaseLevel(){const{gl:t}=this;return this.bind(),t.getTexParameter(t.TEXTURE_2D,t.TEXTURE_BASE_LEVEL)}set textureMaxLevel(t){const{gl:e}=this;this.bind(),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAX_LEVEL,t)}get textureMaxLevel(){const{gl:t}=this;return this.bind(),t.getTexParameter(t.TEXTURE_2D,t.TEXTURE_MAX_LEVEL)}getParameter(t){const{gl:e,glTexture:n}=this;return e.bindTexture(e.TEXTURE_2D,n),e.getTexParameter(e.TEXTURE_2D,e[t])}debug(t){var e;console.log(null!==(e=null!=t?t:this.name)&&void 0!==e?e:"TgdTexture2D","  ",this.width,"",this.height);const n=["TEXTURE_MAG_FILTER","TEXTURE_MIN_FILTER","TEXTURE_WRAP_R","TEXTURE_WRAP_S","TEXTURE_WRAP_T","TEXTURE_MAX_LEVEL","TEXTURE_MAX_LOD","TEXTURE_MIN_LOD","TEXTURE_BASE_LEVEL","TEXTURE_COMPARE_FUNC","TEXTURE_COMPARE_MODE","TEXTURE_IMMUTABLE_FORMAT","TEXTURE_IMMUTABLE_LEVELS"];for(const t of n){const e=this.getParameter(t);console.log(">",t,"=",e,"number"==typeof e?`(${r(e)})`:" ")}}}nn.counter=0;const rn=[["RGB",new Set(["RGB","RGB8","RGB565","SRGB8","RGB8_SNORM","RGB565","R11F_G11F_B10F","RGB9_E5","RGB16F","R11F_G11F_B10F","RGB9_E5","RGB32F","RGB16F","R11F_G11F_B10F","RGB9_E5"])],["RGBA",new Set(["RGBA","RGBA8","RGB5_A1","RGBA4","SRGB8_ALPHA8","RGBA8_SNORM","RGBA4","RGB5_A1","RGB10_A2","RGB5_A1","RGBA16F","RGBA32F","RGBA16F"])],["RG",new Set(["RG8"])],["RED",new Set(["R8"])]];class sn{constructor(t,e){this.context=t,this._width=0,this._height=0,this.numberOfImagesToLoad=6;const{gl:n}=t,i=n.createTexture();if(!i)throw new Error("Unable to create a WebGLTexture!");this.texture=i,this.loadImage(n.TEXTURE_CUBE_MAP_POSITIVE_X,e.imagePosX),this.loadImage(n.TEXTURE_CUBE_MAP_NEGATIVE_X,e.imageNegX),this.loadImage(n.TEXTURE_CUBE_MAP_POSITIVE_Y,e.imagePosY),this.loadImage(n.TEXTURE_CUBE_MAP_NEGATIVE_Y,e.imageNegY),this.loadImage(n.TEXTURE_CUBE_MAP_POSITIVE_Z,e.imagePosZ),this.loadImage(n.TEXTURE_CUBE_MAP_NEGATIVE_Z,e.imageNegZ)}delete(){this.context.gl.deleteTexture(this.texture)}get ready(){return 0===this.numberOfImagesToLoad}get width(){return this._width}get height(){return this._height}bind(){const{gl:t}=this.context;t.bindTexture(t.TEXTURE_CUBE_MAP,this.texture)}activate(t,e,n){if(!this.ready)return;const{context:i,texture:r}=this,{gl:s}=i;s.activeTexture(s.TEXTURE0+t),s.bindTexture(s.TEXTURE_CUBE_MAP,r),e.uniform1i(n,t)}loadImage(t,e){const{width:n,height:i}=e;if(n!==i)throw new Error(`Images in a CubeMap must be squares, but we got ${n}${i}!`);if(0===this._width)this._width=n,this._height=i;else if(this._width!==n||this._height!==i)throw new Error(`Images in a CubeMap must all have the same size, but we got ${this._width}${this._height} and ${n}${i}!`);const{context:r,texture:s}=this,{gl:o}=r;o.bindTexture(o.TEXTURE_CUBE_MAP,s),o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,e instanceof Image),o.texImage2D(t,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,e),this.numberOfImagesToLoad--,0===this.numberOfImagesToLoad&&(o.generateMipmap(o.TEXTURE_CUBE_MAP),o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_MIN_FILTER,o.LINEAR_MIPMAP_LINEAR),r.paint())}}const on=new p(.8,.6,.1,1);class an extends qe{constructor(t={}){var e;super(),this.light=new Je,this.ambient=new Je({color:new p(.2,.1,0,0)}),this.specularExponent=20,this.specularIntensity=1,this.uniforms={uniLight:"vec3",uniLightDir:"vec3",uniAmbient:"vec3",uniSpecularExponent:"float",uniSpecularIntensity:"float",uniModelViewMatrix:"mat4"},this.lightColor=new g,this.ambientColor=new g;const n=t.color instanceof nn?t.color:new p(null!==(e=t.color)&&void 0!==e?e:on);t.light&&(this.light=t.light),t.ambient&&(this.ambient=t.ambient),"number"==typeof t.specularExponent&&(this.specularExponent=t.specularExponent),"number"==typeof t.specularIntensity&&(this.specularIntensity=t.specularIntensity);const i=!(n instanceof p);this.texture=i?n:null,this.fragmentShaderCode=["vec3 normal = normalize(varNormal);","float light = 1.0 - dot(normal, uniLightDir);",i?"vec4 color = texture(texDiffuse, varUV);":`vec4 color = vec4(${n.join(", ")});`,"vec3 normal2 = mat3(uniModelViewMatrix) * normal;","float spec = max(0.0, reflect(uniLightDir, normal2).z);","spec = pow(spec, uniSpecularExponent) * uniSpecularIntensity;","color = vec4(","  color.rgb * (","    uniAmbient + uniLight * light","  ) + vec3(spec),","  1.0",");","return color;"],this.vertexShaderCode=["varNormal = mat3(uniTransfoMatrix) * NORMAL;"],this.varyings={varNormal:"vec3"},i&&(this.vertexShaderCode.push("varUV = TEXCOORD_0;"),this.varyings.varUV="vec2",this.uniforms.texDiffuse="sampler2D")}setUniforms(t){t.uniform3fv("uniLightDir",this.light.direction),this.lightColor.from(this.light.color).scale(this.light.color.w),t.uniform3fv("uniLight",this.lightColor),this.ambientColor.from(this.ambient.color).scale(this.ambient.color.w),t.uniform3fv("uniAmbient",this.ambientColor),t.uniform1f("uniSpecularExponent",this.specularExponent),t.uniform1f("uniSpecularIntensity",this.specularIntensity);const{texture:e}=this;e&&e.activate(0,t,"texDiffuse")}}const hn=[0,0,0,1];class cn extends qe{constructor(t={}){var e;super(),this.uniforms={uniColor:"vec4"};const n=new p(null!==(e=t.color)&&void 0!==e?e:hn);this.fragmentShaderCode=[`return vec4(${n.join(", ")});`],this.vertexShaderCode=[],this.varyings={}}setUniforms(){}}new p(.6,1,.9,1);const un=[.111,.333,.999,1];class ln extends qe{constructor(t={}){var e,n,i;super(),this.expansion=.02,this.uniforms={uniColor:"vec4",uniExpansion:"float"},this.color=new p(null!==(e=t.color)&&void 0!==e?e:un),this.expansion=null!==(n=t.expansion)&&void 0!==n?n:.02,this.fragmentShaderCode=["return uniColor;"],this.vertexShaderCode=[],this.varyings={},this.vertexShaderCodeForGetPosition=[`return pos + uniExpansion * vec4(${null!==(i=t.attNormal)&&void 0!==i?i:"NORMAL"}, 0.0);`]}setUniforms(t){t.uniform4fv("uniColor",this.color),t.uniform1f("uniExpansion",this.expansion)}}class fn extends qe{constructor(){super(),this.fragmentShaderCode=["vec3 color = vec3(1.0) + normalize(varNormal);","color *= 0.5;","return vec4(color, 1.0);"],this.vertexShaderCode=["varNormal = NORMAL;"],this.varyings={varNormal:"vec3"}}setUniforms(t){}}const dn=[.111,.333,.999,1];class mn extends qe{constructor(t={}){var e;super(),this.uniforms={uniColor:"vec4"},this.color=new p(null!==(e=t.color)&&void 0!==e?e:dn),this.fragmentShaderCode=["return uniColor;"],this.vertexShaderCode=[],this.varyings={}}setUniforms(t){t.uniform4fv("uniColor",this.color)}}class gn extends ct{constructor(t,e={}){var n,i;super(),this.context=t,this.transfo=new et,this.drawMode=0,this.bboxMin=null,this.bboxMax=null,this.paint=(t,e)=>{const{context:n,prg:i,geometry:r,material:s,drawMode:o,count:a,transfo:h}=this,{gl:c,camera:u}=n;i.use(),s.setUniforms(i,t,e),i.uniformMatrix4fv("uniTransfoMatrix",h.matrix),i.uniformMatrix4fv("uniModelViewMatrix",u.matrixModelView),i.uniformMatrix4fv("uniProjectionMatrix",u.matrixProjection),this.vao.bind(),r.elements?c.drawElements(o,a,this.elementsType,0):c.drawArrays(o,0,a),this.vao.unbind()};const{transfo:r,material:s=new fn,geometry:o=new Ne}=e;this.transfo=new et(r),this.material=s,this.geometry=o,this.drawMode="number"==typeof o.drawMode?o.drawMode:t.gl[o.drawMode];const a=new we({uniforms:Object.assign({uniTransfoMatrix:"mat4",uniModelViewMatrix:"mat4",uniProjectionMatrix:"mat4"},s.uniforms),attributes:{[o.attPosition]:"vec4",[o.attNormal]:"vec3",[o.attUV]:"vec2"},varying:s.varyings,functions:{applyMaterial:["void applyMaterial() {",[s.vertexShaderCode],"}"],getPosition:["vec4 getPosition(vec4 pos) {",[null!==(n=s.vertexShaderCodeForGetPosition)&&void 0!==n?n:"return pos;"],"}"]},mainCode:["gl_Position = uniProjectionMatrix * uniModelViewMatrix * uniTransfoMatrix * getPosition(POSITION);","applyMaterial();"]}).code,h=new _e({uniforms:s.uniforms,outputs:{FragColor:"vec4"},varying:s.varyings,functions:{applyMaterial:["vec4 applyMaterial() {",[s.fragmentShaderCode],"}"]},mainCode:["FragColor = applyMaterial();"]}).code,c=new se(t.gl,{vert:a,frag:h});this.prg=c,this.vao=new me(t.gl,c,[o.dataset],o.elements),this.elementsType=o.elementsType,this.count=o.count,this.name=null!==(i=e.name)&&void 0!==i?i:`Mesh/${this.name}`}debug(t){this.prg.debug(null!=t?t:this.name)}computeBoundingBox(){if(this.bboxMin&&this.bboxMax)return{min:this.bboxMin,max:this.bboxMax};const{dataset:t}=this.geometry,{get:e}=t.getAttribAccessor("POSITION"),n=new g(e(0,0),e(0,1),e(0,2)),i=new g(n);for(let r=1;r<t.count;r++){const t=e(r,0),s=e(r,1),o=e(r,2);n.x=Math.min(n.x,t),i.x=Math.max(i.x,t),n.y=Math.min(n.y,s),i.y=Math.max(i.y,s),n.z=Math.min(n.z,o),i.z=Math.max(i.z,o)}return this.bboxMin=n,this.bboxMax=i,{min:n,max:i}}delete(){this.vao.delete()}}class pn extends gn{constructor(t,e){var n;const{asset:i,meshIndex:r=0,primitiveIndex:s=0,materialFactory:o=xn}=e,a=function(t,e,n,i){var r,s;const o=null!==(r=t.getMeshPrimitive(e,n).material)&&void 0!==r?r:-1;if(-1===o)return vn;const a=t.getMaterial(o),h=function(t,e,n){var i;const r=n.emissiveTexture;if(!r)return null;const s=e.createTexture2D(t,null!==(i=r.index)&&void 0!==i?i:0);return t.paint&&s.eventChange.addListener(t.paint),s}(i,t,a),c=a.pbrMetallicRoughness;if(!c)return null!=h?h:vn;if(h)return h;if(c.baseColorTexture){const e=null===(s=c.baseColorTexture)||void 0===s?void 0:s.index,n=t.createTexture2D(i,null!=e?e:0);return i.paint&&n.eventChange.addListener(i.paint),n}return c.baseColorFactor?new p(...c.baseColorFactor):vn}(i,r,s,t),h=o({color:a});let c=!1;const u={POSITION:"vec3",NORMAL:"vec3"};i.getMeshPrimitive().attributes.TEXCOORD_0&&(u.TEXCOORD_0="vec2");const l=new ue(u);i.setAttrib(l,"POSITION",r,s),i.getMeshPrimitive().attributes.NORMAL?i.setAttrib(l,"NORMAL",r,s):(console.warn("No normals found! We will apply smooth shading."),c=!0),i.getMeshPrimitive().attributes.TEXCOORD_0&&i.setAttrib(l,"TEXCOORD_0",r,s),super(t,{geometry:new Le({dataset:l,elements:i.getMeshPrimitiveIndices(r,s),drawMode:"TRIANGLES",computeNormalsIfMissing:c}),material:h}),this.name=null!==(n=e.name)&&void 0!==n?n:`Gltf/${this.name}`}}const vn=new p(.9,.5,.1,1);function xn({color:t}){return new an({color:t,specularIntensity:.3,specularExponent:80,light:new Je({color:new p(1,1,1,1),direction:new g(1,.2,0)}),ambient:new Je({color:new p(.2,.1,0,1)})})}class En extends ct{constructor(t={}){super(),this.parentMatrix=new x,this.globalMatrix=new x,this.nodes=[],this.targets=[];const{children:e=[],transfo:n,logic:i,paintTheTargets:r=!0,name:s=`TgdPainterNode/${this.name}`}=t;this.paintTheTargets=r;for(const t of e)this.add(t);this.transfo=new et(n),this.logic=null==i?void 0:i.bind(this),this.name=s}delete(){var t;for(const t of this.nodes)t.delete();for(const e of this.targets)null===(t=e.delete)||void 0===t||t.call(e)}add(...t){for(const e of t)e instanceof En?this.nodes.push(e):this.targets.push(e);return this}remove(...t){for(const e of t)if(e instanceof En){const t=this.nodes.indexOf(e);-1!==t&&this.nodes.splice(t,1)}else{const t=this.targets.indexOf(e);-1!==t&&this.targets.splice(t,1)}return this}getNodes(){return[...this.nodes]}getTargets(){return[...this.targets]}paint(t,e){var n,i,r;null===(n=this.logic)||void 0===n||n.call(this,t,e),this.parentMatrix.reset();const s=[this];for(;s.length>0;){const n=s.shift();n.globalMatrix.from(n.parentMatrix).multiply(n.transfo.matrix),null===(i=n.logic)||void 0===i||i.call(n,t,e);for(const i of n.targets)i.transfo.matrix.from(n.globalMatrix),this.paintTheTargets&&(null===(r=i.paint)||void 0===r||r.call(i,t,e));for(const t of n.nodes)t.parentMatrix.from(n.globalMatrix),s.push(t)}}debug(t="TgdPainterNode"){console.log(t),An(this)}}function An(t,e="| "){var n,i;console.log(`${e}${t.name}  [${bn(t.transfo.orientation)}] (${bn(t.transfo.position)})`);const r=t.getTargets();if(r.length>0)if(1===r.length)console.log(`${e}  Target: ${null!==(n=r[0].name)&&void 0!==n?n:"..."}`);else{console.log(`${e}  Targets (${r.length})`);for(const t of r)console.log(`${e}    ${null!==(i=t.name)&&void 0!==i?i:"..."}`)}const s=t.getNodes();if(s.length>0){console.log(`${e}  Nodes (${s.length})`);for(const t of s)An(t,`${e}  | `)}}function bn(t){return[...t].map((t=>t.toFixed(3))).join(", ")}class Tn extends ct{constructor(t,e){super(),this.context=t,this.minRadius=0,this.radiusMultiplier=1,this.radiusConstant=1,this.radiusSwitch=0,this.light=1,this.shiftZ=0,this.contrast=.3,this.specularIntensity=.4,this.specularExponent=30;const{roundness:n=3,minRadius:i=0,makeDataset:r}=e;if(this.minRadius=i,n>127)throw new Error("[TgdPainterSegments] Max roundness is 127!");if(n<0)throw new Error("[TgdPainterSegments] Min roundness is 0!");this.colorTexture=new nn(t).setParams({magFilter:"NEAREST",minFilter:"NEAREST",wrapR:"CLAMP_TO_EDGE",wrapS:"CLAMP_TO_EDGE",wrapT:"CLAMP_TO_EDGE"}).loadBitmap(function(t,e=0,n=0){const i=e>0?e:t.length,r=n>0?n:Math.ceil(t.length/i),{canvas:s,ctx:o}=Tt(i,r);let a=0;for(let e=0;e<r;e++)for(let n=0;n<i;n++)o.fillStyle=t[a%t.length],o.fillRect(n,e,1,1),a++;return s}(["#f44","#4f4","#44f"]));const s=new se(t.gl,{vert:"#version 300 es\n\nprecision highp float;\n\nuniform sampler2D uniTexture;\nuniform mat4 uniModelViewMatrix;\nuniform mat4 uniProjectionMatrix;\n// Minimal value for the radius.\nuniform float uniMinRadius;\n// Multiply all radii by this value.\nuniform float uniRadiusMultiplier;\n// When uniRadiusSwitch == 1.0,\n// we use uniRadiusConstant as radius. \nuniform float uniRadiusConstant;\n// 0.0 means we will use the radius defined\n// in the attribute attAxyzr or attBaxyz.\n// 1.0 means we use uniRadiusConstant for\n// all vertices.\nuniform float uniRadiusSwitch;\n// Multiply the color by this value;\nuniform float uniLight;\n// Push the segments away from camera of `uniShiftZ`.\n// This can be used if you want contours on the segments:\n// just increase `uniRadiusMultiplier`, set a low `uniLight`,\n// and set a small positive `uniShiftZ`.\nuniform float uniShiftZ;\n\n//===================\n// Vertex attributes\n//-------------------\n\n// Position of the vertex, relative to\n// the current center and assuming a\n// radius of 1.\n// Z tells you what tip is your center: 0 for A and 1 for B.\nin vec3 attOffset;\n// Normals of the tube that represents the segment.\nin vec3 attNormal;\n\n//=====================\n// Instance attributes\n//---------------------\n\n// Coords and radious of tip A.\nin vec4 attAxyzr;\n// Coords and radious of tip B.\nin vec4 attBxyzr;\n// The color is taken from a texture.\nin vec2 attAuv;\nin vec2 attBuv;\n// 0 means that nothing modifies the initial radius,\n// except the minRadius.\nin float attAinfluence;\nin float attBinfluence;\n\n\nout vec4 varColor;\nout vec3 varNormal;\n\n\nvec3 worldToCamera(vec3 v);\nfloat getRadius(float tip);\nmat3 getTransfoMatrix(float tip, vec3 camA, vec3 camB);\n\nvoid main() {\n    vec3 camA = worldToCamera(attAxyzr.xyz);\n    vec3 camB = worldToCamera(attBxyzr.xyz);\n    float tip = attOffset.z;\n    float radius = getRadius(tip);\n    mat3 transfo = getTransfoMatrix(tip, camA, camB);\n    vec3 point = transfo * vec3(attOffset.xy * radius, 1.0);\n    varNormal = attNormal;\n    point.z -= uniShiftZ + abs(attOffset.y) * radius;\n    gl_Position = \n        uniProjectionMatrix \n        * vec4(point, 1);\n    vec2 uv = mix(attAuv, attBuv, tip);\n    // float Z = 1.0 - abs(point.z) * 0.0001;\n    // Z = pow(Z, 0.025);\n    float light = uniLight; // * Z;\n    varColor = texture(uniTexture, uv) * vec4(vec3(light), 1.0);\n    // varColor = vec4(vec3(1.0 - Z, Z, 0.0), varColor.a);\n}\n\nfloat getRadius(float tip) {\n    float influence = mix(attAinfluence, attBinfluence, tip);\n    float originalRadius = mix(\n        attAxyzr.w,\n        attBxyzr.w,\n        tip\n    );\n    float modifiedRadius = mix(\n        originalRadius,\n        uniRadiusConstant,\n        uniRadiusSwitch\n    ) * uniRadiusMultiplier;\n    float radius = mix(\n        originalRadius,\n        modifiedRadius,\n        influence\n    );\n    return max(uniMinRadius, radius);\n}\n\nvec3 worldToCamera(vec3 v) {\n    vec4 result = uniModelViewMatrix * vec4(v, 1.0);\n    return result.xyz;\n}\n\nmat3 getTransfoMatrix(float tip, vec3 camA, vec3 camB) {\n    // What is the current tip?\n    vec3 camO = mix(camA, camB, tip);\n    vec2 A = camA.xy;\n    vec2 B = camB.xy;\n    vec3 Y = vec3(\n        A == B ? vec2(0, 1) : normalize(A - B),\n        0\n    );\n    vec3 X = vec3(Y.y, -Y.x, 0);\n    return mat3(X, Y, camO);\n}",frag:"#version 300 es\n\nprecision highp float;\n\nuniform float uniContrast;\nuniform float uniSpecularIntensity;\nuniform float uniSpecularExponent;\n\nin vec4 varColor;\nin vec3 varNormal;\n\nout vec4 FragColor;\n\n\nvoid main() {\n    if (varColor.a < 1.0) discard;\n\n    float z = normalize(varNormal).z;\n    float light = z * uniContrast + (1.0 - uniContrast);\n    float spec = pow(z, uniSpecularExponent) * uniSpecularIntensity;\n    FragColor =vec4(varColor.rgb * light + vec3(spec), varColor.w); // varColor;\n}\n"});this.prg=s;const{capsule:o,elements:a}=function(t){const e=[0,0,0,1,0,0,-1,0,0,0,0,1,1,0,1,-1,0,1],n=[0,0,1,1,0,0,-1,0,0,0,0,1,1,0,0,-1,0,0],i=[0,3,1,3,4,1,0,2,5,3,0,5];if(t>0){let r=1,s=4,o=6;const a=new g;for(let h=0;h<t;h++){const c=Math.PI*(h+1)/(t+1),u=Math.cos(c),l=Math.sin(c);e.push(u,l,0),a.from([u,0,1-Math.abs(u)]),n.push(a.x,a.y,a.z),i.push(0,r,o),r=o,o++,e.push(u,-l,1),a.from([u,0,1-Math.abs(u)]).normalize(),n.push(a.x,a.y,a.z),i.push(3,o,s),s=o,o++}i.push(0,r,2),i.push(3,5,s)}const r=new ue({attOffset:"vec3",attNormal:"vec3"});return r.set("attOffset",new Float32Array(e)),r.set("attNormal",new Float32Array(n)),{capsule:r,elements:new Uint8Array(i)}}(n),h=r();h.debug(),this.vao=new me(t.gl,s,[o,h],a),this.vertexCount=a.length,this.instanceCount=h.count}delete(){this.vao.delete()}paint(t,e){const{context:n,prg:i,vao:r,colorTexture:s,vertexCount:o,instanceCount:a,light:h,radiusMultiplier:c,radiusConstant:u,radiusSwitch:l,shiftZ:f,contrast:d,specularIntensity:m,specularExponent:g}=this,{gl:p,camera:v}=n;p.disable(p.DITHER),i.use();const x=this.minRadius*v.spaceHeightAtTarget/(v.zoom*v.screenHeight);i.uniform1f("uniMinRadius",x),i.uniform1f("uniLight",h),i.uniform1f("uniShiftZ",f),i.uniform1f("uniRadiusMultiplier",c),i.uniform1f("uniRadiusConstant",u),i.uniform1f("uniRadiusSwitch",l),i.uniform1f("uniContrast",d),i.uniform1f("uniSpecularIntensity",m),i.uniform1f("uniSpecularExponent",g),s.activate(0,i,"uniTexture"),i.uniformMatrix4fv("uniModelViewMatrix",v.matrixModelView),i.uniformMatrix4fv("uniProjectionMatrix",v.matrixProjection),r.bind(),p.drawElementsInstanced(p.TRIANGLES,o,p.UNSIGNED_BYTE,0,a)}}class yn{constructor(){this._count=0,this.attAxyzr=[],this.attAuv=[],this.attAinfluence=[],this.attBxyzr=[],this.attBuv=[],this.attBinfluence=[],this.makeDataset=()=>{const t=new ue({attAxyzr:"vec4",attAuv:"vec2",attAinfluence:"float",attBxyzr:"vec4",attBuv:"vec2",attBinfluence:"float"},{divisor:1});return t.set("attAxyzr",new Float32Array(this.attAxyzr)),t.set("attAuv",new Float32Array(this.attAuv)),t.set("attAinfluence",new Float32Array(this.attAinfluence)),t.set("attBxyzr",new Float32Array(this.attBxyzr)),t.set("attBuv",new Float32Array(this.attBuv)),t.set("attBinfluence",new Float32Array(this.attBinfluence)),t}}get count(){return this._count}add(t,e,n=[0,0],i=[0,0],r=1,s=1){this.attAxyzr.push(...t),this.attAuv.push(...n),this.attAinfluence.push(r),this.attBxyzr.push(...e),this.attBuv.push(...i),this.attBinfluence.push(s),this._count++}}class wn extends ct{constructor(t,e){var n;super(),this.context=t,this.z=1,this.matrix=new x,this.tmpMat=new x,this.z=null!==(n=e.z)&&void 0!==n?n:1,this.transfo=new et(e.transfo),this.camera=e.camera,this.texture=new sn(t,e),this.program=new se(t.gl,{vert:"#version 300 es\n\nuniform float uniZoom;\nuniform float uniZ;\n\nin vec4 attPoint;\n\nout vec4 varPoint;\n\nvoid main() {\n    varPoint =  attPoint;\n    gl_Position = vec4(attPoint.xy, uniZ, 1.0);\n}",frag:"#version 300 es\n\nprecision highp float;\n\nuniform mat4 uniMatrix;\nuniform samplerCube uniTexture;\n\nin vec4 varPoint;\n\nout vec4 FragColor;\n\nvoid main() {\n    vec4 t = uniMatrix * varPoint;\n    FragColor = texture(uniTexture, normalize(t.xyz));\n}"});const i=new ue({attPoint:"vec2"});i.set("attPoint",new Float32Array([-1,1,1,1,-1,-1,1,-1])),this.vao=new me(t.gl,this.program,[i])}delete(){const{vao:t}=this;t.delete()}paint(){const{context:t,vao:e,program:n,texture:i,z:r}=this,{gl:s}=t,{camera:o,matrix:a,tmpMat:h}=this;!function(t,e,n){const i=kt(t);Gt(t,e);try{n()}finally{Gt(t,i)}}(s,zt.off,(()=>{o.screenWidth=t.width,o.screenHeight=t.height,a.from(o.matrixProjection),h.fromMat3(this.transfo.matrix).multiply(o.matrixModelView),h.m03=0,h.m13=0,h.m23=0,a.multiply(h).invert(),n.use(),n.uniformMatrix4fv("uniMatrix",a),n.uniform1f("uniZ",r),i.activate(0,n,"uniTexture"),e.bind(),s.drawArrays(s.TRIANGLE_STRIP,0,4),e.unbind()}))}}class _n extends ct{constructor(t){super(),this.context=t,this.texture=new nn(t).loadBitmap(function(){const t=256,{canvas:e,ctx:n}=Tt(768,512);return Rn(n,0,0,t,"X","#f00","#fff"),Rn(n,1,0,t,"Y","#0f0","#000"),Rn(n,2,0,t,"Z","#00f","#fff"),Rn(n,0,1,t,"","#f00","#500"),Rn(n,1,1,t,"","#0f0","#050"),Rn(n,2,1,t,"","#00f","#005"),e}()).setParams({minFilter:"LINEAR",magFilter:"LINEAR"}).generateMipmap();const e=new ue({attPos:"vec3",attUV:"vec2"});e.set("attPos",new Float32Array([1,0,0,0,1,0,0,0,1,-1,0,0,0,-1,0,0,0,-1]));const n=1/3;e.set("attUV",new Float32Array([0,0,n,0,2*n,0,0,.5,n,.5,2*n,.5]));const i=new se(t.gl,{vert:"#version 300 es\n\nprecision highp float;\n\nuniform mat4 uniModelViewMatrix;\nuniform mat4 uniProjectionMatrix;\nuniform float uniScreenHeight;\n\n/**\n * Position of the tip.\n */\nin vec4 attPos;\nin vec2 attUV;\n\nout vec2 varUV;\n\nvoid main() {\n    varUV = attUV;\n    vec4 point = uniModelViewMatrix * attPos;\n    gl_Position = uniProjectionMatrix * point;\n    point.y += 0.3;\n    point = uniProjectionMatrix * point;\n    gl_PointSize = uniScreenHeight * abs(gl_Position.y / gl_Position.w - point.y / point.w);\n}\n",frag:"#version 300 es\n\nprecision highp float;\n\nuniform sampler2D uniTexture;\n\nin vec2 varUV;\nout vec4 FragColor;\n\n\nvoid main() {\n    vec2 uv = varUV + gl_PointCoord * vec2(0.333333333, 0.5);\n    FragColor = texture(uniTexture, uv);\n    if (FragColor.w < 1.0) {\n        discard;\n    }\n}\n"}),r=new me(t.gl,i,[e]);this.prg=i,this.vao=r}delete(){this.vao.delete()}paint(){const{context:t,prg:e,vao:n}=this,{gl:i,camera:r}=t;e.use(),this.texture.activate(0),e.uniform1i("uniTexture",0),e.uniform1f("uniScreenHeight",t.height),e.uniformMatrix4fv("uniModelViewMatrix",r.matrixModelView),e.uniformMatrix4fv("uniProjectionMatrix",r.matrixProjection),n.bind(),i.drawArrays(i.POINTS,0,6)}}function Rn(t,e,n,i,r,s,o="#fff"){const a=(e+.5)*i,h=(n+.5)*i,c=.45*i;t.fillStyle=s,t.beginPath(),t.ellipse(a,h,c,c,0,0,2*Math.PI),t.fill(),r?(t.font=`bold ${.5*i}px sans-serif`,t.fillStyle=o,t.textAlign="center",t.textBaseline="middle",t.fillText(r,a,h)):(t.fillStyle=o,t.beginPath(),t.ellipse(a,h,.8*c,.8*c,0,0,2*Math.PI),t.fill())}class Mn{constructor(t={}){this.options=t,this.eventTipClick=new st,this._canvas=null,this.context=null,this.contextExternal=null,this.cameraInternal=new rt({fovy:Math.PI/3,near:.01,far:10,transfo:{distance:2.7}}),this.orbiter=null,this.tipsPainter=null,this.handleExternalPaint=()=>{var t;null===(t=this.context)||void 0===t||t.paint()},this.handleInternalToExternal=t=>{const{contextExternal:e}=this;(null==e?void 0:e.camera)&&(e.camera.transfo.orientation=t.transfo.orientation,e.paint())},this.handleTap=t=>{var e;const n=null===(e=this.context)||void 0===e?void 0:e.camera;if(!n)return;const{origin:i,direction:r}=n.castRay(t.x,t.y);let s=1,o=Pn[0];for(const t of Pn){const e=t.distanceToLineSquared(i,r);e<s&&(s=e,o=t)}if(s<1){const t=new g,e=new g,i=o;t.from(this.findAxisX()),t.isClose(i)?(e.from(this.findAxisY()),t.from(e).cross(i)):e.from(i).cross(t);const r=(new Q).fromAxes(t,e,i);r.isEqual(n.transfo.orientation)&&r.rotateAroundY(Math.PI),this.eventTipClick.dispatch({from:n.transfo.orientation,to:r})}},t.canvas&&(this.canvas=t.canvas)}attachContext(t){this.detach(),this.contextExternal=t,this.attach()}detach(){this.contextExternal&&(this.contextExternal.eventPaint.removeListener(this.handleExternalPaint),this.contextExternal=null)}attach(){var t,e;null===(t=this.contextExternal)||void 0===t||t.eventPaint.addListener(this.handleExternalPaint),null===(e=this.context)||void 0===e||e.paint()}get canvas(){return this._canvas}set canvas(t){var e;if(t===this._canvas)return;if(this._canvas=t,this.context){this.context.inputs.pointer.eventTap.removeListener(this.handleTap),this.context.destroy(),this.context=null;const{orbiter:t}=this;t&&(t.detach(),t.eventChange.removeListener(this.handleInternalToExternal))}if(null===(e=this.tipsPainter)||void 0===e||e.delete(),!t)return;const n=new Qt(t,Object.assign({alpha:!0,depth:!0,antialias:!0,name:"GizmoCanvas"},this.options));n.inputs.pointer.eventTap.addListener(this.handleTap),this.context=n,n.camera=this.cameraInternal,this.orbiter=new qt(n,{speedPanning:0,speedZoom:0}),this.orbiter.eventChange.addListener(this.handleInternalToExternal);const i=new _n(n);this.tipsPainter=i,n.add(new Se((()=>{var t,e;const n=null===(t=this.contextExternal)||void 0===t?void 0:t.camera.transfo;if(!n)return;const i=null===(e=this.context)||void 0===e?void 0:e.camera.transfo;i&&(i.orientation=n.orientation)})),new Ee(n,{color:[0,0,0,0],depth:1}),new ye(n,{enabled:!0}),i),n.paint()}findAxisX(){let t=0,e=Pn[0];const n=new g,i=new I;i.fromQuat(this.cameraInternal.transfo.orientation).transpose();for(const r of Pn)n.from(r).applyMatrix(i),n.x>t&&(t=n.x,e=r);return e}findAxisY(){let t=0,e=Pn[0];const n=new g,i=new I;i.fromQuat(this.cameraInternal.transfo.orientation).transpose();for(const r of Pn)n.from(r).applyMatrix(i),n.y>t&&(t=n.y,e=r);return e}}const Pn=[new g(1,0,0),new g(0,1,0),new g(0,0,1),new g(-1,0,0),new g(0,-1,0),new g(0,0,-1)];function Cn({name:t="shiftHue"}={}){return{[t]:`vec3 ${t}(vec3 color, float hue) {\n    const vec3 k = vec3(0.5773502691896258);\n    float cosAngle = cos(hue);\n    return vec3(\n        color * cosAngle \n        + cross(k, color) * sin(hue) \n        + k * dot(k, color) * (1.0 - cosAngle)\n    );\n}\n`}}function Sn({name:t="luminance"}={}){return{[t]:`float ${t}(vec3 color) {\n    return 0.2126 * color.r + 0.7152 * color.g + 0.0722 * color.b;\n}`}}const Ln={E:Math.E,PI:Math.PI,TAU:2*Math.PI,PI_INVERSE:1/Math.PI,TAU_INVERSE:.5/Math.PI,DEG_PER_RAD:180/Math.PI,RAD_PER_DEG:Math.PI/180};function Nn(...t){const e={};for(const n of t)e[n]=`const float ${n} = ${Ln[n]};`;return e}function Un(t={}){const{name:e="uv2xy",uniAspectRatio:n="uniAspectRatio"}=t;return{[e]:`vec2 ${e}(vec2 uv) {\n    return 2.0 * (uv - vec2(0.5)) * vec2(${n}, 1.0);\n}\n`}}function Fn(t={}){const{name:e="xy2uv",uniAspectRatioInverse:n="uniAspectRatioInverse"}=t;return{[e]:`vec2 ${e}(vec2 xy) {\n    return (0.5 * xy * vec2(${n}, 1.0)) + vec2(0.5);\n}\n`}}function On(t={}){const{name:e="xy2polar"}=t;return{[e]:`vec2 ${e}(vec2 xy) {\n    return vec2(\n        length(xy),\n        atan(xy.y, xy.x)\n    );\n}\n`}}function In(t={}){const{name:e="polar2uv"}=t;return{[e]:`vec2 ${e}(vec2 polar) {\n    float r = polar.x;\n    float a = polar.y;\n    return vec2(\n        r * cos(a),\n        r * sin(a)\n    );\n}\n`}}function Bn(t={}){const{name:e="polar2uv",uniAspectRatioInverse:n="uniAspectRatioInverse"}=t;return{[e]:`vec2 ${e}(vec2 polar) {\n    float r = polar.x;\n    float a = polar.y;\n    vec2 xy = vec2(\n        r * cos(a),\n        r * sin(a)\n    );\n    return (0.5 * xy * vec2(${n}, 1.0)) + vec2(0.5);\n}\n`}}function Dn(t={}){const{name:e="uv2polar",uniAspectRatio:n="uniAspectRatio"}=t;return{[e]:`vec2 ${e}(vec2 uv) {\n    vec2 xy = 2.0 * (uv - vec2(0.5)) * vec2(${n}, 1.0);\n    return vec2(\n        length(xy),\n        atan(xy.y, xy.x)\n    );\n}\n`}}function $n(t={}){const{name:e="random"}=t;return{[e]:`float ${e}(vec2 seed){\n   return fract(sin(dot(seed, vec2(12.9898, 78.233))) * 43758.5453);\n}\n`}}function Vn(t){const{data:e,node:n=0}=t,i=function(t,e){return _t(e)?t.getNode(e):wt(e)?t.getNodeByNameOrThrow(e):e}(e,n);return{painter:zn(i,t)}}function zn(t,e){const n={};t.translation&&(n.position=t.translation),t.rotation&&(n.orientation=t.rotation),t.scale&&(n.scale=t.scale);const{data:i}=e,r=function(t,e){var n,i;if(!_t(t))return[];const{data:r,context:s,overrideMaterial:o,excludeByMaterialName:a,includeOnlyMaterialNames:h}=e,c=r.getMesh(t),u=[];for(let e=0;e<c.primitives.length;e++){const l=r.getMeshPrimitive(t,e),f=_t(l.material)?r.getMaterial(l.material):null,d=null!==(n=null==f?void 0:f.name)&&void 0!==n?n:`#${l.material}`;if(a&&a.includes(d))continue;if(h&&!h.includes(d))continue;const m=null==o?void 0:o({data:r,mesh:c,primitive:l}),g=new pn(s,{name:`${c.name}/${null!==(i=null==f?void 0:f.name)&&void 0!==i?i:""}`,asset:r,meshIndex:t,primitiveIndex:e,materialFactory:m});u.push(g)}return u}(t.mesh,e);if(t.children)for(const n of t.children)r.push(zn(i.getNode(n),e));return new En({name:`TgdPainterNode::${t.name}`,transfo:n,children:r})}class Gn{constructor(t={}){this.uniforms={},this.fragmentShaderCode=["vec4 color = texture(uniTexture, varUV);","return color;"],this.extraFunctions={},this.setUniforms=t=>{};const{uniforms:e,fragmentShaderCode:n,extraFunctions:i,setUniforms:r}=t;e&&(this.uniforms=e),n&&(this.fragmentShaderCode=n),i&&(this.extraFunctions=i),r&&(this.setUniforms=r)}delete(){}}const kn=new nt(1,0);class Wn extends Gn{constructor(t={}){const{size:e=4,strength:n=1}=t,i=function(t){if(void 0===t)return kn;if("number"==typeof t){const e=f(t);return new nt(Math.cos(e),Math.sin(e))}return t}(t.direction),r=i.size,s=r>0?1/r:1,o=i.x*s,a=i.y*s,h=["vec2 s;","float f;"];let c=0;for(let t=0;t<e-1;t+=2){const n=e-t;c+=n,h.push(`s = ${t+1.4} * dir;`,`f = ${n.toFixed(1)};`,"color += f * texture(uniTexture, varUV + s);","color += f * texture(uniTexture, varUV - s);")}1&e&&(h.push(`s = ${e} * dir;`,"color += texture(uniTexture, varUV + s);","color += texture(uniTexture, varUV - s);"),c++),c=c+c+e+1,super({fragmentShaderCode:["vec2 dir = uniStrength * vec2(",[`uniInverseWidth * ${o.toFixed(9)},`,`uniInverseHeight * ${a.toFixed(9)}`],");",`vec4 color = ${(e+1).toFixed(1)} * texture(uniTexture, varUV);`,...h,`FragColor = color * ${(1/c).toFixed(9)};`],uniforms:{uniStrength:"float",uniInverseWidth:"float",uniInverseHeight:"float"},setUniforms:({program:t})=>{t.uniform1f("uniInverseWidth",1/t.gl.drawingBufferWidth),t.uniform1f("uniInverseHeight",1/t.gl.drawingBufferHeight),t.uniform1f("uniStrength",this.strength)}}),this.strength=n}}class Xn extends Gn{constructor(t={}){const{strength:e=1}=t;super({fragmentShaderCode:["vec2 dir = (varUV - vec2(0.5)) * 0.01 * uniStrength;","float r = texture(uniTexture, varUV + dir).r;","float g = texture(uniTexture, varUV).g;","float b = texture(uniTexture, varUV - dir).b;","FragColor = vec4(r, g, b, 1);"],uniforms:{uniStrength:"float"},setUniforms:({program:t})=>{t.uniform1f("uniStrength",this.strength),t.uniform1f("uniInverseHeight",1/t.gl.drawingBufferHeight)}}),this.strength=1,this.strength=e}}class Hn extends Gn{constructor({hueShiftInDegrees:t=0}={}){super({fragmentShaderCode:["vec4 color = texture(uniTexture, varUV);","vec3 rgb = color.rgb;","const vec3 k = vec3(0.5773502691896258);","float cosAngle = cos(uniHueShift);","FragColor = vec4(",["rgb * cosAngle ","+ cross(k, rgb) * sin(uniHueShift) ","+ k * dot(k, rgb) * (1.0 - cosAngle),","color.a"],");"],uniforms:{uniHueShift:"float"}}),this.hueShift=0,this.setUniforms=({program:t})=>{t.uniform1f("uniHueShift",this.hueShift)},this.hueShiftInDegrees=t}get hueShiftInRadians(){return this.hueShift}set hueShiftInRadians(t){this.hueShift=t}get hueShiftInDegrees(){return 180*this.hueShift/Math.PI}set hueShiftInDegrees(t){this.hueShift=t*Math.PI/180}}class jn extends Gn{constructor(){super({fragmentShaderCode:["vec2 uv = varUV;","vec4 color = texture(uniTexture, uv);","FragColor = color;"],uniforms:{uniZoom:"float",uniTranslation:"vec2"}})}}class Zn extends Gn{constructor({zoom:t=1}={}){super({fragmentShaderCode:["vec2 uv = (varUV - vec2(0.5) - uniTranslation) * uniZoom + vec2(0.5);","vec4 color = texture(uniTexture, uv);","FragColor = color;"],uniforms:{uniZoom:"float",uniTranslation:"vec2"}}),this.zoom=1,this.setUniforms=({program:t})=>{t.uniform1f("uniZoom",1/this.zoom),t.uniform2f("uniTranslation",this.translation.x,this.translation.y)},this.zoom=t,this.translation=new nt}}class Yn{constructor(t){this.chunkDetails=[],this.cacheImages=new Map,this.cacheImageURLs=new Map,this.cacheBufferViewDatas=new Map;try{const e=function(t){const e=new DataView(t);if(1179937895!==e.getUint32(0,!0))throw new Error("Invalid magic number for GLB file!");const n=e.getUint32(4,!0);if(2!==n)throw new Error(`We support only version 2, but this file is in version ${n}!`);const i=e.getUint32(8,!0);let r={};const s=[],o=[];let a=12;for(;a<i;){const n=e.getUint32(a,!0);a+=4;const i=e.getUint32(a,!0);a+=4;const h=t.slice(a,a+n);if(a+=n,1313821514===i){const t=(new TextDecoder).decode(h);try{const e=JSON.parse(t);Pt(e),r=e,o.push({type:"JSON",size:h.byteLength})}catch(e){throw console.error("Unable to parse this JSON file:",t),console.error(e),new Error("Invalid JSON data in the chunk!")}}else{if(5130562!==i)throw new Error(`We got an invalid chunk type: 0x${i.toString(16).padStart(8,"0")}!`);s.push(h),o.push({type:"BIN",size:h.byteLength})}}return{gltf:r,chunks:s,chunkTypes:o}}(t);this.gltf=e.gltf,this.chunks=e.chunks,this.chunkDetails=e.chunkTypes}catch(t){const e=t instanceof Error?t.message:JSON.stringify(t);throw new Error(`[TgdParserGLTransfertFormatBinary] ${e}`)}}createTransfoFromNode(t){const e={};return t.rotation&&(console.log(" [gltf] node.rotation =",t.rotation),e.orientation=new Q(t.rotation)),t.translation&&(e.position=new g(t.translation)),t.scale&&(e.scale=new g(t.scale)),new et(e)}createCameraByName(t){const e=this.getNodeByNameOrThrow(t);if("number"==typeof e.camera){const n=this.getCamera(e.camera);if("perspective"===n.type)return new rt({name:t,near:n.perspective.znear,far:n.perspective.zfar,fovy:n.perspective.yfov,transfo:this.createTransfoFromNode(e)});throw new Error("Sorry, but for now, we do not support Orthographic cameras...")}throw console.error(e),new Error(`Node "${t}" is not of type Camera!`)}getCamera(t){var e;const n=null===(e=this.gltf.cameras)||void 0===e?void 0:e[t];if(!n)throw new Error(`Asset has no camera with index #${t}!`);return n}getChunkDetails(){return structuredClone(this.chunkDetails)}get fileSize(){return 12+this.chunks.reduce(((t,e)=>t+e.byteLength),0)}getScenes(){var t;return null!==(t=this.gltf.scenes)&&void 0!==t?t:[]}getScene(t){var e;const n=null===(e=this.gltf.scenes)||void 0===e?void 0:e[t];if(!n)throw new Error(`Asset has no scene with index #${t}!`);return n}getNode(t){var e;const n=null===(e=this.gltf.nodes)||void 0===e?void 0:e[t];if(!n)throw new Error(`Asset has no node with index #${t}!`);return n}getNodeByName(t){const e=this.gltf.nodes;if(e)for(const n of e)if(n.name===t)return n}getNodeByNameOrThrow(t){var e;const n=this.getNodeByName(t);if(n)return n;throw new Error(`Unknown node "${t}"!\nAvailable names:${(null!==(e=this.gltf.nodes)&&void 0!==e?e:[]).map(((t,e)=>`\n  - ${"string"==typeof t.name?JSON.stringify(t.name):`#${e}`}`)).join("")}`)}getAccessor(t=0){var e;const n=null===(e=this.gltf.accessors)||void 0===e?void 0:e[t];if(!n)throw new Error(`Asset has no accessor with index #${t}!`);return n}getMaterial(t){var e;const n=null===(e=this.gltf.materials)||void 0===e?void 0:e[t];if(!n)throw new Error(`Asset has no material with index #${t}!`);return n}getMesh(t=0){var e;const n=null===(e=this.gltf.meshes)||void 0===e?void 0:e[t];if(!n)throw new Error(`Asset has no mesh with index #${t}!`);return n}getMeshPrimitive(t=0,e=0){const n=this.getMesh(t).primitives[e];if(!n)throw new Error(`Asset has no primitive #${e} in mesh #${t}!`);return n}getMeshPrimitiveIndices(t=0,e=0){var n,i;const r=this.getMeshPrimitive(t,e),s=this.getAccessor(null!==(n=r.indices)&&void 0!==n?n:0),o=this.getBufferViewData(null!==(i=s.bufferView)&&void 0!==i?i:0,s.componentType);return function(t){if(!(t instanceof Uint8Array||t instanceof Uint16Array||t instanceof Uint32Array))throw new Error("Only Uint8Array, Uint16Array or Uint32Array are allowed for elements!")}(o),o}getAccessorByAttributeName(t,e){const{attributes:n}=t;if(!n||0===Object.keys(n).length)throw new Error("No attributes found!");const i=n[e];if("number"!=typeof i)throw new TypeError(`No attribute with name "${e}"!\nAvailable names are: ${Object.keys(n).map((t=>JSON.stringify(t))).join(", ")}.`);try{return this.getAccessor(i)}catch(t){const n=t instanceof Error?t.message:JSON.stringify(t);throw new Error(`Attribute "${e}" pointed to an inexisting accessor!\n${n}`)}}createTexture2D(t,e){var n,i,r,s,o;const a=null===(n=this.gltf.textures)||void 0===n?void 0:n[e];if(!a)throw new Error(`Asset has no texture with index #${e}!`);const h=null!==(o=null!==(i=a.source)&&void 0!==i?i:null===(s=null===(r=a.extensions)||void 0===r?void 0:r.EXT_texture_webp)||void 0===s?void 0:s.source)&&void 0!==o?o:0,c=this.getImageURL(h),u=new nn(t);return c?function(t){return new Promise((e=>{const n=new Image;n.src=t,n.addEventListener("load",(()=>e(n))),n.addEventListener("error",(()=>e(null)))}))}(c).then((t=>{t?u.loadBitmap(t):console.error("Unable to load this file:",c)})).catch(console.error):console.error(`[GLTF] texture index #${e} is empty!`),u}loadImage(t){return(0,tn.sH)(this,void 0,void 0,(function*(){const e=this.cacheImages.get(t);if(e)return e;const n=this.getImageURL(t);if(!n)return;const i=new Promise(((e,i)=>{const r=new Image;r.src=n,r.addEventListener("load",(()=>{e(r)})),r.addEventListener("error",(()=>{var e;console.error(`Unable to load image #${t}!`,null===(e=this.gltf.images)||void 0===e?void 0:e[t]),i()}))}));return this.cacheImages.set(t,i),i}))}getImageURL(t){var e;const n=this.cacheImageURLs.get(t);if(n)return n;const{gltf:i}=this,r=null===(e=i.images)||void 0===e?void 0:e[t];if(!r)return;if(r.uri)return r.uri;if("number"!=typeof r.bufferView)return;const s=this.getBufferViewData(r.bufferView,"Uint8");if(!s)return;const o=new Blob([s],{type:r.mimeType}),a=URL.createObjectURL(o);return this.cacheImageURLs.set(t,a),a}getBufferViewData(t,e="Float32"){var n,i,r,s,o;if("number"!=typeof t)return this.getBufferViewData(null!==(n=t.bufferView)&&void 0!==n?n:0,t.componentType);const a=t,h=this.cacheBufferViewDatas.get(a);if(h)return h;const{gltf:c}=this,u=null===(i=c.bufferViews)||void 0===i?void 0:i[a];if(!u)throw new Error(`No bufferView with index #${a}!`);const l=this.chunks[u.buffer],f=null!==(r=u.byteOffset)&&void 0!==r?r:0,d=function(t,e){switch(e){case 5120:return new Int8Array(t);case 5121:return new Uint8Array(t);case 5122:return new Int16Array(t);case 5123:return new Uint16Array(t);case 5125:return new Uint32Array(t);default:return new Float32Array(t)}}(l.slice(f,f+u.byteLength),function(t){if("number"==typeof t)return t;switch(t){case"Int8":return 5120;case"Uint8":return 5121;case"Int16":return 5122;case"Uint16":return 5123;case"Uint32":return 5125;default:return WebGL2RenderingContext.FLOAT}throw new Error("Function not implemented.")}(null!==(o=null!=e?e:null===(s=this.findAccessorForBufferView(a))||void 0===s?void 0:s.componentType)&&void 0!==o?o:"Float32"));return this.cacheBufferViewDatas.set(a,d),d}findAccessorForBufferView(t){var e;return(null!==(e=this.gltf.accessors)&&void 0!==e?e:[]).find((e=>e.bufferView===t))}setAttrib(t,e,n=0,i=0,r){var s,o,a,h,c;const{gltf:u}=this,l=null!==(o=null===(s=u.meshes)||void 0===s?void 0:s[n].primitives[i].attributes[null!=r?r:e])&&void 0!==o?o:-1,f=null===(a=u.accessors)||void 0===a?void 0:a[l];if(!f)throw new Error(`No attribute "${null!=r?r:e}" for primitive #${i} of mesh #${n}!`);const d=null!==(h=f.bufferView)&&void 0!==h?h:0,m=null===(c=u.bufferViews)||void 0===c?void 0:c[d];if(!m)throw new Error(`No bufferView with index #${d}!`);const g=this.getBufferViewData(d,f.componentType);t.set(e,g,{byteStride:m.byteStride,byteOffset:f.byteOffset,count:f.count})}makeGeometry({computeNormals:t,meshIndex:e=0,primitiveIndex:n=0,attPositionName:i="POSITION",attNormalName:r="NORMAL",attTextureCoordsName:s="TEXCOORD_0"}={}){const o=this.getMeshPrimitive(e,n);try{const{attributes:a}=o;if(!a)throw new Error("No attributes found!");const h=this.getMeshPrimitiveIndices(e,n),c={[i]:"vec3"};"string"==typeof a[r]&&(c[r]="vec3"),"string"==typeof a[s]&&(c[s]="vec2");const u=new ue(c);return u.set(i,Kn(this.getBufferViewData(this.getAccessorByAttributeName(o,i)))),"string"==typeof a[r]&&u.set(r,Kn(this.getBufferViewData(this.getAccessorByAttributeName(o,r)))),"string"==typeof a[s]&&u.set(s,Kn(this.getBufferViewData(this.getAccessorByAttributeName(o,s)))),new Le({computeNormalsIfMissing:t,dataset:u,elements:h,attPosition:i,attNormal:r,attUV:s})}catch(t){const i=t instanceof Error?t.message:JSON.stringify(t);throw new Error(`Error in primitive #${n} of mesh #${e}:\n${i}`)}}}function Kn(t){if(t instanceof Float32Array)return t;throw new Error("We were expecting a Float32Array!")}class Qn{constructor(t){this.name="Mesh",this.attPosition=[],this.attNormal=[],this.attUV=[],this.elements=[],this.elementIndex=0,this.mapVertices=new Map,this.points=[],this.normals=[],this.verticesPerTriangle=[],this.normalPerTriangle=[],this.trianglesPerVertex=[],this.uvs=[],this.onObject=t=>{this.name=t},this.onVertex=(t,e,n)=>{this.points.push([t,e,n])},this.onNormal=(t,e,n)=>{this.normals.push([t,e,n])},this.onTexture=(t,e)=>{this.uvs.push([t,e])},this.onFace=t=>{var e,n;if(3!==t.length)throw new Error("We can only deal with triangles!");const i=t.map((t=>this.getElem(t)));this.elements.push(...i),this.normalPerTriangle.push(new g(0,0,0)),this.verticesPerTriangle.push(i);const r=this.normalPerTriangle.length-1;for(const t of i)null!==(e=(n=this.trianglesPerVertex)[t])&&void 0!==e||(n[t]=[]),this.trianglesPerVertex[t].push(r)},this.getElem=t=>{var e;const n=this.key(t),i=null!==(e=this.mapVertices.get(n))&&void 0!==e?e:-1;if(i>-1)return i;const[r,s,o]=this.points[t.vertex];if(this.attPosition.push(r,s,o),"number"==typeof t.normal){const[e,n,i]=this.normals[t.normal];this.attNormal.push(e,n,i)}if("number"==typeof t.uv){const[e,n]=this.uvs[t.uv];this.attUV.push(e,n)}return this.mapVertices.set(n,this.elementIndex),this.elementIndex++},this.reset();const{onVertex:e,onNormal:n,onTexture:i,onFace:r,onObject:s}=this;!function(t,e={}){const{onVertex:n,onNormal:i,onTexture:r,onFace:s,onObject:o}=e;for(const e of function*(t){const e=t.length;let n=0,i=0;for(;n>-1&&n<e&&(n=t.indexOf("\n",i),!(n<0));)yield t.slice(i,n).trim(),i=n+1;return t.slice(i).trim()}(t)){const t=e.trimStart();if(n&&t.startsWith("v ")){const e=t.slice(2).split(" ").map(Number);qn(e)&&n(...e)}else if(s&&t.startsWith("f "))s(t.slice(2).split(" ").map((t=>{const[e,n,i]=t.split("/");return{vertex:Number(e)-1,normal:i?Number(i)-1:void 0,uv:n?Number(n)-1:void 0}})));else if(i&&t.startsWith("vn ")){const e=t.slice(3).split(" ").map(Number);qn(e)&&i(...e)}else if(r&&t.startsWith("vt ")){const[e,n,i]=t.slice(3).split(" ").map(Number);r(e,n,i)}else o&&t.startsWith("o ")&&o(t.slice(2))}}(t,{onVertex:e,onNormal:n,onTexture:i,onFace:r,onObject:s})}makeGeometry({computeNormals:t}={}){const e={attPosition:{name:"POSITION",data:new Float32Array(this.attPosition)},computeNormalsIfMissing:t};this.attNormal.length>0&&(e.attNormal={name:"NORMAL",data:new Float32Array(this.attNormal)}),this.attUV.length>0&&(e.attUV={name:"TEXTCOORDS_0",data:new Float32Array(this.attUV)});const{elements:n,elementIndex:i}=this;return e.elements=i<=256?new Uint8Array(n):i<=65536?new Uint16Array(n):new Uint32Array(n),Le.make(e)}computeNormals(){const t=new g,e=new g,n=new g;for(const[i,r]of this.normalPerTriangle.entries()){const[s,o,a]=this.verticesPerTriangle[i];this.readVertexInto(s,t),this.readVertexInto(o,e).subtract(t),this.readVertexInto(a,n).subtract(t),r.from(e.cross(n).normalize())}this.attNormal=[];for(let t=0;t<this.elementIndex;t++){const e=new g(0,0,0);for(const n of this.trianglesPerVertex[t])e.add(this.normalPerTriangle[n]);const[n,i,r]=e.normalize();this.attNormal.push(n,i,r)}}reset(){this.name="Mesh",this.attPosition=[],this.attNormal=[],this.attUV=[],this.elements=[],this.elementIndex=0,this.points=[],this.normals=[],this.verticesPerTriangle=[],this.trianglesPerVertex=[],this.normalPerTriangle=[],this.uvs=[],this.mapVertices.clear(),this.mapVertices.clear()}key(t){return`${t.vertex}/${t.normal}`}readVertexInto(t,e){const n=this.attPosition,i=3*t;return e.reset(n[i+0],n[i+1],n[i+2]),e}}function qn(t){return 3===t.length}function Jn(t){return(0,tn.sH)(this,void 0,void 0,(function*(){try{if(t instanceof File){const e=yield t.arrayBuffer();return new Yn(e)}const e=yield fetch(t);if(!e.ok)throw new Error(`Unable to load GLB from url "${t}"!\nError #${e.status}: ${e.statusText}`);const n=yield e.arrayBuffer();return new Yn(n)}catch(t){return console.error(t),null}}))}function ti(t){return(0,tn.sH)(this,void 0,void 0,(function*(){if(t instanceof File)return yield t.arrayBuffer();try{const e=yield fetch(t);return yield e.arrayBuffer()}catch(t){return console.error(t),null}}))}function ei(t){return(0,tn.sH)(this,void 0,void 0,(function*(){if(t instanceof File)return yield t.text();try{const e=yield fetch(t);return yield e.text()}catch(t){return console.error(t),null}}))}class ni{static computeByteLength(t,e,n,i){let r=t*n*i;for(;3&r;)r++;return e*r}constructor(t,e,n,i,r){this.buffer=t,this.cols=e,this.rows=n,this.dimensions=i,this.bytesPerElement=r;const s=ni.computeByteLength(e,n,i,r);if(t.byteLength<s)throw new Error(`Your data is ${t.byteLength} bytes long.\nBut for a ${e}x${n} table we need at least ${s} bytes!\nPlease use TgdTable.computeByteLength() to get the correct length (with all needed paddings).`);const o=i*r;this.bytesPerVector=o;let a=e*o,h=0;for(;3&a;)h++,a++;this.bytePadding=h,this.bytesPerRow=a,this.bytesPerElement=r,this.view=new DataView(t)}offset(t,e,n=0){return e*this.bytesPerRow+t*this.bytesPerVector+this.bytesPerElement*n}setFloat32(t,e,n,i){const r=this.offset(e,n,i);this.view.setFloat32(r,t)}getFloat32(t,e,n){const i=this.offset(t,e,n);return this.view.getFloat32(i)}setUint8(t,e,n,i){const r=this.offset(e,n,i);this.view.setUint8(r,t)}getUint8(t,e,n){const i=this.offset(t,e,n);return this.view.getUint8(i)}}class ii{constructor(t,e,n){this.cols=t,this.rows=e,this.dimensions=n;const i=ni.computeByteLength(t,e,n,Uint8Array.BYTES_PER_ELEMENT),r=new ArrayBuffer(i);this.table=new ni(r,t,e,n,Uint8Array.BYTES_PER_ELEMENT)}get buffer(){return this.table.buffer}set(t,e,n,i){this.table.setUint8(t,e,n,i)}setVec(t,e,n){for(const[i,r]of t.entries())this.table.setUint8(r,e,n,i)}get(t,e,n){return this.table.getUint8(t,e,n)}}}}]);